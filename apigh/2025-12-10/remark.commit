{
  "sha": "41b75eba087b778fa466b0cb865b34b8efe7ce3a",
  "node_id": "C_kwDOBtgov9oAKDQxYjc1ZWJhMDg3Yjc3OGZhNDY2YjBjYjg2NWIzNGI4ZWZlN2NlM2E",
  "commit": {
    "author": {
      "name": "Dmitry Verkhoturov",
      "email": "paskal.07@gmail.com",
      "date": "2025-12-08T20:46:13Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2025-12-08T20:46:13Z"
    },
    "message": "Merge pull request #1977 from umputun/docker-native-arm64-runners\n\nImprove GitHub Actions workflows security and performance",
    "tree": {
      "sha": "401e8ad8746709c589ef4b6a61e9de499bbe304a",
      "url": "https://api.github.com/repos/umputun/remark42/git/trees/401e8ad8746709c589ef4b6a61e9de499bbe304a"
    },
    "url": "https://api.github.com/repos/umputun/remark42/git/commits/41b75eba087b778fa466b0cb865b34b8efe7ce3a",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsFcBAABCAAQBQJpNzkVCRC1aQ7uu5UhlAAA4tMQABqr8aDeDystrIJeBaOplQBB\nCAM2N+FvFKt5b7jeq+vy7NRyPZwHZa6ZDbnzLPmqHe0+85c9Wj/aESu9vAZNIkBk\nWv6uBTTKrVtrzjun2T33TGGjHR0XQ/a7KOPx4uNhQo9fYSaSbdmXo3JakrdN+5cU\nQ4IbKacPFGI3U7ymPIiIkUG73El2hFqxs7ssML5AlkHaiQW+8IzhSy9tvFOH1u2T\n/kNo0TzVYWUYmJUblFvx/3wZ7NyQK6tPNg4wulAr6PvSjEI0TO7bFr5tDHrpejKA\nc99U6IbjyoaWKLRPli4ekr0foCaBvOE0N02rw5++34ZXTxvUu5h7qazjA2wXImIX\nabr6CU5ZloI1ciuehZ1V7qfgyAJNMOMvhiGZd6p/Qtoaokf8m2roAa3sSKPEQQQk\nHqgK4p3Lu7cJrwOb3D0fQ0goc6nMiJ0Mp3vWi3x3K5YFc+iHyUK1s+ENBoTkfOyE\nq+pkj/LYlahf201KFD2ibXEKVXFYIew6++N+xHjK8wRr5SAI/fhbgQLD00jzj80g\npEuRgVC7+NzDBmwuhnlc9bF4dQiTH/ZuupHpPdXmsCdyndVZpPkWzxO6gEkbsfZU\noBE9+kh+0ogWQgGd8c8TKCmPDmSKOgvMTRKUBDN9OR7OO5oJpVhv3TAo12ydI+UI\nqrBBJzeehPPni8uznOHT\n=WXO/\n-----END PGP SIGNATURE-----\n",
      "payload": "tree 401e8ad8746709c589ef4b6a61e9de499bbe304a\nparent 4aa8362de1bdf280f8e42f6c71e5df2196bc236c\nauthor Dmitry Verkhoturov <paskal.07@gmail.com> 1765226773 +0000\ncommitter GitHub <noreply@github.com> 1765226773 -0600\n\nMerge pull request #1977 from umputun/docker-native-arm64-runners\n\nImprove GitHub Actions workflows security and performance",
      "verified_at": "2025-12-08T20:46:14Z"
    }
  },
  "url": "https://api.github.com/repos/umputun/remark42/commits/41b75eba087b778fa466b0cb865b34b8efe7ce3a",
  "html_url": "https://github.com/umputun/remark42/commit/41b75eba087b778fa466b0cb865b34b8efe7ce3a",
  "comments_url": "https://api.github.com/repos/umputun/remark42/commits/41b75eba087b778fa466b0cb865b34b8efe7ce3a/comments",
  "author": {
    "login": "paskal",
    "id": 712534,
    "node_id": "MDQ6VXNlcjcxMjUzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/712534?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paskal",
    "html_url": "https://github.com/paskal",
    "followers_url": "https://api.github.com/users/paskal/followers",
    "following_url": "https://api.github.com/users/paskal/following{/other_user}",
    "gists_url": "https://api.github.com/users/paskal/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paskal/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paskal/subscriptions",
    "organizations_url": "https://api.github.com/users/paskal/orgs",
    "repos_url": "https://api.github.com/users/paskal/repos",
    "events_url": "https://api.github.com/users/paskal/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paskal/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "4aa8362de1bdf280f8e42f6c71e5df2196bc236c",
      "url": "https://api.github.com/repos/umputun/remark42/commits/4aa8362de1bdf280f8e42f6c71e5df2196bc236c",
      "html_url": "https://github.com/umputun/remark42/commit/4aa8362de1bdf280f8e42f6c71e5df2196bc236c"
    }
  ],
  "stats": {
    "total": 667,
    "additions": 408,
    "deletions": 259
  },
  "files": [
    {
      "sha": "5f02f8b2b4a5a1961cd68499a44d5b757aa2c1d7",
      "filename": ".github/workflows/ci-backend.yml",
      "status": "modified",
      "additions": 8,
      "deletions": 3,
      "changes": 11,
      "blob_url": "https://github.com/umputun/remark42/blob/41b75eba087b778fa466b0cb865b34b8efe7ce3a/.github%2Fworkflows%2Fci-backend.yml",
      "raw_url": "https://github.com/umputun/remark42/raw/41b75eba087b778fa466b0cb865b34b8efe7ce3a/.github%2Fworkflows%2Fci-backend.yml",
      "contents_url": "https://api.github.com/repos/umputun/remark42/contents/.github%2Fworkflows%2Fci-backend.yml?ref=41b75eba087b778fa466b0cb865b34b8efe7ce3a",
      "patch": "@@ -16,13 +16,18 @@ on:\n       - \"backend/**\"\n       - \"!backend/scripts/**\"\n       - \"!**.md\"\n+\n jobs:\n   test:\n     name: Test & Coverage\n     runs-on: ubuntu-latest\n+    permissions:\n+      contents: read\n \n     steps:\n-      - uses: actions/checkout@v5\n+      - uses: actions/checkout@v6\n+        with:\n+          persist-credentials: false\n \n       - name: debug if needed\n         run: if [[ \"$DEBUG\" == \"true\" ]]; then env; fi\n@@ -53,13 +58,13 @@ jobs:\n           TZ: \"America/Chicago\"\n \n       - name: golangci-lint\n-        uses: golangci/golangci-lint-action@v8\n+        uses: golangci/golangci-lint-action@v9\n         with:\n           version: \"v2.6.0\"\n           working-directory: backend/app\n \n       - name: golangci-lint on example directory\n-        uses: golangci/golangci-lint-action@v8\n+        uses: golangci/golangci-lint-action@v9\n         with:\n           version: \"v2.6.0\"\n           args: --config ../../.golangci.yml"
    },
    {
      "sha": "675846f5170e3068f944f5c5042d751249982cb2",
      "filename": ".github/workflows/ci-build.yml",
      "status": "modified",
      "additions": 31,
      "deletions": 211,
      "changes": 242,
      "blob_url": "https://github.com/umputun/remark42/blob/41b75eba087b778fa466b0cb865b34b8efe7ce3a/.github%2Fworkflows%2Fci-build.yml",
      "raw_url": "https://github.com/umputun/remark42/raw/41b75eba087b778fa466b0cb865b34b8efe7ce3a/.github%2Fworkflows%2Fci-build.yml",
      "contents_url": "https://api.github.com/repos/umputun/remark42/contents/.github%2Fworkflows%2Fci-build.yml?ref=41b75eba087b778fa466b0cb865b34b8efe7ce3a",
      "patch": "@@ -1,18 +1,6 @@\n name: build\n \n on:\n-  push:\n-    branches:\n-    tags:\n-    paths:\n-      - \".github/workflows/ci-build.yml\"\n-      - \"backend/**\"\n-      - \"frontend/apps/**\"\n-      - \".dockerignore\"\n-      - \"docker-init.sh\"\n-      - \"Dockerfile\"\n-      - \"!**.md\"\n-      - \"!frontend/packages/**\"\n   pull_request:\n     paths:\n       - \".github/workflows/ci-build.yml\"\n@@ -23,18 +11,33 @@ on:\n       - \"Dockerfile\"\n       - \"!**.md\"\n \n+concurrency:\n+  group: ${{ github.workflow }}-${{ github.ref }}\n+  cancel-in-progress: true\n+\n jobs:\n-  # Build without pushing for PRs and non-master branches\n-  build-test:\n-    name: Build test (non-master)\n-    if: ${{ github.ref != 'refs/heads/master' && !startsWith(github.ref, 'refs/tags/') }}\n-    runs-on: ubuntu-24.04-arm\n+  build-images:\n+    name: Validate Docker build\n+    runs-on: ubuntu-latest\n+    permissions:\n+      contents: read\n+\n     steps:\n-      - uses: actions/checkout@v5\n+      - uses: actions/checkout@v6\n+        with:\n+          persist-credentials: false\n \n       - name: set up Docker Buildx\n         uses: docker/setup-buildx-action@v3\n \n+      - name: expose GitHub Actions cache\n+        uses: actions/cache@v4\n+        with:\n+          path: /tmp/.buildx-cache\n+          key: ${{ runner.os }}-buildx-${{ github.sha }}\n+          restore-keys: |\n+            ${{ runner.os }}-buildx-\n+\n       - name: free disk space\n         run: |\n           sudo rm -rf /usr/share/dotnet\n@@ -44,203 +47,20 @@ jobs:\n \n       - name: build docker image without pushing\n         run: |\n-          docker buildx build \\\n+          docker buildx build --load \\\n+              --cache-from type=local,src=/tmp/.buildx-cache \\\n+              --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \\\n               --build-arg SKIP_BACKEND_TEST=true --build-arg SKIP_FRONTEND_TEST=true \\\n-              --platform linux/arm64 .\n+              --platform linux/amd64 .\n \n       - name: build example docker image without pushing\n         run: |\n-          docker buildx build \\\n+          docker buildx build --load \\\n+              --cache-from type=local,src=/tmp/.buildx-cache \\\n               --build-arg SKIP_BACKEND_TEST=true --build-arg SKIP_FRONTEND_TEST=true \\\n-              --platform linux/arm64 -f backend/_example/memory_store/Dockerfile .\n-\n-  # Build and push for master and tags using native runners\n-  build-push:\n-    name: Build ${{ matrix.platform }}\n-    if: ${{ github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/') }}\n-    strategy:\n-      fail-fast: false\n-      matrix:\n-        include:\n-          - platform: linux/amd64\n-            runner: ubuntu-latest\n-            artifact-name: linux-amd64\n-          - platform: linux/arm64\n-            runner: ubuntu-24.04-arm\n-            artifact-name: linux-arm64\n-    runs-on: ${{ matrix.runner }}\n-\n-    steps:\n-      - uses: actions/checkout@v5\n-\n-      - name: set up Docker Buildx\n-        uses: docker/setup-buildx-action@v3\n-\n-      - name: free disk space\n-        run: |\n-          sudo rm -rf /usr/share/dotnet\n-          sudo rm -rf /opt/ghc\n-          sudo rm -rf /usr/local/share/boost\n-          docker system prune -af\n-\n-      - name: login to ghcr.io\n-        uses: docker/login-action@v3\n-        with:\n-          registry: ghcr.io\n-          username: ${{ github.actor }}\n-          password: ${{ secrets.PKG_TOKEN }}\n-\n-      - name: login to Docker Hub\n-        uses: docker/login-action@v3\n-        with:\n-          username: umputun\n-          password: ${{ secrets.DOCKER_HUB_TOKEN }}\n-\n-      - name: prepare build args\n-        id: prep\n-        run: |\n-          ref=\"$(echo ${GITHUB_REF} | cut -d'/' -f3)\"\n-          echo \"ref=${ref}\" >> $GITHUB_OUTPUT\n-          echo \"GITHUB_REF=${GITHUB_REF}, GITHUB_SHA=${GITHUB_SHA}, GIT_BRANCH=${ref}\"\n+              --platform linux/amd64 -f backend/_example/memory_store/Dockerfile .\n \n-      - name: build and push to ghcr.io\n-        id: build-ghcr\n-        uses: docker/build-push-action@v6\n-        with:\n-          context: .\n-          platforms: ${{ matrix.platform }}\n-          build-args: |\n-            SKIP_BACKEND_TEST=true\n-            SKIP_FRONTEND_TEST=true\n-            CI=github\n-            GITHUB_SHA=${{ github.sha }}\n-            GIT_BRANCH=${{ steps.prep.outputs.ref }}\n-            GITHUB_REF=${{ github.ref }}\n-          outputs: type=image,name=ghcr.io/umputun/remark42,push-by-digest=true,name-canonical=true,push=true\n-\n-      - name: build and push to Docker Hub\n-        id: build-dockerhub\n-        uses: docker/build-push-action@v6\n-        with:\n-          context: .\n-          platforms: ${{ matrix.platform }}\n-          build-args: |\n-            SKIP_BACKEND_TEST=true\n-            SKIP_FRONTEND_TEST=true\n-            CI=github\n-            GITHUB_SHA=${{ github.sha }}\n-            GIT_BRANCH=${{ steps.prep.outputs.ref }}\n-            GITHUB_REF=${{ github.ref }}\n-          outputs: type=image,name=umputun/remark42,push-by-digest=true,name-canonical=true,push=true\n-\n-      - name: export digests\n-        run: |\n-          mkdir -p /tmp/digests/ghcr /tmp/digests/dockerhub\n-          digest_ghcr=\"${{ steps.build-ghcr.outputs.digest }}\"\n-          digest_dockerhub=\"${{ steps.build-dockerhub.outputs.digest }}\"\n-          touch \"/tmp/digests/ghcr/${digest_ghcr#sha256:}\"\n-          touch \"/tmp/digests/dockerhub/${digest_dockerhub#sha256:}\"\n-\n-      - name: upload ghcr digest\n-        uses: actions/upload-artifact@v4\n-        with:\n-          name: digests-ghcr-${{ matrix.artifact-name }}\n-          path: /tmp/digests/ghcr/*\n-          if-no-files-found: error\n-          retention-days: 1\n-\n-      - name: upload dockerhub digest\n-        uses: actions/upload-artifact@v4\n-        with:\n-          name: digests-dockerhub-${{ matrix.artifact-name }}\n-          path: /tmp/digests/dockerhub/*\n-          if-no-files-found: error\n-          retention-days: 1\n-\n-  # Merge digests and create multi-arch manifest\n-  merge-push:\n-    name: Create multi-arch manifest\n-    runs-on: ubuntu-latest\n-    needs: build-push\n-\n-    steps:\n-      - name: download ghcr digests\n-        uses: actions/download-artifact@v4\n-        with:\n-          path: /tmp/digests/ghcr\n-          pattern: digests-ghcr-*\n-          merge-multiple: true\n-\n-      - name: download dockerhub digests\n-        uses: actions/download-artifact@v4\n-        with:\n-          path: /tmp/digests/dockerhub\n-          pattern: digests-dockerhub-*\n-          merge-multiple: true\n-\n-      - name: verify all digests present\n+      - name: rotate cache\n         run: |\n-          for registry in ghcr dockerhub; do\n-            expected=2\n-            actual=$(ls /tmp/digests/${registry} | wc -l)\n-            if [ \"$actual\" -ne \"$expected\" ]; then\n-              echo \"Expected $expected digests for ${registry}, found $actual\"\n-              ls -la /tmp/digests/${registry}\n-              exit 1\n-            fi\n-            echo \"All $expected digests present for ${registry}\"\n-          done\n-\n-      - name: set up Docker Buildx\n-        uses: docker/setup-buildx-action@v3\n-\n-      - name: login to ghcr.io\n-        uses: docker/login-action@v3\n-        with:\n-          registry: ghcr.io\n-          username: ${{ github.actor }}\n-          password: ${{ secrets.PKG_TOKEN }}\n-\n-      - name: login to Docker Hub\n-        uses: docker/login-action@v3\n-        with:\n-          username: umputun\n-          password: ${{ secrets.DOCKER_HUB_TOKEN }}\n-\n-      - name: prepare tags\n-        id: prep\n-        run: |\n-          ref=\"$(echo ${GITHUB_REF} | cut -d'/' -f3)\"\n-          echo \"ref=${ref}\" >> $GITHUB_OUTPUT\n-\n-          # for master branch, tag with branch name only\n-          if [[ \"${GITHUB_REF}\" == \"refs/heads/master\" ]]; then\n-            echo \"ghcr_tags=-t ghcr.io/umputun/remark42:${ref}\" >> $GITHUB_OUTPUT\n-            echo \"dockerhub_tags=-t umputun/remark42:${ref}\" >> $GITHUB_OUTPUT\n-          fi\n-\n-          # for tags, include both version and latest\n-          if [[ \"${GITHUB_REF}\" == refs/tags/* ]]; then\n-            echo \"ghcr_tags=-t ghcr.io/umputun/remark42:${ref} -t ghcr.io/umputun/remark42:latest\" >> $GITHUB_OUTPUT\n-            echo \"dockerhub_tags=-t umputun/remark42:${ref} -t umputun/remark42:latest\" >> $GITHUB_OUTPUT\n-          fi\n-\n-      - name: create ghcr manifest and push\n-        working-directory: /tmp/digests/ghcr\n-        run: |\n-          docker buildx imagetools create \\\n-            ${{ steps.prep.outputs.ghcr_tags }} \\\n-            $(printf 'ghcr.io/umputun/remark42@sha256:%s ' *)\n-\n-      - name: create dockerhub manifest and push\n-        working-directory: /tmp/digests/dockerhub\n-        run: |\n-          docker buildx imagetools create \\\n-            ${{ steps.prep.outputs.dockerhub_tags }} \\\n-            $(printf 'umputun/remark42@sha256:%s ' *)\n-\n-      - name: remote deployment to remark42.com from master\n-        if: ${{ github.ref == 'refs/heads/master' }}\n-        env:\n-          UPDATER_KEY: ${{ secrets.UPDATER_KEY }}\n-        run: curl -s https://jess.umputun.com/update/remark42-core/${UPDATER_KEY}\n+          rm -rf /tmp/.buildx-cache\n+          mv /tmp/.buildx-cache-new /tmp/.buildx-cache || true"
    },
    {
      "sha": "921d99bfe7ebd2c5135551ea0ba5904de2631e83",
      "filename": ".github/workflows/ci-frontend-api.yml",
      "status": "modified",
      "additions": 15,
      "deletions": 3,
      "changes": 18,
      "blob_url": "https://github.com/umputun/remark42/blob/41b75eba087b778fa466b0cb865b34b8efe7ce3a/.github%2Fworkflows%2Fci-frontend-api.yml",
      "raw_url": "https://github.com/umputun/remark42/raw/41b75eba087b778fa466b0cb865b34b8efe7ce3a/.github%2Fworkflows%2Fci-frontend-api.yml",
      "contents_url": "https://api.github.com/repos/umputun/remark42/contents/.github%2Fworkflows%2Fci-frontend-api.yml?ref=41b75eba087b778fa466b0cb865b34b8efe7ce3a",
      "patch": "@@ -18,13 +18,17 @@ jobs:\n   type-check:\n     name: Type check\n     runs-on: ubuntu-latest\n+    permissions:\n+      contents: read\n     strategy:\n       matrix:\n         node: [ 16 ]\n \n     steps:\n       - name: Checkout\n-        uses: actions/checkout@v5\n+        uses: actions/checkout@v6\n+        with:\n+          persist-credentials: false\n \n       - name: Install node\n         uses: actions/setup-node@v6\n@@ -61,13 +65,17 @@ jobs:\n   lint:\n     name: Lint\n     runs-on: ubuntu-latest\n+    permissions:\n+      contents: read\n     strategy:\n       matrix:\n         node: [ 16 ]\n \n     steps:\n       - name: Checkout\n-        uses: actions/checkout@v5\n+        uses: actions/checkout@v6\n+        with:\n+          persist-credentials: false\n \n       - name: Install node\n         uses: actions/setup-node@v6\n@@ -104,13 +112,17 @@ jobs:\n   test:\n     name: Tests & Coverage\n     runs-on: ubuntu-latest\n+    permissions:\n+      contents: read\n     strategy:\n       matrix:\n         node: [ 16 ]\n \n     steps:\n       - name: Checkout\n-        uses: actions/checkout@v5\n+        uses: actions/checkout@v6\n+        with:\n+          persist-credentials: false\n \n       - name: Install node\n         uses: actions/setup-node@v6"
    },
    {
      "sha": "7c51944c7e0a069ab196e1872dfb01fbe26d4fc5",
      "filename": ".github/workflows/ci-frontend.yml",
      "status": "modified",
      "additions": 26,
      "deletions": 5,
      "changes": 31,
      "blob_url": "https://github.com/umputun/remark42/blob/41b75eba087b778fa466b0cb865b34b8efe7ce3a/.github%2Fworkflows%2Fci-frontend.yml",
      "raw_url": "https://github.com/umputun/remark42/raw/41b75eba087b778fa466b0cb865b34b8efe7ce3a/.github%2Fworkflows%2Fci-frontend.yml",
      "contents_url": "https://api.github.com/repos/umputun/remark42/contents/.github%2Fworkflows%2Fci-frontend.yml?ref=41b75eba087b778fa466b0cb865b34b8efe7ce3a",
      "patch": "@@ -18,13 +18,17 @@ jobs:\n   translations-check:\n     name: Translations check\n     runs-on: ubuntu-latest\n+    permissions:\n+      contents: read\n     strategy:\n       matrix:\n         node: [16]\n \n     steps:\n       - name: Checkout\n-        uses: actions/checkout@v5\n+        uses: actions/checkout@v6\n+        with:\n+          persist-credentials: false\n \n       - name: Install node\n         uses: actions/setup-node@v6\n@@ -61,13 +65,17 @@ jobs:\n   type-check:\n     name: Type check\n     runs-on: ubuntu-latest\n+    permissions:\n+      contents: read\n     strategy:\n       matrix:\n         node: [16]\n \n     steps:\n       - name: Checkout\n-        uses: actions/checkout@v5\n+        uses: actions/checkout@v6\n+        with:\n+          persist-credentials: false\n \n       - name: Install node\n         uses: actions/setup-node@v6\n@@ -104,13 +112,17 @@ jobs:\n   lint:\n     name: Eslint & Stylelint\n     runs-on: ubuntu-latest\n+    permissions:\n+      contents: read\n     strategy:\n       matrix:\n         node: [16]\n \n     steps:\n       - name: Checkout\n-        uses: actions/checkout@v5\n+        uses: actions/checkout@v6\n+        with:\n+          persist-credentials: false\n \n       - name: Install node\n         uses: actions/setup-node@v6\n@@ -148,11 +160,16 @@ jobs:\n     name: Size limit\n     runs-on: ubuntu-latest\n     if: github.event_name == 'pull_request'\n+    permissions:\n+      contents: read\n+      pull-requests: write\n     env:\n       CI_JOB_NUMBER: 1\n     steps:\n       - name: Checkout\n-        uses: actions/checkout@v5\n+        uses: actions/checkout@v6\n+        with:\n+          persist-credentials: false\n \n       - name: Install pnpm\n         uses: pnpm/action-setup@v4.2.0\n@@ -171,13 +188,17 @@ jobs:\n   test:\n     name: Tests & Coverage\n     runs-on: ubuntu-latest\n+    permissions:\n+      contents: read\n     strategy:\n       matrix:\n         node: [16]\n \n     steps:\n       - name: Checkout\n-        uses: actions/checkout@v5\n+        uses: actions/checkout@v6\n+        with:\n+          persist-credentials: false\n \n       - name: Install node\n         uses: actions/setup-node@v6"
    },
    {
      "sha": "f2a59f39cb2db6d208a9e892abfbd0db62a544b6",
      "filename": ".github/workflows/ci-site.yml",
      "status": "modified",
      "additions": 109,
      "deletions": 36,
      "changes": 145,
      "blob_url": "https://github.com/umputun/remark42/blob/41b75eba087b778fa466b0cb865b34b8efe7ce3a/.github%2Fworkflows%2Fci-site.yml",
      "raw_url": "https://github.com/umputun/remark42/raw/41b75eba087b778fa466b0cb865b34b8efe7ce3a/.github%2Fworkflows%2Fci-site.yml",
      "contents_url": "https://api.github.com/repos/umputun/remark42/contents/.github%2Fworkflows%2Fci-site.yml?ref=41b75eba087b778fa466b0cb865b34b8efe7ce3a",
      "patch": "@@ -13,57 +13,130 @@ on:\n       - \".github/workflows/ci-site.yml\"\n       - \"site/**\"\n \n+concurrency:\n+  group: ${{ github.workflow }}-${{ github.ref }}\n+  cancel-in-progress: true\n+\n jobs:\n   build:\n-    name: Build\n-    runs-on: ubuntu-latest\n+    name: Build site image (${{ matrix.platform }})\n+    if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')\n+    runs-on: ${{ matrix.runner }}\n+    permissions:\n+      contents: read\n+      packages: write\n+    strategy:\n+      fail-fast: false\n+      matrix:\n+        include:\n+          - platform: linux/amd64\n+            runner: ubuntu-latest\n+            artifact: linux-amd64\n+          - platform: linux/arm64\n+            runner: ubuntu-24.04-arm\n+            artifact: linux-arm64\n \n     steps:\n       - name: checkout\n-        uses: actions/checkout@v5\n-\n-      - name: set up QEMU\n-        uses: docker/setup-qemu-action@v3\n+        uses: actions/checkout@v6\n+        with:\n+          persist-credentials: false\n \n       - name: set up Docker Buildx\n-        id: buildx\n         uses: docker/setup-buildx-action@v3\n \n-      - name: available platforms\n-        run: echo ${{ steps.buildx.outputs.platforms }}\n+      - name: login to ghcr.io\n+        uses: docker/login-action@v3\n+        with:\n+          registry: ghcr.io\n+          username: ${{ github.actor }}\n+          password: ${{ secrets.PKG_TOKEN }}\n \n-      - name: build and deploy master image to ghcr.io\n-        if: ${{ github.ref == 'refs/heads/master' }}\n-        env:\n-          GITHUB_PACKAGE_TOKEN: ${{ secrets.PKG_TOKEN }}\n-          USERNAME: ${{ github.actor }}\n-          GITHUB_SHA: ${{ github.sha}}\n-          GITHUB_REF: ${{ github.ref}}\n-        working-directory: ./site\n+      - name: build and push by digest\n+        id: build\n+        uses: docker/build-push-action@v6\n+        with:\n+          context: ./site\n+          platforms: ${{ matrix.platform }}\n+          cache-from: type=gha,scope=site-${{ matrix.platform }}\n+          cache-to: type=gha,scope=site-${{ matrix.platform }},mode=max\n+          outputs: type=image,name=ghcr.io/umputun/remark42-site,push-by-digest=true,name-canonical=true,push=true\n+\n+      - name: export digest\n         run: |\n-          ref=\"$(echo ${GITHUB_REF} | cut -d'/' -f3)\"\n-          echo GITHUB_REF - $ref\n-          echo ${GITHUB_PACKAGE_TOKEN} | docker login ghcr.io -u ${USERNAME} --password-stdin\n-          docker buildx build --push --no-cache --platform linux/amd64,linux/arm64 \\\n-            -t ghcr.io/umputun/remark42-site:${ref} .\n+          mkdir -p /tmp/digests\n+          digest=\"${{ steps.build.outputs.digest }}\"\n+          touch \"/tmp/digests/${digest#sha256:}\"\n+\n+      - name: upload digest\n+        uses: actions/upload-artifact@v5\n+        with:\n+          name: site-digests-${{ matrix.artifact }}\n+          path: /tmp/digests/*\n+          retention-days: 1\n+\n+  merge:\n+    name: Create site multi-arch manifest\n+    runs-on: ubuntu-latest\n+    needs: build\n+    permissions:\n+      contents: read\n+      packages: write\n+\n+    steps:\n+      - name: download digests\n+        uses: actions/download-artifact@v6\n+        with:\n+          path: /tmp/digests\n+          pattern: site-digests-*\n+          merge-multiple: true\n+\n+      - name: verify all digests present\n+        run: |\n+          expected=2\n+          actual=$(find /tmp/digests -maxdepth 1 -type f | wc -l)\n+          if [ \"$actual\" -ne \"$expected\" ]; then\n+            echo \"Expected $expected digests, found $actual\"\n+            ls -la /tmp/digests\n+            exit 1\n+          fi\n+          echo \"All $expected digests present\"\n+\n+      - name: set up Docker Buildx\n+        uses: docker/setup-buildx-action@v3\n+\n+      - name: login to ghcr.io\n+        uses: docker/login-action@v3\n+        with:\n+          registry: ghcr.io\n+          username: ${{ github.actor }}\n+          password: ${{ secrets.PKG_TOKEN }}\n \n-      - name: deploy tagged (latest) to ghcr.io\n-        if: ${{ startsWith(github.ref, 'refs/tags/') }}\n+      - name: create manifest and push\n+        working-directory: /tmp/digests\n         env:\n-          GITHUB_PACKAGE_TOKEN: ${{ secrets.PKG_TOKEN }}\n-          USERNAME: ${{ github.actor }}\n-          GITHUB_SHA: ${{ github.sha}}\n-          GITHUB_REF: ${{ github.ref}}\n-        working-directory: ./site\n+          GITHUB_REF: ${{ github.ref }}\n         run: |\n           ref=\"$(echo ${GITHUB_REF} | cut -d'/' -f3)\"\n-          echo \"GITHUB_REF=$ref, GITHUB_SHA=${GITHUB_SHA}\"\n-          echo ${GITHUB_PACKAGE_TOKEN} | docker login ghcr.io -u ${USERNAME} --password-stdin\n-          docker buildx build --push --no-cache --platform linux/amd64,linux/arm64 \\\n-            -t ghcr.io/umputun/remark42-site:${ref} -t ghcr.io/umputun/remark42-site:latest .\n+          if [[ \"$GITHUB_REF\" == refs/tags/* ]]; then\n+            docker buildx imagetools create \\\n+              -t ghcr.io/umputun/remark42-site:${ref} \\\n+              -t ghcr.io/umputun/remark42-site:latest \\\n+              $(printf 'ghcr.io/umputun/remark42-site@sha256:%s ' *)\n+          else\n+            docker buildx imagetools create \\\n+              -t ghcr.io/umputun/remark42-site:${ref} \\\n+              $(printf 'ghcr.io/umputun/remark42-site@sha256:%s ' *)\n+          fi\n \n-      - name: remote site deployment from master\n-        if: ${{ github.ref == 'refs/heads/master' }}\n+  deploy:\n+    name: Deploy site\n+    runs-on: ubuntu-latest\n+    needs: merge\n+    if: github.ref == 'refs/heads/master'\n+\n+    steps:\n+      - name: trigger deployment\n         env:\n           UPDATER_KEY: ${{ secrets.UPDATER_KEY }}\n-        run: curl https://jess.umputun.com/update/remark42-site/${UPDATER_KEY}\n+        run: curl -sf https://jess.umputun.com/update/remark42-site/${UPDATER_KEY}"
    },
    {
      "sha": "730ee0c2b8eb6725e23e4e8bdb5f79757ce735a1",
      "filename": ".github/workflows/docker.yml",
      "status": "added",
      "additions": 214,
      "deletions": 0,
      "changes": 214,
      "blob_url": "https://github.com/umputun/remark42/blob/41b75eba087b778fa466b0cb865b34b8efe7ce3a/.github%2Fworkflows%2Fdocker.yml",
      "raw_url": "https://github.com/umputun/remark42/raw/41b75eba087b778fa466b0cb865b34b8efe7ce3a/.github%2Fworkflows%2Fdocker.yml",
      "contents_url": "https://api.github.com/repos/umputun/remark42/contents/.github%2Fworkflows%2Fdocker.yml?ref=41b75eba087b778fa466b0cb865b34b8efe7ce3a",
      "patch": "@@ -0,0 +1,214 @@\n+name: docker\n+\n+on:\n+  workflow_run:\n+    workflows: [backend]\n+    types: [completed]\n+\n+concurrency:\n+  group: ${{ github.workflow }}-${{ github.event.workflow_run.head_branch }}\n+  cancel-in-progress: true\n+\n+jobs:\n+  build:\n+    name: Build Docker image (${{ matrix.platform }})\n+    if: >-\n+      github.event.workflow_run.conclusion == 'success' &&\n+      github.event.workflow_run.event != 'pull_request' &&\n+      (github.event.workflow_run.head_branch == 'master' ||\n+       startsWith(github.event.workflow_run.head_branch, 'v'))\n+    permissions:\n+      contents: read\n+      packages: write\n+    strategy:\n+      fail-fast: false\n+      matrix:\n+        include:\n+          - platform: linux/amd64\n+            runner: ubuntu-latest\n+            artifact: linux-amd64\n+          - platform: linux/arm64\n+            runner: ubuntu-24.04-arm\n+            artifact: linux-arm64\n+    runs-on: ${{ matrix.runner }}\n+\n+    steps:\n+      - name: checkout\n+        uses: actions/checkout@v6\n+        with:\n+          ref: ${{ github.event.workflow_run.head_sha }}\n+          persist-credentials: false\n+\n+      - name: set up Docker Buildx\n+        uses: docker/setup-buildx-action@v3\n+\n+      - name: login to ghcr.io\n+        uses: docker/login-action@v3\n+        with:\n+          registry: ghcr.io\n+          username: ${{ github.actor }}\n+          password: ${{ secrets.PKG_TOKEN }}\n+\n+      - name: login to DockerHub\n+        uses: docker/login-action@v3\n+        with:\n+          username: umputun\n+          password: ${{ secrets.DOCKER_HUB_TOKEN }}\n+\n+      - name: free disk space\n+        run: |\n+          sudo rm -rf /usr/share/dotnet\n+          sudo rm -rf /opt/ghc\n+          sudo rm -rf /usr/local/share/boost\n+          docker system prune -af\n+\n+      - name: build and push to ghcr.io by digest\n+        id: build-ghcr\n+        uses: docker/build-push-action@v6\n+        with:\n+          context: .\n+          platforms: ${{ matrix.platform }}\n+          cache-from: type=gha,scope=${{ matrix.platform }}\n+          cache-to: type=gha,scope=${{ matrix.platform }},mode=max\n+          build-args: |\n+            SKIP_BACKEND_TEST=true\n+            SKIP_FRONTEND_TEST=true\n+            CI=github\n+            GITHUB_SHA=${{ github.event.workflow_run.head_sha }}\n+            GIT_BRANCH=${{ github.event.workflow_run.head_branch }}\n+            GITHUB_REF=refs/heads/${{ github.event.workflow_run.head_branch }}\n+          outputs: type=image,name=ghcr.io/umputun/remark42,push-by-digest=true,name-canonical=true,push=true\n+\n+      - name: build and push to DockerHub by digest\n+        id: build-dockerhub\n+        uses: docker/build-push-action@v6\n+        with:\n+          context: .\n+          platforms: ${{ matrix.platform }}\n+          cache-from: type=gha,scope=${{ matrix.platform }}\n+          build-args: |\n+            SKIP_BACKEND_TEST=true\n+            SKIP_FRONTEND_TEST=true\n+            CI=github\n+            GITHUB_SHA=${{ github.event.workflow_run.head_sha }}\n+            GIT_BRANCH=${{ github.event.workflow_run.head_branch }}\n+            GITHUB_REF=refs/heads/${{ github.event.workflow_run.head_branch }}\n+          outputs: type=image,name=umputun/remark42,push-by-digest=true,name-canonical=true,push=true\n+\n+      - name: export digests\n+        run: |\n+          mkdir -p /tmp/digests/ghcr /tmp/digests/dockerhub\n+          digest_ghcr=\"${{ steps.build-ghcr.outputs.digest }}\"\n+          digest_dockerhub=\"${{ steps.build-dockerhub.outputs.digest }}\"\n+          touch \"/tmp/digests/ghcr/${digest_ghcr#sha256:}\"\n+          touch \"/tmp/digests/dockerhub/${digest_dockerhub#sha256:}\"\n+\n+      - name: upload ghcr digest\n+        uses: actions/upload-artifact@v5\n+        with:\n+          name: digests-ghcr-${{ matrix.artifact }}\n+          path: /tmp/digests/ghcr/*\n+          retention-days: 1\n+\n+      - name: upload dockerhub digest\n+        uses: actions/upload-artifact@v5\n+        with:\n+          name: digests-dockerhub-${{ matrix.artifact }}\n+          path: /tmp/digests/dockerhub/*\n+          retention-days: 1\n+\n+  merge:\n+    name: Create multi-arch manifest\n+    runs-on: ubuntu-latest\n+    needs: build\n+    permissions:\n+      contents: read\n+      packages: write\n+\n+    steps:\n+      - name: download ghcr digests\n+        uses: actions/download-artifact@v6\n+        with:\n+          path: /tmp/digests/ghcr\n+          pattern: digests-ghcr-*\n+          merge-multiple: true\n+\n+      - name: download dockerhub digests\n+        uses: actions/download-artifact@v6\n+        with:\n+          path: /tmp/digests/dockerhub\n+          pattern: digests-dockerhub-*\n+          merge-multiple: true\n+\n+      - name: verify all digests present\n+        run: |\n+          expected=2\n+          for registry in ghcr dockerhub; do\n+            actual=$(find /tmp/digests/$registry -maxdepth 1 -type f | wc -l)\n+            if [ \"$actual\" -ne \"$expected\" ]; then\n+              echo \"Expected $expected digests for $registry, found $actual\"\n+              ls -la /tmp/digests/$registry\n+              exit 1\n+            fi\n+          done\n+          echo \"All digests present for both registries\"\n+\n+      - name: set up Docker Buildx\n+        uses: docker/setup-buildx-action@v3\n+\n+      - name: login to ghcr.io\n+        uses: docker/login-action@v3\n+        with:\n+          registry: ghcr.io\n+          username: ${{ github.actor }}\n+          password: ${{ secrets.PKG_TOKEN }}\n+\n+      - name: login to DockerHub\n+        uses: docker/login-action@v3\n+        with:\n+          username: umputun\n+          password: ${{ secrets.DOCKER_HUB_TOKEN }}\n+\n+      - name: create ghcr.io manifest and push\n+        working-directory: /tmp/digests/ghcr\n+        env:\n+          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}\n+        run: |\n+          if [[ \"$HEAD_BRANCH\" == v* ]]; then\n+            docker buildx imagetools create \\\n+              -t ghcr.io/umputun/remark42:${HEAD_BRANCH} \\\n+              -t ghcr.io/umputun/remark42:latest \\\n+              $(printf 'ghcr.io/umputun/remark42@sha256:%s ' *)\n+          else\n+            docker buildx imagetools create \\\n+              -t ghcr.io/umputun/remark42:${HEAD_BRANCH} \\\n+              $(printf 'ghcr.io/umputun/remark42@sha256:%s ' *)\n+          fi\n+\n+      - name: create DockerHub manifest and push\n+        working-directory: /tmp/digests/dockerhub\n+        env:\n+          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}\n+        run: |\n+          if [[ \"$HEAD_BRANCH\" == v* ]]; then\n+            docker buildx imagetools create \\\n+              -t umputun/remark42:${HEAD_BRANCH} \\\n+              -t umputun/remark42:latest \\\n+              $(printf 'umputun/remark42@sha256:%s ' *)\n+          else\n+            docker buildx imagetools create \\\n+              -t umputun/remark42:${HEAD_BRANCH} \\\n+              $(printf 'umputun/remark42@sha256:%s ' *)\n+          fi\n+\n+  deploy:\n+    name: Deploy to remark42.com\n+    runs-on: ubuntu-latest\n+    needs: merge\n+    if: github.event.workflow_run.head_branch == 'master'\n+\n+    steps:\n+      - name: trigger deployment\n+        env:\n+          UPDATER_KEY: ${{ secrets.UPDATER_KEY }}\n+        run: curl -sf https://jess.umputun.com/update/remark42-core/${UPDATER_KEY}"
    },
    {
      "sha": "668df81649e7e86823423cdc98a5de0847671c70",
      "filename": ".github/workflows/e2e-tests.yml",
      "status": "modified",
      "additions": 5,
      "deletions": 1,
      "changes": 6,
      "blob_url": "https://github.com/umputun/remark42/blob/41b75eba087b778fa466b0cb865b34b8efe7ce3a/.github%2Fworkflows%2Fe2e-tests.yml",
      "raw_url": "https://github.com/umputun/remark42/raw/41b75eba087b778fa466b0cb865b34b8efe7ce3a/.github%2Fworkflows%2Fe2e-tests.yml",
      "contents_url": "https://api.github.com/repos/umputun/remark42/contents/.github%2Fworkflows%2Fe2e-tests.yml?ref=41b75eba087b778fa466b0cb865b34b8efe7ce3a",
      "patch": "@@ -22,9 +22,13 @@ jobs:\n     name: Tests\n     timeout-minutes: 60\n     runs-on: ubuntu-latest\n+    permissions:\n+      contents: read\n     steps:\n       - name: Checkout\n-        uses: actions/checkout@v5\n+        uses: actions/checkout@v6\n+        with:\n+          persist-credentials: false\n \n       - name: Build & run containers\n         id: tests"
    }
  ]
}
