{
  "sha": "16dce5121025f76c48731c986dd53eb4c30df8f9",
  "node_id": "C_kwDOAF-mA9oAKDE2ZGNlNTEyMTAyNWY3NmM0ODczMWM5ODZkZDUzZWI0YzMwZGY4Zjk",
  "commit": {
    "author": {
      "name": "ix5",
      "email": "ix5@users.noreply.github.com",
      "date": "2024-04-29T20:49:28Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2024-04-29T20:49:28Z"
    },
    "message": "Merge pull request #1016 from pkvach/fix/add-stdout-logging-for-new-comments\n\next: notifications: Add link logging for management of new comments in Stdout",
    "tree": {
      "sha": "44902eeaf9f9fdb8545eedeeb2b1fa5f36337e36",
      "url": "https://api.github.com/repos/isso-comments/isso/git/trees/44902eeaf9f9fdb8545eedeeb2b1fa5f36337e36"
    },
    "url": "https://api.github.com/repos/isso-comments/isso/git/commits/16dce5121025f76c48731c986dd53eb4c30df8f9",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsFcBAABCAAQBQJmMAfYCRC1aQ7uu5UhlAAAh44QAH6WHP8q/VDz/KSRJrqIS+gV\nuzUBVZJN0KsJA+g8byRQIUXHIEvbt1azUHdb96j7CjZdT5FvE0Y6W/SFSyOd0LqZ\nSVbBmXNM7fahe5axrzebNDisb/8i/DJ8mHV9kDPb2RPRNJ4Hr8KN6gZXm+JwrhK0\nGnXs+s72eXqeoiujMydhrmA1F0bTXxXD02BtGQsrb5p+uh08kF71FPn+PP6tUwnS\nISsUBcuwGi0BweL2vH1MF2IlzSCzNLLqm0SAS4NdZPMIlDIwOINyshqiBQr5m7uA\nrBNZ/JkWQXlPMq0pPodAGqVEvyPO7/EY8rE3DJCarh67I+sNRU6vYLQO/miU8YaT\nIqegHbf06hwua4SBPCAFOahDNy++rDIY4fhVXIuKSCei9BbryVEi/s07ZgoXWpD5\nTBc1HoFvAEa0I8WZA6BjR8AdFuecbMAjabf8nddK0m96F2JImTaQXzi5ezC4HF7O\nFZP2MLjdxdX5235Y0s+dNN1yJZSGE+egIKCBKfFekWH6Xh0mWFSwtcI/Zog/NMMg\nnAgZfVGJORNUkpmty4e5uvI766i5FOdJD9GZU11k+I1l59Wj4xn6sIsaN7Ix5DZ6\n9cjscuQUcvEKNpU1hC5BuMx7D/HVkkJNA0sTk0XO634CQleJoA3p+98lL6qyd1ho\nVQHtjwonHutdlhUYhVcw\n=ET8p\n-----END PGP SIGNATURE-----\n",
      "payload": "tree 44902eeaf9f9fdb8545eedeeb2b1fa5f36337e36\nparent 95681979010fc32a79138cab2355bbf8eea24cdc\nparent 1f6a96ecb41118642a0caa215763a44d2e564773\nauthor ix5 <ix5@users.noreply.github.com> 1714423768 +0200\ncommitter GitHub <noreply@github.com> 1714423768 +0200\n\nMerge pull request #1016 from pkvach/fix/add-stdout-logging-for-new-comments\n\next: notifications: Add link logging for management of new comments in Stdout"
    }
  },
  "url": "https://api.github.com/repos/isso-comments/isso/commits/16dce5121025f76c48731c986dd53eb4c30df8f9",
  "html_url": "https://github.com/isso-comments/isso/commit/16dce5121025f76c48731c986dd53eb4c30df8f9",
  "comments_url": "https://api.github.com/repos/isso-comments/isso/commits/16dce5121025f76c48731c986dd53eb4c30df8f9/comments",
  "author": {
    "login": "ix5",
    "id": 10212877,
    "node_id": "MDQ6VXNlcjEwMjEyODc3",
    "avatar_url": "https://avatars.githubusercontent.com/u/10212877?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ix5",
    "html_url": "https://github.com/ix5",
    "followers_url": "https://api.github.com/users/ix5/followers",
    "following_url": "https://api.github.com/users/ix5/following{/other_user}",
    "gists_url": "https://api.github.com/users/ix5/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ix5/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ix5/subscriptions",
    "organizations_url": "https://api.github.com/users/ix5/orgs",
    "repos_url": "https://api.github.com/users/ix5/repos",
    "events_url": "https://api.github.com/users/ix5/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ix5/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "95681979010fc32a79138cab2355bbf8eea24cdc",
      "url": "https://api.github.com/repos/isso-comments/isso/commits/95681979010fc32a79138cab2355bbf8eea24cdc",
      "html_url": "https://github.com/isso-comments/isso/commit/95681979010fc32a79138cab2355bbf8eea24cdc"
    },
    {
      "sha": "1f6a96ecb41118642a0caa215763a44d2e564773",
      "url": "https://api.github.com/repos/isso-comments/isso/commits/1f6a96ecb41118642a0caa215763a44d2e564773",
      "html_url": "https://github.com/isso-comments/isso/commit/1f6a96ecb41118642a0caa215763a44d2e564773"
    }
  ],
  "stats": {
    "total": 26,
    "additions": 21,
    "deletions": 5
  },
  "files": [
    {
      "sha": "964c3bab975221c8834f66fe5bcf045f1d3178a1",
      "filename": "CHANGES.rst",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/isso-comments/isso/blob/16dce5121025f76c48731c986dd53eb4c30df8f9/CHANGES.rst",
      "raw_url": "https://github.com/isso-comments/isso/raw/16dce5121025f76c48731c986dd53eb4c30df8f9/CHANGES.rst",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/CHANGES.rst?ref=16dce5121025f76c48731c986dd53eb4c30df8f9",
      "patch": "@@ -41,6 +41,7 @@ Bugfixes & Improvements\n - Handle deleted comments in Disqus migration (`#994`_, pkvach)\n - Fix total comments count calculation (`#997`_, pkvach)\n - Fix newline character handling in data-isso-* i18n strings (`#992`_, pkvach)\n+- Add link logging for management of new comments in Stdout (`#1016`_, pkvach)\n \n .. _#951: https://github.com/posativ/isso/pull/951\n .. _#967: https://github.com/posativ/isso/pull/967\n@@ -50,6 +51,7 @@ Bugfixes & Improvements\n .. _#994: https://github.com/isso-comments/isso/pull/994\n .. _#997: https://github.com/isso-comments/isso/pull/997\n .. _#992: https://github.com/isso-comments/isso/pull/992\n+.. _#1016: https://github.com/isso-comments/isso/pull/1016\n \n 0.13.1.dev0 (2023-02-05)\n ------------------------"
    },
    {
      "sha": "53d34c094eade3aa73deef488289d5ea8bc74113",
      "filename": "isso/__init__.py",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/isso-comments/isso/blob/16dce5121025f76c48731c986dd53eb4c30df8f9/isso%2F__init__.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/16dce5121025f76c48731c986dd53eb4c30df8f9/isso%2F__init__.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2F__init__.py?ref=16dce5121025f76c48731c986dd53eb4c30df8f9",
      "patch": "@@ -110,7 +110,7 @@ def __init__(self, conf):\n         smtp_backend = False\n         for backend in conf.getlist(\"general\", \"notify\"):\n             if backend == \"stdout\":\n-                subscribers.append(Stdout(None))\n+                subscribers.append(Stdout(self))\n             elif backend in (\"smtp\", \"SMTP\"):\n                 smtp_backend = True\n             else:"
    },
    {
      "sha": "ee5a888635a93302480bb3d2470f3007114e9c1d",
      "filename": "isso/ext/notifications.py",
      "status": "modified",
      "additions": 18,
      "deletions": 4,
      "changes": 22,
      "blob_url": "https://github.com/isso-comments/isso/blob/16dce5121025f76c48731c986dd53eb4c30df8f9/isso%2Fext%2Fnotifications.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/16dce5121025f76c48731c986dd53eb4c30df8f9/isso%2Fext%2Fnotifications.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fext%2Fnotifications.py?ref=16dce5121025f76c48731c986dd53eb4c30df8f9",
      "patch": "@@ -22,6 +22,10 @@\n from isso import local\n \n \n+def create_comment_action_url(uri, action, key):\n+    return uri + \"/\" + action + \"/\" + key\n+\n+\n class SMTPConnection(object):\n \n     def __init__(self, conf):\n@@ -118,10 +122,10 @@ def format(self, thread, comment, parent_comment, recipient=None, admin=False):\n             uri = self.public_endpoint + \"/id/%i\" % comment[\"id\"]\n             key = self.isso.sign(comment[\"id\"])\n \n-            rv.write(\"Delete comment: %s\\n\" % (uri + \"/delete/\" + key))\n+            rv.write(\"Delete comment: %s\\n\" % create_comment_action_url(uri, \"delete\", key))\n \n             if comment[\"mode\"] == 2:\n-                rv.write(\"Activate comment: %s\\n\" % (uri + \"/activate/\" + key))\n+                rv.write(\"Activate comment: %s\\n\" % create_comment_action_url(uri, \"activate\", key))\n \n         else:\n             uri = self.public_endpoint + \"/id/%i\" % parent_comment[\"id\"]\n@@ -208,8 +212,9 @@ def _retry(self, subject, body, to, headers):\n \n class Stdout(object):\n \n-    def __init__(self, conf):\n-        pass\n+    def __init__(self, isso):\n+        self.isso = isso\n+        self.public_endpoint = isso.conf.get(\"server\", \"public-endpoint\") or local(\"host\")\n \n     def __iter__(self):\n \n@@ -224,6 +229,15 @@ def _new_thread(self, thread):\n \n     def _new_comment(self, thread, comment):\n         logger.info(\"comment created: %s\", json.dumps(comment))\n+        logger.info(\"Link to comment: %s\" % (local(\"origin\") + thread[\"uri\"] + \"#isso-%i\" % comment[\"id\"]))\n+\n+        uri = self.public_endpoint + \"/id/%i\" % comment[\"id\"]\n+        key = self.isso.sign(comment[\"id\"])\n+\n+        logger.info(\"Delete comment: %s\" % create_comment_action_url(uri, \"delete\", key))\n+\n+        if comment[\"mode\"] == 2:\n+            logger.info(\"Activate comment: %s\" % create_comment_action_url(uri, \"activate\", key))\n \n     def _edit_comment(self, comment):\n         logger.info('comment %i edited: %s',"
    }
  ]
}
