{
  "sha": "0627e04a673af213a2c00d78a7509b38f67d64ec",
  "node_id": "C_kwDOCQOkhNoAKDA2MjdlMDRhNjczYWYyMTNhMmMwMGQ3OGE3NTA5YjM4ZjY3ZDY0ZWM",
  "commit": {
    "author": {
      "name": "qwqcode",
      "email": "qwqcode@gmail.com",
      "date": "2024-11-23T14:31:09Z"
    },
    "committer": {
      "name": "qwqcode",
      "email": "qwqcode@gmail.com",
      "date": "2024-11-23T14:31:09Z"
    },
    "message": "chore(ci): tidy up frontend build shell scripts",
    "tree": {
      "sha": "9f2599caa3fcb9e667cb17633fa8b21c93642c85",
      "url": "https://api.github.com/repos/ArtalkJS/Artalk/git/trees/9f2599caa3fcb9e667cb17633fa8b21c93642c85"
    },
    "url": "https://api.github.com/repos/ArtalkJS/Artalk/git/commits/0627e04a673af213a2c00d78a7509b38f67d64ec",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\niHUEABYIAB0WIQS0Ev3sdPZbHkWwzmLUbg8O6nwTagUCZ0HnLQAKCRDUbg8O6nwT\nalg0AP44dpmJyIzbGO9dDmGKF+OuZE9xH2UV/ZiUBzBniA/u1QEAkigyvx84vPPQ\nAYaba/fMfcCJzttsTTDG3jglWUzi3Aw=\n=PJo1\n-----END PGP SIGNATURE-----",
      "payload": "tree 9f2599caa3fcb9e667cb17633fa8b21c93642c85\nparent ab2c2cf153f77f694f04abec4a143e261332a808\nauthor qwqcode <qwqcode@gmail.com> 1732372269 +0800\ncommitter qwqcode <qwqcode@gmail.com> 1732372269 +0800\n\nchore(ci): tidy up frontend build shell scripts\n",
      "verified_at": "2024-11-23T14:31:20Z"
    }
  },
  "url": "https://api.github.com/repos/ArtalkJS/Artalk/commits/0627e04a673af213a2c00d78a7509b38f67d64ec",
  "html_url": "https://github.com/ArtalkJS/Artalk/commit/0627e04a673af213a2c00d78a7509b38f67d64ec",
  "comments_url": "https://api.github.com/repos/ArtalkJS/Artalk/commits/0627e04a673af213a2c00d78a7509b38f67d64ec/comments",
  "author": {
    "login": "qwqcode",
    "id": 22412567,
    "node_id": "MDQ6VXNlcjIyNDEyNTY3",
    "avatar_url": "https://avatars.githubusercontent.com/u/22412567?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/qwqcode",
    "html_url": "https://github.com/qwqcode",
    "followers_url": "https://api.github.com/users/qwqcode/followers",
    "following_url": "https://api.github.com/users/qwqcode/following{/other_user}",
    "gists_url": "https://api.github.com/users/qwqcode/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/qwqcode/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/qwqcode/subscriptions",
    "organizations_url": "https://api.github.com/users/qwqcode/orgs",
    "repos_url": "https://api.github.com/users/qwqcode/repos",
    "events_url": "https://api.github.com/users/qwqcode/events{/privacy}",
    "received_events_url": "https://api.github.com/users/qwqcode/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "committer": {
    "login": "qwqcode",
    "id": 22412567,
    "node_id": "MDQ6VXNlcjIyNDEyNTY3",
    "avatar_url": "https://avatars.githubusercontent.com/u/22412567?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/qwqcode",
    "html_url": "https://github.com/qwqcode",
    "followers_url": "https://api.github.com/users/qwqcode/followers",
    "following_url": "https://api.github.com/users/qwqcode/following{/other_user}",
    "gists_url": "https://api.github.com/users/qwqcode/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/qwqcode/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/qwqcode/subscriptions",
    "organizations_url": "https://api.github.com/users/qwqcode/orgs",
    "repos_url": "https://api.github.com/users/qwqcode/repos",
    "events_url": "https://api.github.com/users/qwqcode/events{/privacy}",
    "received_events_url": "https://api.github.com/users/qwqcode/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "ab2c2cf153f77f694f04abec4a143e261332a808",
      "url": "https://api.github.com/repos/ArtalkJS/Artalk/commits/ab2c2cf153f77f694f04abec4a143e261332a808",
      "html_url": "https://github.com/ArtalkJS/Artalk/commit/ab2c2cf153f77f694f04abec4a143e261332a808"
    }
  ],
  "stats": {
    "total": 75,
    "additions": 36,
    "deletions": 39
  },
  "files": [
    {
      "sha": "add302cbfd90687679242af7acd1c91b14730994",
      "filename": ".github/workflows/build-nightly.yml",
      "status": "modified",
      "additions": 7,
      "deletions": 13,
      "changes": 20,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/0627e04a673af213a2c00d78a7509b38f67d64ec/.github%2Fworkflows%2Fbuild-nightly.yml",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/0627e04a673af213a2c00d78a7509b38f67d64ec/.github%2Fworkflows%2Fbuild-nightly.yml",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/.github%2Fworkflows%2Fbuild-nightly.yml?ref=0627e04a673af213a2c00d78a7509b38f67d64ec",
      "patch": "@@ -78,19 +78,12 @@ jobs:\n         run: pnpm install --frozen-lockfile\n \n       - name: Build UI\n+        id: build_ui\n         run: |\n           make build-frontend\n+          echo \"ui_tarball=$(make -s pack-frontend)\" >> $GITHUB_ENV\n \n-      - name: Pack UI\n-        id: pack\n-        run: |\n-          mkdir -p ./local/artalk_ui\n-          cp -r ./public/dist ./public/sidebar ./local/artalk_ui\n-\n-          mkdir -p ./local/nightly_includes\n-          tar -czf ./local/nightly_includes/artalk_ui_nightly.tar.gz -C ./local artalk_ui\n-\n-      - name: Upload UI\n+      - name: Upload UI dist\n         uses: actions/upload-artifact@v4\n         with:\n           name: ui-src\n@@ -100,11 +93,12 @@ jobs:\n           if-no-files-found: error\n           retention-days: 1\n \n-      - name: Upload UI package\n+      - name: Upload UI tarball (included in release)\n         uses: actions/upload-artifact@v4\n         with:\n-          name: build-ui-pkg\n-          path: local/nightly_includes/artalk_ui_nightly.tar.gz\n+          name: build-ui-tarball\n+          path: ${{ steps.build_ui.outputs.ui_tarball }}\n+          if-no-files-found: error\n           retention-days: 1\n \n   #"
    },
    {
      "sha": "6264c0aadc094404be8ea626370589b233422473",
      "filename": ".goreleaser.yml",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/0627e04a673af213a2c00d78a7509b38f67d64ec/.goreleaser.yml",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/0627e04a673af213a2c00d78a7509b38f67d64ec/.goreleaser.yml",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/.goreleaser.yml?ref=0627e04a673af213a2c00d78a7509b38f67d64ec",
      "patch": "@@ -17,6 +17,7 @@ before:\n     # install dependencies\n     - make install\n     - make build-frontend\n+    - make pack-frontend\n \n # build multi-platform\n builds:"
    },
    {
      "sha": "0130cf74245179a4c9d528b02d163cc9c7f89315",
      "filename": "Makefile",
      "status": "modified",
      "additions": 5,
      "deletions": 2,
      "changes": 7,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/0627e04a673af213a2c00d78a7509b38f67d64ec/Makefile",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/0627e04a673af213a2c00d78a7509b38f67d64ec/Makefile",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/Makefile?ref=0627e04a673af213a2c00d78a7509b38f67d64ec",
      "patch": "@@ -22,7 +22,10 @@ build:\n     \t$(PKG_NAME)\n \n build-frontend:\n-\t./scripts/build-frontend.sh\n+\t@./scripts/build-frontend.sh\n+\n+pack-frontend:\n+\t@./scripts/pack-frontend.sh\n \n build-debug:\n \t@echo \"Building Artalk for debugging...\"\n@@ -73,7 +76,7 @@ docker-build:\n docker-push:\n \t./scripts/docker-build.sh --push\n \n-.PHONY: all install run build build-frontend build-debug dev \\\n+.PHONY: all install run build build-frontend pack-frontend build-debug dev \\\n \ttest test-coverage test-coverage-html test-frontend-e2e \\\n \tupdate-i18n update-conf update-conf-docs \\\n \tupdate-docs-features update-swagger \\"
    },
    {
      "sha": "7277ce6151e59ab4b7e58bedef66f855c7d29d06",
      "filename": "scripts/build-frontend.sh",
      "status": "modified",
      "additions": 14,
      "deletions": 24,
      "changes": 38,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/0627e04a673af213a2c00d78a7509b38f67d64ec/scripts%2Fbuild-frontend.sh",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/0627e04a673af213a2c00d78a7509b38f67d64ec/scripts%2Fbuild-frontend.sh",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/scripts%2Fbuild-frontend.sh?ref=0627e04a673af213a2c00d78a7509b38f67d64ec",
      "patch": "@@ -2,7 +2,7 @@\n \n set -e\n \n-if ! command -v pnpm &> /dev/null\n+if ! command -v pnpm &>/dev/null && command -v apt-get &>/dev/null;\n then\n     apt-get update && apt-get install --no-install-recommends -y -q curl ca-certificates\n \n@@ -15,36 +15,26 @@ then\n     volta install pnpm@9.10.0\n fi\n \n+# build\n pnpm install --frozen-lockfile\n pnpm build:all\n+pnpm build:auth\n \n ## dist folders\n DIST_DIR=\"./public/dist\"\n+I18N_DIR=\"./public/dist/i18n\"\n SIDEBAR_DIR=\"./public/sidebar\"\n+PLUGIN_DIR=\"./public/dist/plugins\"\n \n-## dist\n+# clean\n rm -rf ${DIST_DIR} && mkdir -p ${DIST_DIR}\n-cp -r ./ui/artalk/dist/{Artalk.css,Artalk.js} ${DIST_DIR}\n-cp -r ./ui/artalk/dist/{ArtalkLite.css,ArtalkLite.js} ${DIST_DIR}\n-\n-I18N_DIR=\"${DIST_DIR}/i18n\"\n-mkdir -p ${I18N_DIR}\n-cp -r ./ui/artalk/dist/i18n/*.js ${I18N_DIR}\n-\n-## sidebar\n+rm -rf ${I18N_DIR} && mkdir -p ${I18N_DIR}\n rm -rf ${SIDEBAR_DIR} && mkdir -p ${SIDEBAR_DIR}\n-cp -r ./ui/artalk-sidebar/dist/* ${SIDEBAR_DIR}\n-\n-## plugins\n-PLUGIN_DIR=\"${DIST_DIR}/plugins\"\n-mkdir -p ${PLUGIN_DIR}\n+rm -rf ${PLUGIN_DIR} && mkdir -p ${PLUGIN_DIR}\n \n-pnpm build:auth\n-cp -r ./ui/plugin-auth/dist/artalk-plugin-auth.js ${PLUGIN_DIR}\n-\n-## create tarball for release\n-mkdir -p ./local/artalk_ui\n-cp -r ${DIST_DIR} ${SIDEBAR_DIR} ./local/artalk_ui\n-\n-mkdir -p ./local/release_includes\n-tar -czf ./local/release_includes/artalk_ui.tar.gz -C ./local artalk_ui\n+## copy\n+cp ./ui/artalk/dist/{Artalk.css,Artalk.js} ${DIST_DIR}\n+cp ./ui/artalk/dist/{ArtalkLite.css,ArtalkLite.js} ${DIST_DIR}\n+cp ./ui/artalk/dist/i18n/*.js ${I18N_DIR}\n+cp -r ./ui/artalk-sidebar/dist/* ${SIDEBAR_DIR}\n+cp ./ui/plugin-*/dist/*.js ${PLUGIN_DIR}"
    },
    {
      "sha": "741b57fceec46ded678e10069be1489dd075f402",
      "filename": "scripts/pack-frontend.sh",
      "status": "added",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/0627e04a673af213a2c00d78a7509b38f67d64ec/scripts%2Fpack-frontend.sh",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/0627e04a673af213a2c00d78a7509b38f67d64ec/scripts%2Fpack-frontend.sh",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/scripts%2Fpack-frontend.sh?ref=0627e04a673af213a2c00d78a7509b38f67d64ec",
      "patch": "@@ -0,0 +1,9 @@\n+#!/bin/bash\n+\n+rm -rf ./local/artalk_ui && mkdir -p ./local/artalk_ui\n+cp -r ./public/* ./local/artalk_ui\n+\n+mkdir -p ./local/release_includes\n+tar -czf ./local/release_includes/artalk_ui.tar.gz -C ./local artalk_ui\n+\n+echo $(realpath ./local/release_includes/artalk_ui.tar.gz)"
    }
  ]
}
