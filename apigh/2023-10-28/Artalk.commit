{
  "sha": "9fe765f87423843bd62df6d172d0cb9d4220e962",
  "node_id": "C_kwDOCQOkhNoAKDlmZTc2NWY4NzQyMzg0M2JkNjJkZjZkMTcyZDBjYjlkNDIyMGU5NjI",
  "commit": {
    "author": {
      "name": "qwqcode",
      "email": "qwqcode@gmail.com",
      "date": "2023-10-27T16:01:09Z"
    },
    "committer": {
      "name": "qwqcode",
      "email": "qwqcode@gmail.com",
      "date": "2023-10-27T16:02:17Z"
    },
    "message": "refactor(ui/api): loose coupling between `Api` and `Context`",
    "tree": {
      "sha": "20cfa1adfc8b9970ff4215f66ec1634c9780c7ac",
      "url": "https://api.github.com/repos/ArtalkJS/Artalk/git/trees/20cfa1adfc8b9970ff4215f66ec1634c9780c7ac"
    },
    "url": "https://api.github.com/repos/ArtalkJS/Artalk/git/commits/9fe765f87423843bd62df6d172d0cb9d4220e962",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\niHUEABYIAB0WIQS0Ev3sdPZbHkWwzmLUbg8O6nwTagUCZTvfDwAKCRDUbg8O6nwT\nap/XAQCQeq9W/lzHIX2ILvRKAeYCHmabLG/5/edCeV1M10ZORgEAl7oqDONjwP5d\nswpcCpfIx9pmRBbAgeALsW29cJ8QEw4=\n=4HF/\n-----END PGP SIGNATURE-----",
      "payload": "tree 20cfa1adfc8b9970ff4215f66ec1634c9780c7ac\nparent 72317ead342ca768b12870078b19394ee0048bbf\nauthor qwqcode <qwqcode@gmail.com> 1698422469 +0800\ncommitter qwqcode <qwqcode@gmail.com> 1698422537 +0800\n\nrefactor(ui/api): loose coupling between `Api` and `Context`\n"
    }
  },
  "url": "https://api.github.com/repos/ArtalkJS/Artalk/commits/9fe765f87423843bd62df6d172d0cb9d4220e962",
  "html_url": "https://github.com/ArtalkJS/Artalk/commit/9fe765f87423843bd62df6d172d0cb9d4220e962",
  "comments_url": "https://api.github.com/repos/ArtalkJS/Artalk/commits/9fe765f87423843bd62df6d172d0cb9d4220e962/comments",
  "author": {
    "login": "qwqcode",
    "id": 22412567,
    "node_id": "MDQ6VXNlcjIyNDEyNTY3",
    "avatar_url": "https://avatars.githubusercontent.com/u/22412567?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/qwqcode",
    "html_url": "https://github.com/qwqcode",
    "followers_url": "https://api.github.com/users/qwqcode/followers",
    "following_url": "https://api.github.com/users/qwqcode/following{/other_user}",
    "gists_url": "https://api.github.com/users/qwqcode/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/qwqcode/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/qwqcode/subscriptions",
    "organizations_url": "https://api.github.com/users/qwqcode/orgs",
    "repos_url": "https://api.github.com/users/qwqcode/repos",
    "events_url": "https://api.github.com/users/qwqcode/events{/privacy}",
    "received_events_url": "https://api.github.com/users/qwqcode/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "qwqcode",
    "id": 22412567,
    "node_id": "MDQ6VXNlcjIyNDEyNTY3",
    "avatar_url": "https://avatars.githubusercontent.com/u/22412567?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/qwqcode",
    "html_url": "https://github.com/qwqcode",
    "followers_url": "https://api.github.com/users/qwqcode/followers",
    "following_url": "https://api.github.com/users/qwqcode/following{/other_user}",
    "gists_url": "https://api.github.com/users/qwqcode/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/qwqcode/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/qwqcode/subscriptions",
    "organizations_url": "https://api.github.com/users/qwqcode/orgs",
    "repos_url": "https://api.github.com/users/qwqcode/repos",
    "events_url": "https://api.github.com/users/qwqcode/events{/privacy}",
    "received_events_url": "https://api.github.com/users/qwqcode/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "72317ead342ca768b12870078b19394ee0048bbf",
      "url": "https://api.github.com/repos/ArtalkJS/Artalk/commits/72317ead342ca768b12870078b19394ee0048bbf",
      "html_url": "https://github.com/ArtalkJS/Artalk/commit/72317ead342ca768b12870078b19394ee0048bbf"
    }
  ],
  "stats": {
    "total": 219,
    "additions": 128,
    "deletions": 91
  },
  "files": [
    {
      "sha": "a3ab4e167e97e04b6e513c278939e37aac8c0bf1",
      "filename": "ui/packages/artalk/src/api/_base.ts",
      "status": "added",
      "additions": 18,
      "deletions": 0,
      "changes": 18,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2F_base.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2F_base.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2F_base.ts?ref=9fe765f87423843bd62df6d172d0cb9d4220e962",
      "patch": "@@ -0,0 +1,18 @@\n+import { ApiOptions } from './_options'\n+import { POST, Fetch } from './_request'\n+\n+abstract class ApiBase {\n+  constructor(\n+    protected options: ApiOptions\n+  ) {}\n+\n+  protected async POST<T>(path: string, data?: {[key: string]: any}) {\n+    return POST<T>(this.options, this.options.baseURL+path, data)\n+  }\n+\n+  protected async Fetch(path: string, init: RequestInit, timeout?: number): Promise<any> {\n+    return Fetch(this.options, this.options.baseURL+path, init, timeout)\n+  }\n+}\n+\n+export default ApiBase"
    },
    {
      "sha": "db521cb78df55289c3310bb655acbf129106ecf0",
      "filename": "ui/packages/artalk/src/api/_options.ts",
      "status": "added",
      "additions": 25,
      "deletions": 0,
      "changes": 25,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2F_options.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2F_options.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2F_options.ts?ref=9fe765f87423843bd62df6d172d0cb9d4220e962",
      "patch": "@@ -0,0 +1,25 @@\n+export interface ApiOptions {\n+  baseURL: string\n+  siteName: string\n+  pageKey: string\n+  pageTitle: string\n+  timeout?: number\n+\n+  // -------------------------------------------------------------------\n+  //  Hooks\n+  // -------------------------------------------------------------------\n+\n+  onNeedCheckCaptcha?: (payload: {\n+    recall: () => void\n+    reject: () => void\n+    data: {\n+      imgData: string\n+      iframe: string\n+    }\n+  }) => void\n+\n+  onNeedCheckAdmin?: (payload: {\n+    recall: () => void\n+    reject: () => void\n+  }) => void\n+}"
    },
    {
      "sha": "8bc2b8c71767d8250c3f546a02487c236d48f3c1",
      "filename": "ui/packages/artalk/src/api/_request.ts",
      "status": "renamed",
      "additions": 19,
      "deletions": 18,
      "changes": 37,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2F_request.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2F_request.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2F_request.ts?ref=9fe765f87423843bd62df6d172d0cb9d4220e962",
      "patch": "@@ -1,9 +1,11 @@\n-import type { ContextApi } from '~/types'\n+import 'abortcontroller-polyfill/dist/polyfill-patch-fetch'\n+\n+import { ApiOptions } from './_options'\n import User from '../lib/user'\n import $t from '../i18n'\n \n /** 公共请求函数 */\n-export async function Fetch(ctx: ContextApi, input: RequestInfo, init: RequestInit, timeout?: number): Promise<any> {\n+export async function Fetch(opts: ApiOptions, input: RequestInfo, init: RequestInit, timeout?: number): Promise<any> {\n   // JWT\n   if (User.data.token) {\n     const headers = new Headers(init.headers) // 保留原有 headers\n@@ -15,7 +17,7 @@ export async function Fetch(ctx: ContextApi, input: RequestInfo, init: RequestIn\n   // init.credentials = 'include'\n \n   // 请求操作\n-  const resp = await timeoutFetch(ctx, input, timeout || ctx.conf.reqTimeout || 15000, init)\n+  const resp = await timeoutFetch(input, timeout || opts.timeout || 15000, init)\n \n   const respHttpCode = resp.status\n   const noAccessCodes = [401, 400]\n@@ -29,7 +31,7 @@ export async function Fetch(ctx: ContextApi, input: RequestInfo, init: RequestIn\n \n   // 重新发起请求\n   const recall = (resolve, reject) => {\n-    Fetch(ctx, input, init)\n+    Fetch(opts, input, init)\n       .then(d => { resolve(d) })\n       .catch(e => { reject(e) })\n   }\n@@ -38,19 +40,18 @@ export async function Fetch(ctx: ContextApi, input: RequestInfo, init: RequestIn\n   if (json.data?.need_captcha) {\n     // 请求需要验证码\n     json = await (new Promise<any>((resolve, reject) => {\n-      ctx.checkCaptcha({\n-        imgData: json.data.img_data,\n-        iframe: json.data.iframe,\n-        onSuccess: () => { recall(resolve, reject) },\n-        onCancel: () => { reject(json) }\n+      opts.onNeedCheckCaptcha && opts.onNeedCheckCaptcha({\n+        data: { imgData: json.data.img_data, iframe: json.data.iframe },\n+        recall: () => { recall(resolve, reject) },\n+        reject: () => { reject(json) }\n       })\n     }))\n   } else if (json.data?.need_login || isNoAccess) {\n     // 请求需要管理员权限\n     json = await (new Promise<any>((resolve, reject) => {\n-      ctx.checkAdmin({\n-        onSuccess: () => { recall(resolve, reject) },\n-        onCancel: () => { reject(json) }\n+      opts.onNeedCheckAdmin && opts.onNeedCheckAdmin({\n+        recall: () => { recall(resolve, reject) },\n+        reject: () => { reject(json) }\n       })\n     }))\n   }\n@@ -61,20 +62,20 @@ export async function Fetch(ctx: ContextApi, input: RequestInfo, init: RequestIn\n }\n \n /** 公共 POST 请求 */\n-export async function POST<T>(ctx: ContextApi, url: string, data?: {[key: string]: any}) {\n+export async function POST<T>(opts: ApiOptions, url: string, data?: {[key: string]: any}) {\n   const init: RequestInit = {\n     method: 'POST',\n   }\n-  data = { site_name: ctx.conf.site || '', ...(data || {}) } // 总是携带 site_name\n+  data = { site_name: opts.siteName || '', ...(data || {}) } // 总是携带 site_name\n   init.body = ToFormData(data)\n \n-  const json = await Fetch(ctx, url, init)\n+  const json = await Fetch(opts, url, init)\n   return ((json.data || {}) as T)\n }\n \n /** 公共 GET 请求 (无 GET 方式 API) */\n-// export async function GET<T>(ctx: Context, url: string, data?: {[key: string]: any}) {\n-//   const json = await Fetch(ctx, url + (data ? (`?${new URLSearchParams(data)}`) : ''), {\n+// export async function GET<T>(opts: ApiOptions, url: string, data?: {[key: string]: any}) {\n+//   const json = await Fetch(opts, url + (data ? (`?${new URLSearchParams(data)}`) : ''), {\n //     method: 'GET',\n //   })\n //   return ((json.data || {}) as T)\n@@ -88,7 +89,7 @@ export function ToFormData(object: {[key: string]: any}): FormData {\n }\n \n /** 我靠，fetch 一个 timeout，都要丑陋的实现 */\n-function timeoutFetch(ctx: ContextApi, url: RequestInfo, ms: number, opts: RequestInit) {\n+function timeoutFetch(url: RequestInfo, ms: number, opts: RequestInit) {\n   const controller = new AbortController()\n   opts.signal?.addEventListener('abort', () => controller.abort()) // 保留原有 signal 功能\n   let promise = fetch(url, { ...opts, signal: controller.signal })",
      "previous_filename": "ui/packages/artalk/src/api/request.ts"
    },
    {
      "sha": "f6bc68c24a65f44c4bd54be3e42daa17b03e747e",
      "filename": "ui/packages/artalk/src/api/admin.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fadmin.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fadmin.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fadmin.ts?ref=9fe765f87423843bd62df6d172d0cb9d4220e962",
      "patch": "@@ -1,4 +1,4 @@\n-import ApiBase from './api-base'\n+import ApiBase from './_base'\n \n /**\n  * 管理员 API"
    },
    {
      "sha": "475a652c5c74f5fdb85ce5ecff6c9e0f3c78dbb2",
      "filename": "ui/packages/artalk/src/api/api-base.ts",
      "status": "removed",
      "additions": 0,
      "deletions": 27,
      "changes": 27,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/72317ead342ca768b12870078b19394ee0048bbf/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fapi-base.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/72317ead342ca768b12870078b19394ee0048bbf/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fapi-base.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fapi-base.ts?ref=72317ead342ca768b12870078b19394ee0048bbf",
      "patch": "@@ -1,27 +0,0 @@\n-import type { ContextApi } from '~/types'\n-import Api from '.'\n-import { POST, Fetch } from './request'\n-\n-abstract class ApiBase {\n-  protected api: Api\n-  protected ctx: ContextApi\n-\n-  constructor(api: Api, ctx: ContextApi) {\n-    this.api = api\n-    this.ctx = ctx\n-  }\n-\n-  protected async POST<T>(path: string, data?: {[key: string]: any}) {\n-    return POST<T>(this.ctx, this.api.baseURL+path, data)\n-  }\n-\n-  protected async Fetch(path: string, init: RequestInit, timeout?: number): Promise<any> {\n-    return Fetch(this.ctx, this.api.baseURL+path, init, timeout)\n-  }\n-}\n-\n-interface ApiBase {\n-\n-}\n-\n-export default ApiBase"
    },
    {
      "sha": "c3446eb0d346dd4e0bdee06bffceff9e491571b0",
      "filename": "ui/packages/artalk/src/api/captcha.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fcaptcha.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fcaptcha.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fcaptcha.ts?ref=9fe765f87423843bd62df6d172d0cb9d4220e962",
      "patch": "@@ -1,4 +1,4 @@\n-import ApiBase from './api-base'\n+import ApiBase from './_base'\n \n /**\n  * 验证码 API"
    },
    {
      "sha": "e1dd70fc2e232f7233c0d80a59e1525833964fd4",
      "filename": "ui/packages/artalk/src/api/comment.ts",
      "status": "modified",
      "additions": 3,
      "deletions": 3,
      "changes": 6,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fcomment.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fcomment.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fcomment.ts?ref=9fe765f87423843bd62df6d172d0cb9d4220e962",
      "patch": "@@ -1,6 +1,6 @@\n import type { CommentData, ListData } from '~/types'\n import * as Utils from '../lib/utils'\n-import ApiBase from './api-base'\n+import ApiBase from './_base'\n import User from '../lib/user'\n \n /**\n@@ -10,8 +10,8 @@ export default class CommentApi extends ApiBase {\n   /** 评论 · 获取 */\n   public get(offset: number, pageSize: number, flatMode?: boolean, paramsEditor?: (params: any) => void) {\n     const params: any = {\n-      page_key: this.ctx.conf.pageKey,\n-      site_name: this.ctx.conf.site || '',\n+      page_key: this.options.pageKey,\n+      site_name: this.options.siteName,\n       limit: pageSize,\n       offset,\n     }"
    },
    {
      "sha": "56a36f75eb0b70277be772c57224f809ec8f1573",
      "filename": "ui/packages/artalk/src/api/index.ts",
      "status": "modified",
      "additions": 3,
      "deletions": 12,
      "changes": 15,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Findex.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Findex.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Findex.ts?ref=9fe765f87423843bd62df6d172d0cb9d4220e962",
      "patch": "@@ -1,6 +1,4 @@\n-import type { ContextApi } from '~/types'\n-import 'abortcontroller-polyfill/dist/polyfill-patch-fetch'\n-\n+import { ApiOptions } from './_options'\n import comment from './comment'\n import page from './page'\n import site from './site'\n@@ -17,16 +15,9 @@ const ApiComponents = {\n }\n \n class Api {\n-  protected ctx: ContextApi\n-  public get baseURL() {\n-    return `${this.ctx.conf.server}/api`\n-  }\n-\n-  constructor (ctx: ContextApi) {\n-    this.ctx = ctx\n-\n+  constructor (opts: ApiOptions) {\n     Object.entries(ApiComponents).forEach(([key, ApiComponent]) => {\n-      this[key] = new ApiComponent(this, this.ctx)\n+      this[key] = new ApiComponent(opts)\n     })\n   }\n }"
    },
    {
      "sha": "d0c4ef9e135d1439f7ca343fca8ce96366b0d8ad",
      "filename": "ui/packages/artalk/src/api/page.ts",
      "status": "modified",
      "additions": 4,
      "deletions": 4,
      "changes": 8,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fpage.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fpage.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fpage.ts?ref=9fe765f87423843bd62df6d172d0cb9d4220e962",
      "patch": "@@ -1,5 +1,5 @@\n import type { PageData, CommentData } from '~/types'\n-import ApiBase from './api-base'\n+import ApiBase from './_base'\n \n /**\n  * 页面 API\n@@ -24,7 +24,7 @@ export default class PageApi extends ApiBase {\n       key: data.key,\n       title: data.title,\n       admin_only: data.admin_only,\n-      site_name: data.site_name || this.ctx.conf.site,\n+      site_name: data.site_name || this.options.siteName,\n     }\n \n     const d = await this.POST<any>('/admin/page-edit', params)\n@@ -55,8 +55,8 @@ export default class PageApi extends ApiBase {\n   /** PV */\n   public async pv() {\n     const params: any = {\n-      page_key: this.ctx.conf.pageKey || '',\n-      page_title: this.ctx.conf.pageTitle || ''\n+      page_key: this.options.pageKey || '',\n+      page_title: this.options.pageTitle || ''\n     }\n \n     const p = await this.POST<any>('/pv', params)"
    },
    {
      "sha": "21b94c008401a33ada7cfeddd314a5a6dd4f9466",
      "filename": "ui/packages/artalk/src/api/site.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fsite.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fsite.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fsite.ts?ref=9fe765f87423843bd62df6d172d0cb9d4220e962",
      "patch": "@@ -1,5 +1,5 @@\n import type { SiteData } from '~/types'\n-import ApiBase from './api-base'\n+import ApiBase from './_base'\n \n /**\n  * 站点 API"
    },
    {
      "sha": "9e00cfca908ebb1f52a635b1f0efa614549f9629",
      "filename": "ui/packages/artalk/src/api/system.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fsystem.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fsystem.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fsystem.ts?ref=9fe765f87423843bd62df6d172d0cb9d4220e962",
      "patch": "@@ -1,5 +1,5 @@\n import type { ArtalkConfig } from '~/types'\n-import ApiBase from './api-base'\n+import ApiBase from './_base'\n \n interface ApiVersionInfo {\n   app: string\n@@ -42,7 +42,7 @@ export default class SystemApi extends ApiBase {\n \n   /** 获取 API 版本信息 */\n   public async version() {\n-    const resp = await fetch(`${this.api.baseURL}/version`, { method: 'POST' })\n+    const resp = await fetch(`${this.options.baseURL}/version`, { method: 'POST' })\n     const data = await resp.json()\n     return data as { app: string, version: string, commit_hash: string, fe_min_version: string }\n   }"
    },
    {
      "sha": "9ac812a3d99249ad89b538eff5085a7f676fdc6b",
      "filename": "ui/packages/artalk/src/api/upload.ts",
      "status": "modified",
      "additions": 3,
      "deletions": 3,
      "changes": 6,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fupload.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fupload.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fupload.ts?ref=9fe765f87423843bd62df6d172d0cb9d4220e962",
      "patch": "@@ -1,5 +1,5 @@\n-import { ToFormData } from './request'\n-import ApiBase from './api-base'\n+import { ToFormData } from './_request'\n+import ApiBase from './_base'\n import User from '../lib/user'\n \n /**\n@@ -11,7 +11,7 @@ export default class UploadApi extends ApiBase {\n     const params: any = {\n       name: User.data.nick,\n       email: User.data.email,\n-      page_key: this.ctx.conf.pageKey,\n+      page_key: this.options.pageKey,\n     }\n \n     const form = ToFormData(params)"
    },
    {
      "sha": "58b4efad07009e779d5269de7e6005867f31e374",
      "filename": "ui/packages/artalk/src/api/user.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fuser.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fuser.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Fsrc%2Fapi%2Fuser.ts?ref=9fe765f87423843bd62df6d172d0cb9d4220e962",
      "patch": "@@ -1,6 +1,6 @@\n import type { UserData, NotifyData, UserDataForAdmin } from '~/types'\n-import ApiBase from './api-base'\n-import { ToFormData } from './request'\n+import ApiBase from './_base'\n+import { ToFormData } from './_request'\n import User from '../lib/user'\n \n /**"
    },
    {
      "sha": "5b257c7dafb7ea2a7ab7dfa2cefb74e46122895a",
      "filename": "ui/packages/artalk/src/artalk.ts",
      "status": "modified",
      "additions": 6,
      "deletions": 9,
      "changes": 15,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fartalk.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fartalk.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Fsrc%2Fartalk.ts?ref=9fe765f87423843bd62df6d172d0cb9d4220e962",
      "patch": "@@ -4,7 +4,7 @@ import type { ArtalkConfig, EventPayloadMap, ArtalkPlugin, ContextApi } from '~/\n import type { EventHandler } from './lib/event-manager'\n import ConcreteContext from './context'\n import defaults from './defaults'\n-import { handelBaseConf } from './config'\n+import { convertApiOptions, handelBaseConf } from './config'\n import Services from './service'\n import { DefaultPlugins } from './plugins'\n import * as Stat from './plugins/stat'\n@@ -38,8 +38,6 @@ export default class Artalk {\n     // 初始化 Context\n     this.ctx = new ConcreteContext(this.conf, this.$root)\n \n-    this.ctx.getApi()\n-\n     // 内建服务初始化\n     Object.entries(Services).forEach(([name, initService]) => {\n       if (Artalk.DisabledComponents.includes(name)) return\n@@ -156,14 +154,13 @@ export default class Artalk {\n \n   /** Load count widget */\n   public static loadCountWidget(conf: Partial<ArtalkConfig>) {\n+    // TODO remove creating context (not necessary)\n     const ctx: ContextApi = new ConcreteContext(handelBaseConf(conf))\n-    ctx.inject('api', new Api(ctx))\n+    ctx.inject('api', createApi(ctx))\n     Stat.initCountWidget({ ctx, pvAdd: false })\n   }\n+}\n \n-  /** @deprecated Please use `loadCountWidget` instead */\n-  public static LoadCountWidget(conf: Partial<ArtalkConfig>) {\n-    console.warn('The method `LoadCountWidget` is deprecated, please use `loadCountWidget` instead.')\n-    this.loadCountWidget(conf)\n-  }\n+export function createApi(ctx: ContextApi) {\n+  return new Api(convertApiOptions(ctx, ctx.conf))\n }"
    },
    {
      "sha": "8214d598252a122d67fbd9b867fdd1e1d0391575",
      "filename": "ui/packages/artalk/src/config.ts",
      "status": "modified",
      "additions": 29,
      "deletions": 1,
      "changes": 30,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fconfig.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fconfig.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Fsrc%2Fconfig.ts?ref=9fe765f87423843bd62df6d172d0cb9d4220e962",
      "patch": "@@ -1,4 +1,6 @@\n-import type { ArtalkConfig } from '~/types'\n+import type { ArtalkConfig, ContextApi } from '~/types'\n+import type { ApiOptions } from './api/_options'\n+import Api from './api'\n import * as Utils from './lib/utils'\n import Defaults from './defaults'\n \n@@ -71,3 +73,29 @@ export function handleBackendRefConf(conf: Partial<ArtalkConfig>) {\n \n   return conf\n }\n+\n+export function convertApiOptions(ctx: ContextApi, conf: Partial<ArtalkConfig>): ApiOptions {\n+  return {\n+    baseURL: `${conf.server}/api`,\n+    siteName: conf.site || '',\n+    pageKey: conf.pageKey || '',\n+    pageTitle: conf.pageTitle || '',\n+    timeout: conf.reqTimeout,\n+\n+    onNeedCheckAdmin(payload) {\n+      ctx.checkAdmin({\n+        onSuccess: () => { payload.recall() },\n+        onCancel: () => { payload.reject() },\n+      })\n+    },\n+\n+    onNeedCheckCaptcha(payload) {\n+      ctx.checkCaptcha({\n+        imgData: payload.data.imgData,\n+        iframe: payload.data.iframe,\n+        onSuccess: () => { payload.recall() },\n+        onCancel: () => { payload.reject() },\n+      })\n+    },\n+  }\n+}"
    },
    {
      "sha": "178495686a5dac15113b25b5062efc8a46704ca6",
      "filename": "ui/packages/artalk/src/lib/ui.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 1,
      "changes": 3,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Flib%2Fui.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Flib%2Fui.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Fsrc%2Flib%2Fui.ts?ref=9fe765f87423843bd62df6d172d0cb9d4220e962",
      "patch": "@@ -1,3 +1,4 @@\n+import type { NotifyLevel } from '~/types'\n import * as Utils from './utils'\n \n /** 显示加载 */\n@@ -75,7 +76,7 @@ export function scrollIntoView(elem: HTMLElement, enableAnim: boolean = true) {\n export function showNotify(\n   wrapElem: HTMLElement,\n   msg: string,\n-  type: 's' | 'e' | 'w' | 'i',\n+  type: NotifyLevel,\n ) {\n   const colors = { s: '#57d59f', e: '#ff6f6c', w: '#ffc721', i: '#2ebcfc' }\n   const timeout = 3000 // 持续显示时间 ms"
    },
    {
      "sha": "52de78be21d2b00038bb2d592dd9de4c39969df5",
      "filename": "ui/packages/artalk/src/plugins/stat.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fplugins%2Fstat.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fplugins%2Fstat.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Fsrc%2Fplugins%2Fstat.ts?ref=9fe765f87423843bd62df6d172d0cb9d4220e962",
      "patch": "@@ -7,6 +7,7 @@ export interface CountConf {\n   pvAdd?: boolean\n }\n \n+// TODO losing the coupling between `PvCountWidget` and `ContextApi`, only keep the `api` and `conf` (only needed in `PvCountWidget`)\n export const PvCountWidget: ArtalkPlugin = (ctx: ContextApi) => {\n   ctx.on('conf-loaded', () => {\n     initCountWidget({ ctx, pvAdd: true })"
    },
    {
      "sha": "7572e93c91faa6f970a76a1f71f8da8be44df0d6",
      "filename": "ui/packages/artalk/src/service.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fservice.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Fsrc%2Fservice.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Fsrc%2Fservice.ts?ref=9fe765f87423843bd62df6d172d0cb9d4220e962",
      "patch": "@@ -9,6 +9,7 @@ import List from './list/list'\n import * as DarkMode from './lib/dark-mode'\n import * as I18n from './i18n'\n import { PlugManager } from './plugins/editor-kit'\n+import { createApi } from './artalk'\n \n /**\n  * Services\n@@ -33,8 +34,7 @@ const services = {\n \n   // HTTP API client\n   api(ctx: ContextApi) {\n-    const api = new Api(ctx)\n-    return api\n+    return createApi(ctx)\n   },\n \n   // CheckerLauncher"
    },
    {
      "sha": "f5d1edfaf521ca41873e0476b37db13ebdb7a9cb",
      "filename": "ui/packages/artalk/types/context.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Ftypes%2Fcontext.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Ftypes%2Fcontext.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Ftypes%2Fcontext.ts?ref=9fe765f87423843bd62df6d172d0cb9d4220e962",
      "patch": "@@ -1,4 +1,4 @@\n-import type { SidebarShowPayload, EventPayloadMap, ArtalkConfig, CommentData, DataManagerApi, ListFetchParams } from '.'\n+import type { SidebarShowPayload, EventPayloadMap, ArtalkConfig, CommentData, DataManagerApi, ListFetchParams, NotifyLevel } from '.'\n import type { EventManagerFuncs } from '../src/lib/event-manager'\n import type { I18n } from '../src/i18n'\n import type Api from '../src/api'\n@@ -62,7 +62,7 @@ export interface ContextApi extends EventManagerFuncs<EventPayloadMap> {\n   editorHideLoading(): void\n \n   /** 编辑器 - 显示提示消息 */\n-  editorShowNotify(msg: string, type: \"i\" | \"s\" | \"w\" | \"e\"): void\n+  editorShowNotify(msg: string, type: NotifyLevel): void\n \n   /** 评论框 - 复原状态 */\n   editorResetState(): void"
    },
    {
      "sha": "f141dddbf4fa04488e9ca5c0440aa56c2b73c6db",
      "filename": "ui/packages/artalk/types/data.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Ftypes%2Fdata.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Ftypes%2Fdata.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Ftypes%2Fdata.ts?ref=9fe765f87423843bd62df6d172d0cb9d4220e962",
      "patch": "@@ -266,3 +266,5 @@ export interface DataManagerApi {\n   getPage(): PageData|undefined\n   updatePage(pageData: PageData): void\n }\n+\n+export type NotifyLevel = \"i\" | \"s\" | \"w\" | \"e\""
    },
    {
      "sha": "8e49c8069a22827154d5e636bc731f43ba9ef630",
      "filename": "ui/packages/artalk/types/editor.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Ftypes%2Feditor.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/9fe765f87423843bd62df6d172d0cb9d4220e962/ui%2Fpackages%2Fartalk%2Ftypes%2Feditor.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fpackages%2Fartalk%2Ftypes%2Feditor.ts?ref=9fe765f87423843bd62df6d172d0cb9d4220e962",
      "patch": "@@ -1,4 +1,4 @@\n-import type { CommentData } from './data'\n+import type { CommentData, NotifyLevel } from '.'\n import Component from '../src/lib/component'\n import { EditorUI } from '../src/editor/ui'\n \n@@ -69,7 +69,7 @@ export interface EditorApi extends Component {\n   /**\n    * Show notification message\n    */\n-  showNotify(msg: string, type: \"i\" | \"s\" | \"w\" | \"e\"): void\n+  showNotify(msg: string, type: NotifyLevel): void\n \n   /**\n    * Show loading on editor"
    }
  ]
}
