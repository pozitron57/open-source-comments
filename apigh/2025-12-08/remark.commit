{
  "sha": "4aa8362de1bdf280f8e42f6c71e5df2196bc236c",
  "node_id": "C_kwDOBtgov9oAKDRhYTgzNjJkZTFiZGYyODBmOGU0MmY2YzcxZTVkZjIxOTZiYzIzNmM",
  "commit": {
    "author": {
      "name": "Umputun",
      "email": "umputun@gmail.com",
      "date": "2025-12-07T22:01:57Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2025-12-07T22:01:57Z"
    },
    "message": "Merge pull request #1976 from umputun/ci-native-arm64-runners\n\nMigrate Docker builds to native GitHub ARM64 runners",
    "tree": {
      "sha": "fd216e9178f0dea58a5a702d4abe707023f0159d",
      "url": "https://api.github.com/repos/umputun/remark42/git/trees/fd216e9178f0dea58a5a702d4abe707023f0159d"
    },
    "url": "https://api.github.com/repos/umputun/remark42/git/commits/4aa8362de1bdf280f8e42f6c71e5df2196bc236c",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsFcBAABCAAQBQJpNflVCRC1aQ7uu5UhlAAAclIQAIIY7J82LrmO8SuPnN3sMQOe\nZwk1m8OpT7k0qmwgo/wqOFix0VS9zPWjgK+/uQ8NnJFE3j3ZTVhLxKIYOd39xk0m\nD3/aHm+OipPkP02hfmM9yiWI8WbypRxebANCmRzFzxUA/Qlj27Mv9/tfxsGTV2ef\n4osxKDhJdH2ghe0u7uvOAIZe5wFTLUPbdli+8D3FCR00/QLxT/FSSwP7sjkaht80\n7KyG7h98qqoE7rO1MvYe12ZMD4Vw1gQarFn+VtJsWYASwjqhvd/phNAezOLXkBaX\n73YUdNDQsqOjwn43GzwP9FIWQaOr+defrFvEQBpX/QfDxdI3qvgvX0bYAMKItxQf\nB906o33Y/CXaQN+FD7M/iFDb45WN+2YDMJAnYZTGBiHT4sq1gUtN+2ZMnuSplYt5\nnh7SBscmNCsT6LnnQHIkN0PEXaKViX6ThFWoEQv06z3VJTsE/b58UxoWiNzdtv3V\n4IIhnNBtLmSH42HdvAnLdYwpKfh22PCbnlpd6iFJu0KL2aC8VQoSUb4Z6Azf2Mc4\nAi/DOxOrcnOSV1UEw7edYXFuHUFPkFQ1vXVID1vtaxjJSjHt/YMkst1tlYRgXXnz\nmG78D19qT5fVsbua+rd1+LR8BiAOP9eatI7u6qQMqXu0jsuM1JsJ1hwJEA02Dqzu\n0ZuRGooIiGU2gjcSdXga\n=g4EI\n-----END PGP SIGNATURE-----\n",
      "payload": "tree fd216e9178f0dea58a5a702d4abe707023f0159d\nparent bc612ddf8192057e587f3880a64a70bf513ac628\nparent dc168f69bfb140b13a61b8262b3f12da8e575456\nauthor Umputun <umputun@gmail.com> 1765144917 -0600\ncommitter GitHub <noreply@github.com> 1765144917 -0600\n\nMerge pull request #1976 from umputun/ci-native-arm64-runners\n\nMigrate Docker builds to native GitHub ARM64 runners",
      "verified_at": "2025-12-07T22:01:57Z"
    }
  },
  "url": "https://api.github.com/repos/umputun/remark42/commits/4aa8362de1bdf280f8e42f6c71e5df2196bc236c",
  "html_url": "https://github.com/umputun/remark42/commit/4aa8362de1bdf280f8e42f6c71e5df2196bc236c",
  "comments_url": "https://api.github.com/repos/umputun/remark42/commits/4aa8362de1bdf280f8e42f6c71e5df2196bc236c/comments",
  "author": {
    "login": "umputun",
    "id": 535880,
    "node_id": "MDQ6VXNlcjUzNTg4MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/535880?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/umputun",
    "html_url": "https://github.com/umputun",
    "followers_url": "https://api.github.com/users/umputun/followers",
    "following_url": "https://api.github.com/users/umputun/following{/other_user}",
    "gists_url": "https://api.github.com/users/umputun/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/umputun/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/umputun/subscriptions",
    "organizations_url": "https://api.github.com/users/umputun/orgs",
    "repos_url": "https://api.github.com/users/umputun/repos",
    "events_url": "https://api.github.com/users/umputun/events{/privacy}",
    "received_events_url": "https://api.github.com/users/umputun/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "bc612ddf8192057e587f3880a64a70bf513ac628",
      "url": "https://api.github.com/repos/umputun/remark42/commits/bc612ddf8192057e587f3880a64a70bf513ac628",
      "html_url": "https://github.com/umputun/remark42/commit/bc612ddf8192057e587f3880a64a70bf513ac628"
    },
    {
      "sha": "dc168f69bfb140b13a61b8262b3f12da8e575456",
      "url": "https://api.github.com/repos/umputun/remark42/commits/dc168f69bfb140b13a61b8262b3f12da8e575456",
      "html_url": "https://github.com/umputun/remark42/commit/dc168f69bfb140b13a61b8262b3f12da8e575456"
    }
  ],
  "stats": {
    "total": 238,
    "additions": 188,
    "deletions": 50
  },
  "files": [
    {
      "sha": "b6e31604636f325329a8a00dbff15451c95a15e7",
      "filename": ".github/workflows/ci-build.yml",
      "status": "modified",
      "additions": 188,
      "deletions": 50,
      "changes": 238,
      "blob_url": "https://github.com/umputun/remark42/blob/4aa8362de1bdf280f8e42f6c71e5df2196bc236c/.github%2Fworkflows%2Fci-build.yml",
      "raw_url": "https://github.com/umputun/remark42/raw/4aa8362de1bdf280f8e42f6c71e5df2196bc236c/.github%2Fworkflows%2Fci-build.yml",
      "contents_url": "https://api.github.com/repos/umputun/remark42/contents/.github%2Fworkflows%2Fci-build.yml?ref=4aa8362de1bdf280f8e42f6c71e5df2196bc236c",
      "patch": "@@ -24,82 +24,220 @@ on:\n       - \"!**.md\"\n \n jobs:\n-  build-images:\n-    name: Build Docker images\n-    runs-on: ubuntu-latest\n-\n+  # Build without pushing for PRs and non-master branches\n+  build-test:\n+    name: Build test (non-master)\n+    if: ${{ github.ref != 'refs/heads/master' && !startsWith(github.ref, 'refs/tags/') }}\n+    runs-on: ubuntu-24.04-arm\n     steps:\n       - uses: actions/checkout@v5\n \n-      - name: set up QEMU\n-        uses: docker/setup-qemu-action@v3\n-\n       - name: set up Docker Buildx\n-        id: buildx\n         uses: docker/setup-buildx-action@v3\n \n-      - name: available platforms\n-        run: echo ${{ steps.buildx.outputs.platforms }}\n-\n       - name: free disk space\n         run: |\n           sudo rm -rf /usr/share/dotnet\n           sudo rm -rf /opt/ghc\n           sudo rm -rf /usr/local/share/boost\n           docker system prune -af\n \n-      - name: build docker image without pushing (only outside master)\n-        if: ${{ github.ref != 'refs/heads/master' }}\n+      - name: build docker image without pushing\n         run: |\n           docker buildx build \\\n               --build-arg SKIP_BACKEND_TEST=true --build-arg SKIP_FRONTEND_TEST=true \\\n-              --platform linux/amd64 .\n+              --platform linux/arm64 .\n \n-      - name: build example docker image without pushing (only outside master)\n-        if: ${{ github.ref != 'refs/heads/master' }}\n+      - name: build example docker image without pushing\n         run: |\n           docker buildx build \\\n               --build-arg SKIP_BACKEND_TEST=true --build-arg SKIP_FRONTEND_TEST=true \\\n-              --platform linux/amd64 -f backend/_example/memory_store/Dockerfile .\n+              --platform linux/arm64 -f backend/_example/memory_store/Dockerfile .\n \n-      - name: build and deploy master image to ghcr.io and dockerhub\n-        if: ${{ github.ref == 'refs/heads/master' }}\n-        env:\n-          GITHUB_PACKAGE_TOKEN: ${{ secrets.PKG_TOKEN }}\n-          DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}\n-          USERNAME: ${{ github.actor }}\n-          GITHUB_SHA: ${{ github.sha}}\n-          GITHUB_REF: ${{ github.ref}}\n+  # Build and push for master and tags using native runners\n+  build-push:\n+    name: Build ${{ matrix.platform }}\n+    if: ${{ github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/') }}\n+    strategy:\n+      fail-fast: false\n+      matrix:\n+        include:\n+          - platform: linux/amd64\n+            runner: ubuntu-latest\n+            artifact-name: linux-amd64\n+          - platform: linux/arm64\n+            runner: ubuntu-24.04-arm\n+            artifact-name: linux-arm64\n+    runs-on: ${{ matrix.runner }}\n+\n+    steps:\n+      - uses: actions/checkout@v5\n+\n+      - name: set up Docker Buildx\n+        uses: docker/setup-buildx-action@v3\n+\n+      - name: free disk space\n+        run: |\n+          sudo rm -rf /usr/share/dotnet\n+          sudo rm -rf /opt/ghc\n+          sudo rm -rf /usr/local/share/boost\n+          docker system prune -af\n+\n+      - name: login to ghcr.io\n+        uses: docker/login-action@v3\n+        with:\n+          registry: ghcr.io\n+          username: ${{ github.actor }}\n+          password: ${{ secrets.PKG_TOKEN }}\n+\n+      - name: login to Docker Hub\n+        uses: docker/login-action@v3\n+        with:\n+          username: umputun\n+          password: ${{ secrets.DOCKER_HUB_TOKEN }}\n+\n+      - name: prepare build args\n+        id: prep\n         run: |\n           ref=\"$(echo ${GITHUB_REF} | cut -d'/' -f3)\"\n+          echo \"ref=${ref}\" >> $GITHUB_OUTPUT\n           echo \"GITHUB_REF=${GITHUB_REF}, GITHUB_SHA=${GITHUB_SHA}, GIT_BRANCH=${ref}\"\n-          echo ${GITHUB_PACKAGE_TOKEN} | docker login ghcr.io -u ${USERNAME} --password-stdin\n-          echo ${DOCKER_HUB_TOKEN} | docker login -u umputun --password-stdin\n-          docker buildx build --push \\\n-              --build-arg SKIP_BACKEND_TEST=true --build-arg SKIP_FRONTEND_TEST=true --build-arg CI=github \\\n-              --build-arg GITHUB_SHA=${GITHUB_SHA} --build-arg GIT_BRANCH=${ref} --build-arg GITHUB_REF=${GITHUB_REF} \\\n-              --platform linux/amd64,linux/arm/v7,linux/arm64 \\\n-              -t ghcr.io/umputun/remark42:${ref} -t umputun/remark42:${ref} .\n-\n-      - name: deploy tagged (latest) to ghcr.io and dockerhub\n-        if: ${{ startsWith(github.ref, 'refs/tags/') }}\n-        env:\n-          GITHUB_PACKAGE_TOKEN: ${{ secrets.PKG_TOKEN }}\n-          DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}\n-          USERNAME: ${{ github.actor }}\n-          GITHUB_SHA: ${{ github.sha}}\n-          GITHUB_REF: ${{ github.ref}}\n+\n+      - name: build and push to ghcr.io\n+        id: build-ghcr\n+        uses: docker/build-push-action@v6\n+        with:\n+          context: .\n+          platforms: ${{ matrix.platform }}\n+          build-args: |\n+            SKIP_BACKEND_TEST=true\n+            SKIP_FRONTEND_TEST=true\n+            CI=github\n+            GITHUB_SHA=${{ github.sha }}\n+            GIT_BRANCH=${{ steps.prep.outputs.ref }}\n+            GITHUB_REF=${{ github.ref }}\n+          outputs: type=image,name=ghcr.io/umputun/remark42,push-by-digest=true,name-canonical=true,push=true\n+\n+      - name: build and push to Docker Hub\n+        id: build-dockerhub\n+        uses: docker/build-push-action@v6\n+        with:\n+          context: .\n+          platforms: ${{ matrix.platform }}\n+          build-args: |\n+            SKIP_BACKEND_TEST=true\n+            SKIP_FRONTEND_TEST=true\n+            CI=github\n+            GITHUB_SHA=${{ github.sha }}\n+            GIT_BRANCH=${{ steps.prep.outputs.ref }}\n+            GITHUB_REF=${{ github.ref }}\n+          outputs: type=image,name=umputun/remark42,push-by-digest=true,name-canonical=true,push=true\n+\n+      - name: export digests\n+        run: |\n+          mkdir -p /tmp/digests/ghcr /tmp/digests/dockerhub\n+          digest_ghcr=\"${{ steps.build-ghcr.outputs.digest }}\"\n+          digest_dockerhub=\"${{ steps.build-dockerhub.outputs.digest }}\"\n+          touch \"/tmp/digests/ghcr/${digest_ghcr#sha256:}\"\n+          touch \"/tmp/digests/dockerhub/${digest_dockerhub#sha256:}\"\n+\n+      - name: upload ghcr digest\n+        uses: actions/upload-artifact@v4\n+        with:\n+          name: digests-ghcr-${{ matrix.artifact-name }}\n+          path: /tmp/digests/ghcr/*\n+          if-no-files-found: error\n+          retention-days: 1\n+\n+      - name: upload dockerhub digest\n+        uses: actions/upload-artifact@v4\n+        with:\n+          name: digests-dockerhub-${{ matrix.artifact-name }}\n+          path: /tmp/digests/dockerhub/*\n+          if-no-files-found: error\n+          retention-days: 1\n+\n+  # Merge digests and create multi-arch manifest\n+  merge-push:\n+    name: Create multi-arch manifest\n+    runs-on: ubuntu-latest\n+    needs: build-push\n+\n+    steps:\n+      - name: download ghcr digests\n+        uses: actions/download-artifact@v4\n+        with:\n+          path: /tmp/digests/ghcr\n+          pattern: digests-ghcr-*\n+          merge-multiple: true\n+\n+      - name: download dockerhub digests\n+        uses: actions/download-artifact@v4\n+        with:\n+          path: /tmp/digests/dockerhub\n+          pattern: digests-dockerhub-*\n+          merge-multiple: true\n+\n+      - name: verify all digests present\n+        run: |\n+          for registry in ghcr dockerhub; do\n+            expected=2\n+            actual=$(ls /tmp/digests/${registry} | wc -l)\n+            if [ \"$actual\" -ne \"$expected\" ]; then\n+              echo \"Expected $expected digests for ${registry}, found $actual\"\n+              ls -la /tmp/digests/${registry}\n+              exit 1\n+            fi\n+            echo \"All $expected digests present for ${registry}\"\n+          done\n+\n+      - name: set up Docker Buildx\n+        uses: docker/setup-buildx-action@v3\n+\n+      - name: login to ghcr.io\n+        uses: docker/login-action@v3\n+        with:\n+          registry: ghcr.io\n+          username: ${{ github.actor }}\n+          password: ${{ secrets.PKG_TOKEN }}\n+\n+      - name: login to Docker Hub\n+        uses: docker/login-action@v3\n+        with:\n+          username: umputun\n+          password: ${{ secrets.DOCKER_HUB_TOKEN }}\n+\n+      - name: prepare tags\n+        id: prep\n         run: |\n           ref=\"$(echo ${GITHUB_REF} | cut -d'/' -f3)\"\n-          echo \"GITHUB_REF=${GITHUB_REF}, GITHUB_SHA=${GITHUB_SHA}, GIT_BRANCH=${ref}\"\n-          echo ${GITHUB_PACKAGE_TOKEN} | docker login ghcr.io -u ${USERNAME} --password-stdin\n-          echo ${DOCKER_HUB_TOKEN} | docker login -u umputun --password-stdin\n-          docker buildx build --push \\\n-              --build-arg SKIP_BACKEND_TEST=true --build-arg SKIP_FRONTEND_TEST=true --build-arg CI=github \\\n-              --build-arg GITHUB_SHA=${GITHUB_SHA} --build-arg GIT_BRANCH=${ref} --build-arg GITHUB_REF=${GITHUB_REF} \\\n-              --platform linux/amd64,linux/arm/v7,linux/arm64 \\\n-              -t ghcr.io/umputun/remark42:${ref} -t ghcr.io/umputun/remark42:latest \\\n-              -t umputun/remark42:${ref} -t umputun/remark42:latest .\n+          echo \"ref=${ref}\" >> $GITHUB_OUTPUT\n+\n+          # for master branch, tag with branch name only\n+          if [[ \"${GITHUB_REF}\" == \"refs/heads/master\" ]]; then\n+            echo \"ghcr_tags=-t ghcr.io/umputun/remark42:${ref}\" >> $GITHUB_OUTPUT\n+            echo \"dockerhub_tags=-t umputun/remark42:${ref}\" >> $GITHUB_OUTPUT\n+          fi\n+\n+          # for tags, include both version and latest\n+          if [[ \"${GITHUB_REF}\" == refs/tags/* ]]; then\n+            echo \"ghcr_tags=-t ghcr.io/umputun/remark42:${ref} -t ghcr.io/umputun/remark42:latest\" >> $GITHUB_OUTPUT\n+            echo \"dockerhub_tags=-t umputun/remark42:${ref} -t umputun/remark42:latest\" >> $GITHUB_OUTPUT\n+          fi\n+\n+      - name: create ghcr manifest and push\n+        working-directory: /tmp/digests/ghcr\n+        run: |\n+          docker buildx imagetools create \\\n+            ${{ steps.prep.outputs.ghcr_tags }} \\\n+            $(printf 'ghcr.io/umputun/remark42@sha256:%s ' *)\n+\n+      - name: create dockerhub manifest and push\n+        working-directory: /tmp/digests/dockerhub\n+        run: |\n+          docker buildx imagetools create \\\n+            ${{ steps.prep.outputs.dockerhub_tags }} \\\n+            $(printf 'umputun/remark42@sha256:%s ' *)\n \n       - name: remote deployment to remark42.com from master\n         if: ${{ github.ref == 'refs/heads/master' }}"
    }
  ]
}
