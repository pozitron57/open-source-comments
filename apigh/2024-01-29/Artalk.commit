{
  "sha": "a40a070bdba65e6661260ded11e7800baab9dd77",
  "node_id": "C_kwDOCQOkhNoAKGE0MGEwNzBiZGJhNjVlNjY2MTI2MGRlZDExZTc4MDBiYWFiOWRkNzc",
  "commit": {
    "author": {
      "name": "qwqcode",
      "email": "qwqcode@gmail.com",
      "date": "2024-01-29T06:46:09Z"
    },
    "committer": {
      "name": "qwqcode",
      "email": "qwqcode@gmail.com",
      "date": "2024-01-29T06:46:19Z"
    },
    "message": "chore(fix/pin): fix pinned comment sort rule",
    "tree": {
      "sha": "c0fb32ce4ca9004b84a4bc716a0ad44beb008f46",
      "url": "https://api.github.com/repos/ArtalkJS/Artalk/git/trees/c0fb32ce4ca9004b84a4bc716a0ad44beb008f46"
    },
    "url": "https://api.github.com/repos/ArtalkJS/Artalk/git/commits/a40a070bdba65e6661260ded11e7800baab9dd77",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\niHUEABYIAB0WIQS0Ev3sdPZbHkWwzmLUbg8O6nwTagUCZbdJuwAKCRDUbg8O6nwT\natNoAQDhBFMEuDqYh2Kyg/b0shP2RIdjbyANOUsj+QRBty2QFAD+O0AAmpioPXbI\n7ge0BxKpDxCvdwU6QtjOhCGHHDDsJQQ=\n=U7hZ\n-----END PGP SIGNATURE-----",
      "payload": "tree c0fb32ce4ca9004b84a4bc716a0ad44beb008f46\nparent 082bfc63d1a5c87a14e55b4e9022628b222b8ba3\nauthor qwqcode <qwqcode@gmail.com> 1706510769 +0800\ncommitter qwqcode <qwqcode@gmail.com> 1706510779 +0800\n\nchore(fix/pin): fix pinned comment sort rule\n"
    }
  },
  "url": "https://api.github.com/repos/ArtalkJS/Artalk/commits/a40a070bdba65e6661260ded11e7800baab9dd77",
  "html_url": "https://github.com/ArtalkJS/Artalk/commit/a40a070bdba65e6661260ded11e7800baab9dd77",
  "comments_url": "https://api.github.com/repos/ArtalkJS/Artalk/commits/a40a070bdba65e6661260ded11e7800baab9dd77/comments",
  "author": {
    "login": "qwqcode",
    "id": 22412567,
    "node_id": "MDQ6VXNlcjIyNDEyNTY3",
    "avatar_url": "https://avatars.githubusercontent.com/u/22412567?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/qwqcode",
    "html_url": "https://github.com/qwqcode",
    "followers_url": "https://api.github.com/users/qwqcode/followers",
    "following_url": "https://api.github.com/users/qwqcode/following{/other_user}",
    "gists_url": "https://api.github.com/users/qwqcode/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/qwqcode/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/qwqcode/subscriptions",
    "organizations_url": "https://api.github.com/users/qwqcode/orgs",
    "repos_url": "https://api.github.com/users/qwqcode/repos",
    "events_url": "https://api.github.com/users/qwqcode/events{/privacy}",
    "received_events_url": "https://api.github.com/users/qwqcode/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "qwqcode",
    "id": 22412567,
    "node_id": "MDQ6VXNlcjIyNDEyNTY3",
    "avatar_url": "https://avatars.githubusercontent.com/u/22412567?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/qwqcode",
    "html_url": "https://github.com/qwqcode",
    "followers_url": "https://api.github.com/users/qwqcode/followers",
    "following_url": "https://api.github.com/users/qwqcode/following{/other_user}",
    "gists_url": "https://api.github.com/users/qwqcode/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/qwqcode/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/qwqcode/subscriptions",
    "organizations_url": "https://api.github.com/users/qwqcode/orgs",
    "repos_url": "https://api.github.com/users/qwqcode/repos",
    "events_url": "https://api.github.com/users/qwqcode/events{/privacy}",
    "received_events_url": "https://api.github.com/users/qwqcode/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "082bfc63d1a5c87a14e55b4e9022628b222b8ba3",
      "url": "https://api.github.com/repos/ArtalkJS/Artalk/commits/082bfc63d1a5c87a14e55b4e9022628b222b8ba3",
      "html_url": "https://github.com/ArtalkJS/Artalk/commit/082bfc63d1a5c87a14e55b4e9022628b222b8ba3"
    }
  ],
  "stats": {
    "total": 21,
    "additions": 8,
    "deletions": 13
  },
  "files": [
    {
      "sha": "f2447c069df15893645fa3b8d0ccdf48b685bf07",
      "filename": "server/handler/comments_get/base.go",
      "status": "modified",
      "additions": 3,
      "deletions": 3,
      "changes": 6,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/a40a070bdba65e6661260ded11e7800baab9dd77/server%2Fhandler%2Fcomments_get%2Fbase.go",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/a40a070bdba65e6661260ded11e7800baab9dd77/server%2Fhandler%2Fcomments_get%2Fbase.go",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/server%2Fhandler%2Fcomments_get%2Fbase.go?ref=a40a070bdba65e6661260ded11e7800baab9dd77",
      "patch": "@@ -39,6 +39,9 @@ func GetQueryScopes(dao *dao.Dao, opts QueryOptions) func(*gorm.DB) *gorm.DB {\n \t\t\tq.Scopes(SearchScope(dao, opts.Search))\n \t\t}\n \n+\t\t// Sort by\n+\t\tq.Order(GetSortSQL(opts.Scope, opts.SortBy))\n+\n \t\t// Scopes\n \t\tscopes := map[Scope]func(*gorm.DB) *gorm.DB{\n \t\t\tScopePage: PageScopeQuery(opts.PagePayload, PageScopeOpts{\n@@ -59,9 +62,6 @@ func GetQueryScopes(dao *dao.Dao, opts QueryOptions) func(*gorm.DB) *gorm.DB {\n \t\t\tq.Where(\"1 = 0\")\n \t\t}\n \n-\t\t// Sort by\n-\t\tq.Order(GetSortSQL(opts.SortBy))\n-\n \t\treturn q\n \t}\n }"
    },
    {
      "sha": "c4396b5c485217567ae73f9b4fce779a8700b5f7",
      "filename": "server/handler/comments_get/scope_page.go",
      "status": "modified",
      "additions": 0,
      "deletions": 9,
      "changes": 9,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/a40a070bdba65e6661260ded11e7800baab9dd77/server%2Fhandler%2Fcomments_get%2Fscope_page.go",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/a40a070bdba65e6661260ded11e7800baab9dd77/server%2Fhandler%2Fcomments_get%2Fscope_page.go",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/server%2Fhandler%2Fcomments_get%2Fscope_page.go?ref=a40a070bdba65e6661260ded11e7800baab9dd77",
      "patch": "@@ -39,19 +39,10 @@ func PageScopeQuery(payload PageScopePayload, opts PageScopeOpts) func(*gorm.DB)\n \t\t\td.Scopes(CommentsWithinSomeUsers(opts.AdminUserIDs))\n \t\t}\n \n-\t\t// Insert pinned comments\n-\t\td.Scopes(PinnedCommentsSort())\n-\n \t\treturn d\n \t}\n }\n \n-func PinnedCommentsSort() func(*gorm.DB) *gorm.DB {\n-\treturn func(d *gorm.DB) *gorm.DB {\n-\t\treturn d.Order(\"is_pinned DESC\")\n-\t}\n-}\n-\n func CommentsWithinSite(siteName string) func(*gorm.DB) *gorm.DB {\n \treturn func(d *gorm.DB) *gorm.DB {\n \t\treturn d.Where(\"site_name = ?\", siteName)"
    },
    {
      "sha": "f353b15d80fc1e1d58637d40f2545d979dce0dda",
      "filename": "server/handler/comments_get/sort.go",
      "status": "modified",
      "additions": 5,
      "deletions": 1,
      "changes": 6,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/a40a070bdba65e6661260ded11e7800baab9dd77/server%2Fhandler%2Fcomments_get%2Fsort.go",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/a40a070bdba65e6661260ded11e7800baab9dd77/server%2Fhandler%2Fcomments_get%2Fsort.go",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/server%2Fhandler%2Fcomments_get%2Fsort.go?ref=a40a070bdba65e6661260ded11e7800baab9dd77",
      "patch": "@@ -9,7 +9,7 @@ const (\n )\n \n // Get sort rule\n-func GetSortSQL(sortBy SortRule) string {\n+func GetSortSQL(scope Scope, sortBy SortRule) string {\n \tswitch sortBy {\n \tcase SortByDateDesc:\n \t\treturn \"created_at DESC\"\n@@ -19,5 +19,9 @@ func GetSortSQL(sortBy SortRule) string {\n \t\treturn \"vote_up DESC, created_at DESC\"\n \t}\n \n+\tif scope == ScopePage {\n+\t\treturn \"is_pinned DESC, created_at DESC\"\n+\t}\n+\n \treturn \"created_at DESC\"\n }"
    }
  ]
}
