{
  "sha": "fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
  "node_id": "C_kwDOAF-mA9oAKGZlNDQ1OWI5NWNjYmQzMjZjNmZmN2JiOTYyM2MzMmVkMzEyODRkYWQ",
  "commit": {
    "author": {
      "name": "Jelmer Vernooĳ",
      "email": "jelmer@jelmer.uk",
      "date": "2026-02-26T11:17:56Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2026-02-26T11:17:56Z"
    },
    "message": "Merge pull request #1084 from isso-comments/ruff\n\nFormat with ruff",
    "tree": {
      "sha": "78d01134842c596f685b6ecde8c2e632491bfb04",
      "url": "https://api.github.com/repos/isso-comments/isso/git/trees/78d01134842c596f685b6ecde8c2e632491bfb04"
    },
    "url": "https://api.github.com/repos/isso-comments/isso/git/commits/fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsFcBAABCAAQBQJpoCvkCRC1aQ7uu5UhlAAAPR0QADUKZRoDB0aP3q2sdUa+q/yP\nS2S3Rk5oFwdcpeMDXe4UBAWN2k4/skbZ/TDkzW6bq7xuSO2EMERtzP0oMK0kLE1s\nde2zVsVCrCkkbHUTmLiAZQ9P5VmFV5ZvdyE/I+a5vDNODcubl5/IlYcCfV5Vi8nm\nccyVAPV8Y7sRu4msb2VQlj/1pZd1v9+nxEhzqkDsGGcMOVvVozMirJa0nbVbt6qe\nW78RwNB9xXy+K0PP62sI3jn9vemR5lQEudoLxOOnKRAxKh6I3jt7Ienpp0eAkIi4\n/IYMG7DbA0nKhQNALJUlT1WA6KnTUtxgStDrkPxtCft6sNADxeHXbvnCSBVtGqRW\nGmwMPMg3Lq4IVOtBYbumfKmzJwR9xuxsz404iP37ZQC1s8xCmMr/5dXKp70FdfON\n+bwdxaVWQuwaw8kFlH+MiUrzuF4E8LtjAGjDCsKnaRgAzNQ3Tjsw2uVghQZ7inCm\nk1BfNFwJ1f5an0JjI8f2+WFsRrA1pIUQbbI5ZUPsxaDRxdrBMmQmHNm/QHnfcvi9\nwwSN2jB+GQpDUr5ln9iOz2yr2VYtPE8wlnGZn3yOnsjIvVjD7ZSXFeG/lQGLR4FQ\nSAvqHA6NC1m0nrnOVHb3Ec5RiZWUuM6h9+HB1zkNkZ4KCgYFSeLcKWGJJFdece8g\nsuLgzFOSaU3CLzrXJMUJ\n=vfqe\n-----END PGP SIGNATURE-----\n",
      "payload": "tree 78d01134842c596f685b6ecde8c2e632491bfb04\nparent 009e2c9bd8534627780e69421541145aae8b2ccf\nparent 459853b034d75b365de2e35a8f03212fece53788\nauthor Jelmer Vernooĳ <jelmer@jelmer.uk> 1772104676 +0000\ncommitter GitHub <noreply@github.com> 1772104676 +0000\n\nMerge pull request #1084 from isso-comments/ruff\n\nFormat with ruff",
      "verified_at": "2026-02-26T11:17:56Z"
    }
  },
  "url": "https://api.github.com/repos/isso-comments/isso/commits/fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
  "html_url": "https://github.com/isso-comments/isso/commit/fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
  "comments_url": "https://api.github.com/repos/isso-comments/isso/commits/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/comments",
  "author": {
    "login": "jelmer",
    "id": 49032,
    "node_id": "MDQ6VXNlcjQ5MDMy",
    "avatar_url": "https://avatars.githubusercontent.com/u/49032?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jelmer",
    "html_url": "https://github.com/jelmer",
    "followers_url": "https://api.github.com/users/jelmer/followers",
    "following_url": "https://api.github.com/users/jelmer/following{/other_user}",
    "gists_url": "https://api.github.com/users/jelmer/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jelmer/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jelmer/subscriptions",
    "organizations_url": "https://api.github.com/users/jelmer/orgs",
    "repos_url": "https://api.github.com/users/jelmer/repos",
    "events_url": "https://api.github.com/users/jelmer/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jelmer/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "009e2c9bd8534627780e69421541145aae8b2ccf",
      "url": "https://api.github.com/repos/isso-comments/isso/commits/009e2c9bd8534627780e69421541145aae8b2ccf",
      "html_url": "https://github.com/isso-comments/isso/commit/009e2c9bd8534627780e69421541145aae8b2ccf"
    },
    {
      "sha": "459853b034d75b365de2e35a8f03212fece53788",
      "url": "https://api.github.com/repos/isso-comments/isso/commits/459853b034d75b365de2e35a8f03212fece53788",
      "html_url": "https://github.com/isso-comments/isso/commit/459853b034d75b365de2e35a8f03212fece53788"
    }
  ],
  "stats": {
    "total": 3331,
    "additions": 1578,
    "deletions": 1753
  },
  "files": [
    {
      "sha": "e790999fc5a4651ff0e25cd6fcc9f8a25c49919f",
      "filename": ".github/workflows/python-tests.yml",
      "status": "modified",
      "additions": 4,
      "deletions": 1,
      "changes": 5,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/.github%2Fworkflows%2Fpython-tests.yml",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/.github%2Fworkflows%2Fpython-tests.yml",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/.github%2Fworkflows%2Fpython-tests.yml?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -72,11 +72,14 @@ jobs:\n       run: pip install pytest pytest-cov\n \n     - name: Install style check dependencies\n-      run: pip install flake8\n+      run: pip install ruff\n \n     - name: Run style check\n       run: make flakes\n \n+    - name: Run format check\n+      run: make format-check\n+\n     - name: Run coverage check, fail if <70%\n       run: |\n         make coverage"
    },
    {
      "sha": "0775d9925c3ae6c4f23a6839983681ae152a3229",
      "filename": "Dockerfile",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/Dockerfile",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/Dockerfile",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/Dockerfile?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -53,7 +53,7 @@ RUN virtualenv --download /isso \\\n # Install Isso's python dependencies via pip in a separate step before copying\n # over client files, so that changing Isso js/python source code will not\n # trigger a re-installation of all pip packages from scratch\n-COPY [\"setup.py\", \"setup.cfg\", \"README.md\", \"LICENSE\", \"./\"]\n+COPY [\"setup.py\", \"pyproject.toml\", \"README.md\", \"LICENSE\", \"./\"]\n RUN --mount=type=cache,target=/root/.cache \\\n   . /isso/bin/activate \\\n  && pip install -e ."
    },
    {
      "sha": "425c6273ee4635fbc1525374c987707f7f0d8346",
      "filename": "Makefile",
      "status": "modified",
      "additions": 7,
      "deletions": 1,
      "changes": 8,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/Makefile",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/Makefile",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/Makefile?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -49,7 +49,13 @@ init:\n \tnpm install --omit=optional\n \n flakes:\n-\tflake8 isso/ contrib/ --count --max-line-length=127 --show-source --statistics\n+\truff check isso/ contrib/ --statistics\n+\n+format:\n+\truff format isso/ contrib/\n+\n+format-check:\n+\truff format --check isso/ contrib/\n \n # Note: It doesn't make sense to split up configs by output file with\n # webpack, just run everything at once"
    },
    {
      "sha": "54951ec7ccf275065ecaa99a2f626cbe68b01a6a",
      "filename": "contrib/dump_comments.py",
      "status": "modified",
      "additions": 33,
      "deletions": 20,
      "changes": 53,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/contrib%2Fdump_comments.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/contrib%2Fdump_comments.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/contrib%2Fdump_comments.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -44,21 +44,24 @@\n from textwrap import indent\n \n \n-class ColorFallback():\n-    __getattr__ = lambda self, name: ''  # noqa: E731\n+class ColorFallback:\n+    __getattr__ = lambda self, name: \"\"  # noqa: E731\n \n \n try:\n     from colorama import Fore, Style, init\n+\n     init()  # needed for Windows\n except ImportError:  # fallback so that the imported classes always exist\n     Fore = Style = ColorFallback()\n \n \n-Comment = namedtuple('Comment', ('uri', 'id', 'parent', 'created', 'text', 'author', 'email', 'website', 'likes', 'dislikes', 'replies'))\n+Comment = namedtuple(\n+    \"Comment\", (\"uri\", \"id\", \"parent\", \"created\", \"text\", \"author\", \"email\", \"website\", \"likes\", \"dislikes\", \"replies\")\n+)\n \n-INDENT = '    '\n-QUERY = 'SELECT uri, comments.id, parent, created, text, author, email, website, likes, dislikes FROM comments INNER JOIN threads on comments.tid = threads.id'\n+INDENT = \"    \"\n+QUERY = \"SELECT uri, comments.id, parent, created, text, author, email, website, likes, dislikes FROM comments INNER JOIN threads on comments.tid = threads.id\"\n \n \n def main():\n@@ -95,34 +98,44 @@ def main():\n \n \n def print_comment(prefix, comment):\n-    author = comment.author or 'Anonymous'\n-    email = comment.email or ''\n-    website = comment.website or ''\n+    author = comment.author or \"Anonymous\"\n+    email = comment.email or \"\"\n+    website = comment.website or \"\"\n     when = date.fromtimestamp(comment.created)\n-    popularity = ''\n+    popularity = \"\"\n     if comment.likes:\n-        popularity = '+{.likes}'.format(comment)\n+        popularity = \"+{.likes}\".format(comment)\n     if comment.dislikes:\n         if popularity:\n-            popularity += '/'\n-        popularity = '-{.dislikes}'.format(comment)\n-    print(prefix + '{Style.BRIGHT}{author}{Style.RESET_ALL} {Style.DIM}- {email} {website}{Style.RESET_ALL} {when} {Style.DIM}{popularity}{Style.RESET_ALL}'.format(Style=Style, **locals()))\n+            popularity += \"/\"\n+        popularity = \"-{.dislikes}\".format(comment)\n+    print(\n+        prefix\n+        + \"{Style.BRIGHT}{author}{Style.RESET_ALL} {Style.DIM}- {email} {website}{Style.RESET_ALL} {when} {Style.DIM}{popularity}{Style.RESET_ALL}\".format(\n+            Style=Style, **locals()\n+        )\n+    )\n     print(indent(comment.text, prefix))\n \n \n def parse_args():\n-    parser = argparse.ArgumentParser(description='Dump all Isso comments in chronological order, grouped by replies',\n-                                     formatter_class=ArgparseHelpFormatter)\n-    parser.add_argument('db_path', help='File path to Isso Sqlite DB')\n-    parser.add_argument('--sort-by-last-reply', action='store_true', help='By default comments are sorted by \"parent\" comment date, this sort comments based on the last replies')\n-    parser.add_argument('--url-prefix', default='', help='Optional domain name to prefix to pages URLs')\n-    parser.add_argument('--no-colors', action='store_false', dest='colors', default=True, help='Disabled colored output')\n+    parser = argparse.ArgumentParser(\n+        description=\"Dump all Isso comments in chronological order, grouped by replies\", formatter_class=ArgparseHelpFormatter\n+    )\n+    parser.add_argument(\"db_path\", help=\"File path to Isso Sqlite DB\")\n+    parser.add_argument(\n+        \"--sort-by-last-reply\",\n+        action=\"store_true\",\n+        help='By default comments are sorted by \"parent\" comment date, this sort comments based on the last replies',\n+    )\n+    parser.add_argument(\"--url-prefix\", default=\"\", help=\"Optional domain name to prefix to pages URLs\")\n+    parser.add_argument(\"--no-colors\", action=\"store_false\", dest=\"colors\", default=True, help=\"Disabled colored output\")\n     return parser.parse_args()\n \n \n class ArgparseHelpFormatter(argparse.RawTextHelpFormatter, argparse.ArgumentDefaultsHelpFormatter):\n     pass\n \n \n-if __name__ == '__main__':\n+if __name__ == \"__main__\":\n     main()"
    },
    {
      "sha": "81f5edebe0f307a780bdb7abded5a9b3643f6077",
      "filename": "contrib/import_blogger.py",
      "status": "modified",
      "additions": 22,
      "deletions": 24,
      "changes": 46,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/contrib%2Fimport_blogger.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/contrib%2Fimport_blogger.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/contrib%2Fimport_blogger.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -28,9 +28,9 @@\n try:\n     import feedparser\n except ImportError:\n-    print(\"Error: Package feedparser not installed! You can install it via \"\n-          \"'pip install feedparser' inside your virtualenv.\")\n+    print(\"Error: Package feedparser not installed! You can install it via 'pip install feedparser' inside your virtualenv.\")\n     import sys\n+\n     sys.exit(1)\n \n from urllib.parse import urlparse\n@@ -43,21 +43,21 @@ def __init__(self, url):\n         self.comments = []\n \n     def add_comment(self, comment):\n-        comment['id'] = len(self.comments) + 1\n+        comment[\"id\"] = len(self.comments) + 1\n         self.comments.append(comment)\n \n \n def encode_post(post):\n     ret = {}\n-    ret['id'] = post.url\n-    ret['title'] = post.title\n-    ret['comments'] = post.comments\n+    ret[\"id\"] = post.url\n+    ret[\"title\"] = post.title\n+    ret[\"comments\"] = post.comments\n     return ret\n \n \n class ImportBlogger:\n-    TYPE_COMMENT = 'http://schemas.google.com/blogger/2008/kind#comment'\n-    TYPE_POST = 'http://schemas.google.com/blogger/2008/kind#post'\n+    TYPE_COMMENT = \"http://schemas.google.com/blogger/2008/kind#comment\"\n+    TYPE_POST = \"http://schemas.google.com/blogger/2008/kind#post\"\n \n     def __init__(self, filename_in, filename_out, prefix):\n         self.channel = feedparser.parse(filename_in)\n@@ -77,7 +77,7 @@ def run(self):\n                 self.process_post(item)\n \n         data = [encode_post(p) for p in self.posts.values() if p.comments]\n-        with open(self.filename_out, 'w') as fp:\n+        with open(self.filename_out, \"w\") as fp:\n             json.dump(data, fp, indent=2)\n \n     def process_post(self, item):\n@@ -99,29 +99,27 @@ def ensure_post(self, item):\n \n     def process_comment(self, item):\n         comment = {}\n-        comment['author'] = item.author_detail.name\n-        comment['email'] = item.author_detail.email\n-        comment['website'] = item.author_detail.get('href', '')\n-        t = time.strftime('%Y-%m-%d %H:%M:%S', item.published_parsed)\n-        comment['created'] = t\n-        comment['text'] = item.content[0].value\n-        comment['remote_addr'] = '127.0.0.1'\n+        comment[\"author\"] = item.author_detail.name\n+        comment[\"email\"] = item.author_detail.email\n+        comment[\"website\"] = item.author_detail.get(\"href\", \"\")\n+        t = time.strftime(\"%Y-%m-%d %H:%M:%S\", item.published_parsed)\n+        comment[\"created\"] = t\n+        comment[\"text\"] = item.content[0].value\n+        comment[\"remote_addr\"] = \"127.0.0.1\"\n         return comment\n \n     def post_id(self, item):\n         u = urlparse(item.link)\n         return self.prefix + u.path\n \n \n-if __name__ == '__main__':\n+if __name__ == \"__main__\":\n     import argparse\n-    parser = argparse.ArgumentParser(\n-        description='Convert comments from blogger.com')\n-    parser.add_argument('input', help='input file')\n-    parser.add_argument('output', help='output file')\n-    parser.add_argument('-p', dest='prefix',\n-                        help='prefix to be added to paths (ID)',\n-                        type=str, default='')\n+\n+    parser = argparse.ArgumentParser(description=\"Convert comments from blogger.com\")\n+    parser.add_argument(\"input\", help=\"input file\")\n+    parser.add_argument(\"output\", help=\"output file\")\n+    parser.add_argument(\"-p\", dest=\"prefix\", help=\"prefix to be added to paths (ID)\", type=str, default=\"\")\n     args = parser.parse_args()\n \n     importer = ImportBlogger(args.input, args.output, args.prefix)"
    },
    {
      "sha": "6c7476b36295e7b5255e3672fe4d847d41540a24",
      "filename": "isso/__init__.py",
      "status": "modified",
      "additions": 56,
      "deletions": 53,
      "changes": 109,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2F__init__.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2F__init__.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2F__init__.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -26,6 +26,7 @@\n # Isso – a lightweight Disqus alternative\n \n from importlib.metadata import version\n+\n __version__ = version(\"isso\")\n \n # check if exectuable is `isso` and gevent is available\n@@ -34,6 +35,7 @@\n if sys.argv[0].startswith(\"isso\"):\n     try:\n         import gevent.monkey\n+\n         gevent.monkey.patch_all()\n     except ImportError:\n         pass\n@@ -70,17 +72,15 @@\n from isso.ext.notifications import Stdout, SMTP\n \n LOG_FORMAT = \"%(asctime)s:%(levelname)s: %(message)s\"\n-logging.getLogger('werkzeug').setLevel(logging.WARN)\n-logging.basicConfig(\n-    level=logging.INFO,\n-    format=LOG_FORMAT)\n+logging.getLogger(\"werkzeug\").setLevel(logging.WARN)\n+logging.basicConfig(level=logging.INFO, format=LOG_FORMAT)\n \n logger = logging.getLogger(\"isso\")\n \n \n def error_handler(env, request, error):\n     if request.accept_mimetypes.best == \"application/json\":\n-        data = {'message': str(error)}\n+        data = {\"message\": str(error)}\n         code = 500 if error.code is None else error.code\n         return JSONResponse(data, code)\n     return error\n@@ -95,13 +95,10 @@ def __init__(self, app):\n \n \n class Isso(object):\n-\n     def __init__(self, conf):\n-\n         self.conf = conf\n-        self.db = db.SQLite3(conf.get('general', 'dbpath'), conf)\n-        self.signer = URLSafeTimedSerializer(\n-            self.db.preferences.get(\"session-key\"))\n+        self.db = db.SQLite3(conf.get(\"general\", \"dbpath\"), conf)\n+        self.signer = URLSafeTimedSerializer(self.db.preferences.get(\"session-key\"))\n         self.markup = html.Markup(conf)\n         self.hasher = hash.new(conf.section(\"hash\"))\n \n@@ -133,14 +130,13 @@ def sign(self, obj):\n         return self.signer.dumps(obj)\n \n     def unsign(self, obj, max_age=None):\n-        return self.signer.loads(obj, max_age=max_age or self.conf.getint('general', 'max-age'))\n+        return self.signer.loads(obj, max_age=max_age or self.conf.getint(\"general\", \"max-age\"))\n \n     def dispatch(self, request):\n         local.request = request\n \n         local.host = wsgi.host(request.environ)\n-        local.origin = origin(self.conf.getiter(\n-            \"general\", \"host\"))(request.environ)\n+        local.origin = origin(self.conf.getiter(\"general\", \"host\"))(request.environ)\n \n         adapter = self.urls.bind_to_environ(request.environ)\n \n@@ -154,8 +150,7 @@ def dispatch(self, request):\n             except HTTPException as e:\n                 return error_handler(request.environ, request, e)\n             except Exception:\n-                logger.exception(\"%s %s\", request.method,\n-                                 request.environ[\"PATH_INFO\"])\n+                logger.exception(\"%s %s\", request.method, request.environ[\"PATH_INFO\"])\n                 return error_handler(request.environ, request, InternalServerError())\n             else:\n                 return response\n@@ -169,98 +164,106 @@ def __call__(self, environ, start_response):\n \n \n def make_app(conf=None, threading=True, multiprocessing=False, uwsgi=False):\n-\n     if not any((threading, multiprocessing, uwsgi)):\n         raise RuntimeError(\"either set threading, multiprocessing or uwsgi\")\n \n     if threading:\n+\n         class App(Isso, ThreadedMixin):\n             pass\n     elif multiprocessing:\n+\n         class App(Isso, ProcessMixin):\n             pass\n     else:\n+\n         class App(Isso, uWSGIMixin):\n             pass\n \n     isso = App(conf)\n \n-    logger.info(\"Using database at '%s'\",\n-                abspath(isso.conf.get('general', 'dbpath')))\n+    logger.info(\"Using database at '%s'\", abspath(isso.conf.get(\"general\", \"dbpath\")))\n \n     if not any(conf.getiter(\"general\", \"host\")):\n         logger.error(\"No website(s) configured, Isso won't work.\")\n         sys.exit(1)\n \n     # check HTTP server connection\n     for host in conf.getiter(\"general\", \"host\"):\n-        with http.curl('HEAD', host, '/', 5) as resp:\n+        with http.curl(\"HEAD\", host, \"/\", 5) as resp:\n             if resp is not None:\n                 logger.info(\"connected to %s\", host)\n                 break\n     else:\n-        logger.warning(\"unable to connect to your website, Isso will probably not \"\n-                       \"work correctly. Please make sure, Isso can reach your \"\n-                       \"website via HTTP(S).\")\n+        logger.warning(\n+            \"unable to connect to your website, Isso will probably not \"\n+            \"work correctly. Please make sure, Isso can reach your \"\n+            \"website via HTTP(S).\"\n+        )\n \n     wrapper = [local_manager.make_middleware]\n \n     if isso.conf.getboolean(\"server\", \"profile\"):\n-        wrapper.append(partial(ProfilerMiddleware,\n-                               sort_by=(\"cumulative\", ), restrictions=(\"isso/(?!lib)\", 10)))\n-\n-    wrapper.append(partial(SharedDataMiddleware, exports={\n-        '/js': join(dirname(__file__), 'js/'),\n-        '/css': join(dirname(__file__), 'css/'),\n-        '/img': join(dirname(__file__), 'img/'),\n-        '/demo': join(dirname(__file__), 'demo/')\n-    }))\n-\n-    wrapper.append(partial(wsgi.CORSMiddleware,\n-                           origin=origin(isso.conf.getiter(\"general\", \"host\")),\n-                           allowed=(\"Origin\", \"Referer\", \"Content-Type\"),\n-                           exposed=(\"X-Set-Cookie\", \"Date\")))\n+        wrapper.append(partial(ProfilerMiddleware, sort_by=(\"cumulative\",), restrictions=(\"isso/(?!lib)\", 10)))\n+\n+    wrapper.append(\n+        partial(\n+            SharedDataMiddleware,\n+            exports={\n+                \"/js\": join(dirname(__file__), \"js/\"),\n+                \"/css\": join(dirname(__file__), \"css/\"),\n+                \"/img\": join(dirname(__file__), \"img/\"),\n+                \"/demo\": join(dirname(__file__), \"demo/\"),\n+            },\n+        )\n+    )\n+\n+    wrapper.append(\n+        partial(\n+            wsgi.CORSMiddleware,\n+            origin=origin(isso.conf.getiter(\"general\", \"host\")),\n+            allowed=(\"Origin\", \"Referer\", \"Content-Type\"),\n+            exposed=(\"X-Set-Cookie\", \"Date\"),\n+        )\n+    )\n \n     wrapper.extend([wsgi.SubURI, ProxyFixCustom])\n \n     return reduce(lambda x, f: f(x), wrapper, isso)\n \n \n def main():\n-\n     parser = ArgumentParser(description=\"a blog comment hosting service\")\n     subparser = parser.add_subparsers(help=\"commands\", dest=\"command\")\n \n-    parser.add_argument('--version', action='version',\n-                        version='%(prog)s ' + __version__)\n-    parser.add_argument(\"-c\", dest=\"conf\", default=\"/etc/isso.cfg\",\n-                        metavar=\"/etc/isso.cfg\", help=\"set configuration file\")\n+    parser.add_argument(\"--version\", action=\"version\", version=\"%(prog)s \" + __version__)\n+    parser.add_argument(\"-c\", dest=\"conf\", default=\"/etc/isso.cfg\", metavar=\"/etc/isso.cfg\", help=\"set configuration file\")\n \n-    imprt = subparser.add_parser('import', help=\"import Disqus XML export\")\n+    imprt = subparser.add_parser(\"import\", help=\"import Disqus XML export\")\n     imprt.add_argument(\"dump\", metavar=\"FILE\")\n-    imprt.add_argument(\"-n\", \"--dry-run\", dest=\"dryrun\", action=\"store_true\",\n-                       help=\"perform a trial run with no changes made\")\n-    imprt.add_argument(\"-t\", \"--type\", dest=\"type\", default=None,\n-                       choices=[\"disqus\", \"wordpress\", \"generic\"], help=\"export type\")\n-    imprt.add_argument(\"--empty-id\", dest=\"empty_id\", action=\"store_true\",\n-                       help=\"workaround for weird Disqus XML exports, #135\")\n+    imprt.add_argument(\"-n\", \"--dry-run\", dest=\"dryrun\", action=\"store_true\", help=\"perform a trial run with no changes made\")\n+    imprt.add_argument(\n+        \"-t\", \"--type\", dest=\"type\", default=None, choices=[\"disqus\", \"wordpress\", \"generic\"], help=\"export type\"\n+    )\n+    imprt.add_argument(\n+        \"--empty-id\", dest=\"empty_id\", action=\"store_true\", help=\"workaround for weird Disqus XML exports, #135\"\n+    )\n \n     # run Isso as stand-alone server\n     subparser.add_parser(\"run\", help=\"run server\")\n \n     args = parser.parse_args()\n \n     # ISSO_SETTINGS env var takes precedence over `-c` flag\n-    conf_file = os.environ.get('ISSO_SETTINGS') or args.conf\n+    conf_file = os.environ.get(\"ISSO_SETTINGS\") or args.conf\n \n     if not conf_file:\n         logger.error(\"No configuration file specified! Exiting.\")\n         sys.exit(1)\n     if exists(conf_file):\n         logger.info(\"Using configuration file '%s'\", abspath(conf_file))\n     else:\n-        logger.error(\"Specified config '%s' does not exist! Exiting.\",\n-                     abspath(conf_file))\n+        logger.error(\"Specified config '%s' does not exist! Exiting.\", abspath(conf_file))\n         sys.exit(1)\n \n     conf = config.load(config.default_file(), conf_file)\n@@ -293,10 +296,10 @@ def main():\n         host, port, _ = urlsplit(conf.get(\"server\", \"listen\"))\n         try:\n             from gevent.pywsgi import WSGIServer\n+\n             WSGIServer((host, port), make_app(conf)).serve_forever()\n         except ImportError:\n-            run_simple(host, port, make_app(conf), threaded=True,\n-                       use_reloader=conf.getboolean('server', 'reload'))\n+            run_simple(host, port, make_app(conf), threaded=True, use_reloader=conf.getboolean(\"server\", \"reload\"))\n     elif conf.get(\"server\", \"listen\").startswith(\"unix://\"):\n         sock = conf.get(\"server\", \"listen\").partition(\"unix://\")[2]\n         try:"
    },
    {
      "sha": "5bae8c77d05bc1fbb787e41f6d186b188ed8d696",
      "filename": "isso/config.py",
      "status": "modified",
      "additions": 19,
      "deletions": 22,
      "changes": 41,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fconfig.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fconfig.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fconfig.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -11,7 +11,7 @@\n \n logger = logging.getLogger(\"isso\")\n \n-default_config_file = str(files('isso').joinpath('isso.cfg'))\n+default_config_file = str(files(\"isso\").joinpath(\"isso.cfg\"))\n \n \n def timedelta(string):\n@@ -86,10 +86,10 @@ def getboolean(self, key):\n class IssoParser(ConfigParser):\n     \"\"\"Parse INI-style configuration with some modifications for Isso.\n \n-        * Parse human-readable timedelta such as \"15m\" as \"15 minutes\"\n-        * Handle indented lines as \"lists\"\n-        * Disable string interpolation ('%s') for values\n-        * Support environment variable substitution\n+    * Parse human-readable timedelta such as \"15m\" as \"15 minutes\"\n+    * Handle indented lines as \"lists\"\n+    * Disable string interpolation ('%s') for values\n+    * Support environment variable substitution\n     \"\"\"\n \n     def __init__(self, *args, **kwargs):\n@@ -118,10 +118,10 @@ def getint(self, section, key):\n                 return int(delta.total_seconds())\n \n     def getlist(self, section, key):\n-        return list(map(str.strip, self.get(section, key).split(',')))\n+        return list(map(str.strip, self.get(section, key).split(\",\")))\n \n     def getiter(self, section, key):\n-        for item in map(str.strip, self.get(section, key).split('\\n')):\n+        for item in map(str.strip, self.get(section, key).split(\"\\n\")):\n             if item:\n                 yield item\n \n@@ -137,7 +137,6 @@ def default_file():\n \n \n def new(options=None):\n-\n     cp = IssoParser()\n \n     if options:\n@@ -147,20 +146,18 @@ def new(options=None):\n \n \n def load(default, user=None):\n-\n     # return set of (section, option)\n     def setify(cp):\n-        return set((section, option) for section in cp.sections()\n-                   for option in cp.options(section))\n+        return set((section, option) for section in cp.sections() for option in cp.options(section))\n \n     parser = new()\n-    with open(default, 'r') as f:\n+    with open(default, \"r\") as f:\n         parser.read_file(f)\n \n     a = setify(parser)\n \n     if user:\n-        with open(user, 'r') as f:\n+        with open(user, \"r\") as f:\n             parser.read_file(f)\n \n     for item in setify(parser).difference(a):\n@@ -170,27 +167,27 @@ def setify(cp):\n         if item == (\"smtp\", \"ssl\"):\n             logger.warning(\"use `security = none | starttls | ssl` instead\")\n         if item == (\"general\", \"session-key\"):\n-            logger.info(\"Your `session-key` has been stored in the \"\n-                        \"database itself, this option is now unused\")\n+            logger.info(\"Your `session-key` has been stored in the database itself, this option is now unused\")\n \n     try:\n-        parser.add_section('smtp')\n+        parser.add_section(\"smtp\")\n     except DuplicateSectionError:\n         pass\n     try:\n         fromaddr = parser.get(\"smtp\", \"from\")\n     except (NoOptionError, NoSectionError):\n-        fromaddr = ''\n+        fromaddr = \"\"\n     if not parseaddr(fromaddr)[0]:\n-        parser.set(\"smtp\", \"from\",\n-                   formataddr((\"Ich schrei sonst!\", fromaddr)))\n+        parser.set(\"smtp\", \"from\", formataddr((\"Ich schrei sonst!\", fromaddr)))\n \n     # Warn on trailing slash which can result in malformed double-slashed URLs\n     if parser.get(\"server\", \"public-endpoint\").endswith(\"/\"):\n         public_endpoint = parser.get(\"server\", \"public-endpoint\")\n-        logger.warning(\"In your config file, '[server] public-endpoint' has a slash at the end, \"\n-                       \"please remove it: '%s' -> '%s'\",\n-                       public_endpoint, public_endpoint.rstrip(\"/\"))\n+        logger.warning(\n+            \"In your config file, '[server] public-endpoint' has a slash at the end, please remove it: '%s' -> '%s'\",\n+            public_endpoint,\n+            public_endpoint.rstrip(\"/\"),\n+        )\n         # XXX Actually fail here in a future version\n         logger.warning(\"A future version of Isso might quit with an error if 'public-endpoint' is set incorrectly\")\n         # Remove trailing slash"
    },
    {
      "sha": "a50d6a46e266475f13ee263554b084ccf1e155ef",
      "filename": "isso/core.py",
      "status": "modified",
      "additions": 2,
      "deletions": 8,
      "changes": 10,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fcore.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fcore.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fcore.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -37,7 +37,6 @@ def delete(self, cache, key):\n \n \n class Mixin(object):\n-\n     def __init__(self, conf):\n         self.lock = threading.Lock()\n         self.cache = Cache(NullCache())\n@@ -52,15 +51,13 @@ def threaded(func):\n     \"\"\"\n \n     def dec(self, *args, **kwargs):\n-        thread.start_new_thread(func, (self, ) + args, kwargs)\n+        thread.start_new_thread(func, (self,) + args, kwargs)\n \n     return dec\n \n \n class ThreadedMixin(Mixin):\n-\n     def __init__(self, conf):\n-\n         super(ThreadedMixin, self).__init__(conf)\n \n         if conf.getboolean(\"moderation\", \"enabled\"):\n@@ -77,9 +74,7 @@ def purge(self, delta):\n \n \n class ProcessMixin(ThreadedMixin):\n-\n     def __init__(self, conf):\n-\n         super(ProcessMixin, self).__init__(conf)\n         self.lock = multiprocessing.Lock()\n \n@@ -107,9 +102,7 @@ def delete(self, cache, key):\n \n \n class uWSGIMixin(Mixin):\n-\n     def __init__(self, conf):\n-\n         super(uWSGIMixin, self).__init__(conf)\n \n         self.lock = multiprocessing.Lock()\n@@ -119,6 +112,7 @@ def __init__(self, conf):\n \n         def purge(signum):\n             return self.db.comments.purge(timedelta)\n+\n         uwsgi.register_signal(1, \"\", purge)\n         uwsgi.add_timer(1, timedelta)\n "
    },
    {
      "sha": "d7ba0a928e36af23f8bd562dda0707809c598d37",
      "filename": "isso/db/__init__.py",
      "status": "modified",
      "additions": 44,
      "deletions": 42,
      "changes": 86,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fdb%2F__init__.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fdb%2F__init__.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fdb%2F__init__.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -25,13 +25,11 @@ class SQLite3:\n     MAX_VERSION = 5\n \n     def __init__(self, path, conf):\n-\n         self.path = os.path.expanduser(path)\n         self.conf = conf\n \n-        rv = self.execute([\n-            \"SELECT name FROM sqlite_master\"\n-            \"   WHERE type='table' AND name IN ('threads', 'comments', 'preferences')\"]\n+        rv = self.execute(\n+            [\"SELECT name FROM sqlite_master   WHERE type='table' AND name IN ('threads', 'comments', 'preferences')\"]\n         ).fetchone()\n \n         self.preferences = Preferences(self)\n@@ -44,17 +42,19 @@ def __init__(self, path, conf):\n         else:\n             self.migrate(to=SQLite3.MAX_VERSION)\n \n-        self.execute([\n-            'CREATE TRIGGER IF NOT EXISTS remove_stale_threads',\n-            'AFTER DELETE ON comments',\n-            'BEGIN',\n-            '    DELETE FROM threads WHERE id NOT IN (SELECT tid FROM comments);',\n-            'END'])\n+        self.execute(\n+            [\n+                \"CREATE TRIGGER IF NOT EXISTS remove_stale_threads\",\n+                \"AFTER DELETE ON comments\",\n+                \"BEGIN\",\n+                \"    DELETE FROM threads WHERE id NOT IN (SELECT tid FROM comments);\",\n+                \"END\",\n+            ]\n+        )\n \n     def execute(self, sql, args=()):\n-\n         if isinstance(sql, (list, tuple)):\n-            sql = ' '.join(sql)\n+            sql = \" \".join(sql)\n \n         with sqlite3.connect(self.path) as con:\n             return con.execute(sql, args)\n@@ -64,7 +64,6 @@ def version(self):\n         return self.execute(\"PRAGMA user_version\").fetchone()[0]\n \n     def migrate(self, to):\n-\n         if self.version >= to:\n             return\n \n@@ -73,37 +72,40 @@ def migrate(self, to):\n         # re-initialize voters blob due a bug in the bloomfilter signature\n         # which added older commenter's ip addresses to the current voters blob\n         if self.version == 0:\n-\n             from isso.utils import Bloomfilter\n+\n             bf = memoryview(Bloomfilter(iterable=[\"127.0.0.0\"]).array)\n \n             with sqlite3.connect(self.path) as con:\n                 con.execute(\"BEGIN TRANSACTION\")\n                 try:\n-                    con.execute('UPDATE comments SET voters=?', (bf, ))\n-                    con.execute('PRAGMA user_version = 1')\n+                    con.execute(\"UPDATE comments SET voters=?\", (bf,))\n+                    con.execute(\"PRAGMA user_version = 1\")\n                     con.execute(\"COMMIT\")\n-                    logger.info(\"Migrating DB version 0 to 1 by re-initializing voters blob, %i rows changed\",\n-                                con.total_changes)\n+                    logger.info(\n+                        \"Migrating DB version 0 to 1 by re-initializing voters blob, %i rows changed\", con.total_changes\n+                    )\n                 except sqlite3.Error as e:\n                     con.execute(\"ROLLBACK\")\n                     logger.error(\"Migrating DB version 0 to 1 failed: %s\", e)\n                     raise RuntimeError(\"Migrating DB version 0 to 1 failed: %s\" % e)\n \n         # move [general] session-key to database\n         if self.version == 1:\n-\n             with sqlite3.connect(self.path) as con:\n                 con.execute(\"BEGIN TRANSACTION\")\n                 try:\n                     if self.conf.has_option(\"general\", \"session-key\"):\n-                        con.execute('UPDATE preferences SET value=? WHERE key=?', (\n-                            self.conf.get(\"general\", \"session-key\"), \"session-key\"))\n+                        con.execute(\n+                            \"UPDATE preferences SET value=? WHERE key=?\",\n+                            (self.conf.get(\"general\", \"session-key\"), \"session-key\"),\n+                        )\n \n-                    con.execute('PRAGMA user_version = 2')\n+                    con.execute(\"PRAGMA user_version = 2\")\n                     con.execute(\"COMMIT\")\n-                    logger.info(\"Migrating DB version 1 to 2 by moving session-key to database, %i rows changed\",\n-                                con.total_changes)\n+                    logger.info(\n+                        \"Migrating DB version 1 to 2 by moving session-key to database, %i rows changed\", con.total_changes\n+                    )\n                 except sqlite3.Error as e:\n                     con.execute(\"ROLLBACK\")\n                     logger.error(\"Migrating DB version 1 to 2 failed: %s\", e)\n@@ -116,31 +118,30 @@ def first(rv):\n                 return list(map(operator.itemgetter(0), rv))\n \n             with sqlite3.connect(self.path) as con:\n-                top = first(con.execute(\n-                    \"SELECT id FROM comments WHERE parent IS NULL\").fetchall())\n+                top = first(con.execute(\"SELECT id FROM comments WHERE parent IS NULL\").fetchall())\n                 flattened = defaultdict(set)\n \n                 for id in top:\n-\n-                    ids = [id, ]\n+                    ids = [\n+                        id,\n+                    ]\n \n                     while ids:\n-                        rv = first(con.execute(\n-                            \"SELECT id FROM comments WHERE parent=?\", (ids.pop(), )))\n+                        rv = first(con.execute(\"SELECT id FROM comments WHERE parent=?\", (ids.pop(),)))\n                         ids.extend(rv)\n                         flattened[id].update(set(rv))\n \n                 con.execute(\"BEGIN TRANSACTION\")\n                 try:\n                     for id in flattened.keys():\n                         for n in flattened[id]:\n-                            con.execute(\n-                                \"UPDATE comments SET parent=? WHERE id=?\", (id, n))\n+                            con.execute(\"UPDATE comments SET parent=? WHERE id=?\", (id, n))\n \n-                    con.execute('PRAGMA user_version = 3')\n+                    con.execute(\"PRAGMA user_version = 3\")\n                     con.execute(\"COMMIT\")\n-                    logger.info(\"Migrating DB version 2 to 3 by limiting nesting level to 1, %i rows changed\",\n-                                con.total_changes)\n+                    logger.info(\n+                        \"Migrating DB version 2 to 3 by limiting nesting level to 1, %i rows changed\", con.total_changes\n+                    )\n                 except sqlite3.Error as e:\n                     con.execute(\"ROLLBACK\")\n                     logger.error(\"Migrating DB version 2 to 3 failed: %s\", e)\n@@ -176,10 +177,11 @@ def first(rv):\n                     con.execute(\"ALTER TABLE comments_new RENAME TO comments\")\n                     con.execute(\"DROP TABLE comments_backup_v4\")\n \n-                    con.execute('PRAGMA user_version = 5')\n+                    con.execute(\"PRAGMA user_version = 5\")\n                     con.execute(\"COMMIT\")\n-                    logger.info(\"Migrating DB version 4 to 5 by setting empty comments.text to '', %i rows changed\",\n-                                con.total_changes)\n+                    logger.info(\n+                        \"Migrating DB version 4 to 5 by setting empty comments.text to '', %i rows changed\", con.total_changes\n+                    )\n                 except sqlite3.Error as e:\n                     con.execute(\"ROLLBACK\")\n                     logger.error(\"Migrating DB version 4 to 5 failed: %s\", e)\n@@ -188,15 +190,15 @@ def first(rv):\n     def migrate_to_version_4(self, con):\n         # check if \"notification\" column exists in \"comments\" table\n         rv = con.execute(\"PRAGMA table_info(comments)\").fetchall()\n-        if any([row[1] == 'notification' for row in rv]):\n+        if any([row[1] == \"notification\" for row in rv]):\n             logger.info(\"Migrating DB version 3 to 4 skipped, 'notification' field already exists in comments\")\n-            con.execute('PRAGMA user_version = 4')\n+            con.execute(\"PRAGMA user_version = 4\")\n             return\n \n         con.execute(\"BEGIN TRANSACTION\")\n         try:\n-            con.execute('ALTER TABLE comments ADD COLUMN notification INTEGER DEFAULT 0;')\n-            con.execute('PRAGMA user_version = 4')\n+            con.execute(\"ALTER TABLE comments ADD COLUMN notification INTEGER DEFAULT 0;\")\n+            con.execute(\"PRAGMA user_version = 4\")\n             con.execute(\"COMMIT\")\n             logger.info(\"Migrating DB version 3 to 4 by adding 'notification' field to comments\")\n         except sqlite3.Error as e:"
    },
    {
      "sha": "edffddab76312dd240bf03712f3364a2c8fbdfde",
      "filename": "isso/db/comments.py",
      "status": "modified",
      "additions": 194,
      "deletions": 147,
      "changes": 341,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fdb%2Fcomments.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fdb%2Fcomments.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fdb%2Fcomments.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -25,17 +25,30 @@ class Comments:\n     The tuple (tid, id) is unique and thus primary key.\n     \"\"\"\n \n-    fields = ['tid', 'id', 'parent', 'created', 'modified',\n-              'mode',  # status of the comment 1 = valid, 2 = pending,\n-                       # 4 = soft-deleted (cannot hard delete because of replies)\n-              'remote_addr', 'text', 'author', 'email', 'website',\n-              'likes', 'dislikes', 'voters', 'notification']\n+    fields = [\n+        \"tid\",\n+        \"id\",\n+        \"parent\",\n+        \"created\",\n+        \"modified\",\n+        \"mode\",  # status of the comment 1 = valid, 2 = pending,\n+        # 4 = soft-deleted (cannot hard delete because of replies)\n+        \"remote_addr\",\n+        \"text\",\n+        \"author\",\n+        \"email\",\n+        \"website\",\n+        \"likes\",\n+        \"dislikes\",\n+        \"voters\",\n+        \"notification\",\n+    ]\n \n     # This method is used in the migration script from version 4 to 5.\n     # You need to write a new migration if you change the database schema!\n     @staticmethod\n     def create_table_query(table_name):\n-        return f'''\n+        return f\"\"\"\n             CREATE TABLE IF NOT EXISTS {table_name} (\n                 tid REFERENCES threads(id),\n                 id INTEGER PRIMARY KEY,\n@@ -53,10 +66,9 @@ def create_table_query(table_name):\n                 voters BLOB NOT NULL,\n                 notification INTEGER DEFAULT 0\n             );\n-        '''\n+        \"\"\"\n \n     def __init__(self, db):\n-\n         self.db = db\n         self.db.execute(Comments.create_table_query(\"comments\"))\n \n@@ -74,49 +86,64 @@ def _find(uri, parent):\n             obj = self.get(parent)\n             if obj is None:  # parent does not exist\n                 return None\n-            rv = self.db.execute([\n-                'SELECT CASE WHEN EXISTS(',\n-                '   SELECT comments.id FROM comments INNER JOIN threads',\n-                '       ON comments.tid=threads.id WHERE threads.uri=?',\n-                '       AND comments.id=?)',\n-                '   THEN 1 ELSE 0 END;'],\n-                (uri, parent)).fetchone()\n+            rv = self.db.execute(\n+                [\n+                    \"SELECT CASE WHEN EXISTS(\",\n+                    \"   SELECT comments.id FROM comments INNER JOIN threads\",\n+                    \"       ON comments.tid=threads.id WHERE threads.uri=?\",\n+                    \"       AND comments.id=?)\",\n+                    \"   THEN 1 ELSE 0 END;\",\n+                ],\n+                (uri, parent),\n+            ).fetchone()\n             if rv[0] == 0:  # parent is not in current thread\n                 return None\n             return _find(uri, obj.get(\"parent\")) or parent\n \n         if c.get(\"parent\") is not None:\n             c[\"parent\"] = _find(uri, c[\"parent\"])\n \n-        self.db.execute([\n-            'INSERT INTO comments (',\n-            '    tid, parent,'\n-            '    created, modified, mode, remote_addr,',\n-            '    text, author, email, website, voters, notification)',\n-            'SELECT',\n-            '    threads.id, ?,',\n-            '    ?, ?, ?, ?,',\n-            '    ?, ?, ?, ?, ?, ?',\n-            'FROM threads WHERE threads.uri = ?;'], (\n-            c.get('parent'),\n-            c.get('created') or time.time(), None, c[\"mode\"], c['remote_addr'],\n-            c['text'], c.get('author'), c.get('email'), c.get('website'), memoryview(\n-                Bloomfilter(iterable=[c['remote_addr']]).array), c.get('notification'),\n-            uri)\n+        self.db.execute(\n+            [\n+                \"INSERT INTO comments (\",\n+                \"    tid, parent,    created, modified, mode, remote_addr,\",\n+                \"    text, author, email, website, voters, notification)\",\n+                \"SELECT\",\n+                \"    threads.id, ?,\",\n+                \"    ?, ?, ?, ?,\",\n+                \"    ?, ?, ?, ?, ?, ?\",\n+                \"FROM threads WHERE threads.uri = ?;\",\n+            ],\n+            (\n+                c.get(\"parent\"),\n+                c.get(\"created\") or time.time(),\n+                None,\n+                c[\"mode\"],\n+                c[\"remote_addr\"],\n+                c[\"text\"],\n+                c.get(\"author\"),\n+                c.get(\"email\"),\n+                c.get(\"website\"),\n+                memoryview(Bloomfilter(iterable=[c[\"remote_addr\"]]).array),\n+                c.get(\"notification\"),\n+                uri,\n+            ),\n         )\n \n-        return dict(zip(Comments.fields, self.db.execute(\n-            'SELECT *, MAX(c.id) FROM comments AS c INNER JOIN threads ON threads.uri = ?',\n-            (uri, )).fetchone()))\n+        return dict(\n+            zip(\n+                Comments.fields,\n+                self.db.execute(\n+                    \"SELECT *, MAX(c.id) FROM comments AS c INNER JOIN threads ON threads.uri = ?\", (uri,)\n+                ).fetchone(),\n+            )\n+        )\n \n     def activate(self, id):\n         \"\"\"\n         Activate comment id if pending.\n         \"\"\"\n-        self.db.execute([\n-            'UPDATE comments SET',\n-            '    mode=1',\n-            'WHERE id=? AND mode=2'], (id, ))\n+        self.db.execute([\"UPDATE comments SET\", \"    mode=1\", \"WHERE id=? AND mode=2\"], (id,))\n \n     def is_previously_approved_author(self, email):\n         \"\"\"\n@@ -128,11 +155,15 @@ def is_previously_approved_author(self, email):\n             # search for any activated comments within the last 6 months by email\n             # this SQL should be one of the fastest ways of doing this check\n             # https://stackoverflow.com/questions/18114458/fastest-way-to-determine-if-record-exists\n-            rv = self.db.execute([\n-                'SELECT CASE WHEN EXISTS(',\n-                '    select * from comments where email=? and mode=1 and ',\n-                '    created > strftime(\"%s\", DATETIME(\"now\", \"-6 month\"))',\n-                ') THEN 1 ELSE 0 END;'], (email,)).fetchone()\n+            rv = self.db.execute(\n+                [\n+                    \"SELECT CASE WHEN EXISTS(\",\n+                    \"    select * from comments where email=? and mode=1 and \",\n+                    '    created > strftime(\"%s\", DATETIME(\"now\", \"-6 month\"))',\n+                    \") THEN 1 ELSE 0 END;\",\n+                ],\n+                (email,),\n+            ).fetchone()\n             return rv[0] == 1\n         else:\n             return False\n@@ -141,21 +172,18 @@ def unsubscribe(self, email, id):\n         \"\"\"\n         Turn off email notifications for replies to this comment.\n         \"\"\"\n-        self.db.execute([\n-            'UPDATE comments SET',\n-            '    notification=0',\n-            'WHERE email=? AND (id=? OR parent=?);'], (email, id, id))\n+        self.db.execute(\n+            [\"UPDATE comments SET\", \"    notification=0\", \"WHERE email=? AND (id=? OR parent=?);\"], (email, id, id)\n+        )\n \n     def update(self, id, data):\n         \"\"\"\n         Update comment :param:`id` with values from :param:`data` and return\n         updated comment.\n         \"\"\"\n-        self.db.execute([\n-            'UPDATE comments SET',\n-            ','.join(key + '=' + '?' for key in data),\n-            'WHERE id=?;'],\n-            list(data.values()) + [id])\n+        self.db.execute(\n+            [\"UPDATE comments SET\", \",\".join(key + \"=\" + \"?\" for key in data), \"WHERE id=?;\"], list(data.values()) + [id]\n+        )\n \n         return self.get(id)\n \n@@ -164,8 +192,7 @@ def get(self, id):\n         Search for comment :param:`id` and return a mapping of :attr:`fields`\n         and values.\n         \"\"\"\n-        rv = self.db.execute(\n-            'SELECT * FROM comments WHERE id=?', (id, )).fetchone()\n+        rv = self.db.execute(\"SELECT * FROM comments WHERE id=?\", (id,)).fetchone()\n         if rv:\n             return dict(zip(Comments.fields, rv))\n \n@@ -175,117 +202,130 @@ def count_modes(self):\n         \"\"\"\n         Return comment mode counts for admin\n         \"\"\"\n-        comment_count = self.db.execute(\n-            'SELECT mode, COUNT(comments.id) FROM comments '\n-            'GROUP BY comments.mode').fetchall()\n+        comment_count = self.db.execute(\"SELECT mode, COUNT(comments.id) FROM comments GROUP BY comments.mode\").fetchall()\n         return dict(comment_count)\n \n-    def fetchall(self, mode=5, after=0, parent='any', order_by='id',\n-                 limit=100, page=0, asc=1, comment_id=None, thread_uri=None):\n+    def fetchall(\n+        self, mode=5, after=0, parent=\"any\", order_by=\"id\", limit=100, page=0, asc=1, comment_id=None, thread_uri=None\n+    ):\n         \"\"\"\n         Return comments for admin with :param:`mode`.\n         \"\"\"\n-        fields_comments = ['tid', 'id', 'parent', 'created', 'modified',\n-                           'mode', 'remote_addr', 'text', 'author',\n-                           'email', 'website', 'likes', 'dislikes']\n-        fields_threads = ['uri', 'title']\n-        sql_comments_fields = ', '.join(['comments.' + f\n-                                         for f in fields_comments])\n-        sql_threads_fields = ', '.join(['threads.' + f\n-                                        for f in fields_threads])\n-        sql = ['SELECT ' + sql_comments_fields + ', ' + sql_threads_fields + ' '\n-               'FROM comments INNER JOIN threads '\n-               'ON comments.tid=threads.id '\n-               'WHERE ']\n+        fields_comments = [\n+            \"tid\",\n+            \"id\",\n+            \"parent\",\n+            \"created\",\n+            \"modified\",\n+            \"mode\",\n+            \"remote_addr\",\n+            \"text\",\n+            \"author\",\n+            \"email\",\n+            \"website\",\n+            \"likes\",\n+            \"dislikes\",\n+        ]\n+        fields_threads = [\"uri\", \"title\"]\n+        sql_comments_fields = \", \".join([\"comments.\" + f for f in fields_comments])\n+        sql_threads_fields = \", \".join([\"threads.\" + f for f in fields_threads])\n+        sql = [\n+            \"SELECT \" + sql_comments_fields + \", \" + sql_threads_fields + \" \"\n+            \"FROM comments INNER JOIN threads \"\n+            \"ON comments.tid=threads.id \"\n+            \"WHERE \"\n+        ]\n \n         if comment_id:\n-            sql.append('comments.id = ? ')\n+            sql.append(\"comments.id = ? \")\n             sql_args = [comment_id]\n         elif thread_uri:\n-            sql.append('threads.uri = ? ')\n+            sql.append(\"threads.uri = ? \")\n             sql_args = [thread_uri]\n         else:\n-            sql.append('comments.mode = ? ')\n+            sql.append(\"comments.mode = ? \")\n             sql_args = [mode]\n \n-        if parent != 'any':\n+        if parent != \"any\":\n             if parent is None:\n-                sql.append('AND comments.parent IS NULL')\n+                sql.append(\"AND comments.parent IS NULL\")\n             else:\n-                sql.append('AND comments.parent=?')\n+                sql.append(\"AND comments.parent=?\")\n                 sql_args.append(parent)\n \n         # custom sanitization\n-        if order_by not in ['id', 'created', 'modified', 'likes', 'dislikes', 'tid']:\n-            sql.append('ORDER BY CASE WHEN comments.parent IS NOT NULL THEN comments.created END, ')\n-            sql.append('comments.created')\n+        if order_by not in [\"id\", \"created\", \"modified\", \"likes\", \"dislikes\", \"tid\"]:\n+            sql.append(\"ORDER BY CASE WHEN comments.parent IS NOT NULL THEN comments.created END, \")\n+            sql.append(\"comments.created\")\n             if not asc:\n-                sql.append(' DESC')\n+                sql.append(\" DESC\")\n         else:\n-            sql.append('ORDER BY CASE WHEN comments.parent IS NOT NULL THEN comments.created END, ')\n-            sql.append('comments.' + order_by)\n+            sql.append(\"ORDER BY CASE WHEN comments.parent IS NOT NULL THEN comments.created END, \")\n+            sql.append(\"comments.\" + order_by)\n             if not asc:\n-                sql.append(' DESC')\n-            sql.append(', comments.created')\n+                sql.append(\" DESC\")\n+            sql.append(\", comments.created\")\n \n         if limit:\n-            sql.append('LIMIT ?,?')\n+            sql.append(\"LIMIT ?,?\")\n             sql_args.append(page * limit)\n             sql_args.append(limit)\n \n         rv = self.db.execute(sql, sql_args).fetchall()\n         for item in rv:\n             yield dict(zip(fields_comments + fields_threads, item))\n \n-    def fetch(self, uri, mode=5, after=0, parent='any',\n-              order_by='id', asc=1, limit=None, offset=0):\n+    def fetch(self, uri, mode=5, after=0, parent=\"any\", order_by=\"id\", asc=1, limit=None, offset=0):\n         \"\"\"\n         Return comments for :param:`uri` with :param:`mode`.\n         \"\"\"\n-        sql = ['SELECT comments.*, likes - dislikes AS karma FROM comments INNER JOIN threads ON',\n-               '    threads.uri=? AND comments.tid=threads.id AND (? | comments.mode) = ?',\n-               '    AND comments.created>?']\n+        sql = [\n+            \"SELECT comments.*, likes - dislikes AS karma FROM comments INNER JOIN threads ON\",\n+            \"    threads.uri=? AND comments.tid=threads.id AND (? | comments.mode) = ?\",\n+            \"    AND comments.created>?\",\n+        ]\n \n         sql_args = [uri, mode, mode, after]\n \n-        if parent != 'any':\n+        if parent != \"any\":\n             if parent is None:\n-                sql.append('AND comments.parent IS NULL')\n+                sql.append(\"AND comments.parent IS NULL\")\n             else:\n-                sql.append('AND comments.parent=?')\n+                sql.append(\"AND comments.parent=?\")\n                 sql_args.append(parent)\n \n         # custom sanitization\n-        if order_by not in ['id', 'created', 'modified', 'likes', 'dislikes', 'karma']:\n-            order_by = 'created'\n-        sql.append('ORDER BY CASE WHEN comments.parent IS NOT NULL THEN comments.created END, ')\n+        if order_by not in [\"id\", \"created\", \"modified\", \"likes\", \"dislikes\", \"karma\"]:\n+            order_by = \"created\"\n+        sql.append(\"ORDER BY CASE WHEN comments.parent IS NOT NULL THEN comments.created END, \")\n         sql.append(order_by)\n         if not asc:\n-            sql.append(' DESC')\n+            sql.append(\" DESC\")\n \n         if offset and limit:\n-            sql.append('LIMIT ?,?')\n+            sql.append(\"LIMIT ?,?\")\n             sql_args.append(offset)\n             sql_args.append(limit)\n         elif limit:\n-            sql.append('LIMIT ?')\n+            sql.append(\"LIMIT ?\")\n             sql_args.append(limit)\n \n         rv = self.db.execute(sql, sql_args).fetchall()\n         for item in rv:\n             yield dict(zip(Comments.fields, item))\n \n     def _remove_stale(self):\n-\n-        sql = ('DELETE FROM',\n-               '    comments',\n-               'WHERE',\n-               '    mode=4 AND id NOT IN (',\n-               '        SELECT',\n-               '            parent',\n-               '        FROM',\n-               '            comments',\n-               '        WHERE parent IS NOT NULL)')\n+        sql = (\n+            \"DELETE FROM\",\n+            \"    comments\",\n+            \"WHERE\",\n+            \"    mode=4 AND id NOT IN (\",\n+            \"        SELECT\",\n+            \"            parent\",\n+            \"        FROM\",\n+            \"            comments\",\n+            \"        WHERE parent IS NOT NULL)\",\n+        )\n \n         while self.db.execute(sql).rowcount:\n             continue\n@@ -301,19 +341,17 @@ def delete(self, id):\n         In the second case this comment can be safely removed without any side\n         effects.\"\"\"\n \n-        refs = self.db.execute(\n-            'SELECT * FROM comments WHERE parent=?', (id, )).fetchone()\n+        refs = self.db.execute(\"SELECT * FROM comments WHERE parent=?\", (id,)).fetchone()\n \n         if refs is None:\n-            self.db.execute('DELETE FROM comments WHERE id=?', (id, ))\n+            self.db.execute(\"DELETE FROM comments WHERE id=?\", (id,))\n             self._remove_stale()\n             return None\n \n-        self.db.execute('UPDATE comments SET text=? WHERE id=?', ('', id))\n-        self.db.execute('UPDATE comments SET mode=? WHERE id=?', (4, id))\n-        for field in ('author', 'website'):\n-            self.db.execute('UPDATE comments SET %s=? WHERE id=?' %\n-                            field, (None, id))\n+        self.db.execute(\"UPDATE comments SET text=? WHERE id=?\", (\"\", id))\n+        self.db.execute(\"UPDATE comments SET mode=? WHERE id=?\", (4, id))\n+        for field in (\"author\", \"website\"):\n+            self.db.execute(\"UPDATE comments SET %s=? WHERE id=?\" % field, (None, id))\n \n         self._remove_stale()\n         return self.get(id)\n@@ -323,47 +361,54 @@ def vote(self, upvote, id, remote_addr):\n         the creater can't vote on his/her own comment and multiple votes from the\n         same ip address are ignored as well).\"\"\"\n \n-        rv = self.db.execute(\n-            'SELECT likes, dislikes, voters FROM comments WHERE id=?', (id, )) \\\n-            .fetchone()\n+        rv = self.db.execute(\"SELECT likes, dislikes, voters FROM comments WHERE id=?\", (id,)).fetchone()\n \n         if rv is None:\n             return None\n \n-        operation_name = 'Upvote' if upvote else 'Downvote'\n+        operation_name = \"Upvote\" if upvote else \"Downvote\"\n         likes, dislikes, voters = rv\n         if likes + dislikes >= MAX_LIKES_AND_DISLIKES:\n-            message = '{} denied due to a \"likes + dislikes\" total too high ({} >= {})'.format(operation_name, likes + dislikes, MAX_LIKES_AND_DISLIKES)\n-            logger.debug('Comments.vote(id=%s): %s', id, message)\n-            return {'likes': likes, 'dislikes': dislikes, 'message': message}\n+            message = '{} denied due to a \"likes + dislikes\" total too high ({} >= {})'.format(\n+                operation_name, likes + dislikes, MAX_LIKES_AND_DISLIKES\n+            )\n+            logger.debug(\"Comments.vote(id=%s): %s\", id, message)\n+            return {\"likes\": likes, \"dislikes\": dislikes, \"message\": message}\n \n         bf = Bloomfilter(bytearray(voters), likes + dislikes)\n         if remote_addr in bf:\n-            message = '{} denied because a vote has already been registered for this remote address: {}'.format(operation_name, remote_addr)\n-            logger.debug('Comments.vote(id=%s): %s', id, message)\n-            return {'likes': likes, 'dislikes': dislikes, 'message': message}\n+            message = \"{} denied because a vote has already been registered for this remote address: {}\".format(\n+                operation_name, remote_addr\n+            )\n+            logger.debug(\"Comments.vote(id=%s): %s\", id, message)\n+            return {\"likes\": likes, \"dislikes\": dislikes, \"message\": message}\n \n         bf.add(remote_addr)\n-        self.db.execute([\n-            'UPDATE comments SET',\n-            '    likes = likes + 1,' if upvote else 'dislikes = dislikes + 1,',\n-            '    voters = ?'\n-            'WHERE id=?;'], (memoryview(bf.array), id))\n+        self.db.execute(\n+            [\n+                \"UPDATE comments SET\",\n+                \"    likes = likes + 1,\" if upvote else \"dislikes = dislikes + 1,\",\n+                \"    voters = ?WHERE id=?;\",\n+            ],\n+            (memoryview(bf.array), id),\n+        )\n \n         if upvote:\n-            return {'likes': likes + 1, 'dislikes': dislikes}\n-        return {'likes': likes, 'dislikes': dislikes + 1}\n+            return {\"likes\": likes + 1, \"dislikes\": dislikes}\n+        return {\"likes\": likes, \"dislikes\": dislikes + 1}\n \n     def reply_count(self, url, mode=5):\n         \"\"\"\n         Return comment count for main thread and all reply threads for one url.\n         \"\"\"\n \n-        sql = ['SELECT comments.parent,count(*)',\n-               'FROM comments INNER JOIN threads ON',\n-               '   threads.uri=? AND comments.tid=threads.id AND',\n-               '   (? | comments.mode = ?)',\n-               'GROUP BY comments.parent']\n+        sql = [\n+            \"SELECT comments.parent,count(*)\",\n+            \"FROM comments INNER JOIN threads ON\",\n+            \"   threads.uri=? AND comments.tid=threads.id AND\",\n+            \"   (? | comments.mode = ?)\",\n+            \"GROUP BY comments.parent\",\n+        ]\n \n         return dict(self.db.execute(sql, [url, mode, mode]).fetchall())\n \n@@ -372,19 +417,21 @@ def count(self, *urls):\n         Return comment count for one ore more urls..\n         \"\"\"\n \n-        threads = dict(self.db.execute([\n-            'SELECT threads.uri, COUNT(comments.id) FROM comments',\n-            'LEFT OUTER JOIN threads ON threads.id = tid AND comments.mode = 1',\n-            'GROUP BY threads.uri'\n-        ]).fetchall())\n+        threads = dict(\n+            self.db.execute(\n+                [\n+                    \"SELECT threads.uri, COUNT(comments.id) FROM comments\",\n+                    \"LEFT OUTER JOIN threads ON threads.id = tid AND comments.mode = 1\",\n+                    \"GROUP BY threads.uri\",\n+                ]\n+            ).fetchall()\n+        )\n \n         return [threads.get(url, 0) for url in urls]\n \n     def purge(self, delta):\n         \"\"\"\n         Remove stale pending comments older than :param:`delta`.\n         \"\"\"\n-        self.db.execute([\n-            'DELETE FROM comments WHERE mode = 2 AND ? - created > ?;'\n-        ], (time.time(), delta))\n+        self.db.execute([\"DELETE FROM comments WHERE mode = 2 AND ? - created > ?;\"], (time.time(), delta))\n         self._remove_stale()"
    },
    {
      "sha": "db6912765f042ae46b7f2eab78e83f5a56d47f8f",
      "filename": "isso/db/preferences.py",
      "status": "modified",
      "additions": 5,
      "deletions": 12,
      "changes": 17,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fdb%2Fpreferences.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fdb%2Fpreferences.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fdb%2Fpreferences.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -5,32 +5,25 @@\n \n \n class Preferences:\n-\n     defaults = [\n-        (\"session-key\", binascii.b2a_hex(os.urandom(24)).decode('utf-8')),\n+        (\"session-key\", binascii.b2a_hex(os.urandom(24)).decode(\"utf-8\")),\n     ]\n \n     def __init__(self, db):\n-\n         self.db = db\n-        self.db.execute([\n-            'CREATE TABLE IF NOT EXISTS preferences (',\n-            '   key VARCHAR PRIMARY KEY, value VARCHAR',\n-            ');'])\n+        self.db.execute([\"CREATE TABLE IF NOT EXISTS preferences (\", \"   key VARCHAR PRIMARY KEY, value VARCHAR\", \");\"])\n \n-        for (key, value) in Preferences.defaults:\n+        for key, value in Preferences.defaults:\n             if self.get(key) is None:\n                 self.set(key, value)\n \n     def get(self, key, default=None):\n-        rv = self.db.execute(\n-            'SELECT value FROM preferences WHERE key=?', (key, )).fetchone()\n+        rv = self.db.execute(\"SELECT value FROM preferences WHERE key=?\", (key,)).fetchone()\n \n         if rv is None:\n             return default\n \n         return rv[0]\n \n     def set(self, key, value):\n-        self.db.execute(\n-            'INSERT INTO preferences (key, value) VALUES (?, ?)', (key, value))\n+        self.db.execute(\"INSERT INTO preferences (key, value) VALUES (?, ?)\", (key, value))"
    },
    {
      "sha": "ad8b84969428779580986202c4bebb5e61b0fd73",
      "filename": "isso/db/spam.py",
      "status": "modified",
      "additions": 17,
      "deletions": 22,
      "changes": 39,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fdb%2Fspam.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fdb%2Fspam.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fdb%2Fspam.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -5,9 +5,7 @@\n \n \n class Guard:\n-\n     def __init__(self, db):\n-\n         self.db = db\n         self.conf = db.conf.section(\"guard\")\n         try:\n@@ -16,7 +14,6 @@ def __init__(self, db):\n             self.max_age = None\n \n     def validate(self, uri, comment):\n-\n         if not self.conf.getboolean(\"enabled\"):\n             return True, \"\"\n \n@@ -31,37 +28,35 @@ def ids(cls, rv):\n         return [str(col[0]) for col in rv]\n \n     def _limit(self, uri, comment):\n-\n         # block more than :param:`ratelimit` comments per minute\n-        rv = self.db.execute([\n-            'SELECT id FROM comments WHERE remote_addr = ? AND ? - created < 60;'\n-        ], (comment[\"remote_addr\"], time.time())).fetchall()\n+        rv = self.db.execute(\n+            [\"SELECT id FROM comments WHERE remote_addr = ? AND ? - created < 60;\"], (comment[\"remote_addr\"], time.time())\n+        ).fetchall()\n \n         if len(rv) >= self.conf.getint(\"ratelimit\"):\n-            return False, \"{0}: ratelimit exceeded ({1})\".format(\n-                comment[\"remote_addr\"], ', '.join(Guard.ids(rv)))\n+            return False, \"{0}: ratelimit exceeded ({1})\".format(comment[\"remote_addr\"], \", \".join(Guard.ids(rv)))\n \n         # block more than three comments as direct response to the post\n         if comment[\"parent\"] is None:\n-            rv = self.db.execute([\n-                'SELECT id FROM comments WHERE',\n-                '    tid = (SELECT id FROM threads WHERE uri = ?)',\n-                'AND remote_addr = ?',\n-                'AND parent IS NULL;'\n-            ], (uri, comment[\"remote_addr\"])).fetchall()\n+            rv = self.db.execute(\n+                [\n+                    \"SELECT id FROM comments WHERE\",\n+                    \"    tid = (SELECT id FROM threads WHERE uri = ?)\",\n+                    \"AND remote_addr = ?\",\n+                    \"AND parent IS NULL;\",\n+                ],\n+                (uri, comment[\"remote_addr\"]),\n+            ).fetchall()\n \n             if len(rv) >= self.conf.getint(\"direct-reply\"):\n                 return False, \"%i direct responses to %s\" % (len(rv), uri)\n \n         # block replies to self unless :param:`reply-to-self` is enabled\n         elif self.conf.getboolean(\"reply-to-self\") is False:\n-            rv = self.db.execute([\n-                'SELECT id FROM comments WHERE'\n-                '    remote_addr = ?',\n-                'AND id = ?',\n-                'AND ? - created < ?'\n-            ], (comment[\"remote_addr\"], comment[\"parent\"],\n-                time.time(), self.max_age)).fetchall()\n+            rv = self.db.execute(\n+                [\"SELECT id FROM comments WHERE    remote_addr = ?\", \"AND id = ?\", \"AND ? - created < ?\"],\n+                (comment[\"remote_addr\"], comment[\"parent\"], time.time(), self.max_age),\n+            ).fetchall()\n \n             if len(rv) > 0:\n                 return False, \"edit time frame is still open\""
    },
    {
      "sha": "41a40b5c92916bacd00de087dba5011f03e51a5a",
      "filename": "isso/db/threads.py",
      "status": "modified",
      "additions": 11,
      "deletions": 16,
      "changes": 27,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fdb%2Fthreads.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fdb%2Fthreads.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fdb%2Fthreads.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -2,33 +2,28 @@\n \n \n def Thread(id, uri, title):\n-    return {\n-        \"id\": id,\n-        \"uri\": uri,\n-        \"title\": title\n-    }\n+    return {\"id\": id, \"uri\": uri, \"title\": title}\n \n \n class Threads(object):\n-\n     def __init__(self, db):\n-\n         self.db = db\n-        self.db.execute([\n-            'CREATE TABLE IF NOT EXISTS threads (',\n-            '    id INTEGER PRIMARY KEY, uri VARCHAR(256) UNIQUE, title VARCHAR(256))'])\n+        self.db.execute(\n+            [\n+                \"CREATE TABLE IF NOT EXISTS threads (\",\n+                \"    id INTEGER PRIMARY KEY, uri VARCHAR(256) UNIQUE, title VARCHAR(256))\",\n+            ]\n+        )\n \n     def __contains__(self, uri):\n-        return self.db.execute(\"SELECT title FROM threads WHERE uri=?\", (uri, )) \\\n-                      .fetchone() is not None\n+        return self.db.execute(\"SELECT title FROM threads WHERE uri=?\", (uri,)).fetchone() is not None\n \n     def __getitem__(self, uri):\n-        return Thread(*self.db.execute(\"SELECT * FROM threads WHERE uri=?\", (uri, )).fetchone())\n+        return Thread(*self.db.execute(\"SELECT * FROM threads WHERE uri=?\", (uri,)).fetchone())\n \n     def get(self, id):\n-        return Thread(*self.db.execute(\"SELECT * FROM threads WHERE id=?\", (id, )).fetchone())\n+        return Thread(*self.db.execute(\"SELECT * FROM threads WHERE id=?\", (id,)).fetchone())\n \n     def new(self, uri, title):\n-        self.db.execute(\n-            \"INSERT INTO threads (uri, title) VALUES (?, ?)\", (uri, title))\n+        self.db.execute(\"INSERT INTO threads (uri, title) VALUES (?, ?)\", (uri, title))\n         return self[uri]"
    },
    {
      "sha": "cf6330963d63d8a1e87f5be03745a873dc4bdf1b",
      "filename": "isso/dispatch.py",
      "status": "modified",
      "additions": 4,
      "deletions": 6,
      "changes": 10,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fdispatch.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fdispatch.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fdispatch.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -36,22 +36,20 @@ def __init__(self, *confs):\n         super(Dispatcher, self).__init__(self.default, mounts=self.isso)\n \n     def __call__(self, environ, start_response):\n-\n         # clear X-Script-Name as the PATH_INFO is already adjusted\n-        environ.pop('HTTP_X_SCRIPT_NAME', None)\n+        environ.pop(\"HTTP_X_SCRIPT_NAME\", None)\n \n         return super(Dispatcher, self).__call__(environ, start_response)\n \n     def default(self, environ, start_response):\n-        resp = Response(\"\\n\".join(self.isso.keys()),\n-                        404, content_type=\"text/plain\")\n+        resp = Response(\"\\n\".join(self.isso.keys()), 404, content_type=\"text/plain\")\n         return resp(environ, start_response)\n \n \n settings = os.environ.get(\"ISSO_SETTINGS\")\n if settings:\n     if os.path.isdir(settings):\n-        conf_glob = os.path.join(settings, '*.cfg')\n+        conf_glob = os.path.join(settings, \"*.cfg\")\n         confs = glob(conf_glob)\n         application = wsgi.SubURI(Dispatcher(*confs))\n     else:\n@@ -62,4 +60,4 @@ def default(self, environ, start_response):\n                 sys.exit(1)\n     application = wsgi.SubURI(Dispatcher(*confs))\n else:\n-    logger.fatal('environment variable ISSO_SETTINGS must be set')\n+    logger.fatal(\"environment variable ISSO_SETTINGS must be set\")"
    },
    {
      "sha": "3a8a428c802d2f16111fb8ebcefcc43d0d6487ed",
      "filename": "isso/ext/__init__.py",
      "status": "modified",
      "additions": 0,
      "deletions": 1,
      "changes": 1,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fext%2F__init__.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fext%2F__init__.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fext%2F__init__.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -4,7 +4,6 @@\n \n \n class Signal(object):\n-\n     def __init__(self, *subscriber):\n         self.subscriptions = defaultdict(list)\n "
    },
    {
      "sha": "8995352160cb3699c972a91483614648ee78a31d",
      "filename": "isso/ext/notifications.py",
      "status": "modified",
      "additions": 43,
      "deletions": 41,
      "changes": 84,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fext%2Fnotifications.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fext%2Fnotifications.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fext%2Fnotifications.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -12,6 +12,7 @@\n from urllib.parse import quote\n \n import logging\n+\n logger = logging.getLogger(\"isso\")\n \n try:\n@@ -27,23 +28,20 @@ def create_comment_action_url(uri, action, key):\n \n \n class SMTPConnection(object):\n-\n     def __init__(self, conf):\n         self.conf = conf\n \n     def __enter__(self):\n-        klass = (smtplib.SMTP_SSL if self.conf.get(\n-            'security') == 'ssl' else smtplib.SMTP)\n-        self.client = klass(host=self.conf.get('host'),\n-                            port=self.conf.getint('port'),\n-                            timeout=self.conf.getint('timeout'))\n+        klass = smtplib.SMTP_SSL if self.conf.get(\"security\") == \"ssl\" else smtplib.SMTP\n+        self.client = klass(host=self.conf.get(\"host\"), port=self.conf.getint(\"port\"), timeout=self.conf.getint(\"timeout\"))\n \n-        if self.conf.get('security') == 'starttls':\n+        if self.conf.get(\"security\") == \"starttls\":\n             import ssl\n+\n             self.client.starttls(context=ssl.create_default_context())\n \n-        username = self.conf.get('username')\n-        password = self.conf.get('password')\n+        username = self.conf.get(\"username\")\n+        password = self.conf.get(\"password\")\n         if username and password:\n             self.client.login(username, password)\n \n@@ -54,9 +52,7 @@ def __exit__(self, exc_type, exc_value, traceback):\n \n \n class SMTP(object):\n-\n     def __init__(self, isso):\n-\n         self.isso = isso\n         self.conf = isso.conf.section(\"smtp\")\n         self.public_endpoint = isso.conf.get(\"server\", \"public-endpoint\") or local(\"host\")\n@@ -71,12 +67,15 @@ def __init__(self, isso):\n             logger.exception(\"unable to connect to SMTP server\")\n \n         if uwsgi:\n+\n             def spooler(args):\n                 try:\n-                    self._sendmail(args[b\"subject\"].decode(\"utf-8\"),\n-                                   args[\"body\"].decode(\"utf-8\"),\n-                                   args[b\"to\"].decode(\"utf-8\"),\n-                                   args[b\"headers\"].decode(\"utf-8\"))\n+                    self._sendmail(\n+                        args[b\"subject\"].decode(\"utf-8\"),\n+                        args[\"body\"].decode(\"utf-8\"),\n+                        args[b\"to\"].decode(\"utf-8\"),\n+                        args[b\"headers\"].decode(\"utf-8\"),\n+                    )\n                 except smtplib.SMTPConnectError:\n                     return uwsgi.SPOOL_RETRY\n                 else:\n@@ -91,11 +90,10 @@ def __iter__(self):\n     # Add List-Unsubscribe email header\n     def create_headers(self, parent_comment, recipient):\n         uri = self.public_endpoint + \"/id/%i\" % parent_comment[\"id\"]\n-        key = self.isso.sign(('unsubscribe', recipient))\n-        return (('List-Unsubscribe', uri + \"/unsubscribe/\" + quote(recipient) + \"/\" + key),)\n+        key = self.isso.sign((\"unsubscribe\", recipient))\n+        return ((\"List-Unsubscribe\", uri + \"/unsubscribe/\" + quote(recipient) + \"/\" + key),)\n \n     def format(self, thread, comment, parent_comment, recipient=None, admin=False):\n-\n         rv = io.StringIO()\n \n         author = comment[\"author\"] or \"Anonymous\"\n@@ -113,8 +111,7 @@ def format(self, thread, comment, parent_comment, recipient=None, admin=False):\n \n             rv.write(\"IP address: %s\\n\" % comment[\"remote_addr\"])\n \n-        rv.write(\"Link to comment: %s\\n\" %\n-                 (local(\"origin\") + thread[\"uri\"] + \"#isso-%i\" % comment[\"id\"]))\n+        rv.write(\"Link to comment: %s\\n\" % (local(\"origin\") + thread[\"uri\"] + \"#isso-%i\" % comment[\"id\"]))\n         rv.write(\"\\n\")\n         rv.write(\"---\\n\")\n \n@@ -129,7 +126,7 @@ def format(self, thread, comment, parent_comment, recipient=None, admin=False):\n \n         else:\n             uri = self.public_endpoint + \"/id/%i\" % parent_comment[\"id\"]\n-            key = self.isso.sign(('unsubscribe', recipient))\n+            key = self.isso.sign((\"unsubscribe\", recipient))\n \n             rv.write(\"Unsubscribe from this conversation: %s\\n\" % (uri + \"/unsubscribe/\" + quote(recipient) + \"/\" + key))\n \n@@ -140,7 +137,7 @@ def notify_new(self, thread, comment):\n         if self.admin_notify:\n             body = self.format(thread, comment, None, admin=True)\n             subject = \"New comment posted\"\n-            if thread['title']:\n+            if thread[\"title\"]:\n                 subject = \"%s on %s\" % (subject, thread[\"title\"])\n             self.sendmail(subject, body, thread, comment, None)\n \n@@ -159,8 +156,13 @@ def notify_users(self, thread, comment):\n             comments_to_notify += self.isso.db.comments.fetch(thread[\"uri\"], mode=1, parent=comment[\"parent\"])\n             for comment_to_notify in comments_to_notify:\n                 email = comment_to_notify[\"email\"]\n-                if \"email\" in comment_to_notify and comment_to_notify[\"notification\"] and email not in notified \\\n-                        and comment_to_notify[\"id\"] != comment[\"id\"] and email != comment[\"email\"]:\n+                if (\n+                    \"email\" in comment_to_notify\n+                    and comment_to_notify[\"notification\"]\n+                    and email not in notified\n+                    and comment_to_notify[\"id\"] != comment[\"id\"]\n+                    and email != comment[\"email\"]\n+                ):\n                     body = self.format(thread, comment, parent_comment, email, admin=False)\n                     headers = self.create_headers(parent_comment, email)\n                     subject = \"Re: New comment posted on %s\" % thread[\"title\"]\n@@ -171,28 +173,31 @@ def sendmail(self, subject, body, thread, comment, to=None, headers=None):\n         to = to or self.conf.get(\"to\")\n         if not subject:\n             # Fallback, just in case as an empty subject does not work\n-            subject = 'isso notification'\n+            subject = \"isso notification\"\n \n         if uwsgi:\n             if not headers:\n-                headers = ''\n-            uwsgi.spool({b\"subject\": subject.encode(\"utf-8\"),\n-                         b\"body\": body.encode(\"utf-8\"),\n-                         b\"to\": to.encode(\"utf-8\"),\n-                         b\"headers\": headers.encode(\"utf-8\")})\n+                headers = \"\"\n+            uwsgi.spool(\n+                {\n+                    b\"subject\": subject.encode(\"utf-8\"),\n+                    b\"body\": body.encode(\"utf-8\"),\n+                    b\"to\": to.encode(\"utf-8\"),\n+                    b\"headers\": headers.encode(\"utf-8\"),\n+                }\n+            )\n         else:\n             start_new_thread(self._retry, (subject, body, to, headers))\n \n     def _sendmail(self, subject, body, to_addr, headers=None):\n-\n         from_addr = self.conf.get(\"from\")\n \n         msg = EmailMessage()\n-        msg.set_payload(body, 'utf-8')\n-        msg['From'] = from_addr\n-        msg['To'] = to_addr\n-        msg['Date'] = formatdate(localtime=True)\n-        msg['Subject'] = subject\n+        msg.set_payload(body, \"utf-8\")\n+        msg[\"From\"] = from_addr\n+        msg[\"To\"] = to_addr\n+        msg[\"Date\"] = formatdate(localtime=True)\n+        msg[\"Subject\"] = subject\n \n         for key, val in headers if headers else ():\n             msg.add_header(key, val)\n@@ -211,13 +216,11 @@ def _retry(self, subject, body, to, headers):\n \n \n class Stdout(object):\n-\n     def __init__(self, isso):\n         self.isso = isso\n         self.public_endpoint = isso.conf.get(\"server\", \"public-endpoint\") or local(\"host\")\n \n     def __iter__(self):\n-\n         yield \"comments.new:new-thread\", self._new_thread\n         yield \"comments.new:finish\", self._new_comment\n         yield \"comments.edit\", self._edit_comment\n@@ -240,11 +243,10 @@ def _new_comment(self, thread, comment):\n             logger.info(\"Activate comment: %s\" % create_comment_action_url(uri, \"activate\", key))\n \n     def _edit_comment(self, comment):\n-        logger.info('comment %i edited: %s',\n-                    comment[\"id\"], json.dumps(comment))\n+        logger.info(\"comment %i edited: %s\", comment[\"id\"], json.dumps(comment))\n \n     def _delete_comment(self, id):\n-        logger.info('comment %i deleted', id)\n+        logger.info(\"comment %i deleted\", id)\n \n     def _activate_comment(self, thread, comment):\n         logger.info(\"comment %(id)s activated\" % thread)"
    },
    {
      "sha": "540f608e0603273f555741cdd48c80d1016d272c",
      "filename": "isso/html/__init__.py",
      "status": "modified",
      "additions": 52,
      "deletions": 32,
      "changes": 84,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fhtml%2F__init__.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fhtml%2F__init__.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fhtml%2F__init__.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -7,7 +7,6 @@\n \n \n class Sanitizer(object):\n-\n     # pattern to match a valid class attribute for code tags\n     code_language_pattern = re.compile(r\"^language-[a-zA-Z0-9]{1,20}$\")\n \n@@ -21,19 +20,38 @@ def __init__(self, elements, attributes):\n         # - sub and sup added\n         #\n         # [1] https://github.com/vmg/sundown/blob/master/html/html.c\n-        self.elements = [\"a\", \"p\", \"hr\", \"br\", \"ol\", \"ul\", \"li\",\n-                         \"pre\", \"code\", \"blockquote\",\n-                         \"del\", \"ins\", \"strong\", \"em\",\n-                         \"h1\", \"h2\", \"h3\", \"h4\", \"h5\", \"h6\", \"sub\", \"sup\",\n-                         \"table\", \"thead\", \"tbody\", \"th\", \"td\"] + elements\n+        self.elements = [\n+            \"a\",\n+            \"p\",\n+            \"hr\",\n+            \"br\",\n+            \"ol\",\n+            \"ul\",\n+            \"li\",\n+            \"pre\",\n+            \"code\",\n+            \"blockquote\",\n+            \"del\",\n+            \"ins\",\n+            \"strong\",\n+            \"em\",\n+            \"h1\",\n+            \"h2\",\n+            \"h3\",\n+            \"h4\",\n+            \"h5\",\n+            \"h6\",\n+            \"sub\",\n+            \"sup\",\n+            \"table\",\n+            \"thead\",\n+            \"tbody\",\n+            \"th\",\n+            \"td\",\n+        ] + elements\n \n         # allowed attributes for tags\n-        self.attributes = {\n-            \"table\": [\"align\"],\n-            \"a\": [\"href\"],\n-            \"code\": Sanitizer.allow_attribute_class,\n-            \"*\": attributes\n-        }\n+        self.attributes = {\"table\": [\"align\"], \"a\": [\"href\"], \"code\": Sanitizer.allow_attribute_class, \"*\": attributes}\n \n     def sanitize(self, text):\n         clean_html = bleach.clean(text, tags=self.elements, attributes=self.attributes, strip=True)\n@@ -44,56 +62,58 @@ def set_links(attrs, new=False):\n             if new:\n                 return None\n \n-            href_key = (None, u'href')\n+            href_key = (None, \"href\")\n \n             if href_key not in attrs:\n                 return attrs\n-            if attrs[href_key].startswith(u'mailto:'):\n+            if attrs[href_key].startswith(\"mailto:\"):\n                 return attrs\n \n-            rel_key = (None, u'rel')\n-            rel_values = [val for val in attrs.get(rel_key, u'').split(u' ') if val]\n+            rel_key = (None, \"rel\")\n+            rel_values = [val for val in attrs.get(rel_key, \"\").split(\" \") if val]\n \n-            for value in [u'nofollow', u'noopener']:\n+            for value in [\"nofollow\", \"noopener\"]:\n                 if value not in [rel_val.lower() for rel_val in rel_values]:\n                     rel_values.append(value)\n \n-            attrs[rel_key] = u' '.join(rel_values)\n+            attrs[rel_key] = \" \".join(rel_values)\n             return attrs\n \n         linker = bleach.linkifier.Linker(callbacks=[set_links])\n         return linker.linkify(clean_html)\n \n \n class Markup(object):\n-\n     def __init__(self, conf):\n-        conf_markup = conf.section('markup')\n+        conf_markup = conf.section(\"markup\")\n \n-        if conf_markup.has_option('renderer') and conf_markup.get('renderer') == \"mistune\":\n+        if conf_markup.has_option(\"renderer\") and conf_markup.get(\"renderer\") == \"mistune\":\n             from isso.html.mistune import MistuneMarkdown\n-            self.parser = MistuneMarkdown(conf.section('markup.mistune'))\n+\n+            self.parser = MistuneMarkdown(conf.section(\"markup.mistune\"))\n             logging.info(\"Using Mistune as Markdown rendering engine\")\n-        elif not conf_markup.has_option('renderer') or conf_markup.get('renderer') == \"misaka\":\n+        elif not conf_markup.has_option(\"renderer\") or conf_markup.get(\"renderer\") == \"misaka\":\n             # We do not want to depend on Misaka unless it is actually used\n             from isso.html.misaka import MisakaMarkdown\n+\n             self.parser = MisakaMarkdown(conf)\n-            logging.warning(\"Misaka has been deprecated. Please switch to Mistune for \"\n-                            \"Markdown rendering before the next release.\")\n+            logging.warning(\n+                \"Misaka has been deprecated. Please switch to Mistune for Markdown rendering before the next release.\"\n+            )\n         else:\n-            logging.fatal('The `renderer` configuration option is set to an unknown value: %s. '\n-                          'Set to either `mistune` or `misaka`.',\n-                          conf_markup.get('renderer'))\n-            raise ValueError(\"Invalid renderer value: %s. Set to either `mistune` or `misaka`.\"\n-                             % conf_markup.get('renderer'))\n+            logging.fatal(\n+                \"The `renderer` configuration option is set to an unknown value: %s. Set to either `mistune` or `misaka`.\",\n+                conf_markup.get(\"renderer\"),\n+            )\n+            raise ValueError(\"Invalid renderer value: %s. Set to either `mistune` or `misaka`.\" % conf_markup.get(\"renderer\"))\n \n         # Filter out empty strings:\n         allowed_elements = [x for x in conf_markup.getlist(\"allowed-elements\") if x]\n         allowed_attributes = [x for x in conf_markup.getlist(\"allowed-attributes\") if x]\n \n         # If images are allowed, source element should be allowed as well\n-        if 'img' in allowed_elements and 'src' not in allowed_attributes:\n-            allowed_attributes.append('src')\n+        if \"img\" in allowed_elements and \"src\" not in allowed_attributes:\n+            allowed_attributes.append(\"src\")\n         self.sanitizer = Sanitizer(allowed_elements, allowed_attributes)\n \n     def render(self, text):"
    },
    {
      "sha": "cf6d9adcd452a386c102445763da53acc853ea72",
      "filename": "isso/html/markdown.py",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fhtml%2Fmarkdown.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fhtml%2Fmarkdown.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fhtml%2Fmarkdown.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -2,7 +2,7 @@\n \n \n class Markdown(ABC):\n-    \"\"\" Abstract base class for rendering Markdown to HTML \"\"\"\n+    \"\"\"Abstract base class for rendering Markdown to HTML\"\"\"\n \n     @property\n     @abstractmethod"
    },
    {
      "sha": "ab902474104cd07441e6eccbea902008d33a3be9",
      "filename": "isso/html/misaka.py",
      "status": "modified",
      "additions": 21,
      "deletions": 13,
      "changes": 34,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fhtml%2Fmisaka.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fhtml%2Fmisaka.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fhtml%2Fmisaka.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -17,7 +17,7 @@ class Unofficial(misaka.HtmlRenderer):\n     \"\"\"\n \n     def blockcode(self, text, lang):\n-        lang = ' class=\"language-{0}\"'.format(html.escape(lang)) if lang else ''\n+        lang = ' class=\"language-{0}\"'.format(html.escape(lang)) if lang else \"\"\n         return \"<pre><code{1}>{0}</code></pre>\\n\".format(html.escape(text, False), lang)\n \n \n@@ -31,8 +31,8 @@ def __init__(self, conf=None):\n                      the Markup and Markup.misaka sections.\n         \"\"\"\n         if conf is not None:\n-            misaka_markup_section = conf.section('markup.misaka')\n-            markup_section = conf.section('markup')\n+            misaka_markup_section = conf.section(\"markup.misaka\")\n+            markup_section = conf.section(\"markup\")\n \n             self._flags = misaka_markup_section.getlist(\"flags\")\n             self._extensions = misaka_markup_section.getlist(\"options\")\n@@ -42,26 +42,34 @@ def __init__(self, conf=None):\n                 markup_flags = markup_section.getlist(\"flags\")\n             if markup_flags:\n                 if self._flags:\n-                    logger.warning('The configuration setting flags is set in both sections Markup and Markup.misaka. '\n-                                   'The setting in section Markup has been deprecated and is ignored.')\n+                    logger.warning(\n+                        \"The configuration setting flags is set in both sections Markup and Markup.misaka. \"\n+                        \"The setting in section Markup has been deprecated and is ignored.\"\n+                    )\n                 else:\n                     self._flags = markup_section.getlist(\"flags\")\n-                    logger.warning('The configuration setting flags in section Markup has been deprecated. Please move '\n-                                   'the setting to the new section Markup.misaka or preferably replace Misaka with '\n-                                   'Mistune entirely.')\n+                    logger.warning(\n+                        \"The configuration setting flags in section Markup has been deprecated. Please move \"\n+                        \"the setting to the new section Markup.misaka or preferably replace Misaka with \"\n+                        \"Mistune entirely.\"\n+                    )\n \n             markup_options = None\n             if markup_section.has_option(\"options\"):\n                 markup_options = markup_section.getlist(\"options\")\n             if markup_options:\n                 if self._extensions:\n-                    logger.warning('The configuration setting options is set in both sections Markup and '\n-                                   'Markup.misaka. The setting in section Markup has been deprecated and is ignored.')\n+                    logger.warning(\n+                        \"The configuration setting options is set in both sections Markup and \"\n+                        \"Markup.misaka. The setting in section Markup has been deprecated and is ignored.\"\n+                    )\n                 else:\n                     self._extensions = markup_section.getlist(\"options\")\n-                    logger.warning('The configuration setting options in section Markup has been deprecated. Please '\n-                                   'move the setting to the new section Markup.misaka or preferably replace Misaka '\n-                                   'with Mistune entirely.')\n+                    logger.warning(\n+                        \"The configuration setting options in section Markup has been deprecated. Please \"\n+                        \"move the setting to the new section Markup.misaka or preferably replace Misaka \"\n+                        \"with Mistune entirely.\"\n+                    )\n \n             # Normalize render flags and extensions for Misaka 2.0, which uses\n             # `dashed-case` instead of `snake_case` (Misaka 1.x) for options."
    },
    {
      "sha": "3e1d9cd2d9e5fe6e884154d6897e46d2ba221dc4",
      "filename": "isso/html/mistune.py",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fhtml%2Fmistune.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fhtml%2Fmistune.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fhtml%2Fmistune.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -9,7 +9,7 @@\n \n class MistuneMarkdown(Markdown):\n     _parameters = []\n-    _plugins = ('strikethrough', 'subscript', 'superscript', 'url')\n+    _plugins = (\"strikethrough\", \"subscript\", \"superscript\", \"url\")\n \n     def __init__(self, conf=None):\n         if conf is not None:\n@@ -20,7 +20,7 @@ def __init__(self, conf=None):\n \n             self._parameters = conf.getlist(\"parameters\")\n \n-        hard_wrap = True if 'hard_wrap' in self._parameters else False\n+        hard_wrap = True if \"hard_wrap\" in self._parameters else False\n \n         logging.info(\"Loading Mistune with plugins: %s and parameters: %s\", self._plugins, self._parameters)\n "
    },
    {
      "sha": "046cab9457bdeb9b9c9f619a6bfe370be9dd42b4",
      "filename": "isso/migrate.py",
      "status": "modified",
      "additions": 58,
      "deletions": 74,
      "changes": 132,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fmigrate.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fmigrate.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fmigrate.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -20,26 +20,24 @@\n \n \n def strip(val):\n-    if isinstance(val, (str, )):\n+    if isinstance(val, (str,)):\n         return val.strip()\n     return val\n \n \n class Progress(object):\n-\n     def __init__(self, end):\n         self.end = end or 1\n \n         self.istty = sys.stdout.isatty()\n         self.last = 0\n \n     def update(self, i, message):\n-\n         if not self.istty or message is None:\n             return\n \n-        cols = int((os.popen('stty size', 'r').read()).split()[1])\n-        message = message[:cols - 7]\n+        cols = int((os.popen(\"stty size\", \"r\").read()).split()[1])\n+        message = message[: cols - 7]\n \n         if time() - self.last > 0.2:\n             sys.stdout.write(\"\\r{0}\".format(\" \" * cols))\n@@ -55,8 +53,8 @@ def finish(self, message):\n class Disqus(object):\n     # Format documented at https://help.disqus.com/en/articles/1717164-comments-export\n \n-    ns = '{http://disqus.com}'\n-    internals = '{http://disqus.com/disqus-internals}'\n+    ns = \"{http://disqus.com}\"\n+    internals = \"{http://disqus.com/disqus-internals}\"\n \n     def __init__(self, db, xmlfile, empty_id=False):\n         self.threads = set([])\n@@ -67,77 +65,69 @@ def __init__(self, db, xmlfile, empty_id=False):\n         self.empty_id = empty_id\n \n     def insert(self, thread, posts):\n-\n-        path = urlparse(thread.find('%slink' % Disqus.ns).text).path\n+        path = urlparse(thread.find(\"%slink\" % Disqus.ns).text).path\n         remap = dict()\n \n         if path not in self.db.threads:\n-            thread_title = thread.find(Disqus.ns + 'title').text or ''\n+            thread_title = thread.find(Disqus.ns + \"title\").text or \"\"\n             self.db.threads.new(path, thread_title.strip())\n \n-        for item in sorted(posts, key=lambda k: k['created']):\n-\n-            dsq_id = item.pop('dsq:id')\n-            item['parent'] = remap.get(item.pop('dsq:parent', None))\n+        for item in sorted(posts, key=lambda k: k[\"created\"]):\n+            dsq_id = item.pop(\"dsq:id\")\n+            item[\"parent\"] = remap.get(item.pop(\"dsq:parent\", None))\n             rv = self.db.comments.add(path, item)\n             remap[dsq_id] = rv[\"id\"]\n \n         self.comments.update(set(remap.keys()))\n \n     def migrate(self):\n-\n         tree = ElementTree.parse(self.xmlfile)\n         res = defaultdict(list)\n \n-        for post in tree.findall(Disqus.ns + 'post'):\n-            email = post.find('{0}author/{0}email'.format(Disqus.ns))\n-            ip = post.find(Disqus.ns + 'ipAddress')\n-            comment_text = post.find(Disqus.ns + 'message').text or ''\n+        for post in tree.findall(Disqus.ns + \"post\"):\n+            email = post.find(\"{0}author/{0}email\".format(Disqus.ns))\n+            ip = post.find(Disqus.ns + \"ipAddress\")\n+            comment_text = post.find(Disqus.ns + \"message\").text or \"\"\n \n             item = {\n-                'dsq:id': post.attrib.get(Disqus.internals + 'id'),\n-                'text': comment_text,\n-                'author': post.find('{0}author/{0}name'.format(Disqus.ns)).text,\n-                'email': email.text if email is not None else '',\n-                'created': mktime(strptime(\n-                    post.find(Disqus.ns + 'createdAt').text, '%Y-%m-%dT%H:%M:%SZ')),\n-                'remote_addr': anonymize(ip.text if ip is not None else '0.0.0.0'),\n-                'mode': 1 if post.find(Disqus.ns + \"isDeleted\").text == \"false\" else 4\n+                \"dsq:id\": post.attrib.get(Disqus.internals + \"id\"),\n+                \"text\": comment_text,\n+                \"author\": post.find(\"{0}author/{0}name\".format(Disqus.ns)).text,\n+                \"email\": email.text if email is not None else \"\",\n+                \"created\": mktime(strptime(post.find(Disqus.ns + \"createdAt\").text, \"%Y-%m-%dT%H:%M:%SZ\")),\n+                \"remote_addr\": anonymize(ip.text if ip is not None else \"0.0.0.0\"),\n+                \"mode\": 1 if post.find(Disqus.ns + \"isDeleted\").text == \"false\" else 4,\n             }\n \n-            if post.find(Disqus.ns + 'parent') is not None:\n-                item['dsq:parent'] = post.find(\n-                    Disqus.ns + 'parent').attrib.get(Disqus.internals + 'id')\n+            if post.find(Disqus.ns + \"parent\") is not None:\n+                item[\"dsq:parent\"] = post.find(Disqus.ns + \"parent\").attrib.get(Disqus.internals + \"id\")\n \n-            res[post.find('%sthread' % Disqus.ns).attrib.get(\n-                Disqus.internals + 'id')].append(item)\n+            res[post.find(\"%sthread\" % Disqus.ns).attrib.get(Disqus.internals + \"id\")].append(item)\n \n-        progress = Progress(len(tree.findall(Disqus.ns + 'thread')))\n-        for i, thread in enumerate(tree.findall(Disqus.ns + 'thread')):\n+        progress = Progress(len(tree.findall(Disqus.ns + \"thread\")))\n+        for i, thread in enumerate(tree.findall(Disqus.ns + \"thread\")):\n             # Workaround for not crashing with empty thread ids:\n-            thread_id = thread.find(Disqus.ns + 'id')\n+            thread_id = thread.find(Disqus.ns + \"id\")\n             if not thread_id:\n                 thread_id = dict(text=\"<empty thread id>\", empty=True)\n \n-            progress.update(i, thread_id.get('text'))\n+            progress.update(i, thread_id.get(\"text\"))\n \n             # skip (possibly?) duplicate, but empty thread elements\n-            if thread_id.get('empty') and not self.empty_id:\n+            if thread_id.get(\"empty\") and not self.empty_id:\n                 continue\n \n-            id = thread.attrib.get(Disqus.internals + 'id')\n+            id = thread.attrib.get(Disqus.internals + \"id\")\n             if id in res:\n                 self.threads.add(id)\n                 self.insert(thread, res[id])\n \n         # in case a comment has been deleted (and no further childs)\n         self.db.comments._remove_stale()\n \n-        progress.finish(\"{0} threads, {1} comments\".format(\n-            len(self.threads), len(self.comments)))\n+        progress.finish(\"{0} threads, {1} comments\".format(len(self.threads), len(self.comments)))\n \n-        orphans = set(map(lambda e: e.attrib.get(Disqus.internals + \"id\"),\n-                          tree.findall(Disqus.ns + \"post\"))) - self.comments\n+        orphans = set(map(lambda e: e.attrib.get(Disqus.internals + \"id\"), tree.findall(Disqus.ns + \"post\"))) - self.comments\n         if orphans and not self.threads:\n             print(\"Isso couldn't import any thread, try again with --empty-id\")\n         elif orphans:\n@@ -147,19 +137,20 @@ def migrate(self):\n                     continue\n \n                 email = post.find(\"{0}author/{0}email\".format(Disqus.ns))\n-                comment_text = post.find(Disqus.ns + 'message').text or ''\n-\n-                print(\" * {0} by {1} <{2}>\".format(\n-                    post.attrib.get(Disqus.internals + \"id\"),\n-                    post.find(\"{0}author/{0}name\".format(Disqus.ns)).text,\n-                    email.text if email is not None else \"\"))\n-                print(textwrap.fill(comment_text,\n-                                    initial_indent=\"  \", subsequent_indent=\"  \"))\n+                comment_text = post.find(Disqus.ns + \"message\").text or \"\"\n+\n+                print(\n+                    \" * {0} by {1} <{2}>\".format(\n+                        post.attrib.get(Disqus.internals + \"id\"),\n+                        post.find(\"{0}author/{0}name\".format(Disqus.ns)).text,\n+                        email.text if email is not None else \"\",\n+                    )\n+                )\n+                print(textwrap.fill(comment_text, initial_indent=\"  \", subsequent_indent=\"  \"))\n                 print(\"\")\n \n \n class WordPress(object):\n-\n     ns = \"{http://wordpress.org/export/1.0/}\"\n \n     def __init__(self, db, xmlfile):\n@@ -176,7 +167,6 @@ def __init__(self, db, xmlfile):\n             logger.warning(\"No WXR namespace found, assuming 1.0\")\n \n     def insert(self, thread):\n-\n         url = urlparse(thread.find(\"link\").text)\n         path = url.path\n \n@@ -211,7 +201,6 @@ def insert(self, thread):\n                 return\n \n     def migrate(self):\n-\n         tree = ElementTree.parse(self.xmlfile)\n \n         skip = 0\n@@ -226,15 +215,14 @@ def migrate(self):\n             progress.update(i, thread.find(\"title\").text)\n             self.insert(thread)\n \n-        progress.finish(\"{0} threads, {1} comments\".format(\n-            len(items) - skip, self.count))\n+        progress.finish(\"{0} threads, {1} comments\".format(len(items) - skip, self.count))\n \n     def _process_comment_content(self, text):\n         # WordPress comment text renders a single newline between two blocks of\n         # text as a <br> tag, so add an explicit Markdown line break on import\n         # (Otherwise multiple blocks of text separated by single newlines are\n         # all shown as one long line.)\n-        text = re.sub(r'(?!^\\n)\\n(?!^\\n)', '  \\n', text, 0)\n+        text = re.sub(r\"(?!^\\n)\\n(?!^\\n)\", \"  \\n\", text, 0)\n \n         return strip(text)\n \n@@ -244,14 +232,11 @@ def Comment(self, el):\n             \"author\": strip(el.find(self.ns + \"comment_author\").text),\n             \"email\": strip(el.find(self.ns + \"comment_author_email\").text),\n             \"website\": strip(el.find(self.ns + \"comment_author_url\").text),\n-            \"remote_addr\": anonymize(\n-                strip(el.find(self.ns + \"comment_author_IP\").text)),\n-            \"created\": mktime(strptime(\n-                strip(el.find(self.ns + \"comment_date_gmt\").text),\n-                \"%Y-%m-%d %H:%M:%S\")),\n+            \"remote_addr\": anonymize(strip(el.find(self.ns + \"comment_author_IP\").text)),\n+            \"created\": mktime(strptime(strip(el.find(self.ns + \"comment_date_gmt\").text), \"%Y-%m-%d %H:%M:%S\")),\n             \"mode\": 1 if el.find(self.ns + \"comment_approved\").text == \"1\" else 2,\n             \"id\": int(el.find(self.ns + \"comment_id\").text),\n-            \"parent\": int(el.find(self.ns + \"comment_parent\").text) or None\n+            \"parent\": int(el.find(self.ns + \"comment_parent\").text) or None,\n         }\n \n     @classmethod\n@@ -288,19 +273,19 @@ def __init__(self, db, json_file):\n \n     def insert(self, thread):\n         \"\"\"Process a thread and insert its comments in the DB.\"\"\"\n-        thread_id = thread['id']\n-        title = thread['title']\n+        thread_id = thread[\"id\"]\n+        title = thread[\"title\"]\n         self.db.threads.new(thread_id, title)\n \n-        comments = list(map(self._build_comment, thread['comments']))\n-        comments.sort(key=lambda comment: comment['id'])\n+        comments = list(map(self._build_comment, thread[\"comments\"]))\n+        comments.sort(key=lambda comment: comment[\"id\"])\n         self.count += len(comments)\n         for comment in comments:\n             self.db.comments.add(thread_id, comment)\n \n     def migrate(self):\n         \"\"\"Process the input file and fill the DB.\"\"\"\n-        with io.open(self.json_file, 'rt', encoding='utf8') as fh:\n+        with io.open(self.json_file, \"rt\", encoding=\"utf8\") as fh:\n             threads = json.load(fh)\n         progress = Progress(len(threads))\n \n@@ -312,13 +297,13 @@ def migrate(self):\n \n     def _build_comment(self, raw_comment):\n         return {\n-            \"text\": raw_comment['text'],\n-            \"author\": raw_comment['author'],\n-            \"email\": raw_comment['email'],\n-            \"website\": raw_comment['website'],\n-            \"created\": mktime(strptime(raw_comment['created'], \"%Y-%m-%d %H:%M:%S\")),\n+            \"text\": raw_comment[\"text\"],\n+            \"author\": raw_comment[\"author\"],\n+            \"email\": raw_comment[\"email\"],\n+            \"website\": raw_comment[\"website\"],\n+            \"created\": mktime(strptime(raw_comment[\"created\"], \"%Y-%m-%d %H:%M:%S\")),\n             \"mode\": 1,\n-            \"id\": int(raw_comment['id']),\n+            \"id\": int(raw_comment[\"id\"]),\n             \"parent\": None,\n             \"remote_addr\": raw_comment[\"remote_addr\"],\n         }\n@@ -334,7 +319,6 @@ def detect(cls, peek):\n \n \n def autodetect(peek):\n-\n     if 'xmlns=\"http://disqus.com' in peek:\n         return Disqus\n "
    },
    {
      "sha": "17c4e18d39b45a84ec0e76391b58a7512a721c01",
      "filename": "isso/run.py",
      "status": "modified",
      "additions": 2,
      "deletions": 6,
      "changes": 8,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Frun.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Frun.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Frun.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -11,10 +11,6 @@\n # without valid configuration\n # https://stackoverflow.com/a/44595269/1279355\n if \"pytest\" in sys.modules:\n-    make_app = lambda config, multiprocessing: True # noqa\n+    make_app = lambda config, multiprocessing: True  # noqa\n \n-application = make_app(\n-    config.load(\n-        config.default_file(),\n-        os.environ.get('ISSO_SETTINGS')),\n-    multiprocessing=True)\n+application = make_app(config.load(config.default_file(), os.environ.get(\"ISSO_SETTINGS\")), multiprocessing=True)"
    },
    {
      "sha": "5a29492f23e5fcefe80d61f3df3a853f017d3cfd",
      "filename": "isso/tests/fixtures.py",
      "status": "modified",
      "additions": 6,
      "deletions": 10,
      "changes": 16,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ffixtures.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ffixtures.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Ftests%2Ffixtures.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -6,45 +6,41 @@\n \n \n class FakeIP(object):\n-\n     def __init__(self, app, ip):\n         self.app = app\n         self.ip = ip\n \n     def __call__(self, environ, start_response):\n-        environ['REMOTE_ADDR'] = self.ip\n+        environ[\"REMOTE_ADDR\"] = self.ip\n         return self.app(environ, start_response)\n \n \n class FakeHost(object):\n-\n     def __init__(self, app, host, scheme):\n         self.app = app\n         self.host = host\n         self.scheme = scheme\n \n     def __call__(self, environ, start_response):\n-        environ['HTTP_HOST'] = self.host\n-        environ['wsgi.url_scheme'] = self.scheme\n+        environ[\"HTTP_HOST\"] = self.host\n+        environ[\"wsgi.url_scheme\"] = self.scheme\n         return self.app(environ, start_response)\n \n \n class JSONClient(Client):\n-\n     def open(self, *args, **kwargs):\n-        kwargs.setdefault('content_type', 'application/json')\n+        kwargs.setdefault(\"content_type\", \"application/json\")\n         return super(JSONClient, self).open(*args, **kwargs)\n \n \n class Dummy:\n-\n     status = 200\n \n     def __enter__(self):\n         return self\n \n     def read(self):\n-        return ''\n+        return \"\"\n \n     def __exit__(self, exc_type, exc_val, exc_tb):\n         pass\n@@ -55,4 +51,4 @@ def curl(method, host, path):\n \n \n def loads(data):\n-    return json.loads(data.decode('utf-8'))\n+    return json.loads(data.decode(\"utf-8\"))"
    },
    {
      "sha": "579487f2c0e667feda2d3da764cbbaf284fa6fbf",
      "filename": "isso/tests/test_comments.py",
      "status": "modified",
      "additions": 277,
      "deletions": 366,
      "changes": 643,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_comments.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_comments.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Ftests%2Ftest_comments.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -15,11 +15,11 @@\n from isso.views import comments\n \n from fixtures import curl, loads, FakeIP, FakeHost, JSONClient\n+\n http.curl = curl\n \n \n class TestComments(unittest.TestCase):\n-\n     def setUp(self):\n         fd, self.path = tempfile.mkstemp()\n         conf = config.load(config.default_file())\n@@ -45,35 +45,30 @@ def tearDown(self):\n         os.unlink(self.path)\n \n     def testGet(self):\n-\n-        self.post('/new?uri=%2Fpath%2F',\n-                  data=json.dumps({'text': 'Lorem ipsum ...'}))\n-        r = self.get('/id/1')\n+        self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Lorem ipsum ...\"}))\n+        r = self.get(\"/id/1\")\n         self.assertEqual(r.status_code, 200)\n \n         rv = loads(r.data)\n \n-        self.assertEqual(rv['id'], 1)\n-        self.assertEqual(rv['text'], '<p>Lorem ipsum ...</p>')\n+        self.assertEqual(rv[\"id\"], 1)\n+        self.assertEqual(rv[\"text\"], \"<p>Lorem ipsum ...</p>\")\n \n     def testCreate(self):\n-\n-        rv = self.post('/new?uri=%2Fpath%2F',\n-                       data=json.dumps({'text': 'Lorem ipsum ...'}))\n+        rv = self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Lorem ipsum ...\"}))\n \n         self.assertEqual(rv.status_code, 201)\n         self.assertIn(\"Set-Cookie\", rv.headers)\n \n         rv = loads(rv.data)\n \n         self.assertEqual(rv[\"mode\"], 1)\n-        self.assertEqual(rv[\"text\"], '<p>Lorem ipsum ...</p>')\n+        self.assertEqual(rv[\"text\"], \"<p>Lorem ipsum ...</p>\")\n \n     def testWebsiteXSSPayloadIsEscaped(self):\n         \"\"\"Website field with XSS payload must have quotes HTML-escaped.\"\"\"\n         payload = \"http://x.com/?'onmouseover='alert(document.domain)'x='\"\n-        rv = self.post('/new?uri=%2Fpath%2F',\n-                       data=json.dumps({'text': 'Hello', 'website': payload}))\n+        rv = self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Hello\", \"website\": payload}))\n         self.assertEqual(rv.status_code, 201)\n         rv = loads(rv.data)\n         # Single quotes must be HTML-escaped so they cannot break out of an\n@@ -86,78 +81,68 @@ def testWebsiteXSSPayloadIsEscaped(self):\n         )\n \n     def textCreateWithNonAsciiText(self):\n-\n-        rv = self.post('/new?uri=%2Fpath%2F',\n-                       data=json.dumps({'text': 'Здравствуй, мир!'}))\n+        rv = self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Здравствуй, мир!\"}))\n \n         self.assertEqual(rv.status_code, 201)\n         rv = loads(rv.data)\n \n         self.assertEqual(rv[\"mode\"], 1)\n-        self.assertEqual(rv[\"text\"], '<p>Здравствуй, мир!</p>')\n+        self.assertEqual(rv[\"text\"], \"<p>Здравствуй, мир!</p>\")\n \n     def testCreateMultiple(self):\n-\n-        a = self.post('/new?uri=test', data=json.dumps({'text': '...'}))\n-        b = self.post('/new?uri=test', data=json.dumps({'text': '...'}))\n-        c = self.post('/new?uri=test', data=json.dumps({'text': '...'}))\n+        a = self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n+        b = self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n+        c = self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n \n         self.assertEqual(loads(a.data)[\"id\"], 1)\n         self.assertEqual(loads(b.data)[\"id\"], 2)\n         self.assertEqual(loads(c.data)[\"id\"], 3)\n \n     def testCreateAndGetMultiple(self):\n-\n         for i in range(20):\n-            self.post('/new?uri=%2Fpath%2F', data=json.dumps({'text': 'Spam'}))\n+            self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Spam\"}))\n \n-        r = self.get('/?uri=%2Fpath%2F')\n+        r = self.get(\"/?uri=%2Fpath%2F\")\n         self.assertEqual(r.status_code, 200)\n \n         rv = loads(r.data)\n-        self.assertEqual(len(rv['replies']), 20)\n-        self.assertEqual(rv['total_replies'], 20)\n+        self.assertEqual(len(rv[\"replies\"]), 20)\n+        self.assertEqual(rv[\"total_replies\"], 20)\n \n     def testCreateInvalidParent(self):\n-\n-        self.post('/new?uri=test', data=json.dumps({'text': '...'}))\n-        self.post('/new?uri=test',\n-                  data=json.dumps({'text': '...', 'parent': 1}))\n-        invalid = self.post(\n-            '/new?uri=test', data=json.dumps({'text': '...', 'parent': 2}))\n+        self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n+        self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\", \"parent\": 1}))\n+        invalid = self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\", \"parent\": 2}))\n \n         self.assertEqual(loads(invalid.data)[\"parent\"], 1)\n \n     def testCreateInvalidThreadForParent(self):\n-\n-        self.post('/new?uri=one', data=json.dumps({'text': '...'}))\n+        self.post(\"/new?uri=one\", data=json.dumps({\"text\": \"...\"}))\n         # Parent which is not in same thread should be rejected, set to None\n-        invalid = self.post(\n-            '/new?uri=two', data=json.dumps({'text': '...', 'parent': 1}))\n+        invalid = self.post(\"/new?uri=two\", data=json.dumps({\"text\": \"...\", \"parent\": 1}))\n         # Replies to commments in thread \"two\" are valid\n-        valid = self.post(\n-            '/new?uri=two', data=json.dumps({'text': '...', 'parent': 2}))\n+        valid = self.post(\"/new?uri=two\", data=json.dumps({\"text\": \"...\", \"parent\": 2}))\n \n         self.assertEqual(loads(invalid.data)[\"parent\"], None)\n         self.assertEqual(loads(valid.data)[\"parent\"], 2)\n \n         # Insert (invalid) comment into thread \"two\" with parent from thread 1\n-        self.app.db.execute([\n-            'INSERT INTO COMMENTS (tid, parent, created, modified, mode,'\n-            '   remote_addr, text, author, email, website, voters, notification)',\n-            'SELECT threads.id, ?, ?, ?, ?, ?,     ?, ?, ?, ?, ?, ?',\n-            'FROM threads where threads.uri = ?;'],\n-            (None, 0.0, 0.0, 1, None, 'Text', None, None, None, bytes(1), None, 'two')\n+        self.app.db.execute(\n+            [\n+                \"INSERT INTO COMMENTS (tid, parent, created, modified, mode,\"\n+                \"   remote_addr, text, author, email, website, voters, notification)\",\n+                \"SELECT threads.id, ?, ?, ?, ?, ?,     ?, ?, ?, ?, ?, ?\",\n+                \"FROM threads where threads.uri = ?;\",\n+            ],\n+            (None, 0.0, 0.0, 1, None, \"Text\", None, None, None, bytes(1), None, \"two\"),\n         )\n         # For id=4, the parent has id=1, but is from thread \"one\". Because id=1\n         # does not belong to the current thread \"two\", it is rejected and id=4\n         # chosen instead.\n-        impossible = self.post(\n-            '/new?uri=two', data=json.dumps({'text': '...', 'parent': 4}))\n+        impossible = self.post(\"/new?uri=two\", data=json.dumps({\"text\": \"...\", \"parent\": 4}))\n         self.assertEqual(loads(impossible.data)[\"parent\"], 4)\n \n     def testVerifyFields(self):\n-\n         def verify(comment):\n             return comments.API.verify(comment)[0]\n \n@@ -175,12 +160,10 @@ def verify(comment):\n \n         # email/website length\n         self.assertTrue(verify({\"text\": \"...\", \"email\": \"*\" * 254}))\n-        self.assertTrue(\n-            verify({\"text\": \"...\", \"website\": \"google.de/\" + \"a\" * 128}))\n+        self.assertTrue(verify({\"text\": \"...\", \"website\": \"google.de/\" + \"a\" * 128}))\n \n         self.assertFalse(verify({\"text\": \"...\", \"email\": \"*\" * 1024}))\n-        self.assertFalse(\n-            verify({\"text\": \"...\", \"website\": \"google.de/\" + \"*\" * 1024}))\n+        self.assertFalse(verify({\"text\": \"...\", \"website\": \"google.de/\" + \"*\" * 1024}))\n \n         # valid website url\n         self.assertTrue(comments.isurl(\"example.tld\"))\n@@ -189,237 +172,198 @@ def verify(comment):\n         self.assertTrue(comments.isurl(\"https://exämple.tld\"))\n         self.assertTrue(comments.isurl(\"https://example.tld:1337/\"))\n         self.assertTrue(comments.isurl(\"https://example.tld:1337/foobar\"))\n-        self.assertTrue(comments.isurl(\n-            \"https://example.tld:1337/foobar?p=1#isso-thread\"))\n+        self.assertTrue(comments.isurl(\"https://example.tld:1337/foobar?p=1#isso-thread\"))\n \n         self.assertFalse(comments.isurl(\"ftp://example.tld/\"))\n         self.assertFalse(comments.isurl(\"tel:+1234567890\"))\n         self.assertFalse(comments.isurl(\"+1234567890\"))\n         self.assertFalse(comments.isurl(\"spam\"))\n \n     def testGetInvalid(self):\n+        self.assertEqual(self.get(\"/?uri=%2Fpath%2F&id=123\").status_code, 200)\n+        data = loads(self.get(\"/?uri=%2Fpath%2F&id=123\").data)\n+        self.assertEqual(len(data[\"replies\"]), 0)\n+        self.assertEqual(data[\"total_replies\"], 0)\n \n-        self.assertEqual(self.get('/?uri=%2Fpath%2F&id=123').status_code, 200)\n-        data = loads(self.get('/?uri=%2Fpath%2F&id=123').data)\n-        self.assertEqual(len(data['replies']), 0)\n-        self.assertEqual(data['total_replies'], 0)\n+        self.assertEqual(self.get(\"/?uri=%2Fpath%2Fspam%2F&id=123\").status_code, 200)\n+        data = loads(self.get(\"/?uri=%2Fpath%2Fspam%2F&id=123\").data)\n+        self.assertEqual(len(data[\"replies\"]), 0)\n+        self.assertEqual(data[\"total_replies\"], 0)\n \n-        self.assertEqual(\n-            self.get('/?uri=%2Fpath%2Fspam%2F&id=123').status_code, 200)\n-        data = loads(self.get('/?uri=%2Fpath%2Fspam%2F&id=123').data)\n-        self.assertEqual(len(data['replies']), 0)\n-        self.assertEqual(data['total_replies'], 0)\n-\n-        self.assertEqual(self.get('/?uri=?uri=%foo%2F').status_code, 200)\n-        data = loads(self.get('/?uri=?uri=%foo%2F').data)\n-        self.assertEqual(len(data['replies']), 0)\n-        self.assertEqual(data['total_replies'], 0)\n+        self.assertEqual(self.get(\"/?uri=?uri=%foo%2F\").status_code, 200)\n+        data = loads(self.get(\"/?uri=?uri=%foo%2F\").data)\n+        self.assertEqual(len(data[\"replies\"]), 0)\n+        self.assertEqual(data[\"total_replies\"], 0)\n \n     def testFetchEmpty(self):\n-\n-        empty = self.get('/?uri=%2Fempty%2F')\n+        empty = self.get(\"/?uri=%2Fempty%2F\")\n         # Empty database returns 200, not 404\n         self.assertEqual(empty.status_code, 200)\n         data = loads(empty.data)\n-        self.assertEqual(data['total_replies'], 0)\n-        self.assertEqual(data['id'], None)\n+        self.assertEqual(data[\"total_replies\"], 0)\n+        self.assertEqual(data[\"id\"], None)\n \n     def testGetLimited(self):\n-\n         for i in range(20):\n-            self.post('/new?uri=test', data=json.dumps({'text': '...'}))\n+            self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n \n-        r = self.get('/?uri=test&limit=10')\n+        r = self.get(\"/?uri=test&limit=10\")\n         self.assertEqual(r.status_code, 200)\n \n         rv = loads(r.data)\n-        self.assertEqual(len(rv['replies']), 10)\n-        self.assertEqual(rv['total_replies'], 20)\n+        self.assertEqual(len(rv[\"replies\"]), 10)\n+        self.assertEqual(rv[\"total_replies\"], 20)\n \n     def testGetNested(self):\n+        self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n+        self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\", \"parent\": 1}))\n \n-        self.post('/new?uri=test', data=json.dumps({'text': '...'}))\n-        self.post('/new?uri=test',\n-                  data=json.dumps({'text': '...', 'parent': 1}))\n-\n-        r = self.get('/?uri=test&parent=1')\n+        r = self.get(\"/?uri=test&parent=1\")\n         self.assertEqual(r.status_code, 200)\n \n         rv = loads(r.data)\n-        self.assertEqual(len(rv['replies']), 1)\n-        self.assertEqual(rv['total_replies'], 1)\n+        self.assertEqual(len(rv[\"replies\"]), 1)\n+        self.assertEqual(rv[\"total_replies\"], 1)\n \n     def testGetLimitedNested(self):\n-\n-        self.post('/new?uri=test', data=json.dumps({'text': '...'}))\n+        self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n         for i in range(20):\n-            self.post('/new?uri=test',\n-                      data=json.dumps({'text': '...', 'parent': 1}))\n+            self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\", \"parent\": 1}))\n \n-        r = self.get('/?uri=test&parent=1&limit=10')\n+        r = self.get(\"/?uri=test&parent=1&limit=10\")\n         self.assertEqual(r.status_code, 200)\n \n         rv = loads(r.data)\n-        self.assertEqual(len(rv['replies']), 10)\n-        self.assertEqual(rv['total_replies'], 20)\n+        self.assertEqual(len(rv[\"replies\"]), 10)\n+        self.assertEqual(rv[\"total_replies\"], 20)\n \n     def testGetWithOffset(self):\n         for i in range(5):\n-            self.post('/new?uri=test', data=json.dumps({'text': '...'}))\n+            self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n \n-        r = self.get('/?uri=test&limit=3&offset=2')\n+        r = self.get(\"/?uri=test&limit=3&offset=2\")\n         self.assertEqual(r.status_code, 200)\n \n         rv = loads(r.data)\n-        self.assertEqual(\n-            [comment['id'] for comment in rv['replies']],\n-            [3, 4, 5]\n-        )\n+        self.assertEqual([comment[\"id\"] for comment in rv[\"replies\"]], [3, 4, 5])\n \n     def testGetWithOffsetIgnoredWithoutLimit(self):\n         for i in range(5):\n-            self.post('/new?uri=test', data=json.dumps({'text': '...'}))\n+            self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n \n-        r = self.get('/?uri=test&offset=2')\n+        r = self.get(\"/?uri=test&offset=2\")\n         self.assertEqual(r.status_code, 200)\n \n         rv = loads(r.data)\n-        self.assertEqual(\n-            [comment['id'] for comment in rv['replies']],\n-            [1, 2, 3, 4, 5]\n-        )\n+        self.assertEqual([comment[\"id\"] for comment in rv[\"replies\"]], [1, 2, 3, 4, 5])\n \n     def testGetNestedWithOffset(self):\n-\n-        self.post('/new?uri=test', data=json.dumps({'text': '...'}))\n+        self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n         for i in range(5):\n-            self.post('/new?uri=test',\n-                      data=json.dumps({'text': '...', 'parent': 1}))\n+            self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\", \"parent\": 1}))\n \n-        r = self.get('/?uri=test&parent=1&limit=3&offset=2')\n+        r = self.get(\"/?uri=test&parent=1&limit=3&offset=2\")\n         self.assertEqual(r.status_code, 200)\n \n         rv = loads(r.data)\n-        self.assertEqual(\n-            [comment['id'] for comment in rv['replies']],\n-            [4, 5, 6]\n-        )\n+        self.assertEqual([comment[\"id\"] for comment in rv[\"replies\"]], [4, 5, 6])\n \n     def testGetSortedByOldest(self):\n         for i in range(5):\n-            self.post('/new?uri=test', data=json.dumps({'text': '...'}))\n+            self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n \n-        r = self.get('/?uri=test&sort=oldest')\n+        r = self.get(\"/?uri=test&sort=oldest\")\n         self.assertEqual(r.status_code, 200)\n \n         rv = loads(r.data)\n         # assert order of comments is oldest first\n-        self.assertEqual(\n-            [comment['id'] for comment in rv['replies']],\n-            [1, 2, 3, 4, 5]\n-        )\n+        self.assertEqual([comment[\"id\"] for comment in rv[\"replies\"]], [1, 2, 3, 4, 5])\n \n     def testGetSortedByNewest(self):\n         for i in range(5):\n-            self.post('/new?uri=test', data=json.dumps({'text': '...'}))\n+            self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n \n-        r = self.get('/?uri=test&sort=newest')\n+        r = self.get(\"/?uri=test&sort=newest\")\n         self.assertEqual(r.status_code, 200)\n \n         rv = loads(r.data)\n         # assert order of comments is newest first\n-        self.assertEqual(\n-            [comment['id'] for comment in rv['replies']],\n-            [5, 4, 3, 2, 1]\n-        )\n+        self.assertEqual([comment[\"id\"] for comment in rv[\"replies\"]], [5, 4, 3, 2, 1])\n \n     def testGetSortedByUpvotes(self):\n         for i in range(5):\n-            self.post('/new?uri=test', data=json.dumps({'text': '...'}))\n+            self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n \n         # update the likes for some comments\n-        self.app.db.execute(\n-            'UPDATE comments SET likes = id WHERE id IN (2, 4)'\n-        )\n+        self.app.db.execute(\"UPDATE comments SET likes = id WHERE id IN (2, 4)\")\n \n-        r = self.get('/?uri=test&sort=upvotes')\n+        r = self.get(\"/?uri=test&sort=upvotes\")\n         self.assertEqual(r.status_code, 200)\n \n         rv = loads(r.data)\n         # assert order of comments is by upvotes\n-        self.assertEqual(\n-            [comment['id'] for comment in rv['replies']],\n-            [4, 2, 1, 3, 5]\n-        )\n+        self.assertEqual([comment[\"id\"] for comment in rv[\"replies\"]], [4, 2, 1, 3, 5])\n \n     def testGetSortedByNewestWithNested(self):\n-        self.post('/new?uri=test', data=json.dumps({'text': '...'}))\n+        self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n         for i in range(5):\n-            self.post('/new?uri=test',\n-                      data=json.dumps({'text': '...', 'parent': 1}))\n+            self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\", \"parent\": 1}))\n \n-        r = self.get('/?uri=test&sort=newest')\n+        r = self.get(\"/?uri=test&sort=newest\")\n         self.assertEqual(r.status_code, 200)\n \n         rv = loads(r.data)\n-        self.assertEqual(len(rv['replies']), 1)\n+        self.assertEqual(len(rv[\"replies\"]), 1)\n         # assert order of nested comments is oldest first\n-        self.assertEqual(\n-            [comment['id'] for comment in rv['replies'][0]['replies']],\n-            [2, 3, 4, 5, 6]\n-        )\n+        self.assertEqual([comment[\"id\"] for comment in rv[\"replies\"][0][\"replies\"]], [2, 3, 4, 5, 6])\n \n     def testGetSortedByUpvotesWithNested(self):\n-        self.post('/new?uri=test', data=json.dumps({'text': '...'}))\n+        self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n         for i in range(5):\n-            self.post('/new?uri=test',\n-                      data=json.dumps({'text': '...', 'parent': 1}))\n+            self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\", \"parent\": 1}))\n \n         # update the likes for some comments\n-        self.app.db.execute(\n-            'UPDATE comments SET likes = id WHERE id IN (3, 6)'\n-        )\n+        self.app.db.execute(\"UPDATE comments SET likes = id WHERE id IN (3, 6)\")\n \n-        r = self.get('/?uri=test&sort=upvotes')\n+        r = self.get(\"/?uri=test&sort=upvotes\")\n         self.assertEqual(r.status_code, 200)\n \n         rv = loads(r.data)\n-        self.assertEqual(len(rv['replies']), 1)\n+        self.assertEqual(len(rv[\"replies\"]), 1)\n         # assert order of nested comments is oldest first\n-        self.assertEqual(\n-            [comment['id'] for comment in rv['replies'][0]['replies']],\n-            [2, 3, 4, 5, 6]\n-        )\n+        self.assertEqual([comment[\"id\"] for comment in rv[\"replies\"][0][\"replies\"]], [2, 3, 4, 5, 6])\n \n     def testUpdate(self):\n+        self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Lorem ipsum ...\"}))\n+        self.put(\"/id/1\", data=json.dumps({\"text\": \"Hello World\", \"author\": \"me\", \"website\": \"http://example.com/\"}))\n \n-        self.post('/new?uri=%2Fpath%2F',\n-                  data=json.dumps({'text': 'Lorem ipsum ...'}))\n-        self.put('/id/1', data=json.dumps({\n-            'text': 'Hello World', 'author': 'me', 'website': 'http://example.com/'}))\n-\n-        r = self.get('/id/1?plain=1')\n+        r = self.get(\"/id/1?plain=1\")\n         self.assertEqual(r.status_code, 200)\n \n         rv = loads(r.data)\n-        self.assertEqual(rv['text'], 'Hello World')\n-        self.assertEqual(rv['author'], 'me')\n-        self.assertEqual(rv['website'], 'http://example.com/')\n-        self.assertIn('modified', rv)\n+        self.assertEqual(rv[\"text\"], \"Hello World\")\n+        self.assertEqual(rv[\"author\"], \"me\")\n+        self.assertEqual(rv[\"website\"], \"http://example.com/\")\n+        self.assertIn(\"modified\", rv)\n \n     def testUpdateWebsiteXSSPayloadIsEscaped(self):\n         \"\"\"Website and author XSS payloads via edit endpoint must be HTML-escaped.\"\"\"\n-        self.post('/new?uri=%2Fpath%2F', data=json.dumps({'text': 'Lorem ipsum ...'}))\n+        self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Lorem ipsum ...\"}))\n \n         website_payload = \"http://x.com/?'onmouseover='alert(document.domain)'x='\"\n         author_payload = \"<script>alert(1)</script>\"\n-        self.put('/id/1', data=json.dumps({\n-            'text': 'Hello World',\n-            'author': author_payload,\n-            'website': website_payload,\n-        }))\n+        self.put(\n+            \"/id/1\",\n+            data=json.dumps(\n+                {\n+                    \"text\": \"Hello World\",\n+                    \"author\": author_payload,\n+                    \"website\": website_payload,\n+                }\n+            ),\n+        )\n \n-        rv = loads(self.get('/id/1?plain=1').data)\n+        rv = loads(self.get(\"/id/1?plain=1\").data)\n         self.assertNotIn(\"'\", rv[\"website\"])\n         self.assertEqual(\n             rv[\"website\"],\n@@ -429,65 +373,59 @@ def testUpdateWebsiteXSSPayloadIsEscaped(self):\n         self.assertEqual(rv[\"author\"], \"&lt;script&gt;alert(1)&lt;/script&gt;\")\n \n     def testUpdateForbidden(self):\n+        self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"Hello world!\"}))\n \n-        self.post('/new?uri=test', data=json.dumps({'text': 'Hello world!'}))\n-\n-        resp = self.put('/id/1', data=json.dumps({}))\n-        self.assertEqual(resp.status, '400 BAD REQUEST')\n-        self.assertIn('text is missing', resp.text)\n+        resp = self.put(\"/id/1\", data=json.dumps({}))\n+        self.assertEqual(resp.status, \"400 BAD REQUEST\")\n+        self.assertIn(\"text is missing\", resp.text)\n \n-        resp = self.put('/id/1', data=json.dumps({'text': ''}))\n-        self.assertEqual(resp.status, '400 BAD REQUEST')\n-        self.assertIn('text is too short', resp.text)\n+        resp = self.put(\"/id/1\", data=json.dumps({\"text\": \"\"}))\n+        self.assertEqual(resp.status, \"400 BAD REQUEST\")\n+        self.assertIn(\"text is too short\", resp.text)\n \n-        resp = self.put('/id/1', data=json.dumps({'text': 'Hello again!', 'website': 'name@example.com'}))\n-        self.assertEqual(resp.status, '400 BAD REQUEST')\n-        self.assertIn('Website not Django-conform', resp.text)\n+        resp = self.put(\"/id/1\", data=json.dumps({\"text\": \"Hello again!\", \"website\": \"name@example.com\"}))\n+        self.assertEqual(resp.status, \"400 BAD REQUEST\")\n+        self.assertIn(\"Website not Django-conform\", resp.text)\n \n     def testDelete(self):\n-\n-        self.post('/new?uri=%2Fpath%2F',\n-                  data=json.dumps({'text': 'Lorem ipsum ...'}))\n-        r = self.delete('/id/1')\n+        self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Lorem ipsum ...\"}))\n+        r = self.delete(\"/id/1\")\n         self.assertEqual(r.status_code, 200)\n         self.assertEqual(loads(r.data), None)\n-        self.assertEqual(self.get('/id/1').status_code, 404)\n+        self.assertEqual(self.get(\"/id/1\").status_code, 404)\n \n     def testFetchAuthorization(self):\n-        self.post('/new?uri=%2Fpath%2F',\n-                  data=json.dumps({'text': 'Lorem ipsum ...'}))\n+        self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Lorem ipsum ...\"}))\n \n-        r = self.get('/id/1?plain=1')\n+        r = self.get(\"/id/1?plain=1\")\n         self.assertEqual(r.status_code, 200)\n \n-        self.client.delete_cookie(key='1', domain='localhost')\n-        r = self.get('/id/1?plain=1')\n+        self.client.delete_cookie(key=\"1\", domain=\"localhost\")\n+        r = self.get(\"/id/1?plain=1\")\n         self.assertEqual(r.status_code, 403)\n \n     def testDeleteWithReference(self):\n-\n         client = JSONClient(self.app, Response)\n-        client.post('/new?uri=%2Fpath%2F', data=json.dumps({'text': 'First'}))\n-        client.post('/new?uri=%2Fpath%2F',\n-                    data=json.dumps({'text': 'First', 'parent': 1}))\n+        client.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"First\"}))\n+        client.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"First\", \"parent\": 1}))\n \n-        r = client.delete('/id/1')\n+        r = client.delete(\"/id/1\")\n         self.assertEqual(r.status_code, 200)\n-        self.assertEqual(loads(r.data)['mode'], 4)\n-        self.assertIn('/path/', self.app.db.threads)\n+        self.assertEqual(loads(r.data)[\"mode\"], 4)\n+        self.assertIn(\"/path/\", self.app.db.threads)\n \n         data = loads(client.get(\"/?uri=%2Fpath%2F\").data)\n         self.assertEqual(data[\"total_replies\"], 2)\n \n-        self.assertEqual(self.get('/?uri=%2Fpath%2F&id=1').status_code, 200)\n-        self.assertEqual(self.get('/?uri=%2Fpath%2F&id=2').status_code, 200)\n+        self.assertEqual(self.get(\"/?uri=%2Fpath%2F&id=1\").status_code, 200)\n+        self.assertEqual(self.get(\"/?uri=%2Fpath%2F&id=2\").status_code, 200)\n \n-        r = client.delete('/id/2')\n-        self.assertEqual(self.get('/?uri=%2Fpath%2F').status_code, 200)\n-        self.assertNotIn('/path/', self.app.db.threads)\n+        r = client.delete(\"/id/2\")\n+        self.assertEqual(self.get(\"/?uri=%2Fpath%2F\").status_code, 200)\n+        self.assertNotIn(\"/path/\", self.app.db.threads)\n \n-        data = loads(client.get('/?uri=%2Fpath%2F').data)\n-        self.assertEqual(len(data['replies']), 0)\n+        data = loads(client.get(\"/?uri=%2Fpath%2F\").data)\n+        self.assertEqual(len(data[\"replies\"]), 0)\n \n     def testDeleteWithMultipleReferences(self):\n         \"\"\"\n@@ -500,69 +438,59 @@ def testDeleteWithMultipleReferences(self):\n         \"\"\"\n         client = JSONClient(self.app, Response)\n \n-        client.post('/new?uri=%2Fpath%2F', data=json.dumps({'text': 'First'}))\n-        client.post('/new?uri=%2Fpath%2F',\n-                    data=json.dumps({'text': 'Second', 'parent': 1}))\n-        client.post('/new?uri=%2Fpath%2F',\n-                    data=json.dumps({'text': 'Third', 'parent': 1}))\n-        client.post('/new?uri=%2Fpath%2F', data=json.dumps({'text': 'Last'}))\n-\n-        client.delete('/id/1')\n-        self.assertEqual(self.get('/?uri=%2Fpath%2F').status_code, 200)\n-        client.delete('/id/2')\n-        self.assertEqual(self.get('/?uri=%2Fpath%2F').status_code, 200)\n-        client.delete('/id/3')\n-        self.assertEqual(self.get('/?uri=%2Fpath%2F').status_code, 200)\n-        client.delete('/id/4')\n-        self.assertEqual(self.get('/?uri=%2Fpath%2F').status_code, 200)\n-\n-        data = loads(client.get('/?uri=%2Fpath%2F').data)\n-        self.assertEqual(len(data['replies']), 0)\n+        client.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"First\"}))\n+        client.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Second\", \"parent\": 1}))\n+        client.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Third\", \"parent\": 1}))\n+        client.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Last\"}))\n \n-    def testPathVariations(self):\n+        client.delete(\"/id/1\")\n+        self.assertEqual(self.get(\"/?uri=%2Fpath%2F\").status_code, 200)\n+        client.delete(\"/id/2\")\n+        self.assertEqual(self.get(\"/?uri=%2Fpath%2F\").status_code, 200)\n+        client.delete(\"/id/3\")\n+        self.assertEqual(self.get(\"/?uri=%2Fpath%2F\").status_code, 200)\n+        client.delete(\"/id/4\")\n+        self.assertEqual(self.get(\"/?uri=%2Fpath%2F\").status_code, 200)\n \n-        paths = ['/sub/path/', '/path.html', '/sub/path.html', 'path', '/']\n+        data = loads(client.get(\"/?uri=%2Fpath%2F\").data)\n+        self.assertEqual(len(data[\"replies\"]), 0)\n+\n+    def testPathVariations(self):\n+        paths = [\"/sub/path/\", \"/path.html\", \"/sub/path.html\", \"path\", \"/\"]\n \n         for path in paths:\n-            self.assertEqual(self.post('/new?' + urlencode({'uri': path}),\n-                                       data=json.dumps({'text': '...'})).status_code, 201)\n+            self.assertEqual(self.post(\"/new?\" + urlencode({\"uri\": path}), data=json.dumps({\"text\": \"...\"})).status_code, 201)\n \n         for i, path in enumerate(paths):\n-            self.assertEqual(\n-                self.get('/?' + urlencode({'uri': path})).status_code, 200)\n-            self.assertEqual(self.get('/id/%i' % (i + 1)).status_code, 200)\n+            self.assertEqual(self.get(\"/?\" + urlencode({\"uri\": path})).status_code, 200)\n+            self.assertEqual(self.get(\"/id/%i\" % (i + 1)).status_code, 200)\n \n     def testDeleteAndCreateByDifferentUsersButSamePostId(self):\n-\n         mallory = JSONClient(self.app, Response)\n-        mallory.post('/new?uri=%2Fpath%2F', data=json.dumps({'text': 'Foo'}))\n-        mallory.delete('/id/1')\n+        mallory.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Foo\"}))\n+        mallory.delete(\"/id/1\")\n \n         bob = JSONClient(self.app, Response)\n-        bob.post('/new?uri=%2Fpath%2F', data=json.dumps({'text': 'Bar'}))\n+        bob.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Bar\"}))\n \n-        self.assertEqual(mallory.delete('/id/1').status_code, 403)\n-        self.assertEqual(bob.delete('/id/1').status_code, 200)\n+        self.assertEqual(mallory.delete(\"/id/1\").status_code, 403)\n+        self.assertEqual(bob.delete(\"/id/1\").status_code, 200)\n \n     def testHash(self):\n-\n-        a = self.post('/new?uri=%2Fpath%2F', data=json.dumps({\"text\": \"Aaa\"}))\n-        b = self.post('/new?uri=%2Fpath%2F', data=json.dumps({\"text\": \"Bbb\"}))\n-        c = self.post('/new?uri=%2Fpath%2F',\n-                      data=json.dumps({\"text\": \"Ccc\", \"email\": \"...\"}))\n+        a = self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Aaa\"}))\n+        b = self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Bbb\"}))\n+        c = self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Ccc\", \"email\": \"...\"}))\n \n         a = loads(a.data)\n         b = loads(b.data)\n         c = loads(c.data)\n \n-        self.assertNotEqual(a['hash'], '192.168.1.1')\n-        self.assertEqual(a['hash'], b['hash'])\n-        self.assertNotEqual(a['hash'], c['hash'])\n+        self.assertNotEqual(a[\"hash\"], \"192.168.1.1\")\n+        self.assertEqual(a[\"hash\"], b[\"hash\"])\n+        self.assertNotEqual(a[\"hash\"], c[\"hash\"])\n \n     def testVisibleFields(self):\n-\n-        rv = self.post('/new?uri=%2Fpath%2F',\n-                       data=json.dumps({\"text\": \"...\", \"invalid\": \"field\"}))\n+        rv = self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"...\", \"invalid\": \"field\"}))\n         self.assertEqual(rv.status_code, 201)\n \n         rv = loads(rv.data)\n@@ -574,178 +502,171 @@ def testVisibleFields(self):\n         self.assertListEqual(list(rv.keys()), [])\n \n     def testNoFeed(self):\n-        rv = self.get('/feed?uri=%2Fpath%2Fnothing')\n+        rv = self.get(\"/feed?uri=%2Fpath%2Fnothing\")\n         self.assertEqual(rv.status_code, 404)\n \n     def testFeedEmpty(self):\n         self.conf.set(\"rss\", \"base\", \"https://example.org\")\n \n-        rv = self.get('/feed?uri=%2Fpath%2Fnothing')\n+        rv = self.get(\"/feed?uri=%2Fpath%2Fnothing\")\n         self.assertEqual(rv.status_code, 200)\n-        self.assertEqual(rv.headers['ETag'], '\"empty\"')\n-        data = rv.data.decode('utf-8')\n-        self.assertEqual(data, \"\"\"<?xml version=\\'1.0\\' encoding=\\'utf-8\\'?>\n-<feed xmlns=\"http://www.w3.org/2005/Atom\" xmlns:thr=\"http://purl.org/syndication/thread/1.0\"><updated>1970-01-01T01:00:00Z</updated><id>tag:example.org,2018:/isso/thread/path/nothing</id><title>Comments for example.org/path/nothing</title></feed>\"\"\")\n+        self.assertEqual(rv.headers[\"ETag\"], '\"empty\"')\n+        data = rv.data.decode(\"utf-8\")\n+        self.assertEqual(\n+            data,\n+            \"\"\"<?xml version=\\'1.0\\' encoding=\\'utf-8\\'?>\n+<feed xmlns=\"http://www.w3.org/2005/Atom\" xmlns:thr=\"http://purl.org/syndication/thread/1.0\"><updated>1970-01-01T01:00:00Z</updated><id>tag:example.org,2018:/isso/thread/path/nothing</id><title>Comments for example.org/path/nothing</title></feed>\"\"\",\n+        )\n \n     def testFeed(self):\n         self.conf.set(\"rss\", \"base\", \"https://example.org\")\n \n-        self.post('/new?uri=%2Fpath%2F', data=json.dumps({'text': 'First'}))\n-        self.post('/new?uri=%2Fpath%2F',\n-                  data=json.dumps({'text': '*Second*', 'parent': 1}))\n+        self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"First\"}))\n+        self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"*Second*\", \"parent\": 1}))\n \n-        rv = self.get('/feed?uri=%2Fpath%2F')\n+        rv = self.get(\"/feed?uri=%2Fpath%2F\")\n         self.assertEqual(rv.status_code, 200)\n-        self.assertEqual(rv.headers['ETag'], '\"1-1\"')\n-        data = rv.data.decode('utf-8')\n-        data = re.sub('[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}\\\\.[0-9]+Z',\n-                      '2018-04-01T10:00:00Z', data)\n+        self.assertEqual(rv.headers[\"ETag\"], '\"1-1\"')\n+        data = rv.data.decode(\"utf-8\")\n+        data = re.sub(\"[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}\\\\.[0-9]+Z\", \"2018-04-01T10:00:00Z\", data)\n         self.maxDiff = None\n         # Two accepted outputs, since different versions of Python sort attributes in different order.\n-        self.assertIn(data, [\"\"\"<?xml version=\\'1.0\\' encoding=\\'utf-8\\'?>\n-<feed xmlns=\"http://www.w3.org/2005/Atom\" xmlns:thr=\"http://purl.org/syndication/thread/1.0\"><updated>2018-04-01T10:00:00Z</updated><id>tag:example.org,2018:/isso/thread/path/</id><title>Comments for example.org/path/</title><entry><id>tag:example.org,2018:/isso/1/1</id><title>Comment #1</title><updated>2018-04-01T10:00:00Z</updated><author><name /></author><link href=\"https://example.org/path/#isso-1\" /><content type=\"html\">&lt;p&gt;First&lt;/p&gt;</content></entry><entry><id>tag:example.org,2018:/isso/1/2</id><title>Comment #2</title><updated>2018-04-01T10:00:00Z</updated><author><name /></author><link href=\"https://example.org/path/#isso-2\" /><content type=\"html\">&lt;p&gt;&lt;em&gt;Second&lt;/em&gt;&lt;/p&gt;</content><thr:in-reply-to href=\"https://example.org/path/#isso-1\" ref=\"tag:example.org,2018:/isso/1/1\" /></entry></feed>\"\"\", \"\"\"<?xml version=\\'1.0\\' encoding=\\'utf-8\\'?>\n-<feed xmlns=\"http://www.w3.org/2005/Atom\" xmlns:thr=\"http://purl.org/syndication/thread/1.0\"><updated>2018-04-01T10:00:00Z</updated><id>tag:example.org,2018:/isso/thread/path/</id><title>Comments for example.org/path/</title><entry><id>tag:example.org,2018:/isso/1/1</id><title>Comment #1</title><updated>2018-04-01T10:00:00Z</updated><author><name /></author><link href=\"https://example.org/path/#isso-1\" /><content type=\"html\">&lt;p&gt;First&lt;/p&gt;</content></entry><entry><id>tag:example.org,2018:/isso/1/2</id><title>Comment #2</title><updated>2018-04-01T10:00:00Z</updated><author><name /></author><link href=\"https://example.org/path/#isso-2\" /><content type=\"html\">&lt;p&gt;&lt;em&gt;Second&lt;/em&gt;&lt;/p&gt;</content><thr:in-reply-to ref=\"tag:example.org,2018:/isso/1/1\" href=\"https://example.org/path/#isso-1\" /></entry></feed>\"\"\"])\n+        self.assertIn(\n+            data,\n+            [\n+                \"\"\"<?xml version=\\'1.0\\' encoding=\\'utf-8\\'?>\n+<feed xmlns=\"http://www.w3.org/2005/Atom\" xmlns:thr=\"http://purl.org/syndication/thread/1.0\"><updated>2018-04-01T10:00:00Z</updated><id>tag:example.org,2018:/isso/thread/path/</id><title>Comments for example.org/path/</title><entry><id>tag:example.org,2018:/isso/1/1</id><title>Comment #1</title><updated>2018-04-01T10:00:00Z</updated><author><name /></author><link href=\"https://example.org/path/#isso-1\" /><content type=\"html\">&lt;p&gt;First&lt;/p&gt;</content></entry><entry><id>tag:example.org,2018:/isso/1/2</id><title>Comment #2</title><updated>2018-04-01T10:00:00Z</updated><author><name /></author><link href=\"https://example.org/path/#isso-2\" /><content type=\"html\">&lt;p&gt;&lt;em&gt;Second&lt;/em&gt;&lt;/p&gt;</content><thr:in-reply-to href=\"https://example.org/path/#isso-1\" ref=\"tag:example.org,2018:/isso/1/1\" /></entry></feed>\"\"\",\n+                \"\"\"<?xml version=\\'1.0\\' encoding=\\'utf-8\\'?>\n+<feed xmlns=\"http://www.w3.org/2005/Atom\" xmlns:thr=\"http://purl.org/syndication/thread/1.0\"><updated>2018-04-01T10:00:00Z</updated><id>tag:example.org,2018:/isso/thread/path/</id><title>Comments for example.org/path/</title><entry><id>tag:example.org,2018:/isso/1/1</id><title>Comment #1</title><updated>2018-04-01T10:00:00Z</updated><author><name /></author><link href=\"https://example.org/path/#isso-1\" /><content type=\"html\">&lt;p&gt;First&lt;/p&gt;</content></entry><entry><id>tag:example.org,2018:/isso/1/2</id><title>Comment #2</title><updated>2018-04-01T10:00:00Z</updated><author><name /></author><link href=\"https://example.org/path/#isso-2\" /><content type=\"html\">&lt;p&gt;&lt;em&gt;Second&lt;/em&gt;&lt;/p&gt;</content><thr:in-reply-to ref=\"tag:example.org,2018:/isso/1/1\" href=\"https://example.org/path/#isso-1\" /></entry></feed>\"\"\",\n+            ],\n+        )\n \n     def testCounts(self):\n-\n-        rv = self.post('/count', data=json.dumps(['/path/']))\n+        rv = self.post(\"/count\", data=json.dumps([\"/path/\"]))\n         self.assertEqual(rv.status_code, 200)\n         self.assertEqual(loads(rv.data), [0])\n \n-        self.post('/new?uri=%2Fpath%2F', data=json.dumps({\"text\": \"...\"}))\n+        self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"...\"}))\n \n-        rv = self.post('/count', data=json.dumps(['/path/']))\n+        rv = self.post(\"/count\", data=json.dumps([\"/path/\"]))\n         self.assertEqual(rv.status_code, 200)\n         self.assertEqual(loads(rv.data), [1])\n \n         for x in range(3):\n-            self.post('/new?uri=%2Fpath%2F', data=json.dumps({\"text\": \"...\"}))\n+            self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"...\"}))\n \n-        rv = self.post('/count', data=json.dumps(['/path/']))\n+        rv = self.post(\"/count\", data=json.dumps([\"/path/\"]))\n         self.assertEqual(rv.status_code, 200)\n         self.assertEqual(loads(rv.data), [4])\n \n         for x in range(4):\n-            self.delete('/id/%i' % (x + 1))\n+            self.delete(\"/id/%i\" % (x + 1))\n \n-        rv = self.post('/count', data=json.dumps(['/path/']))\n+        rv = self.post(\"/count\", data=json.dumps([\"/path/\"]))\n         self.assertEqual(rv.status_code, 200)\n         self.assertEqual(loads(rv.data), [0])\n \n     def testMultipleCounts(self):\n-\n-        expected = {'a': 1, 'b': 2, 'c': 0}\n+        expected = {\"a\": 1, \"b\": 2, \"c\": 0}\n \n         for uri, count in expected.items():\n             for _ in range(count):\n-                self.post('/new?uri=%s' %\n-                          uri, data=json.dumps({\"text\": \"...\"}))\n+                self.post(\"/new?uri=%s\" % uri, data=json.dumps({\"text\": \"...\"}))\n \n-        rv = self.post('/count', data=json.dumps(list(expected.keys())))\n+        rv = self.post(\"/count\", data=json.dumps(list(expected.keys())))\n         self.assertEqual(loads(rv.data), list(expected.values()))\n \n     def testModify(self):\n-        self.post('/new?uri=test', data=json.dumps({\"text\": \"Tpyo\"}))\n+        self.post(\"/new?uri=test\", data=json.dumps({\"text\": \"Tpyo\"}))\n \n-        self.put('/id/1', data=json.dumps({\"text\": \"Tyop\"}))\n-        self.assertEqual(loads(self.get('/id/1').data)[\"text\"], \"<p>Tyop</p>\")\n+        self.put(\"/id/1\", data=json.dumps({\"text\": \"Tyop\"}))\n+        self.assertEqual(loads(self.get(\"/id/1\").data)[\"text\"], \"<p>Tyop</p>\")\n \n-        self.put('/id/1', data=json.dumps({\"text\": \"Typo\"}))\n-        self.assertEqual(loads(self.get('/id/1').data)[\"text\"], \"<p>Typo</p>\")\n+        self.put(\"/id/1\", data=json.dumps({\"text\": \"Typo\"}))\n+        self.assertEqual(loads(self.get(\"/id/1\").data)[\"text\"], \"<p>Typo</p>\")\n \n     def testDeleteCommentRemovesThread(self):\n-\n-        self.client.post('/new?uri=%2F', data=json.dumps({\"text\": \"...\"}))\n-        self.assertIn('/', self.app.db.threads)\n-        self.client.delete('/id/1')\n-        self.assertNotIn('/', self.app.db.threads)\n+        self.client.post(\"/new?uri=%2F\", data=json.dumps({\"text\": \"...\"}))\n+        self.assertIn(\"/\", self.app.db.threads)\n+        self.client.delete(\"/id/1\")\n+        self.assertNotIn(\"/\", self.app.db.threads)\n \n     def testCSRF(self):\n-\n         js = \"application/json\"\n         form = \"application/x-www-form-urlencoded\"\n \n-        self.post('/new?uri=%2F', data=json.dumps({\"text\": \"...\"}))\n+        self.post(\"/new?uri=%2F\", data=json.dumps({\"text\": \"...\"}))\n \n         # no header is fine (default for XHR)\n-        self.assertEqual(\n-            self.post('/id/1/dislike', content_type=\"\").status_code, 200)\n+        self.assertEqual(self.post(\"/id/1/dislike\", content_type=\"\").status_code, 200)\n \n         # x-www-form-urlencoded is definitely not RESTful\n-        self.assertEqual(\n-            self.post('/id/1/dislike', content_type=form).status_code, 403)\n-        self.assertEqual(self.post('/new?uri=%2F', data=json.dumps({\"text\": \"...\"}),\n-                                   content_type=form).status_code, 403)\n+        self.assertEqual(self.post(\"/id/1/dislike\", content_type=form).status_code, 403)\n+        self.assertEqual(self.post(\"/new?uri=%2F\", data=json.dumps({\"text\": \"...\"}), content_type=form).status_code, 403)\n         # just for the record\n-        self.assertEqual(\n-            self.post('/id/1/dislike', content_type=js).status_code, 200)\n+        self.assertEqual(self.post(\"/id/1/dislike\", content_type=js).status_code, 200)\n \n     def testPreview(self):\n-        response = self.post(\n-            '/preview', data=json.dumps({'text': 'This is **mark**_down_'}))\n+        response = self.post(\"/preview\", data=json.dumps({\"text\": \"This is **mark**_down_\"}))\n         self.assertEqual(response.status_code, 200)\n \n         rv = loads(response.data)\n-        self.assertEqual(\n-            '<p>This is <strong>mark</strong><em>down</em></p>',\n-            rv[\"text\"])\n+        self.assertEqual(\"<p>This is <strong>mark</strong><em>down</em></p>\", rv[\"text\"])\n \n     def testTitleNull(self):\n         # Thread title set to `null` in API request\n         # Javascript `null` equals Python `None`\n-        self.post('/new?uri=%2Fpath%2F',\n-                  data=json.dumps({'text': 'Spam', 'title': None}))\n+        self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Spam\", \"title\": None}))\n \n         thread = self.app.db.threads.get(1)\n         # Expect server to attempt to parse uri to extract title\n         # utils.parse cannot parse fake /path/, so default=\"Untitled.\"\n-        self.assertEqual(thread.get('title'), \"Untitled.\")\n+        self.assertEqual(thread.get(\"title\"), \"Untitled.\")\n \n     def testLatestOk(self):\n         # load some comments in a mix of posts\n         saved = []\n         for idx, post_id in enumerate([1, 2, 2, 1, 2, 1, 3, 1, 4, 2, 3, 4, 1, 2]):\n-            text = 'text-{}'.format(idx)\n-            post_uri = 'test-{}'.format(post_id)\n-            self.post('/new?uri=' + post_uri, data=json.dumps({'text': text}))\n+            text = \"text-{}\".format(idx)\n+            post_uri = \"test-{}\".format(post_id)\n+            self.post(\"/new?uri=\" + post_uri, data=json.dumps({\"text\": text}))\n             saved.append((post_uri, text))\n \n-        response = self.get('/latest?limit=5')\n+        response = self.get(\"/latest?limit=5\")\n         self.assertEqual(response.status_code, 200)\n \n         body = loads(response.data)\n         expected_items = saved[-5:]  # latest 5\n         for reply, expected in zip(body, expected_items):\n             expected_uri, expected_text = expected\n-            self.assertIn(expected_text, reply['text'])\n-            self.assertEqual(expected_uri, reply['uri'])\n+            self.assertIn(expected_text, reply[\"text\"])\n+            self.assertEqual(expected_uri, reply[\"uri\"])\n \n     def testLatestWithoutLimit(self):\n-        response = self.get('/latest')\n+        response = self.get(\"/latest\")\n         self.assertEqual(response.status_code, 400)\n \n     def testLatestBadLimitNaN(self):\n-        response = self.get('/latest?limit=WAT')\n+        response = self.get(\"/latest?limit=WAT\")\n         self.assertEqual(response.status_code, 400)\n \n     def testLatestBadLimitNegative(self):\n-        response = self.get('/latest?limit=-12')\n+        response = self.get(\"/latest?limit=-12\")\n         self.assertEqual(response.status_code, 400)\n \n     def testLatestBadLimitZero(self):\n-        response = self.get('/latest?limit=0')\n+        response = self.get(\"/latest?limit=0\")\n         self.assertEqual(response.status_code, 400)\n \n     def testLatestNotEnabled(self):\n         # disable the endpoint\n         self.conf.set(\"general\", \"latest-enabled\", \"false\")\n \n-        response = self.get('/latest?limit=5')\n+        response = self.get(\"/latest?limit=5\")\n         self.assertEqual(response.status_code, 404)\n \n \n class TestHostDependent(unittest.TestCase):\n-\n     def setUp(self):\n         fd, self.path = tempfile.mkstemp()\n         conf = config.load(config.default_file())\n@@ -765,17 +686,15 @@ def tearDown(self):\n \n     def testSecureCookieNoConf(self):\n         self.app.wsgi_app = FakeHost(self.app.wsgi_app, \"isso-dev.local\", \"https\")\n-        rv = self.post('/new?uri=%2Fpath%2F',\n-                       data=json.dumps({'text': 'Lorem ipsum ...'}))\n+        rv = self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Lorem ipsum ...\"}))\n \n         self.assertIn(\"Secure\", rv.headers[\"Set-Cookie\"])\n         self.assertIn(\"Secure\", rv.headers[\"X-Set-Cookie\"])\n         self.assertIn(\"SameSite=None\", rv.headers[\"Set-Cookie\"])\n \n     def testInSecureCookieNoConf(self):\n         self.app.wsgi_app = FakeHost(self.app.wsgi_app, \"isso-dev.local\", \"http\")\n-        rv = self.post('/new?uri=%2Fpath%2F',\n-                       data=json.dumps({'text': 'Lorem ipsum ...'}))\n+        rv = self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Lorem ipsum ...\"}))\n \n         self.assertNotIn(\"Secure\", rv.headers[\"Set-Cookie\"])\n         self.assertNotIn(\"Secure\", rv.headers[\"X-Set-Cookie\"])\n@@ -787,8 +706,7 @@ def testSameSiteConfNone(self):\n         # Conf overrides SameSite setting\n         self.conf.set(\"server\", \"samesite\", \"None\")\n \n-        rv = self.post('/new?uri=%2Fpath%2F',\n-                       data=json.dumps({'text': 'Lorem ipsum ...'}))\n+        rv = self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Lorem ipsum ...\"}))\n \n         self.assertNotIn(\"Secure\", rv.headers[\"Set-Cookie\"])\n         self.assertNotIn(\"Secure\", rv.headers[\"X-Set-Cookie\"])\n@@ -800,16 +718,14 @@ def testSameSiteConfLax(self):\n         # Conf overrides SameSite setting\n         self.conf.set(\"server\", \"samesite\", \"Lax\")\n \n-        rv = self.post('/new?uri=%2Fpath%2F',\n-                       data=json.dumps({'text': 'Lorem ipsum ...'}))\n+        rv = self.post(\"/new?uri=%2Fpath%2F\", data=json.dumps({\"text\": \"Lorem ipsum ...\"}))\n \n         self.assertIn(\"Secure\", rv.headers[\"Set-Cookie\"])\n         self.assertIn(\"Secure\", rv.headers[\"X-Set-Cookie\"])\n         self.assertIn(\"SameSite=Lax\", rv.headers[\"Set-Cookie\"])\n \n \n class TestModeratedComments(unittest.TestCase):\n-\n     def setUp(self):\n         fd, self.path = tempfile.mkstemp()\n         conf = config.load(config.default_file())\n@@ -829,48 +745,44 @@ def tearDown(self):\n         os.unlink(self.path)\n \n     def testAddComment(self):\n-\n-        rv = self.client.post(\n-            '/new?uri=test', data=json.dumps({\"text\": \"...\"}))\n+        rv = self.client.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n         self.assertEqual(rv.status_code, 202)\n \n-        self.assertEqual(self.client.get('/id/1').status_code, 200)\n-        self.assertEqual(self.client.get('/?uri=test').status_code, 200)\n+        self.assertEqual(self.client.get(\"/id/1\").status_code, 200)\n+        self.assertEqual(self.client.get(\"/?uri=test\").status_code, 200)\n \n-        data = loads(self.client.get('/?uri=test').data)\n-        self.assertEqual(len(data['replies']), 0)\n+        data = loads(self.client.get(\"/?uri=test\").data)\n+        self.assertEqual(len(data[\"replies\"]), 0)\n \n         self.app.db.comments.activate(1)\n-        self.assertEqual(self.client.get('/?uri=test').status_code, 200)\n+        self.assertEqual(self.client.get(\"/?uri=test\").status_code, 200)\n \n     def testModerateComment(self):\n-\n         id_ = 1\n         signed = self.app.sign(id_)\n \n         # Create new comment, should have mode=2 (pending moderation)\n-        rv = self.client.post(\n-            '/new?uri=/moderated', data=json.dumps({\"text\": \"...\"}))\n+        rv = self.client.post(\"/new?uri=/moderated\", data=json.dumps({\"text\": \"...\"}))\n         self.assertEqual(rv.status_code, 202)\n-        self.assertEqual(self.client.get('/id/1').status_code, 200)\n+        self.assertEqual(self.client.get(\"/id/1\").status_code, 200)\n         self.assertEqual(self.app.db.comments.get(id_)[\"mode\"], 2)\n         self.assertEqual(self.app.db.comments.get(id_)[\"text\"], \"...\")\n \n         # GET should return some html form\n         action = \"activate\"\n-        rv_activate_get = self.client.get('/id/%d/%s/%s' % (id_, action, signed))\n+        rv_activate_get = self.client.get(\"/id/%d/%s/%s\" % (id_, action, signed))\n         self.assertEqual(rv_activate_get.status_code, 200)\n         self.assertIn(b\"Activate: Are you sure?\", rv_activate_get.data)\n         self.assertIn(b\"http://invalid.local/moderated#isso-1\", rv_activate_get.data)\n \n         # Activate comment\n         action = \"activate\"\n-        rv_activated = self.client.post('/id/%d/%s/%s' % (id_, action, signed))\n+        rv_activated = self.client.post(\"/id/%d/%s/%s\" % (id_, action, signed))\n         self.assertEqual(rv_activated.status_code, 200)\n         self.assertEqual(rv_activated.data, b\"Comment has been activated\")\n \n         # Activating should be idempotent\n-        rv_activated = self.client.post('/id/%d/%s/%s' % (id_, action, signed))\n+        rv_activated = self.client.post(\"/id/%d/%s/%s\" % (id_, action, signed))\n         self.assertEqual(rv_activated.status_code, 200)\n         self.assertEqual(rv_activated.data, b\"Already activated\")\n \n@@ -879,19 +791,19 @@ def testModerateComment(self):\n \n         # Edit comment\n         action = \"edit\"\n-        rv_edit = self.client.post('/id/%d/%s/%s' % (id_, action, signed), data=json.dumps({\"text\": \"new text\"}))\n+        rv_edit = self.client.post(\"/id/%d/%s/%s\" % (id_, action, signed), data=json.dumps({\"text\": \"new text\"}))\n         self.assertEqual(rv_edit.status_code, 200)\n         self.assertEqual(json.loads(rv_edit.data)[\"id\"], id_)\n         self.assertEqual(self.app.db.comments.get(id_)[\"text\"], \"new text\")\n \n         # Wrong action on comment is handled by the routing\n         action = \"foo\"\n-        rv_wrong_action = self.client.post('/id/%d/%s/%s' % (id_, action, signed))\n+        rv_wrong_action = self.client.post(\"/id/%d/%s/%s\" % (id_, action, signed))\n         self.assertEqual(rv_wrong_action.status_code, 404)\n \n         # Delete comment\n         action = \"delete\"\n-        rv_deleted = self.client.post('/id/%d/%s/%s' % (id_, action, signed))\n+        rv_deleted = self.client.post(\"/id/%d/%s/%s\" % (id_, action, signed))\n         self.assertEqual(rv_deleted.status_code, 200)\n         self.assertEqual(rv_deleted.data, b\"Comment has been deleted\")\n \n@@ -903,17 +815,19 @@ def testModerateEditXSSPayloadIsEscaped(self):\n         id_ = 1\n         signed = self.app.sign(id_)\n \n-        self.client.post('/new?uri=/moderated', data=json.dumps({\"text\": \"...\"}))\n+        self.client.post(\"/new?uri=/moderated\", data=json.dumps({\"text\": \"...\"}))\n \n         website_payload = \"http://x.com/?'onmouseover='alert(document.domain)'x='\"\n         author_payload = \"<script>alert(1)</script>\"\n         rv = self.client.post(\n-            '/id/%d/edit/%s' % (id_, signed),\n-            data=json.dumps({\n-                \"text\": \"new text\",\n-                \"author\": author_payload,\n-                \"website\": website_payload,\n-            }),\n+            \"/id/%d/edit/%s\" % (id_, signed),\n+            data=json.dumps(\n+                {\n+                    \"text\": \"new text\",\n+                    \"author\": author_payload,\n+                    \"website\": website_payload,\n+                }\n+            ),\n         )\n         self.assertEqual(rv.status_code, 200)\n \n@@ -928,7 +842,6 @@ def testModerateEditXSSPayloadIsEscaped(self):\n \n \n class TestUnsubscribe(unittest.TestCase):\n-\n     def setUp(self):\n         fd, self.path = tempfile.mkstemp()\n         conf = config.load(config.default_file())\n@@ -945,8 +858,7 @@ class App(Isso, core.Mixin):\n         self.client = JSONClient(self.app, Response)\n \n         # add default comment\n-        rv = self.client.post(\n-            '/new?uri=test', data=json.dumps({\"text\": \"...\"}))\n+        rv = self.client.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n         self.assertEqual(rv.status_code, 202)\n \n     def tearDown(self):\n@@ -955,26 +867,25 @@ def tearDown(self):\n     def testUnsubscribe(self):\n         id_ = 1\n         email = \"test@test.example\"\n-        key = self.app.sign(('unsubscribe', email))\n+        key = self.app.sign((\"unsubscribe\", email))\n \n         # GET should return some html form\n-        rv_unsubscribe_get = self.client.get('/id/%d/unsubscribe/%s/%s' % (id_, email, key))\n+        rv_unsubscribe_get = self.client.get(\"/id/%d/unsubscribe/%s/%s\" % (id_, email, key))\n         self.assertEqual(rv_unsubscribe_get.status_code, 200)\n         self.assertIn(b\"Successfully unsubscribed\", rv_unsubscribe_get.data)\n \n         # Incomplete key should fail\n-        key = self.app.sign(['unsubscribe'])\n-        rv_incomplete_key = self.client.get('/id/%d/unsubscribe/%s/%s' % (id_, email, key))\n+        key = self.app.sign([\"unsubscribe\"])\n+        rv_incomplete_key = self.client.get(\"/id/%d/unsubscribe/%s/%s\" % (id_, email, key))\n         self.assertEqual(rv_incomplete_key.status_code, 403)\n \n         # Wrong key type should fail\n         key = self.app.sign(1)\n-        rv_wrong_key_type = self.client.get('/id/%d/unsubscribe/%s/%s' % (id_, email, key))\n+        rv_wrong_key_type = self.client.get(\"/id/%d/unsubscribe/%s/%s\" % (id_, email, key))\n         self.assertEqual(rv_wrong_key_type.status_code, 403)\n \n \n class TestPurgeComments(unittest.TestCase):\n-\n     def setUp(self):\n         fd, self.path = tempfile.mkstemp()\n         conf = config.load(config.default_file())\n@@ -991,16 +902,16 @@ class App(Isso, core.Mixin):\n         self.client = JSONClient(self.app, Response)\n \n     def testPurgeDoesNoHarm(self):\n-        self.client.post('/new?uri=test', data=json.dumps({\"text\": \"...\"}))\n+        self.client.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n         self.app.db.comments.activate(1)\n         self.app.db.comments.purge(0)\n-        self.assertEqual(self.client.get('/?uri=test').status_code, 200)\n+        self.assertEqual(self.client.get(\"/?uri=test\").status_code, 200)\n \n     def testPurgeWorks(self):\n-        self.client.post('/new?uri=test', data=json.dumps({\"text\": \"...\"}))\n+        self.client.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n         self.app.db.comments.purge(0)\n-        self.assertEqual(self.client.get('/id/1').status_code, 404)\n+        self.assertEqual(self.client.get(\"/id/1\").status_code, 404)\n \n-        self.client.post('/new?uri=test', data=json.dumps({\"text\": \"...\"}))\n+        self.client.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n         self.app.db.comments.purge(3600)\n-        self.assertEqual(self.client.get('/id/1').status_code, 200)\n+        self.assertEqual(self.client.get(\"/id/1\").status_code, 200)"
    },
    {
      "sha": "1a7380d7951e34ae41c6c88d0e73a2c25deb4a6a",
      "filename": "isso/tests/test_config.py",
      "status": "modified",
      "additions": 33,
      "deletions": 30,
      "changes": 63,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_config.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_config.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Ftests%2Ftest_config.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -8,11 +8,10 @@\n \n \n class TestConfig(unittest.TestCase):\n-\n     def test_parser(self):\n-\n         parser = config.IssoParser()\n-        parser.read_file(io.StringIO(\"\"\"\n+        parser.read_file(\n+            io.StringIO(\"\"\"\n             [foo]\n             bar = 1h\n             baz = 12\n@@ -21,65 +20,69 @@ def test_parser(self):\n                 spam\n                 ham\n             asd = fgh\n-            password = %s%%foo\"\"\"))\n+            password = %s%%foo\"\"\")\n+        )\n \n         self.assertEqual(parser.getint(\"foo\", \"bar\"), 3600)\n         self.assertEqual(parser.getint(\"foo\", \"baz\"), 12)\n-        self.assertEqual(parser.getlist(\"foo\", \"spam\"), ['a', 'b', 'cdef'])\n-        self.assertEqual(list(parser.getiter(\"foo\", \"bla\")), ['spam', 'ham'])\n-        self.assertEqual(list(parser.getiter(\"foo\", \"asd\")), ['fgh'])\n+        self.assertEqual(parser.getlist(\"foo\", \"spam\"), [\"a\", \"b\", \"cdef\"])\n+        self.assertEqual(list(parser.getiter(\"foo\", \"bla\")), [\"spam\", \"ham\"])\n+        self.assertEqual(list(parser.getiter(\"foo\", \"asd\")), [\"fgh\"])\n \n         # Strings containing '%' should not be python-interpolated\n-        self.assertEqual(parser.get(\"foo\", \"password\"), '%s%%foo')\n+        self.assertEqual(parser.get(\"foo\", \"password\"), \"%s%%foo\")\n \n         # Section.get() should function the same way as plain IssoParser\n         foosection = parser.section(\"foo\")\n-        self.assertEqual(foosection.get(\"password\"), '%s%%foo')\n+        self.assertEqual(foosection.get(\"password\"), \"%s%%foo\")\n \n     def test_parser_with_environment_variables(self):\n-\n         parser = config.IssoParser()\n-        parser.read_file(io.StringIO(\"\"\"\n+        parser.read_file(\n+            io.StringIO(\"\"\"\n             [foo]\n             bar = $TEST_ENV_VAR\n             baz = ${TEST_ENV_VAR2}\n-        \"\"\"))\n+        \"\"\")\n+        )\n \n         # Set environment variables\n-        os.environ['TEST_ENV_VAR'] = 'test_value'\n-        os.environ['TEST_ENV_VAR2'] = 'another_test_value'\n+        os.environ[\"TEST_ENV_VAR\"] = \"test_value\"\n+        os.environ[\"TEST_ENV_VAR2\"] = \"another_test_value\"\n \n         # Test environment variable expansion\n-        self.assertEqual(parser.get(\"foo\", \"bar\"), 'test_value')\n-        self.assertEqual(parser.get(\"foo\", \"baz\"), 'another_test_value')\n+        self.assertEqual(parser.get(\"foo\", \"bar\"), \"test_value\")\n+        self.assertEqual(parser.get(\"foo\", \"baz\"), \"another_test_value\")\n \n         # Test Section.get() with environment variables\n         foosection = parser.section(\"foo\")\n-        self.assertEqual(foosection.get(\"bar\"), 'test_value')\n-        self.assertEqual(foosection.get(\"baz\"), 'another_test_value')\n+        self.assertEqual(foosection.get(\"bar\"), \"test_value\")\n+        self.assertEqual(foosection.get(\"baz\"), \"another_test_value\")\n \n         # Clean up environment variables\n-        del os.environ['TEST_ENV_VAR']\n-        del os.environ['TEST_ENV_VAR2']\n+        del os.environ[\"TEST_ENV_VAR\"]\n+        del os.environ[\"TEST_ENV_VAR2\"]\n \n     def test_parser_with_missing_environment_variables(self):\n-\n         parser = config.IssoParser()\n-        parser.read_file(io.StringIO(\"\"\"\n+        parser.read_file(\n+            io.StringIO(\"\"\"\n             [foo]\n             bar = $MISSING_ENV_VAR\n-        \"\"\"))\n+        \"\"\")\n+        )\n \n-        self.assertEqual(parser.get(\"foo\", \"bar\"), '$MISSING_ENV_VAR')\n+        self.assertEqual(parser.get(\"foo\", \"bar\"), \"$MISSING_ENV_VAR\")\n \n     def test_parser_with_special_characters_in_environment_variables(self):\n-\n-        os.environ['SPECIAL_ENV_VAR'] = 'value_with_$pecial_characters'\n+        os.environ[\"SPECIAL_ENV_VAR\"] = \"value_with_$pecial_characters\"\n         parser = config.IssoParser()\n-        parser.read_file(io.StringIO(\"\"\"\n+        parser.read_file(\n+            io.StringIO(\"\"\"\n             [foo]\n             bar = $SPECIAL_ENV_VAR\n-        \"\"\"))\n+        \"\"\")\n+        )\n \n-        self.assertEqual(parser.get(\"foo\", \"bar\"), 'value_with_$pecial_characters')\n-        del os.environ['SPECIAL_ENV_VAR']\n+        self.assertEqual(parser.get(\"foo\", \"bar\"), \"value_with_$pecial_characters\")\n+        del os.environ[\"SPECIAL_ENV_VAR\"]"
    },
    {
      "sha": "026345d3c4564d8304bd7a2d7c998a56e548415f",
      "filename": "isso/tests/test_cors.py",
      "status": "modified",
      "additions": 22,
      "deletions": 30,
      "changes": 52,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_cors.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_cors.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Ftests%2Ftest_cors.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -9,59 +9,51 @@\n \n \n def hello_world(environ, start_response):\n-    start_response('200 OK', [('Content-Type', 'text/html')])\n+    start_response(\"200 OK\", [(\"Content-Type\", \"text/html\")])\n     return [\"Hello, World.\"]\n \n \n class CORSTest(unittest.TestCase):\n-\n     def test_simple(self):\n-\n-        app = CORSMiddleware(hello_world,\n-                             origin=origin([\n-                                 \"https://example.tld/\",\n-                                 \"http://example.tld/\",\n-                             ]),\n-                             allowed=(\"Foo\", \"Bar\"), exposed=(\"Spam\", ))\n+        app = CORSMiddleware(\n+            hello_world,\n+            origin=origin(\n+                [\n+                    \"https://example.tld/\",\n+                    \"http://example.tld/\",\n+                ]\n+            ),\n+            allowed=(\"Foo\", \"Bar\"),\n+            exposed=(\"Spam\",),\n+        )\n \n         client = Client(app, Response)\n \n         rv = client.get(\"/\", headers={\"Origin\": \"https://example.tld\"})\n \n-        self.assertEqual(\n-            rv.headers[\"Access-Control-Allow-Origin\"], \"https://example.tld\")\n-        self.assertEqual(\n-            rv.headers[\"Access-Control-Allow-Credentials\"], \"true\")\n-        self.assertEqual(\n-            rv.headers[\"Access-Control-Allow-Methods\"], \"HEAD, GET, POST, PUT, DELETE\")\n-        self.assertEqual(\n-            rv.headers[\"Access-Control-Allow-Headers\"], \"Foo, Bar\")\n+        self.assertEqual(rv.headers[\"Access-Control-Allow-Origin\"], \"https://example.tld\")\n+        self.assertEqual(rv.headers[\"Access-Control-Allow-Credentials\"], \"true\")\n+        self.assertEqual(rv.headers[\"Access-Control-Allow-Methods\"], \"HEAD, GET, POST, PUT, DELETE\")\n+        self.assertEqual(rv.headers[\"Access-Control-Allow-Headers\"], \"Foo, Bar\")\n         self.assertEqual(rv.headers[\"Access-Control-Expose-Headers\"], \"Spam\")\n \n         a = client.get(\"/\", headers={\"Origin\": \"http://example.tld\"})\n-        self.assertEqual(\n-            a.headers[\"Access-Control-Allow-Origin\"], \"http://example.tld\")\n+        self.assertEqual(a.headers[\"Access-Control-Allow-Origin\"], \"http://example.tld\")\n \n         b = client.get(\"/\", headers={\"Origin\": \"http://example.tld\"})\n-        self.assertEqual(\n-            b.headers[\"Access-Control-Allow-Origin\"], \"http://example.tld\")\n+        self.assertEqual(b.headers[\"Access-Control-Allow-Origin\"], \"http://example.tld\")\n \n         c = client.get(\"/\", headers={\"Origin\": \"http://foo.other\"})\n-        self.assertEqual(\n-            c.headers[\"Access-Control-Allow-Origin\"], \"https://example.tld\")\n+        self.assertEqual(c.headers[\"Access-Control-Allow-Origin\"], \"https://example.tld\")\n \n     def test_preflight(self):\n-\n-        app = CORSMiddleware(hello_world, origin=origin([\"http://example.tld\"]),\n-                             allowed=(\"Foo\", ), exposed=(\"Bar\", ))\n+        app = CORSMiddleware(hello_world, origin=origin([\"http://example.tld\"]), allowed=(\"Foo\",), exposed=(\"Bar\",))\n         client = Client(app, Response)\n \n-        rv = client.open(method=\"OPTIONS\", path=\"/\",\n-                         headers={\"Origin\": \"http://example.tld\"})\n+        rv = client.open(method=\"OPTIONS\", path=\"/\", headers={\"Origin\": \"http://example.tld\"})\n         self.assertEqual(rv.status_code, 200)\n \n         for hdr in (\"Origin\", \"Headers\", \"Credentials\", \"Methods\"):\n             self.assertIn(\"Access-Control-Allow-%s\" % hdr, rv.headers)\n \n-        self.assertEqual(\n-            rv.headers[\"Access-Control-Allow-Origin\"], \"http://example.tld\")\n+        self.assertEqual(rv.headers[\"Access-Control-Allow-Origin\"], \"http://example.tld\")"
    },
    {
      "sha": "dd43fa52eaf1e38894e0328bc920fb3845313eb3",
      "filename": "isso/tests/test_db.py",
      "status": "modified",
      "additions": 109,
      "deletions": 159,
      "changes": 268,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_db.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_db.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Ftests%2Ftest_db.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -10,34 +10,21 @@\n \n \n class TestDBMigration(unittest.TestCase):\n-\n     def setUp(self):\n         fd, self.path = tempfile.mkstemp()\n \n     def tearDown(self):\n         os.unlink(self.path)\n \n     def test_defaults(self):\n-\n-        conf = config.new({\n-            \"general\": {\n-                \"dbpath\": \"/dev/null\",\n-                \"max-age\": \"1h\"\n-            }\n-        })\n+        conf = config.new({\"general\": {\"dbpath\": \"/dev/null\", \"max-age\": \"1h\"}})\n         db = SQLite3(self.path, conf)\n \n         self.assertEqual(db.version, SQLite3.MAX_VERSION)\n         self.assertTrue(db.preferences.get(\"session-key\", \"\").isalnum())\n \n     def test_session_key_migration(self):\n-\n-        conf = config.new({\n-            \"general\": {\n-                \"dbpath\": \"/dev/null\",\n-                \"max-age\": \"1h\"\n-            }\n-        })\n+        conf = config.new({\"general\": {\"dbpath\": \"/dev/null\", \"max-age\": \"1h\"}})\n         conf.set(\"general\", \"session-key\", \"supersecretkey\")\n \n         with sqlite3.connect(self.path) as con:\n@@ -47,100 +34,72 @@ def test_session_key_migration(self):\n         db = SQLite3(self.path, conf)\n \n         self.assertEqual(db.version, SQLite3.MAX_VERSION)\n-        self.assertEqual(db.preferences.get(\"session-key\"),\n-                         conf.get(\"general\", \"session-key\"))\n+        self.assertEqual(db.preferences.get(\"session-key\"), conf.get(\"general\", \"session-key\"))\n \n         # try again, now with the session-key removed from our conf\n         conf.remove_option(\"general\", \"session-key\")\n         db = SQLite3(self.path, conf)\n \n         self.assertEqual(db.version, SQLite3.MAX_VERSION)\n-        self.assertEqual(db.preferences.get(\"session-key\"),\n-                         \"supersecretkey\")\n+        self.assertEqual(db.preferences.get(\"session-key\"), \"supersecretkey\")\n \n     def test_limit_nested_comments(self):\n         \"\"\"Transform previously A -> B -> C comment nesting to A -> B, A -> C\"\"\"\n \n-        tree = {\n-            1: None,\n-            2: None,\n-            3: 2,\n-            4: 3,\n-            7: 3,\n-            5: 2,\n-            6: None\n-        }\n+        tree = {1: None, 2: None, 3: 2, 4: 3, 7: 3, 5: 2, 6: None}\n \n         with sqlite3.connect(self.path) as con:\n             con.execute(\"PRAGMA user_version = 2\")\n-            con.execute(\"CREATE TABLE threads (\"\n-                        \"    id INTEGER PRIMARY KEY,\"\n-                        \"    uri VARCHAR UNIQUE,\"\n-                        \"    title VARCHAR)\")\n-            con.execute(\"CREATE TABLE comments (\"\n-                        \"    tid REFERENCES threads(id),\"\n-                        \"    id INTEGER PRIMARY KEY,\"\n-                        \"    parent INTEGER,\"\n-                        \"    created FLOAT NOT NULL, modified FLOAT,\"\n-                        \"    text VARCHAR, author VARCHAR, email VARCHAR, website VARCHAR,\"\n-                        \"    mode INTEGER,\"\n-                        \"    remote_addr VARCHAR,\"\n-                        \"    likes INTEGER DEFAULT 0,\"\n-                        \"    dislikes INTEGER DEFAULT 0,\"\n-                        \"    voters BLOB NOT NULL)\")\n-\n+            con.execute(\"CREATE TABLE threads (    id INTEGER PRIMARY KEY,    uri VARCHAR UNIQUE,    title VARCHAR)\")\n             con.execute(\n-                \"INSERT INTO threads (uri, title) VALUES (?, ?)\", (\"/\", \"Test\"))\n-            for (id, parent) in tree.items():\n-                con.execute(\"INSERT INTO comments (\"\n-                            \"   id, parent, created, voters)\"\n-                            \"VALUEs (?, ?, ?, ?)\", (id, parent, id, sqlite3.Binary(b\"\")))\n-\n-        conf = config.new({\n-            \"general\": {\n-                \"dbpath\": \"/dev/null\",\n-                \"max-age\": \"1h\"\n-            }\n-        })\n+                \"CREATE TABLE comments (\"\n+                \"    tid REFERENCES threads(id),\"\n+                \"    id INTEGER PRIMARY KEY,\"\n+                \"    parent INTEGER,\"\n+                \"    created FLOAT NOT NULL, modified FLOAT,\"\n+                \"    text VARCHAR, author VARCHAR, email VARCHAR, website VARCHAR,\"\n+                \"    mode INTEGER,\"\n+                \"    remote_addr VARCHAR,\"\n+                \"    likes INTEGER DEFAULT 0,\"\n+                \"    dislikes INTEGER DEFAULT 0,\"\n+                \"    voters BLOB NOT NULL)\"\n+            )\n+\n+            con.execute(\"INSERT INTO threads (uri, title) VALUES (?, ?)\", (\"/\", \"Test\"))\n+            for id, parent in tree.items():\n+                con.execute(\n+                    \"INSERT INTO comments (   id, parent, created, voters)VALUEs (?, ?, ?, ?)\",\n+                    (id, parent, id, sqlite3.Binary(b\"\")),\n+                )\n+\n+        conf = config.new({\"general\": {\"dbpath\": \"/dev/null\", \"max-age\": \"1h\"}})\n         SQLite3(self.path, conf)\n \n-        flattened = list({\n-            1: None,\n-            2: None,\n-            3: 2,\n-            4: 2,\n-            5: 2,\n-            6: None,\n-            7: 2\n-        }.items())\n+        flattened = list({1: None, 2: None, 3: 2, 4: 2, 5: 2, 6: None, 7: 2}.items())\n \n         with sqlite3.connect(self.path) as con:\n-            rv = con.execute(\n-                \"SELECT id, parent FROM comments ORDER BY created\").fetchall()\n+            rv = con.execute(\"SELECT id, parent FROM comments ORDER BY created\").fetchall()\n             self.assertEqual(flattened, rv)\n \n     def test_comment_add_notification_column_migration(self):\n         with sqlite3.connect(self.path) as con:\n             con.execute(\"PRAGMA user_version = 3\")\n \n-            con.execute(\"CREATE TABLE comments (\"\n-                        \"    tid REFERENCES threads(id),\"\n-                        \"    id INTEGER PRIMARY KEY,\"\n-                        \"    parent INTEGER,\"\n-                        \"    created FLOAT NOT NULL, modified FLOAT,\"\n-                        \"    text VARCHAR, author VARCHAR, email VARCHAR, website VARCHAR,\"\n-                        \"    mode INTEGER,\"\n-                        \"    remote_addr VARCHAR,\"\n-                        \"    likes INTEGER DEFAULT 0,\"\n-                        \"    dislikes INTEGER DEFAULT 0,\"\n-                        \"    voters BLOB NOT NULL)\")\n-\n-        conf = config.new({\n-            \"general\": {\n-                \"dbpath\": \"/dev/null\",\n-                \"max-age\": \"1h\"\n-            }\n-        })\n+            con.execute(\n+                \"CREATE TABLE comments (\"\n+                \"    tid REFERENCES threads(id),\"\n+                \"    id INTEGER PRIMARY KEY,\"\n+                \"    parent INTEGER,\"\n+                \"    created FLOAT NOT NULL, modified FLOAT,\"\n+                \"    text VARCHAR, author VARCHAR, email VARCHAR, website VARCHAR,\"\n+                \"    mode INTEGER,\"\n+                \"    remote_addr VARCHAR,\"\n+                \"    likes INTEGER DEFAULT 0,\"\n+                \"    dislikes INTEGER DEFAULT 0,\"\n+                \"    voters BLOB NOT NULL)\"\n+            )\n+\n+        conf = config.new({\"general\": {\"dbpath\": \"/dev/null\", \"max-age\": \"1h\"}})\n \n         db = SQLite3(self.path, conf)\n \n@@ -155,25 +114,22 @@ def test_comment_add_notification_column_migration_with_existing_column(self):\n         with sqlite3.connect(self.path) as con:\n             con.execute(\"PRAGMA user_version = 3\")\n \n-            con.execute(\"CREATE TABLE comments (\"\n-                        \"    tid REFERENCES threads(id),\"\n-                        \"    id INTEGER PRIMARY KEY,\"\n-                        \"    parent INTEGER,\"\n-                        \"    created FLOAT NOT NULL, modified FLOAT,\"\n-                        \"    text VARCHAR, author VARCHAR, email VARCHAR, website VARCHAR,\"\n-                        \"    mode INTEGER,\"\n-                        \"    remote_addr VARCHAR,\"\n-                        \"    likes INTEGER DEFAULT 0,\"\n-                        \"    dislikes INTEGER DEFAULT 0,\"\n-                        \"    voters BLOB NOT NULL,\"\n-                        \"    notification INTEGER DEFAULT 0)\")\n-\n-        conf = config.new({\n-            \"general\": {\n-                \"dbpath\": \"/dev/null\",\n-                \"max-age\": \"1h\"\n-            }\n-        })\n+            con.execute(\n+                \"CREATE TABLE comments (\"\n+                \"    tid REFERENCES threads(id),\"\n+                \"    id INTEGER PRIMARY KEY,\"\n+                \"    parent INTEGER,\"\n+                \"    created FLOAT NOT NULL, modified FLOAT,\"\n+                \"    text VARCHAR, author VARCHAR, email VARCHAR, website VARCHAR,\"\n+                \"    mode INTEGER,\"\n+                \"    remote_addr VARCHAR,\"\n+                \"    likes INTEGER DEFAULT 0,\"\n+                \"    dislikes INTEGER DEFAULT 0,\"\n+                \"    voters BLOB NOT NULL,\"\n+                \"    notification INTEGER DEFAULT 0)\"\n+            )\n+\n+        conf = config.new({\"general\": {\"dbpath\": \"/dev/null\", \"max-age\": \"1h\"}})\n \n         db = SQLite3(self.path, conf)\n \n@@ -183,38 +139,35 @@ def test_comment_text_not_null_migration(self):\n         with sqlite3.connect(self.path) as con:\n             con.execute(\"PRAGMA user_version = 4\")\n \n-            con.execute(\"CREATE TABLE threads (\"\n-                        \"    id INTEGER PRIMARY KEY,\"\n-                        \"    uri VARCHAR UNIQUE,\"\n-                        \"    title VARCHAR)\")\n-            con.execute(\"CREATE TABLE comments (\"\n-                        \"    tid REFERENCES threads(id),\"\n-                        \"    id INTEGER PRIMARY KEY,\"\n-                        \"    parent INTEGER,\"\n-                        \"    created FLOAT NOT NULL, modified FLOAT,\"\n-                        \"    text VARCHAR, author VARCHAR, email VARCHAR, website VARCHAR,\"\n-                        \"    mode INTEGER,\"\n-                        \"    remote_addr VARCHAR,\"\n-                        \"    likes INTEGER DEFAULT 0,\"\n-                        \"    dislikes INTEGER DEFAULT 0,\"\n-                        \"    voters BLOB NOT NULL,\"\n-                        \"    notification INTEGER DEFAULT 0)\")\n-\n+            con.execute(\"CREATE TABLE threads (    id INTEGER PRIMARY KEY,    uri VARCHAR UNIQUE,    title VARCHAR)\")\n             con.execute(\n-                \"INSERT INTO threads (uri, title) VALUES (?, ?)\", (\"/\", \"Test\"))\n+                \"CREATE TABLE comments (\"\n+                \"    tid REFERENCES threads(id),\"\n+                \"    id INTEGER PRIMARY KEY,\"\n+                \"    parent INTEGER,\"\n+                \"    created FLOAT NOT NULL, modified FLOAT,\"\n+                \"    text VARCHAR, author VARCHAR, email VARCHAR, website VARCHAR,\"\n+                \"    mode INTEGER,\"\n+                \"    remote_addr VARCHAR,\"\n+                \"    likes INTEGER DEFAULT 0,\"\n+                \"    dislikes INTEGER DEFAULT 0,\"\n+                \"    voters BLOB NOT NULL,\"\n+                \"    notification INTEGER DEFAULT 0)\"\n+            )\n+\n+            con.execute(\"INSERT INTO threads (uri, title) VALUES (?, ?)\", (\"/\", \"Test\"))\n \n-            con.execute(\"INSERT INTO comments (id, parent, created, text, voters) VALUES (?, ?, ?, ?, ?)\",\n-                        (1, None, 1, None, sqlite3.Binary(b\"\")))\n+            con.execute(\n+                \"INSERT INTO comments (id, parent, created, text, voters) VALUES (?, ?, ?, ?, ?)\",\n+                (1, None, 1, None, sqlite3.Binary(b\"\")),\n+            )\n \n-            con.execute(\"INSERT INTO comments (id, parent, created, text, voters) VALUES (?, ?, ?, ?, ?)\",\n-                        (2, 1, 2, \"foo\", sqlite3.Binary(b\"\")))\n+            con.execute(\n+                \"INSERT INTO comments (id, parent, created, text, voters) VALUES (?, ?, ?, ?, ?)\",\n+                (2, 1, 2, \"foo\", sqlite3.Binary(b\"\")),\n+            )\n \n-        conf = config.new({\n-            \"general\": {\n-                \"dbpath\": \"/dev/null\",\n-                \"max-age\": \"1h\"\n-            }\n-        })\n+        conf = config.new({\"general\": {\"dbpath\": \"/dev/null\", \"max-age\": \"1h\"}})\n \n         db = SQLite3(self.path, conf)\n \n@@ -232,39 +185,36 @@ def test_comment_text_not_null_migration_with_rollback_after_error(self):\n         with sqlite3.connect(self.path) as con:\n             con.execute(\"PRAGMA user_version = 4\")\n \n-            con.execute(\"CREATE TABLE threads (\"\n-                        \"    id INTEGER PRIMARY KEY,\"\n-                        \"    uri VARCHAR UNIQUE,\"\n-                        \"    title VARCHAR)\")\n+            con.execute(\"CREATE TABLE threads (    id INTEGER PRIMARY KEY,    uri VARCHAR UNIQUE,    title VARCHAR)\")\n \n             # emulate a migration error by creating a source table without the \"notification\" field\n-            con.execute(\"CREATE TABLE comments (\"\n-                        \"    tid REFERENCES threads(id),\"\n-                        \"    id INTEGER PRIMARY KEY,\"\n-                        \"    parent INTEGER,\"\n-                        \"    created FLOAT NOT NULL, modified FLOAT,\"\n-                        \"    text VARCHAR, author VARCHAR, email VARCHAR, website VARCHAR,\"\n-                        \"    mode INTEGER,\"\n-                        \"    remote_addr VARCHAR,\"\n-                        \"    likes INTEGER DEFAULT 0,\"\n-                        \"    dislikes INTEGER DEFAULT 0,\"\n-                        \"    voters BLOB NOT NULL)\")\n-\n             con.execute(\n-                \"INSERT INTO threads (uri, title) VALUES (?, ?)\", (\"/\", \"Test\"))\n+                \"CREATE TABLE comments (\"\n+                \"    tid REFERENCES threads(id),\"\n+                \"    id INTEGER PRIMARY KEY,\"\n+                \"    parent INTEGER,\"\n+                \"    created FLOAT NOT NULL, modified FLOAT,\"\n+                \"    text VARCHAR, author VARCHAR, email VARCHAR, website VARCHAR,\"\n+                \"    mode INTEGER,\"\n+                \"    remote_addr VARCHAR,\"\n+                \"    likes INTEGER DEFAULT 0,\"\n+                \"    dislikes INTEGER DEFAULT 0,\"\n+                \"    voters BLOB NOT NULL)\"\n+            )\n+\n+            con.execute(\"INSERT INTO threads (uri, title) VALUES (?, ?)\", (\"/\", \"Test\"))\n \n-            con.execute(\"INSERT INTO comments (id, parent, created, text, voters) VALUES (?, ?, ?, ?, ?)\",\n-                        (1, None, 1, None, sqlite3.Binary(b\"\")))\n+            con.execute(\n+                \"INSERT INTO comments (id, parent, created, text, voters) VALUES (?, ?, ?, ?, ?)\",\n+                (1, None, 1, None, sqlite3.Binary(b\"\")),\n+            )\n \n-            con.execute(\"INSERT INTO comments (id, parent, created, text, voters) VALUES (?, ?, ?, ?, ?)\",\n-                        (2, 1, 2, \"foo\", sqlite3.Binary(b\"\")))\n+            con.execute(\n+                \"INSERT INTO comments (id, parent, created, text, voters) VALUES (?, ?, ?, ?, ?)\",\n+                (2, 1, 2, \"foo\", sqlite3.Binary(b\"\")),\n+            )\n \n-        conf = config.new({\n-            \"general\": {\n-                \"dbpath\": \"/dev/null\",\n-                \"max-age\": \"1h\"\n-            }\n-        })\n+        conf = config.new({\"general\": {\"dbpath\": \"/dev/null\", \"max-age\": \"1h\"}})\n \n         try:\n             SQLite3(self.path, conf)"
    },
    {
      "sha": "804ead71fef08e4bfaee3048e753cd244642ca53",
      "filename": "isso/tests/test_guard.py",
      "status": "modified",
      "additions": 28,
      "deletions": 59,
      "changes": 87,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_guard.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_guard.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Ftests%2Ftest_guard.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -11,19 +11,17 @@\n from isso.utils import http\n \n from fixtures import curl, FakeIP\n+\n http.curl = curl\n \n \n class TestGuard(unittest.TestCase):\n-\n     data = json.dumps({\"text\": \"Lorem ipsum.\"})\n \n     def setUp(self):\n         self.path = tempfile.NamedTemporaryFile().name\n \n-    def makeClient(self, ip, ratelimit=2, direct_reply=3, self_reply=False,\n-                   require_email=False, require_author=False):\n-\n+    def makeClient(self, ip, ratelimit=2, direct_reply=3, self_reply=False, require_email=False, require_author=False):\n         conf = config.load(config.default_file())\n         conf.set(\"general\", \"dbpath\", self.path)\n         conf.set(\"hash\", \"algorithm\", \"none\")\n@@ -44,34 +42,26 @@ class App(Isso, core.Mixin):\n         return Client(app, Response)\n \n     def testRateLimit(self):\n-\n         bob = self.makeClient(\"127.0.0.1\", 2)\n \n         for i in range(2):\n-            rv = bob.post('/new?uri=test', data=self.data)\n+            rv = bob.post(\"/new?uri=test\", data=self.data)\n             self.assertEqual(rv.status_code, 201)\n \n-        rv = bob.post('/new?uri=test', data=self.data)\n+        rv = bob.post(\"/new?uri=test\", data=self.data)\n \n         self.assertEqual(rv.status_code, 403)\n         self.assertIn(\"ratelimit exceeded\", rv.get_data(as_text=True))\n \n         alice = self.makeClient(\"1.2.3.4\", 2)\n         for i in range(2):\n-            self.assertEqual(alice.post(\n-                \"/new?uri=test\", data=self.data).status_code, 201)\n+            self.assertEqual(alice.post(\"/new?uri=test\", data=self.data).status_code, 201)\n \n-        bob.application.db.execute([\n-            \"UPDATE comments SET\",\n-            \"    created = created - 60\",\n-            \"WHERE remote_addr = '127.0.0.0'\"\n-        ])\n+        bob.application.db.execute([\"UPDATE comments SET\", \"    created = created - 60\", \"WHERE remote_addr = '127.0.0.0'\"])\n \n-        self.assertEqual(\n-            bob.post(\"/new?uri=test\", data=self.data).status_code, 201)\n+        self.assertEqual(bob.post(\"/new?uri=test\", data=self.data).status_code, 201)\n \n     def testDirectReply(self):\n-\n         client = self.makeClient(\"127.0.0.1\", 15, 3)\n \n         for url in (\"foo\", \"bar\", \"baz\", \"spam\"):\n@@ -86,72 +76,51 @@ def testDirectReply(self):\n             self.assertIn(\"direct responses to\", rv.get_data(as_text=True))\n \n     def testSelfReply(self):\n-\n         def payload(id):\n             return json.dumps({\"text\": \"...\", \"parent\": id})\n \n         client = self.makeClient(\"127.0.0.1\", self_reply=False)\n-        self.assertEqual(client.post(\n-            \"/new?uri=test\", data=self.data).status_code, 201)\n-        self.assertEqual(client.post(\n-            \"/new?uri=test\", data=payload(1)).status_code, 403)\n+        self.assertEqual(client.post(\"/new?uri=test\", data=self.data).status_code, 201)\n+        self.assertEqual(client.post(\"/new?uri=test\", data=payload(1)).status_code, 403)\n \n-        client.application.db.execute([\n-            \"UPDATE comments SET\",\n-            \"    created = created - ?\",\n-            \"WHERE id = 1\"\n-        ], (client.application.conf.getint(\"general\", \"max-age\"), ))\n+        client.application.db.execute(\n+            [\"UPDATE comments SET\", \"    created = created - ?\", \"WHERE id = 1\"],\n+            (client.application.conf.getint(\"general\", \"max-age\"),),\n+        )\n \n-        self.assertEqual(client.post(\n-            \"/new?uri=test\", data=payload(1)).status_code, 201)\n+        self.assertEqual(client.post(\"/new?uri=test\", data=payload(1)).status_code, 201)\n \n         client = self.makeClient(\"128.0.0.1\", ratelimit=3, self_reply=False)\n-        self.assertEqual(client.post(\n-            \"/new?uri=test\", data=self.data).status_code, 201)\n-        self.assertEqual(client.post(\n-            \"/new?uri=test\", data=payload(1)).status_code, 201)\n-        self.assertEqual(client.post(\n-            \"/new?uri=test\", data=payload(2)).status_code, 201)\n+        self.assertEqual(client.post(\"/new?uri=test\", data=self.data).status_code, 201)\n+        self.assertEqual(client.post(\"/new?uri=test\", data=payload(1)).status_code, 201)\n+        self.assertEqual(client.post(\"/new?uri=test\", data=payload(2)).status_code, 201)\n \n     def testRequireEmail(self):\n-\n         def payload(email):\n             return json.dumps({\"text\": \"...\", \"email\": email})\n \n         client = self.makeClient(\"127.0.0.1\", ratelimit=4, require_email=False)\n-        client_strict = self.makeClient(\n-            \"127.0.0.2\", ratelimit=4, require_email=True)\n+        client_strict = self.makeClient(\"127.0.0.2\", ratelimit=4, require_email=True)\n \n         # if we don't require email\n-        self.assertEqual(client.post(\n-            \"/new?uri=test\", data=payload(\"\")).status_code, 201)\n-        self.assertEqual(client.post(\n-            \"/new?uri=test\", data=payload(\"test@me.more\")).status_code, 201)\n+        self.assertEqual(client.post(\"/new?uri=test\", data=payload(\"\")).status_code, 201)\n+        self.assertEqual(client.post(\"/new?uri=test\", data=payload(\"test@me.more\")).status_code, 201)\n \n         # if we do require email\n-        self.assertEqual(client_strict.post(\n-            \"/new?uri=test\", data=payload(\"\")).status_code, 403)\n-        self.assertEqual(client_strict.post(\n-            \"/new?uri=test\", data=payload(\"test@me.more\")).status_code, 201)\n+        self.assertEqual(client_strict.post(\"/new?uri=test\", data=payload(\"\")).status_code, 403)\n+        self.assertEqual(client_strict.post(\"/new?uri=test\", data=payload(\"test@me.more\")).status_code, 201)\n \n     def testRequireAuthor(self):\n-\n         def payload(author):\n             return json.dumps({\"text\": \"...\", \"author\": author})\n \n-        client = self.makeClient(\n-            \"127.0.0.1\", ratelimit=4, require_author=False)\n-        client_strict = self.makeClient(\n-            \"127.0.0.2\", ratelimit=4, require_author=True)\n+        client = self.makeClient(\"127.0.0.1\", ratelimit=4, require_author=False)\n+        client_strict = self.makeClient(\"127.0.0.2\", ratelimit=4, require_author=True)\n \n         # if we don't require author\n-        self.assertEqual(client.post(\n-            \"/new?uri=test\", data=payload(\"\")).status_code, 201)\n-        self.assertEqual(client.post(\n-            \"/new?uri=test\", data=payload(\"pipo author\")).status_code, 201)\n+        self.assertEqual(client.post(\"/new?uri=test\", data=payload(\"\")).status_code, 201)\n+        self.assertEqual(client.post(\"/new?uri=test\", data=payload(\"pipo author\")).status_code, 201)\n \n         # if we do require author\n-        self.assertEqual(client_strict.post(\n-            \"/new?uri=test\", data=payload(\"\")).status_code, 403)\n-        self.assertEqual(client_strict.post(\n-            \"/new?uri=test\", data=payload(\"pipo author\")).status_code, 201)\n+        self.assertEqual(client_strict.post(\"/new?uri=test\", data=payload(\"\")).status_code, 403)\n+        self.assertEqual(client_strict.post(\"/new?uri=test\", data=payload(\"pipo author\")).status_code, 201)"
    },
    {
      "sha": "fb1a714da07c7f0c007e2e2d826d2844f5fb821e",
      "filename": "isso/tests/test_html.py",
      "status": "modified",
      "additions": 18,
      "deletions": 16,
      "changes": 34,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_html.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_html.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Ftests%2Ftest_html.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -6,33 +6,35 @@\n \n \n class TestHTML(unittest.TestCase):\n-\n     def test_sanitizer(self):\n         sanitizer = Sanitizer(elements=[], attributes=[])\n         examples = [\n-            ('Look: <img src=\"...\" />', 'Look: '),\n-            ('<a href=\"http://example.org/\">Ha</a>',\n-             ['<a href=\"http://example.org/\" rel=\"nofollow noopener\">Ha</a>',\n-              '<a rel=\"nofollow noopener\" href=\"http://example.org/\">Ha</a>']),\n-            ('<a href=\"sms:+1234567890\">Ha</a>', '<a>Ha</a>'),\n-            ('ld.so', 'ld.so'),\n-            ('/usr/lib/x86_64-linux-gnu/libc/memcpy-preload.so', '/usr/lib/x86_64-linux-gnu/libc/memcpy-preload.so'),\n-            ('<p style=\"visibility: hidden;\">Test</p>', '<p>Test</p>'),\n+            ('Look: <img src=\"...\" />', \"Look: \"),\n+            (\n+                '<a href=\"http://example.org/\">Ha</a>',\n+                [\n+                    '<a href=\"http://example.org/\" rel=\"nofollow noopener\">Ha</a>',\n+                    '<a rel=\"nofollow noopener\" href=\"http://example.org/\">Ha</a>',\n+                ],\n+            ),\n+            ('<a href=\"sms:+1234567890\">Ha</a>', \"<a>Ha</a>\"),\n+            (\"ld.so\", \"ld.so\"),\n+            (\"/usr/lib/x86_64-linux-gnu/libc/memcpy-preload.so\", \"/usr/lib/x86_64-linux-gnu/libc/memcpy-preload.so\"),\n+            ('<p style=\"visibility: hidden;\">Test</p>', \"<p>Test</p>\"),\n             ('<code class=\"language-cpp\">Test</code>', '<code class=\"language-cpp\">Test</code>'),\n-            ('<code class=\"test language-cpp\">Test</code>', '<code>Test</code>'),\n-            ('<script>alert(\"Onoe\")</script>', 'alert(\"Onoe\")')]\n+            ('<code class=\"test language-cpp\">Test</code>', \"<code>Test</code>\"),\n+            ('<script>alert(\"Onoe\")</script>', 'alert(\"Onoe\")'),\n+        ]\n \n-        for (markup, expected) in examples:\n+        for markup, expected in examples:\n             if isinstance(expected, list):\n                 self.assertIn(sanitizer.sanitize(markup), expected)\n             else:\n                 self.assertEqual(sanitizer.sanitize(markup), expected)\n \n     def test_sanitizer_extensions(self):\n         sanitizer = Sanitizer(elements=[\"img\"], attributes=[\"src\"])\n-        examples = [\n-            ('<img src=\"cat.gif\" />', '<img src=\"cat.gif\">'),\n-            ('<script src=\"doge.js\"></script>', '')]\n+        examples = [('<img src=\"cat.gif\" />', '<img src=\"cat.gif\">'), ('<script src=\"doge.js\"></script>', \"\")]\n \n-        for (element, expected) in examples:\n+        for element, expected in examples:\n             self.assertEqual(sanitizer.sanitize(element), expected)"
    },
    {
      "sha": "906fe9ecdd983c33c5ca8e8bd4182ca4b0c6be63",
      "filename": "isso/tests/test_html_misaka.py",
      "status": "modified",
      "additions": 45,
      "deletions": 48,
      "changes": 93,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_html_misaka.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_html_misaka.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Ftests%2Ftest_html_misaka.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -7,45 +7,31 @@\n \n \n class TestHTMLMisaka(unittest.TestCase):\n-\n     def test_markdown(self):\n-        conf = config.new({\n-            \"markup.misaka\": {\n-                \"options\": \"\",\n-                \"flags\": \"\"\n-            }\n-        })\n+        conf = config.new({\"markup.misaka\": {\"options\": \"\", \"flags\": \"\"}})\n         convert = MisakaMarkdown(conf)\n         examples = [\n             (\"*Ohai!*\", \"<p><em>Ohai!</em></p>\"),\n             (\"<em>Hi</em>\", \"<p><em>Hi</em></p>\"),\n-            (\"http://example.org/\", '<p>http://example.org/</p>')]\n+            (\"http://example.org/\", \"<p>http://example.org/</p>\"),\n+        ]\n \n-        for (markup, expected) in examples:\n+        for markup, expected in examples:\n             self.assertEqual(expected, convert.render(markup))\n \n     def test_markdown_plugins(self):\n-        conf = config.new({\n-            \"markup.misaka\": {\n-                \"options\": \"strikethrough, superscript\",\n-                \"flags\": \"\"\n-            }\n-        })\n+        conf = config.new({\"markup.misaka\": {\"options\": \"strikethrough, superscript\", \"flags\": \"\"}})\n         convert = MisakaMarkdown(conf)\n         examples = [\n             (\"~~strike~~ through\", \"<p><del>strike</del> through</p>\"),\n-            (\"sup^(script)\", \"<p>sup<sup>script</sup></p>\")]\n+            (\"sup^(script)\", \"<p>sup<sup>script</sup></p>\"),\n+        ]\n \n-        for (markup, expected) in examples:\n+        for markup, expected in examples:\n             self.assertEqual(expected, convert.render(markup))\n \n     def test_github_flavoured_markdown(self):\n-        conf = config.new({\n-            \"markup.misaka\": {\n-                \"options\": \"fenced-code\",\n-                \"flags\": \"\"\n-            }\n-        })\n+        conf = config.new({\"markup.misaka\": {\"options\": \"fenced-code\", \"flags\": \"\"}})\n         convert = MisakaMarkdown(conf)\n \n         # without lang\n@@ -79,43 +65,54 @@ def test_github_flavoured_markdown(self):\n         self.assertEqual(_expected, convert.render(_in))\n \n     def test_render(self):\n-        conf = config.new({\n-            \"markup\": {\n-                \"renderer\": \"misaka\",\n-                \"allowed-elements\": \"\",\n-                \"allowed-attributes\": \"\"\n-            },\n-            \"markup.misaka\": {\n-                \"options\": \"autolink\",\n-                \"flags\": \"\"\n+        conf = config.new(\n+            {\n+                \"markup\": {\"renderer\": \"misaka\", \"allowed-elements\": \"\", \"allowed-attributes\": \"\"},\n+                \"markup.misaka\": {\"options\": \"autolink\", \"flags\": \"\"},\n             }\n-        })\n+        )\n         convert = Markup(conf)\n-        self.assertIn(convert.render(\"http://example.org/ and sms:+1234567890\"),\n-                      ['<p><a href=\"http://example.org/\" rel=\"nofollow noopener\">http://example.org/</a> and sms:+1234567890</p>',\n-                       '<p><a rel=\"nofollow noopener\" href=\"http://example.org/\">http://example.org/</a> and sms:+1234567890</p>'])\n+        self.assertIn(\n+            convert.render(\"http://example.org/ and sms:+1234567890\"),\n+            [\n+                '<p><a href=\"http://example.org/\" rel=\"nofollow noopener\">http://example.org/</a> and sms:+1234567890</p>',\n+                '<p><a rel=\"nofollow noopener\" href=\"http://example.org/\">http://example.org/</a> and sms:+1234567890</p>',\n+            ],\n+        )\n \n     def test_sanitized_render_extensions(self):\n         \"\"\"Options should be normalized from both dashed-case or snake_case (legacy)\"\"\"\n-        conf = config.new({\n-            \"markup.misaka\": {\n-                \"options\": \"no_intra_emphasis\",  # Deliberately snake_case\n-                \"flags\": \"\",\n+        conf = config.new(\n+            {\n+                \"markup.misaka\": {\n+                    \"options\": \"no_intra_emphasis\",  # Deliberately snake_case\n+                    \"flags\": \"\",\n+                }\n             }\n-        })\n+        )\n         convert = MisakaMarkdown(conf)\n-        self.assertEqual('<p>foo_bar_baz</p>', convert.render(\"foo_bar_baz\"))\n+        self.assertEqual(\"<p>foo_bar_baz</p>\", convert.render(\"foo_bar_baz\"))\n \n         conf.set(\"markup.misaka\", \"options\", \"no-intra-emphasis\")  # dashed-case\n         convert = MisakaMarkdown(conf)\n-        self.assertEqual('<p>foo_bar_baz</p>', convert.render(\"foo_bar_baz\"))\n+        self.assertEqual(\"<p>foo_bar_baz</p>\", convert.render(\"foo_bar_baz\"))\n \n     def test_code_blocks(self):\n         convert = MisakaMarkdown()\n         examples = [\n-            (\"```\\nThis is a code-fence. <hello>\\n```\", \"<p><pre><code>This is a code-fence. &lt;hello&gt;\\n</code></pre></p>\"),\n-            (\"```cpp\\nThis is a code-fence. <hello>\\n```\", \"<p><pre><code class=\\\"language-cpp\\\">This is a code-fence. &lt;hello&gt;\\n</code></pre></p>\"),\n-            (\"    This is a four-character indent. <hello>\", \"<p><pre><code>This is a four-character indent. &lt;hello&gt;\\n</code></pre></p>\")]\n-\n-        for (markup, expected) in examples:\n+            (\n+                \"```\\nThis is a code-fence. <hello>\\n```\",\n+                \"<p><pre><code>This is a code-fence. &lt;hello&gt;\\n</code></pre></p>\",\n+            ),\n+            (\n+                \"```cpp\\nThis is a code-fence. <hello>\\n```\",\n+                '<p><pre><code class=\"language-cpp\">This is a code-fence. &lt;hello&gt;\\n</code></pre></p>',\n+            ),\n+            (\n+                \"    This is a four-character indent. <hello>\",\n+                \"<p><pre><code>This is a four-character indent. &lt;hello&gt;\\n</code></pre></p>\",\n+            ),\n+        ]\n+\n+        for markup, expected in examples:\n             self.assertEqual(expected, convert.render(markup))"
    },
    {
      "sha": "167b7546eeca4159f783e3752d06443473b335a1",
      "filename": "isso/tests/test_html_mistune.py",
      "status": "modified",
      "additions": 31,
      "deletions": 37,
      "changes": 68,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_html_mistune.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_html_mistune.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Ftests%2Ftest_html_mistune.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -7,36 +7,24 @@\n \n \n class TestHTMLMistune(unittest.TestCase):\n-\n     def test_markdown(self):\n-        conf = config.new({\n-            \"markup.mistune\": {\n-                \"plugins\": \"\",\n-                \"parameters\": \"\"\n-            }\n-        })\n+        conf = config.new({\"markup.mistune\": {\"plugins\": \"\", \"parameters\": \"\"}})\n         convert = MistuneMarkdown(conf.section(\"markup.mistune\"))\n         examples = [\n             (\"*Ohai!*\", \"<p><em>Ohai!</em></p>\"),\n             (\"<em>Hi</em>\", \"<p>&lt;em&gt;Hi&lt;/em&gt;</p>\"),\n-            (\"http://example.org/\", '<p>http://example.org/</p>')]\n+            (\"http://example.org/\", \"<p>http://example.org/</p>\"),\n+        ]\n \n-        for (markup, expected) in examples:\n+        for markup, expected in examples:\n             self.assertEqual(expected, convert.render(markup))\n \n     def test_markdown_plugins(self):\n-        conf = config.new({\n-            \"markup.mistune\": {\n-                \"plugins\": \"strikethrough, superscript\",\n-                \"parameters\": \"\"\n-            }\n-        })\n-        convert = MistuneMarkdown(conf.section('markup.mistune'))\n-        examples = [\n-            (\"~~strike~~ through\", \"<p><del>strike</del> through</p>\"),\n-            (\"sup^script^\", \"<p>sup<sup>script</sup></p>\")]\n+        conf = config.new({\"markup.mistune\": {\"plugins\": \"strikethrough, superscript\", \"parameters\": \"\"}})\n+        convert = MistuneMarkdown(conf.section(\"markup.mistune\"))\n+        examples = [(\"~~strike~~ through\", \"<p><del>strike</del> through</p>\"), (\"sup^script^\", \"<p>sup<sup>script</sup></p>\")]\n \n-        for (markup, expected) in examples:\n+        for markup, expected in examples:\n             self.assertEqual(expected, convert.render(markup))\n \n     def test_github_flavoured_markdown(self):\n@@ -73,27 +61,33 @@ def test_github_flavoured_markdown(self):\n         self.assertEqual(_expected, convert.render(_in))\n \n     def test_render(self):\n-        conf = config.new({\n-            \"markup\": {\n-                \"renderer\": \"mistune\",\n-                \"allowed-elements\": \"\",\n-                \"allowed-attributes\": \"\"\n-            },\n-            \"markup.mistune\": {\n-                \"plugins\": \"url\",\n-                \"parameters\": \"\"\n+        conf = config.new(\n+            {\n+                \"markup\": {\"renderer\": \"mistune\", \"allowed-elements\": \"\", \"allowed-attributes\": \"\"},\n+                \"markup.mistune\": {\"plugins\": \"url\", \"parameters\": \"\"},\n             }\n-        })\n+        )\n         convert = Markup(conf)\n-        self.assertIn(convert.render(\"http://example.org/ and sms:+1234567890\"),\n-                      ['<p><a href=\"http://example.org/\" rel=\"nofollow noopener\">http://example.org/</a> and sms:+1234567890</p>',\n-                       '<p><a rel=\"nofollow noopener\" href=\"http://example.org/\">http://example.org/</a> and sms:+1234567890</p>'])\n+        self.assertIn(\n+            convert.render(\"http://example.org/ and sms:+1234567890\"),\n+            [\n+                '<p><a href=\"http://example.org/\" rel=\"nofollow noopener\">http://example.org/</a> and sms:+1234567890</p>',\n+                '<p><a rel=\"nofollow noopener\" href=\"http://example.org/\">http://example.org/</a> and sms:+1234567890</p>',\n+            ],\n+        )\n \n     def test_code_blocks(self):\n         convert = MistuneMarkdown()\n         examples = [\n-            (\"```\\nThis is a code-fence. <hello>\\n```\", \"<p><pre><code>This is a code-fence. &lt;hello&gt;\\n</code></pre></p>\"),\n-            (\"```cpp\\nThis is a code-fence. <hello>\\n```\", \"<p><pre><code class=\\\"language-cpp\\\">This is a code-fence. &lt;hello&gt;\\n</code></pre></p>\")]\n-\n-        for (markup, expected) in examples:\n+            (\n+                \"```\\nThis is a code-fence. <hello>\\n```\",\n+                \"<p><pre><code>This is a code-fence. &lt;hello&gt;\\n</code></pre></p>\",\n+            ),\n+            (\n+                \"```cpp\\nThis is a code-fence. <hello>\\n```\",\n+                '<p><pre><code class=\"language-cpp\">This is a code-fence. &lt;hello&gt;\\n</code></pre></p>',\n+            ),\n+        ]\n+\n+        for markup, expected in examples:\n             self.assertEqual(expected, convert.render(markup))"
    },
    {
      "sha": "e0cd256c6b676eb9adc19cd78f632790438c9bbd",
      "filename": "isso/tests/test_migration.py",
      "status": "modified",
      "additions": 7,
      "deletions": 21,
      "changes": 28,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_migration.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_migration.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Ftests%2Ftest_migration.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -10,16 +10,10 @@\n from isso.db import SQLite3\n from isso.migrate import Disqus, WordPress, autodetect, Generic\n \n-conf = config.new({\n-    \"general\": {\n-        \"dbpath\": \"/dev/null\",\n-        \"max-age\": \"1h\"\n-    }\n-})\n+conf = config.new({\"general\": {\"dbpath\": \"/dev/null\", \"max-age\": \"1h\"}})\n \n \n class TestMigration(unittest.TestCase):\n-\n     def test_disqus_empty_id(self):\n         \"\"\"\n         Fails with empty thread id\n@@ -40,8 +34,7 @@ def test_disqus_empty_id(self):\n         # assert out == \\\n         #     \"Isso couldn't import any thread, try again with --empty-id\\n\"\n \n-        self.assertEqual(\n-            len(db.execute(\"SELECT id FROM comments\").fetchall()), 0)\n+        self.assertEqual(len(db.execute(\"SELECT id FROM comments\").fetchall()), 0)\n \n     def test_disqus_empty_id_workaround(self):\n         \"\"\"\n@@ -55,8 +48,7 @@ def test_disqus_empty_id_workaround(self):\n         db = SQLite3(xxx.name, conf)\n         Disqus(db, xml, empty_id=True).migrate()\n \n-        self.assertEqual(\n-            len(db.execute(\"SELECT id FROM comments\").fetchall()), 5)\n+        self.assertEqual(len(db.execute(\"SELECT id FROM comments\").fetchall()), 5)\n \n         self.assertEqual(db.threads[\"/\"][\"title\"], \"Hello, World!\")\n         self.assertEqual(db.threads[\"/\"][\"id\"], 1)\n@@ -74,7 +66,6 @@ def test_disqus_empty_id_workaround(self):\n         self.assertEqual(deleted_comment[\"text\"], \"\")\n \n     def test_wordpress(self):\n-\n         xml = join(dirname(__file__), \"wordpress.xml\")\n         xxx = tempfile.NamedTemporaryFile()\n \n@@ -87,10 +78,8 @@ def test_wordpress(self):\n         self.assertEqual(db.threads[\"/?p=4\"][\"title\"], \"...\")\n         self.assertEqual(db.threads[\"/?p=4\"][\"id\"], 2)\n \n-        self.assertEqual(\n-            len(db.execute(\"SELECT id FROM threads\").fetchall()), 2)\n-        self.assertEqual(\n-            len(db.execute(\"SELECT id FROM comments\").fetchall()), 8)\n+        self.assertEqual(len(db.execute(\"SELECT id FROM threads\").fetchall()), 2)\n+        self.assertEqual(len(db.execute(\"SELECT id FROM comments\").fetchall()), 8)\n \n         first = db.comments.get(1)\n         self.assertEqual(first[\"author\"], \"Ohai\")\n@@ -125,10 +114,8 @@ def test_generic(self):\n         self.assertEqual(db.threads[\"/posts/0007/\"][\"title\"], \"Nat+%26+Miguel\")\n         self.assertEqual(db.threads[\"/posts/0007/\"][\"id\"], 2)\n \n-        self.assertEqual(\n-            len(db.execute(\"SELECT id FROM threads\").fetchall()), 2)\n-        self.assertEqual(\n-            len(db.execute(\"SELECT id FROM comments\").fetchall()), 2)\n+        self.assertEqual(len(db.execute(\"SELECT id FROM threads\").fetchall()), 2)\n+        self.assertEqual(len(db.execute(\"SELECT id FROM comments\").fetchall()), 2)\n \n         comment = db.comments.get(1)\n         self.assertEqual(comment[\"author\"], \"texas holdem\")\n@@ -145,7 +132,6 @@ def test_generic(self):\n         self.assertEqual(comment[\"remote_addr\"], \"0.0.0.0\")\n \n     def test_detection(self):\n-\n         wp = \"\"\"\\\n                 <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n                 <rss version=\"2.0\""
    },
    {
      "sha": "0702a89fa65d0f8d720a3061f2b12442e59f0ff6",
      "filename": "isso/tests/test_utils.py",
      "status": "modified",
      "additions": 27,
      "deletions": 22,
      "changes": 49,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_utils.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_utils.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Ftests%2Ftest_utils.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -7,37 +7,35 @@\n \n \n class TestUtils(unittest.TestCase):\n-\n     def test_anonymize(self):\n-\n         examples = [\n-            (u'12.34.56.78', u'12.34.56.0'),\n-            (u'1234:5678:90ab:cdef:fedc:ba09:8765:4321',\n-             u'1234:5678:90ab:0000:0000:0000:0000:0000'),\n-            (u'::ffff:127.0.0.1', u'127.0.0.0')]\n+            (\"12.34.56.78\", \"12.34.56.0\"),\n+            (\"1234:5678:90ab:cdef:fedc:ba09:8765:4321\", \"1234:5678:90ab:0000:0000:0000:0000:0000\"),\n+            (\"::ffff:127.0.0.1\", \"127.0.0.0\"),\n+        ]\n \n-        for (addr, anonymized) in examples:\n+        for addr, anonymized in examples:\n             self.assertEqual(utils.anonymize(addr), anonymized)\n \n     def test_str(self):\n         # Accept a str on both Python 2 and Python 3, for\n         # convenience.\n         examples = [\n-            ('12.34.56.78', u'12.34.56.0'),\n-            ('1234:5678:90ab:cdef:fedc:ba09:8765:4321',\n-             '1234:5678:90ab:0000:0000:0000:0000:0000'),\n-            ('::ffff:127.0.0.1', u'127.0.0.0')]\n+            (\"12.34.56.78\", \"12.34.56.0\"),\n+            (\"1234:5678:90ab:cdef:fedc:ba09:8765:4321\", \"1234:5678:90ab:0000:0000:0000:0000:0000\"),\n+            (\"::ffff:127.0.0.1\", \"127.0.0.0\"),\n+        ]\n \n-        for (addr, anonymized) in examples:\n+        for addr, anonymized in examples:\n             self.assertEqual(utils.anonymize(addr), anonymized)\n \n \n class TestParse(unittest.TestCase):\n-\n     def test_thread(self):\n-        self.assertEqual(parse.thread(\"asdf\"), (None, 'Untitled.'))\n+        self.assertEqual(parse.thread(\"asdf\"), (None, \"Untitled.\"))\n \n-        self.assertEqual(parse.thread(\"\"\"\n+        self.assertEqual(\n+            parse.thread(\"\"\"\n             <html>\n             <head>\n                 <title>Foo!</title>\n@@ -55,18 +53,25 @@ def test_thread(self):\n                     </div>\n                 </article>\n             </body>\n-            </html>\"\"\"), (None, 'Can you find me?'))\n+            </html>\"\"\"),\n+            (None, \"Can you find me?\"),\n+        )\n \n-        self.assertEqual(parse.thread(\"\"\"\n+        self.assertEqual(\n+            parse.thread(\"\"\"\n             <html>\n             <body>\n             <h1>I'm the real title!1\n             <div data-title=\"No way%21\" id=\"isso-thread\">\n-            \"\"\"), (None, 'No way!'))\n+            \"\"\"),\n+            (None, \"No way!\"),\n+        )\n \n-        self.assertEqual(parse.thread(\"\"\"\n+        self.assertEqual(\n+            parse.thread(\"\"\"\n             <div id=\"isso-thread\" data-title=\"Test\" data-isso-id=\"test\">\n-            \"\"\"), ('test', 'Test'))\n+            \"\"\"),\n+            (\"test\", \"Test\"),\n+        )\n \n-        self.assertEqual(parse.thread('<div id=\"isso-thread\" data-isso-id=\"Fuu.\">'),\n-                         ('Fuu.', 'Untitled.'))\n+        self.assertEqual(parse.thread('<div id=\"isso-thread\" data-isso-id=\"Fuu.\">'), (\"Fuu.\", \"Untitled.\"))"
    },
    {
      "sha": "b9ecdc2345799c909433943b41c3b4d17b3d9f41",
      "filename": "isso/tests/test_utils_hash.py",
      "status": "modified",
      "additions": 2,
      "deletions": 11,
      "changes": 13,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_utils_hash.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_utils_hash.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Ftests%2Ftest_utils_hash.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -8,7 +8,6 @@\n \n \n class TestHasher(unittest.TestCase):\n-\n     def test_hash(self):\n         self.assertRaises(TypeError, Hash, \"Foo\")\n \n@@ -19,15 +18,14 @@ def test_hash(self):\n \n         self.assertRaises(TypeError, h.hash, \"...\")\n         self.assertEqual(h.hash(b\"...\"), b\"...\")\n-        self.assertIsInstance(h.uhash(\"...\"), (str, ))\n+        self.assertIsInstance(h.uhash(\"...\"), (str,))\n \n     def test_uhash(self):\n         h = Hash(b\"\", func=None)\n         self.assertRaises(TypeError, h.uhash, b\"...\")\n \n \n class TestPBKDF2(unittest.TestCase):\n-\n     def test_default(self):\n         # original setting (and still default)\n         pbkdf2 = PBKDF2(iterations=1000)\n@@ -40,16 +38,9 @@ def test_different_salt(self):\n \n \n class TestCreate(unittest.TestCase):\n-\n     def test_custom(self):\n-\n         def _new(val):\n-            conf = config.new({\n-                \"hash\": {\n-                    \"algorithm\": val,\n-                    \"salt\": \"\"\n-                }\n-            })\n+            conf = config.new({\"hash\": {\"algorithm\": val, \"salt\": \"\"}})\n             return new(conf.section(\"hash\"))\n \n         sha1 = _new(\"sha1\")"
    },
    {
      "sha": "72cb54e549ae095b754b95198ac869e1f62cffc5",
      "filename": "isso/tests/test_vote.py",
      "status": "modified",
      "additions": 15,
      "deletions": 26,
      "changes": 41,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_vote.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_vote.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Ftests%2Ftest_vote.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -10,16 +10,15 @@\n from isso.utils import http\n \n from fixtures import curl, loads, FakeIP, JSONClient\n+\n http.curl = curl\n \n \n class TestVote(unittest.TestCase):\n-\n     def setUp(self):\n         self.path = tempfile.NamedTemporaryFile().name\n \n     def makeClient(self, ip):\n-\n         conf = config.load(config.default_file())\n         conf.set(\"general\", \"dbpath\", self.path)\n         conf.set(\"guard\", \"enabled\", \"off\")\n@@ -34,50 +33,41 @@ class App(Isso, core.Mixin):\n         return JSONClient(app, Response)\n \n     def testZeroLikes(self):\n-\n-        rv = self.makeClient(\"127.0.0.1\").post(\n-            \"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n-        self.assertEqual(loads(rv.data)['likes'], 0)\n-        self.assertEqual(loads(rv.data)['dislikes'], 0)\n+        rv = self.makeClient(\"127.0.0.1\").post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n+        self.assertEqual(loads(rv.data)[\"likes\"], 0)\n+        self.assertEqual(loads(rv.data)[\"dislikes\"], 0)\n \n     def testSingleLike(self):\n-\n-        self.makeClient(\"127.0.0.1\").post(\n-            \"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n+        self.makeClient(\"127.0.0.1\").post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n         rv = self.makeClient(\"0.0.0.0\").post(\"/id/1/like\")\n \n         self.assertEqual(rv.status_code, 200)\n         self.assertEqual(loads(rv.data)[\"likes\"], 1)\n \n     def testSelfLike(self):\n-\n         bob = self.makeClient(\"127.0.0.1\")\n         bob.post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n-        rv = bob.post('/id/1/like')\n+        rv = bob.post(\"/id/1/like\")\n \n         self.assertEqual(rv.status_code, 200)\n         self.assertEqual(loads(rv.data)[\"likes\"], 0)\n \n     def testMultipleLikes(self):\n-\n-        self.makeClient(\"127.0.0.1\").post(\n-            \"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n+        self.makeClient(\"127.0.0.1\").post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n         for num in range(15):\n-            rv = self.makeClient(\"1.2.%i.0\" % num).post('/id/1/like')\n+            rv = self.makeClient(\"1.2.%i.0\" % num).post(\"/id/1/like\")\n             self.assertEqual(rv.status_code, 200)\n             self.assertEqual(loads(rv.data)[\"likes\"], num + 1)\n \n     def testVoteOnNonexistentComment(self):\n-        rv = self.makeClient(\"1.2.3.4\").post('/id/1/like')\n+        rv = self.makeClient(\"1.2.3.4\").post(\"/id/1/like\")\n         self.assertEqual(rv.status_code, 200)\n         self.assertEqual(loads(rv.data), None)\n \n     def testTooManyLikes(self):\n-\n-        self.makeClient(\"127.0.0.1\").post(\n-            \"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n+        self.makeClient(\"127.0.0.1\").post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n         for num in range(256):\n-            rv = self.makeClient(\"1.2.%i.0\" % num).post('/id/1/like')\n+            rv = self.makeClient(\"1.2.%i.0\" % num).post(\"/id/1/like\")\n             self.assertEqual(rv.status_code, 200)\n \n             if num >= 142:\n@@ -86,10 +76,9 @@ def testTooManyLikes(self):\n                 self.assertEqual(loads(rv.data)[\"likes\"], num + 1)\n \n     def testDislike(self):\n-        self.makeClient(\"127.0.0.1\").post(\n-            \"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n-        rv = self.makeClient(\"1.2.3.4\").post('/id/1/dislike')\n+        self.makeClient(\"127.0.0.1\").post(\"/new?uri=test\", data=json.dumps({\"text\": \"...\"}))\n+        rv = self.makeClient(\"1.2.3.4\").post(\"/id/1/dislike\")\n \n         self.assertEqual(rv.status_code, 200)\n-        self.assertEqual(loads(rv.data)['likes'], 0)\n-        self.assertEqual(loads(rv.data)['dislikes'], 1)\n+        self.assertEqual(loads(rv.data)[\"likes\"], 0)\n+        self.assertEqual(loads(rv.data)[\"dislikes\"], 1)"
    },
    {
      "sha": "e5af8042bfa5fdff8e1dba755b83016ffb8b7171",
      "filename": "isso/tests/test_wsgi.py",
      "status": "modified",
      "additions": 19,
      "deletions": 32,
      "changes": 51,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_wsgi.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Ftests%2Ftest_wsgi.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Ftests%2Ftest_wsgi.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -12,42 +12,36 @@\n \n \n class TestWSGIUtilities(unittest.TestCase):\n-\n     def test_urlsplit(self):\n-\n         examples = [\n-            (\"http://example.tld/\", ('example.tld', 80, False)),\n-            (\"https://example.tld/\", ('example.tld', 443, True)),\n-            (\"example.tld\", ('example.tld', 80, False)),\n-            (\"example.tld:42\", ('example.tld', 42, False)),\n-            (\"https://example.tld:80/\", ('example.tld', 80, True))]\n-\n-        for (hostname, result) in examples:\n+            (\"http://example.tld/\", (\"example.tld\", 80, False)),\n+            (\"https://example.tld/\", (\"example.tld\", 443, True)),\n+            (\"example.tld\", (\"example.tld\", 80, False)),\n+            (\"example.tld:42\", (\"example.tld\", 42, False)),\n+            (\"https://example.tld:80/\", (\"example.tld\", 80, True)),\n+        ]\n+\n+        for hostname, result in examples:\n             self.assertEqual(wsgi.urlsplit(hostname), result)\n \n     def test_urljoin(self):\n-\n         examples = [\n             ((\"example.tld\", 80, False), \"http://example.tld\"),\n             ((\"example.tld\", 42, True), \"https://example.tld:42\"),\n-            ((\"example.tld\", 443, True), \"https://example.tld\")]\n+            ((\"example.tld\", 443, True), \"https://example.tld\"),\n+        ]\n \n-        for (split, result) in examples:\n+        for split, result in examples:\n             self.assertEqual(wsgi.urljoin(*split), result)\n \n     def test_origin(self):\n-\n         self.assertEqual(wsgi.origin([])({}), \"http://invalid.local\")\n \n         origin = wsgi.origin([\"http://foo.bar/\", \"https://foo.bar\"])\n-        self.assertEqual(origin({\"HTTP_ORIGIN\": \"http://foo.bar\"}),\n-                         \"http://foo.bar\")\n-        self.assertEqual(origin({\"HTTP_ORIGIN\": \"https://foo.bar\"}),\n-                         \"https://foo.bar\")\n-        self.assertEqual(origin({\"HTTP_REFERER\": \"http://foo.bar\"}),\n-                         \"http://foo.bar\")\n-        self.assertEqual(origin({\"HTTP_ORIGIN\": \"http://spam.baz\"}),\n-                         \"http://foo.bar\")\n+        self.assertEqual(origin({\"HTTP_ORIGIN\": \"http://foo.bar\"}), \"http://foo.bar\")\n+        self.assertEqual(origin({\"HTTP_ORIGIN\": \"https://foo.bar\"}), \"https://foo.bar\")\n+        self.assertEqual(origin({\"HTTP_REFERER\": \"http://foo.bar\"}), \"http://foo.bar\")\n+        self.assertEqual(origin({\"HTTP_ORIGIN\": \"http://spam.baz\"}), \"http://foo.bar\")\n         self.assertEqual(origin({}), \"http://foo.bar\")\n \n     def test_errorhandler(self):\n@@ -61,20 +55,16 @@ def test_errorhandler(self):\n         \"\"\"\n \n         # Client prefers response with `text/html` MIME type\n-        env = create_environ(headers=((\n-            'Accept', 'text/html, application/xml;q=0.9'),\n-        ))\n+        env = create_environ(headers=((\"Accept\", \"text/html, application/xml;q=0.9\"),))\n         req = Request(env)\n         error = BadRequest\n         # Error is simply passed through\n         self.assertEqual(error_handler(env, req, error), BadRequest)\n \n         # Client prefers response with `application/json` MIME type\n-        env = create_environ(headers=((\n-            'Accept', 'text/html;q=0.7, application/json;q=0.9, */*;q=0.8'),\n-        ))\n+        env = create_environ(headers=((\"Accept\", \"text/html;q=0.7, application/json;q=0.9, */*;q=0.8\"),))\n         req = Request(env)\n-        error = BadRequest('invalid data')\n+        error = BadRequest(\"invalid data\")\n         self.assertEqual(req.accept_mimetypes.best, \"application/json\")\n         # Error is converted to JSONResponse\n         self.assertIsInstance(error_handler(env, req, error), JSONResponse)\n@@ -83,10 +73,7 @@ def test_errorhandler(self):\n \n         # Missing error codes get converted to 500\n         error.code = None\n-        self.assertEqual(json.loads(\n-            error_handler(env, req, error).response[0])['message'],\n-            '??? Unknown Error: invalid data'\n-        )\n+        self.assertEqual(json.loads(error_handler(env, req, error).response[0])[\"message\"], \"??? Unknown Error: invalid data\")\n         self.assertEqual(error_handler(env, req, error).status_code, 500)\n \n         # Request's accept_mimetypes.best should always return, even if no"
    },
    {
      "sha": "b7f8abc073c8acfecb1fa39760756a21977d4008",
      "filename": "isso/utils/__init__.py",
      "status": "modified",
      "additions": 12,
      "deletions": 18,
      "changes": 30,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Futils%2F__init__.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Futils%2F__init__.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Futils%2F__init__.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -20,18 +20,18 @@ def anonymize(remote_addr):\n \n     \"\"\"\n     if isinstance(remote_addr, bytes):\n-        remote_addr = remote_addr.decode('ascii', 'ignore')\n+        remote_addr = remote_addr.decode(\"ascii\", \"ignore\")\n     try:\n         ipv4 = ipaddress.IPv4Address(remote_addr)\n-        return u''.join(ipv4.exploded.rsplit('.', 1)[0]) + '.' + '0'\n+        return \"\".join(ipv4.exploded.rsplit(\".\", 1)[0]) + \".\" + \"0\"\n     except ipaddress.AddressValueError:\n         try:\n             ipv6 = ipaddress.IPv6Address(remote_addr)\n             if ipv6.ipv4_mapped is not None:\n                 return anonymize(str(ipv6.ipv4_mapped))\n-            return u'' + ipv6.exploded.rsplit(':', 5)[0] + ':' + ':'.join(['0000'] * 5)\n+            return \"\" + ipv6.exploded.rsplit(\":\", 5)[0] + \":\" + \":\".join([\"0000\"] * 5)\n         except ipaddress.AddressValueError:\n-            return u'0.0.0.0'\n+            return \"0.0.0.0\"\n \n \n class Bloomfilter:\n@@ -93,38 +93,32 @@ def __len__(self):\n \n \n class JSONRequest(Request):\n-\n     def get_json(self):\n         try:\n             return json.loads(self.get_data(as_text=True))\n         except ValueError:\n-            raise BadRequest('Unable to read JSON request')\n+            raise BadRequest(\"Unable to read JSON request\")\n \n \n def render_template(template_name, **context):\n-    template_path = os.path.join(os.path.dirname(__file__),\n-                                 '..', 'templates')\n-    jinja_env = Environment(loader=FileSystemLoader(template_path),\n-                            autoescape=True)\n+    template_path = os.path.join(os.path.dirname(__file__), \"..\", \"templates\")\n+    jinja_env = Environment(loader=FileSystemLoader(template_path), autoescape=True)\n \n     def datetimeformat(value):\n-        return datetime.fromtimestamp(value).strftime('%H:%M / %d-%m-%Y')\n+        return datetime.fromtimestamp(value).strftime(\"%H:%M / %d-%m-%Y\")\n \n-    jinja_env.filters['datetimeformat'] = datetimeformat\n+    jinja_env.filters[\"datetimeformat\"] = datetimeformat\n     t = jinja_env.get_template(template_name)\n-    return Response(t.render(context), mimetype='text/html')\n+    return Response(t.render(context), mimetype=\"text/html\")\n \n \n class JSONResponse(Response):\n-\n     def __init__(self, obj, *args, **kwargs):\n         kwargs[\"content_type\"] = \"application/json\"\n-        super(JSONResponse, self).__init__(\n-            json.dumps(obj).encode(\"utf-8\"), *args, **kwargs)\n+        super(JSONResponse, self).__init__(json.dumps(obj).encode(\"utf-8\"), *args, **kwargs)\n \n \n class XMLResponse(Response):\n     def __init__(self, obj, *args, **kwargs):\n         kwargs[\"content_type\"] = \"text/xml\"\n-        super(XMLResponse, self).__init__(\n-            obj, *args, **kwargs)\n+        super(XMLResponse, self).__init__(obj, *args, **kwargs)"
    },
    {
      "sha": "b5eb3411810fdf40fd12ea3822e7f3cf56cc6a6d",
      "filename": "isso/utils/cache.py",
      "status": "modified",
      "additions": 1,
      "deletions": 7,
      "changes": 8,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Futils%2Fcache.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Futils%2Fcache.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Futils%2Fcache.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -62,7 +62,6 @@ class NullCache(BaseCache):\n \n \n class SimpleCache(BaseCache):\n-\n     \"\"\"Simple memory cache for single process environments.  This class exists\n     mainly for the development server and is not 100% thread safe.  It tries\n     to use as many atomic operations as possible and no locks for simplicity\n@@ -95,12 +94,7 @@ def _remove_expired(self, now):\n             self._cache.pop(k, None)\n \n     def _remove_older(self):\n-        k_ordered = (\n-            k\n-            for k, v in sorted(\n-                self._cache.items(), key=lambda item: item[1][0]\n-            )\n-        )\n+        k_ordered = (k for k, v in sorted(self._cache.items(), key=lambda item: item[1][0]))\n         for k in k_ordered:\n             self._cache.pop(k, None)\n             if not self._over_threshold():"
    },
    {
      "sha": "b87604988ae8738705756276368ce4a0f8e33a6e",
      "filename": "isso/utils/hash.py",
      "status": "modified",
      "additions": 3,
      "deletions": 8,
      "changes": 11,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Futils%2Fhash.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Futils%2Fhash.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Futils%2Fhash.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -7,17 +7,14 @@\n \n \n def _TypeError(name, expected, val):\n-    return TypeError(\"'{0}' must be {1}, not {2}\".format(\n-        name, expected, val.__class__.__name__))\n+    return TypeError(\"'{0}' must be {1}, not {2}\".format(name, expected, val.__class__.__name__))\n \n \n class Hash(object):\n-\n     func = None\n     salt = b\"Eech7co8Ohloopo9Ol6baimi\"\n \n     def __init__(self, salt=None, func=\"sha1\"):\n-\n         if func is not None:\n             hashlib.new(func)  # may not be available\n             self.func = func\n@@ -43,7 +40,7 @@ def hash(self, val):\n     def uhash(self, val):\n         \"\"\"Calculate hash from unicode value and return hex value as unicode\"\"\"\n \n-        if not isinstance(val, (str, )):\n+        if not isinstance(val, (str,)):\n             raise _TypeError(\"val\", \"str\", val)\n \n         return codecs.encode(self.hash(val.encode(\"utf-8\")), \"hex_codec\").decode(\"utf-8\")\n@@ -59,7 +56,6 @@ def compute(self, val):\n \n \n class PBKDF2(Hash):\n-\n     def __init__(self, salt=None, iterations=1000, dklen=6, func=\"sha1\"):\n         super(PBKDF2, self).__init__(salt)\n \n@@ -68,8 +64,7 @@ def __init__(self, salt=None, iterations=1000, dklen=6, func=\"sha1\"):\n         self.func = func\n \n     def compute(self, val):\n-        return pbkdf2(hash_name=self.func, password=val, salt=self.salt,\n-                      iterations=self.iterations, dklen=self.dklen)\n+        return pbkdf2(hash_name=self.func, password=val, salt=self.salt, iterations=self.iterations, dklen=self.dklen)\n \n \n def new(conf):"
    },
    {
      "sha": "0a014951ddede92a9e2620bae2c898b62afddfbc",
      "filename": "isso/utils/http.py",
      "status": "modified",
      "additions": 2,
      "deletions": 4,
      "changes": 6,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Futils%2Fhttp.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Futils%2Fhttp.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Futils%2Fhttp.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -23,9 +23,7 @@ class curl(object):\n                 return resp.status\n     \"\"\"\n \n-    headers = {\n-        \"User-Agent\": \"Isso/{0} (+https://isso-comments.de)\".format(__version__)\n-    }\n+    headers = {\"User-Agent\": \"Isso/{0} (+https://isso-comments.de)\".format(__version__)}\n \n     def __init__(self, method, host, path, timeout=3):\n         self.method = method\n@@ -47,7 +45,7 @@ def __enter__(self):\n             try:\n                 resp = self.con.getresponse()\n                 if resp.status == 301:\n-                    location = resp.getheader('Location')\n+                    location = resp.getheader(\"Location\")\n                     if location:\n                         self.con.close()\n                         self.path = urlparse(location).path"
    },
    {
      "sha": "a34cae0805089745543c94a7433455b628824ac5",
      "filename": "isso/utils/parse.py",
      "status": "modified",
      "additions": 7,
      "deletions": 5,
      "changes": 12,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Futils%2Fparse.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Futils%2Fparse.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Futils%2Fparse.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -18,9 +18,12 @@ def thread(data, default=\"Untitled.\", id=None):\n     html = html.lastChild\n \n     # aka getElementById, but limited to div and section tags\n-    el = list(filter(lambda i: i.attributes[\"id\"].value == \"isso-thread\",\n-                     filter(lambda i: \"id\" in i.attributes,\n-                            chain(*map(html.getElementsByTagName, (\"div\", \"section\"))))))\n+    el = list(\n+        filter(\n+            lambda i: i.attributes[\"id\"].value == \"isso-thread\",\n+            filter(lambda i: \"id\" in i.attributes, chain(*map(html.getElementsByTagName, (\"div\", \"section\")))),\n+        )\n+    )\n \n     if not el:\n         return id, default\n@@ -56,12 +59,11 @@ def gettext(rv):\n         pass\n \n     while el is not None:  # el.parentNode is None in the very end\n-\n         visited.append(el)\n         rv = recurse(el)\n \n         if rv:\n-            return id, ''.join(gettext(rv)).strip()\n+            return id, \"\".join(gettext(rv)).strip()\n \n         el = el.parentNode\n "
    },
    {
      "sha": "87c1c30f43e81614a34d12bd4e9aa91d3df767d1",
      "filename": "isso/views/__init__.py",
      "status": "modified",
      "additions": 4,
      "deletions": 6,
      "changes": 10,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fviews%2F__init__.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fviews%2F__init__.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fviews%2F__init__.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -1,6 +1,7 @@\n # -*- encoding: utf-8 -*-\n \n from importlib.metadata import version\n+\n __version__ = version(\"isso\")\n \n import json\n@@ -30,26 +31,23 @@ def __init__(self, type, param):\n \n     def __call__(self, func):\n         def dec(cls, env, req, *args, **kwargs):\n-\n             if self.param not in req.args:\n                 raise BadRequest(\"missing %s query\" % self.param)\n \n             try:\n                 kwargs[self.param] = self.type(req.args[self.param])\n             except TypeError:\n-                raise BadRequest(\"invalid type for %s, expected %s\" %\n-                                 (self.param, self.type))\n+                raise BadRequest(\"invalid type for %s, expected %s\" % (self.param, self.type))\n \n             return func(cls, env, req, *args, **kwargs)\n \n         return dec\n \n \n class Info(object):\n-\n     def __init__(self, isso):\n         self.moderation = isso.conf.getboolean(\"moderation\", \"enabled\")\n-        isso.urls.add(Rule('/info', endpoint=self.show))\n+        isso.urls.add(Rule(\"/info\", endpoint=self.show))\n \n     \"\"\"\n     @api {get} /info Server info\n@@ -78,8 +76,8 @@ def __init__(self, isso):\n           \"moderation\": true\n         }\n     \"\"\"\n-    def show(self, environ, request):\n \n+    def show(self, environ, request):\n         rv = {\n             \"version\": __version__,\n             \"host\": str(local(\"host\")),"
    },
    {
      "sha": "d5a035c4df7be828cc17979b18afcb98fb480940",
      "filename": "isso/views/comments.py",
      "status": "modified",
      "additions": 252,
      "deletions": 259,
      "changes": 511,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fviews%2Fcomments.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fviews%2Fcomments.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fviews%2Fcomments.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -24,24 +24,24 @@\n from werkzeug.wsgi import get_current_url\n \n from isso import utils, local\n-from isso.utils import (http, parse,\n-                        JSONResponse as JSON, XMLResponse as XML,\n-                        render_template)\n+from isso.utils import http, parse, JSONResponse as JSON, XMLResponse as XML, render_template\n from isso.utils.hash import md5, sha1\n from isso.views import requires\n \n \n # from Django apparently, looks good to me *duck*\n __url_re = re.compile(\n-    r'^'\n-    r'(https?://)?'\n+    r\"^\"\n+    r\"(https?://)?\"\n     # domain...\n-    r'(?:(?:[\\w](?:[\\w-]{0,61}[\\w])?\\.)+(?:[\\w]{2,6}\\.?|[\\w-]{2,}\\.?)|'\n-    r'localhost|'  # localhost...\n-    r'\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})'  # ...or ip\n-    r'(?::\\d+)?'  # optional port\n-    r'(?:/?|[/?]\\S+)'\n-    r'$', re.IGNORECASE | re.UNICODE)\n+    r\"(?:(?:[\\w](?:[\\w-]{0,61}[\\w])?\\.)+(?:[\\w]{2,6}\\.?|[\\w-]{2,}\\.?)|\"\n+    r\"localhost|\"  # localhost...\n+    r\"\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})\"  # ...or ip\n+    r\"(?::\\d+)?\"  # optional port\n+    r\"(?:/?|[/?]\\S+)\"\n+    r\"$\",\n+    re.IGNORECASE | re.UNICODE,\n+)\n \n \n def isurl(text):\n@@ -76,7 +76,6 @@ def xhr(func):\n     \"\"\"\n \n     def dec(self, env, req, *args, **kwargs):\n-\n         if req.content_type and not req.content_type.startswith(\"application/json\"):\n             raise Forbidden(\"CSRF\")\n         return func(self, env, req, *args, **kwargs)\n@@ -102,11 +101,11 @@ def get_comment_id_from_url(comment_url):\n         return None\n \n     fragment = parsed_url.fragment\n-    if not fragment or '-' not in fragment:\n+    if not fragment or \"-\" not in fragment:\n         # Handle missing fragment or fragment without hyphen\n         return None\n \n-    last_element = fragment.split('-')[-1]\n+    last_element = fragment.split(\"-\")[-1]\n     try:\n         comment_id = int(last_element)\n     except ValueError:\n@@ -133,36 +132,49 @@ def get_uri_from_url(url):\n \n \n class API(object):\n-\n-    FIELDS = set(['id', 'parent', 'text', 'author', 'website',\n-                  'mode', 'created', 'modified', 'likes', 'dislikes', 'hash', 'gravatar_image', 'notification'])\n+    FIELDS = set(\n+        [\n+            \"id\",\n+            \"parent\",\n+            \"text\",\n+            \"author\",\n+            \"website\",\n+            \"mode\",\n+            \"created\",\n+            \"modified\",\n+            \"likes\",\n+            \"dislikes\",\n+            \"hash\",\n+            \"gravatar_image\",\n+            \"notification\",\n+        ]\n+    )\n \n     # comment fields, that can be submitted\n-    ACCEPT = set(['text', 'author', 'website', 'email', 'parent', 'title', 'notification'])\n+    ACCEPT = set([\"text\", \"author\", \"website\", \"email\", \"parent\", \"title\", \"notification\"])\n \n     VIEWS = [\n-        ('fetch', ('GET', '/')),\n-        ('new', ('POST', '/new')),\n-        ('counts', ('POST', '/count')),\n-        ('feed', ('GET', '/feed')),\n-        ('latest', ('GET', '/latest')),\n-        ('view', ('GET', '/id/<int:id>')),\n-        ('edit', ('PUT', '/id/<int:id>')),\n-        ('delete', ('DELETE', '/id/<int:id>')),\n-        ('unsubscribe', ('GET', '/id/<int:id>/unsubscribe/<string:email>/<string:key>')),\n-        ('moderate', ('GET', '/id/<int:id>/<any(edit,activate,delete):action>/<string:key>')),\n-        ('moderate', ('POST', '/id/<int:id>/<any(edit,activate,delete):action>/<string:key>')),\n-        ('like', ('POST', '/id/<int:id>/like')),\n-        ('dislike', ('POST', '/id/<int:id>/dislike')),\n-        ('demo', ('GET', '/demo/')),\n-        ('preview', ('POST', '/preview')),\n-        ('config', ('GET', '/config')),\n-        ('login', ('POST', '/login/')),\n-        ('admin', ('GET', '/admin/'))\n+        (\"fetch\", (\"GET\", \"/\")),\n+        (\"new\", (\"POST\", \"/new\")),\n+        (\"counts\", (\"POST\", \"/count\")),\n+        (\"feed\", (\"GET\", \"/feed\")),\n+        (\"latest\", (\"GET\", \"/latest\")),\n+        (\"view\", (\"GET\", \"/id/<int:id>\")),\n+        (\"edit\", (\"PUT\", \"/id/<int:id>\")),\n+        (\"delete\", (\"DELETE\", \"/id/<int:id>\")),\n+        (\"unsubscribe\", (\"GET\", \"/id/<int:id>/unsubscribe/<string:email>/<string:key>\")),\n+        (\"moderate\", (\"GET\", \"/id/<int:id>/<any(edit,activate,delete):action>/<string:key>\")),\n+        (\"moderate\", (\"POST\", \"/id/<int:id>/<any(edit,activate,delete):action>/<string:key>\")),\n+        (\"like\", (\"POST\", \"/id/<int:id>/like\")),\n+        (\"dislike\", (\"POST\", \"/id/<int:id>/dislike\")),\n+        (\"demo\", (\"GET\", \"/demo/\")),\n+        (\"preview\", (\"POST\", \"/preview\")),\n+        (\"config\", (\"GET\", \"/config\")),\n+        (\"login\", (\"POST\", \"/login/\")),\n+        (\"admin\", (\"GET\", \"/admin/\")),\n     ]\n \n     def __init__(self, isso, hasher):\n-\n         self.isso = isso\n         self.hash = hasher.uhash\n         self.cache = isso.cache\n@@ -172,7 +184,9 @@ def __init__(self, isso, hasher):\n         self.moderated = isso.conf.getboolean(\"moderation\", \"enabled\")\n         # this is similar to the wordpress setting \"Comment author must have a previously approved comment\"\n         try:\n-            self.approve_if_email_previously_approved = isso.conf.getboolean(\"moderation\", \"approve-if-email-previously-approved\")\n+            self.approve_if_email_previously_approved = isso.conf.getboolean(\n+                \"moderation\", \"approve-if-email-previously-approved\"\n+            )\n         except NoOptionError:\n             self.approve_if_email_previously_approved = False\n         try:\n@@ -193,20 +207,18 @@ def __init__(self, isso, hasher):\n \n         self.public_conf[\"feed\"] = False\n         rss = isso.conf.section(\"rss\")\n-        if rss and rss.get('base'):\n+        if rss and rss.get(\"base\"):\n             self.public_conf[\"feed\"] = True\n \n         self.guard = isso.db.guard\n         self.threads = isso.db.threads\n         self.comments = isso.db.comments\n \n-        for (view, (method, path)) in self.VIEWS:\n-            isso.urls.add(\n-                Rule(path, methods=[method], endpoint=getattr(self, view)))\n+        for view, (method, path) in self.VIEWS:\n+            isso.urls.add(Rule(path, methods=[method], endpoint=getattr(self, view)))\n \n     @classmethod\n     def verify(cls, comment):\n-\n         if comment.get(\"text\") is None:\n             return False, \"text is missing\"\n \n@@ -319,10 +331,10 @@ def verify(cls, comment):\n             \"likes\": 0\n         }\n     \"\"\"\n+\n     @xhr\n-    @requires(str, 'uri')\n+    @requires(str, \"uri\")\n     def new(self, environ, request, uri):\n-\n         data = request.json\n \n         for field in set(data.keys()) - API.ACCEPT:\n@@ -345,19 +357,21 @@ def new(self, environ, request, uri):\n         if data.get(\"website\"):\n             data[\"website\"] = normalize(data[\"website\"])\n \n-        data['mode'] = 2 if self.moderated else 1\n-        data['remote_addr'] = self._remote_addr(request)\n+        data[\"mode\"] = 2 if self.moderated else 1\n+        data[\"remote_addr\"] = self._remote_addr(request)\n \n         with self.isso.lock:\n             if uri not in self.threads:\n-                if not data.get('title'):\n-                    with http.curl('GET', local(\"origin\"), uri) as resp:\n+                if not data.get(\"title\"):\n+                    with http.curl(\"GET\", local(\"origin\"), uri) as resp:\n                         if resp and resp.status == 200:\n                             uri, title = parse.thread(resp.read(), id=uri)\n                         else:\n-                            return BadRequest(f'Cannot create new thread: URI {uri} is not accessible and no title was provided. Please provide a title parameter in your request.')\n+                            return BadRequest(\n+                                f\"Cannot create new thread: URI {uri} is not accessible and no title was provided. Please provide a title parameter in your request.\"\n+                            )\n                 else:\n-                    title = data['title']\n+                    title = data[\"title\"]\n \n                 thread = self.threads.new(uri, title)\n                 self.signal(\"comments.new:new-thread\", thread)\n@@ -375,23 +389,20 @@ def new(self, environ, request, uri):\n         with self.isso.lock:\n             # if email-based auto-moderation enabled, check for previously approved author\n             # right before approval.\n-            if self.approve_if_email_previously_approved and self.comments.is_previously_approved_author(data['email']):\n-                data['mode'] = 1\n+            if self.approve_if_email_previously_approved and self.comments.is_previously_approved_author(data[\"email\"]):\n+                data[\"mode\"] = 1\n \n             rv = self.comments.add(uri, data)\n \n         # notify extension, that the new comment has been successfully saved\n         self.signal(\"comments.new:after-save\", thread, rv)\n \n-        cookie = self.create_cookie(\n-            value=self.isso.sign([rv[\"id\"], sha1(rv[\"text\"])]),\n-            max_age=self.conf.getint('max-age'))\n+        cookie = self.create_cookie(value=self.isso.sign([rv[\"id\"], sha1(rv[\"text\"])]), max_age=self.conf.getint(\"max-age\"))\n \n         rv[\"text\"] = self.isso.render(rv[\"text\"])\n-        rv[\"hash\"] = self.hash(rv['email'] or rv['remote_addr'])\n+        rv[\"hash\"] = self.hash(rv[\"email\"] or rv[\"remote_addr\"])\n \n-        self.cache.set(\n-            'hash', (rv['email'] or rv['remote_addr']).encode('utf-8'), rv['hash'])\n+        self.cache.set(\"hash\", (rv[\"email\"] or rv[\"remote_addr\"]).encode(\"utf-8\"), rv[\"hash\"])\n \n         rv = self._add_gravatar_image(rv)\n \n@@ -417,8 +428,7 @@ def _remote_addr(self, request):\n         remote_addr = request.remote_addr\n         if self.trusted_proxies:\n             route = request.access_route + [remote_addr]\n-            remote_addr = next((addr for addr in reversed(route)\n-                                if addr not in self.trusted_proxies), remote_addr)\n+            remote_addr = next((addr for addr in reversed(route) if addr not in self.trusted_proxies), remote_addr)\n         return utils.anonymize(str(remote_addr))\n \n     def create_cookie(self, **kwargs):\n@@ -436,8 +446,7 @@ def create_cookie(self, **kwargs):\n         else:\n             secure = False\n             samesite = samesite or \"Lax\"\n-        return functools.partial(dump_cookie, **kwargs,\n-                                 secure=secure, samesite=samesite)\n+        return functools.partial(dump_cookie, **kwargs, secure=secure, samesite=samesite)\n \n     \"\"\"\n     @api {get} /id/:id view\n@@ -470,22 +479,22 @@ def create_cookie(self, **kwargs):\n             \"likes\": 1\n         }\n     \"\"\"\n-    def view(self, environ, request, id):\n \n+    def view(self, environ, request, id):\n         rv = self.comments.get(id)\n         if rv is None:\n             raise NotFound\n \n         try:\n-            self.isso.unsign(request.cookies.get(str(id), ''))\n+            self.isso.unsign(request.cookies.get(str(id), \"\"))\n         except (SignatureExpired, BadSignature):\n             raise Forbidden\n \n         for key in set(rv.keys()) - API.FIELDS:\n             rv.pop(key)\n \n-        if request.args.get('plain', '0') == '0':\n-            rv['text'] = self.isso.render(rv['text'])\n+        if request.args.get(\"plain\", \"0\") == \"0\":\n+            rv[\"text\"] = self.isso.render(rv[\"text\"])\n \n         return JSON(rv, 200)\n \n@@ -527,11 +536,11 @@ def view(self, environ, request, id):\n             \"likes\": 0\n         }\n     \"\"\"\n+\n     @xhr\n     def edit(self, environ, request, id):\n-\n         try:\n-            rv = self.isso.unsign(request.cookies.get(str(id), ''))\n+            rv = self.isso.unsign(request.cookies.get(str(id), \"\"))\n         except (SignatureExpired, BadSignature):\n             raise Forbidden\n \n@@ -558,7 +567,7 @@ def edit(self, environ, request, id):\n         if data.get(\"website\") is not None:\n             data[\"website\"] = escape(data[\"website\"], quote=True)\n \n-        data['modified'] = time.time()\n+        data[\"modified\"] = time.time()\n \n         with self.isso.lock:\n             rv = self.comments.update(id, data)\n@@ -568,9 +577,7 @@ def edit(self, environ, request, id):\n \n         self.signal(\"comments.edit\", rv)\n \n-        cookie = self.create_cookie(\n-            value=self.isso.sign([rv[\"id\"], sha1(rv[\"text\"])]),\n-            max_age=self.conf.getint('max-age'))\n+        cookie = self.create_cookie(value=self.isso.sign([rv[\"id\"], sha1(rv[\"text\"])]), max_age=self.conf.getint(\"max-age\"))\n \n         rv[\"text\"] = self.isso.render(rv[\"text\"])\n \n@@ -620,9 +627,9 @@ def edit(self, environ, request, id):\n             \"notification\": 0\n         }\n     \"\"\"\n+\n     @xhr\n     def delete(self, environ, request, id):\n-\n         try:\n             rv = self.isso.unsign(request.cookies.get(str(id), \"\"))\n         except (SignatureExpired, BadSignature):\n@@ -640,8 +647,7 @@ def delete(self, environ, request, id):\n         if item is None:\n             raise NotFound\n \n-        self.cache.delete(\n-            'hash', (item['email'] or item['remote_addr']).encode('utf-8'))\n+        self.cache.delete(\"hash\", (item[\"email\"] or item[\"remote_addr\"]).encode(\"utf-8\"))\n \n         with self.isso.lock:\n             rv = self.comments.delete(id)\n@@ -686,6 +692,7 @@ def delete(self, environ, request, id):\n             </body>\n         </html>\n     \"\"\"\n+\n     def unsubscribe(self, environ, request, id, email, key):\n         email = unquote(email)\n \n@@ -697,7 +704,7 @@ def unsubscribe(self, environ, request, id, email, key):\n         if not isinstance(rv, list) or len(rv) != 2:\n             raise Forbidden\n \n-        if rv[0] != 'unsubscribe' or rv[1] != email:\n+        if rv[0] != \"unsubscribe\" or rv[1] != email:\n             raise Forbidden\n \n         item = self.comments.get(id)\n@@ -717,7 +724,8 @@ def unsubscribe(self, environ, request, id, email, key):\n             \"<body>\"\n             \"  <p>You have been unsubscribed from replies in the given conversation.</p>\"\n             \"</body>\"\n-            \"</html>\")\n+            \"</html>\"\n+        )\n \n         return Response(modal, 200, content_type=\"text/html\")\n \n@@ -764,6 +772,7 @@ def unsubscribe(self, environ, request, id, email, key):\n     @apiSuccessExample Activate using POST:\n         Comment has been activated\n     \"\"\"\n+\n     def moderate(self, environ, request, id, action, key):\n         try:\n             id = self.isso.unsign(key, max_age=2**32)\n@@ -774,7 +783,7 @@ def moderate(self, environ, request, id, action, key):\n         if item is None:\n             raise NotFound\n \n-        thread = self.threads.get(item['tid'])\n+        thread = self.threads.get(item[\"tid\"])\n         link = local(\"origin\") + thread[\"uri\"] + \"#isso-%i\" % item[\"id\"]\n \n         if request.method == \"GET\":\n@@ -791,12 +800,13 @@ def moderate(self, environ, request, id, action, key):\n                 \"          window.location.href = %s;\"\n                 \"      };\"\n                 \"  }\"\n-                \"</script>\" % (action.capitalize(), json.dumps(link)))\n+                \"</script>\" % (action.capitalize(), json.dumps(link))\n+            )\n \n             return Response(modal, 200, content_type=\"text/html\")\n \n         if action == \"activate\":\n-            if item['mode'] == 1:\n+            if item[\"mode\"] == 1:\n                 return Response(\"Already activated\", 200)\n             with self.isso.lock:\n                 self.comments.activate(id)\n@@ -828,8 +838,7 @@ def moderate(self, environ, request, id, action, key):\n         else:\n             with self.isso.lock:\n                 self.comments.delete(id)\n-            self.cache.delete(\n-                'hash', (item['email'] or item['remote_addr']).encode('utf-8'))\n+            self.cache.delete(\"hash\", (item[\"email\"] or item[\"remote_addr\"]).encode(\"utf-8\"))\n             self.signal(\"comments.delete\", id)\n             return Response(\"Comment has been deleted\", 200)\n \n@@ -923,60 +932,57 @@ def moderate(self, environ, request, id, action, key):\n             \"hidden_replies\": 12\n         }\n     \"\"\"\n-    @requires(str, 'uri')\n-    def fetch(self, environ, request, uri):\n \n-        args = {\n-            'uri': uri,\n-            'after': request.args.get('after', 0)\n-        }\n+    @requires(str, \"uri\")\n+    def fetch(self, environ, request, uri):\n+        args = {\"uri\": uri, \"after\": request.args.get(\"after\", 0)}\n \n         # map sort query parameter\n-        valid_sort_options = ['newest', 'oldest', 'upvotes']\n-        sort = request.args.get('sort', 'oldest')\n+        valid_sort_options = [\"newest\", \"oldest\", \"upvotes\"]\n+        sort = request.args.get(\"sort\", \"oldest\")\n \n         if sort not in valid_sort_options:\n             return BadRequest(\"Invalid sort option. Must be one of: 'newest', 'oldest', 'upvotes'\")\n \n-        if sort == 'newest':\n-            args['order_by'] = 'created'\n-            args['asc'] = 0\n-        elif sort == 'oldest':\n-            args['order_by'] = 'created'\n-            args['asc'] = 1\n-        elif sort == 'upvotes':\n-            args['order_by'] = 'karma'\n-            args['asc'] = 0\n+        if sort == \"newest\":\n+            args[\"order_by\"] = \"created\"\n+            args[\"asc\"] = 0\n+        elif sort == \"oldest\":\n+            args[\"order_by\"] = \"created\"\n+            args[\"asc\"] = 1\n+        elif sort == \"upvotes\":\n+            args[\"order_by\"] = \"karma\"\n+            args[\"asc\"] = 0\n \n         try:\n-            args['limit'] = int(request.args.get('limit'))\n+            args[\"limit\"] = int(request.args.get(\"limit\"))\n         except TypeError:\n-            args['limit'] = None\n+            args[\"limit\"] = None\n         except ValueError:\n             return BadRequest(\"limit should be integer\")\n \n         try:\n-            args['offset'] = int(request.args.get('offset', 0))\n-            if args['offset'] < 0:\n+            args[\"offset\"] = int(request.args.get(\"offset\", 0))\n+            if args[\"offset\"] < 0:\n                 return BadRequest(\"offset should not be negative\")\n         except (ValueError, TypeError):\n             return BadRequest(\"offset should be integer\")\n \n-        if request.args.get('parent') is not None:\n+        if request.args.get(\"parent\") is not None:\n             try:\n-                args['parent'] = int(request.args.get('parent'))\n-                root_id = args['parent']\n+                args[\"parent\"] = int(request.args.get(\"parent\"))\n+                root_id = args[\"parent\"]\n             except ValueError:\n                 return BadRequest(\"parent should be integer\")\n         else:\n-            args['parent'] = None\n+            args[\"parent\"] = None\n             root_id = None\n \n-        plain = request.args.get('plain', '0') == '0'\n+        plain = request.args.get(\"plain\", \"0\") == \"0\"\n \n         reply_counts = self.comments.reply_count(uri)\n \n-        if args['limit'] == 0:\n+        if args[\"limit\"] == 0:\n             root_list = []\n         else:\n             root_list = list(self.comments.fetch(**args))\n@@ -988,69 +994,67 @@ def fetch(self, environ, request, uri):\n         total_replies = sum(reply_counts.values()) if root_id is None else reply_counts[root_id]\n \n         try:\n-            nested_limit = int(request.args.get('nested_limit'))\n+            nested_limit = int(request.args.get(\"nested_limit\"))\n         except TypeError:\n             nested_limit = None\n         except ValueError:\n             return BadRequest(\"nested_limit should be integer\")\n \n         rv = {\n-            'id': root_id,\n-            'total_replies': total_replies,\n-            'hidden_replies': reply_counts[root_id] - len(root_list) - args['offset'],\n-            'replies': self._process_fetched_list(root_list, plain),\n-            'config': self.public_conf\n+            \"id\": root_id,\n+            \"total_replies\": total_replies,\n+            \"hidden_replies\": reply_counts[root_id] - len(root_list) - args[\"offset\"],\n+            \"replies\": self._process_fetched_list(root_list, plain),\n+            \"config\": self.public_conf,\n         }\n         # We are only checking for one level deep comments\n         if root_id is None:\n-            for comment in rv['replies']:\n-                if comment['id'] in reply_counts:\n-                    comment['total_replies'] = reply_counts[comment['id']]\n+            for comment in rv[\"replies\"]:\n+                if comment[\"id\"] in reply_counts:\n+                    comment[\"total_replies\"] = reply_counts[comment[\"id\"]]\n                     if nested_limit is not None:\n                         if nested_limit > 0:\n-                            args['parent'] = comment['id']\n-                            args['limit'] = nested_limit\n+                            args[\"parent\"] = comment[\"id\"]\n+                            args[\"limit\"] = nested_limit\n                             # Reset offset to 0 for nested comments to ensure correct pagination\n-                            args['offset'] = 0\n+                            args[\"offset\"] = 0\n                             replies = list(self.comments.fetch(**args))\n                         else:\n                             replies = []\n                     else:\n-                        args['parent'] = comment['id']\n+                        args[\"parent\"] = comment[\"id\"]\n                         replies = list(self.comments.fetch(**args))\n                 else:\n-                    comment['total_replies'] = 0\n+                    comment[\"total_replies\"] = 0\n                     replies = []\n \n-                comment['hidden_replies'] = comment['total_replies'] - \\\n-                    len(replies)\n-                comment['replies'] = self._process_fetched_list(replies, plain)\n+                comment[\"hidden_replies\"] = comment[\"total_replies\"] - len(replies)\n+                comment[\"replies\"] = self._process_fetched_list(replies, plain)\n \n         return JSON(rv, 200)\n \n     def _add_gravatar_image(self, item):\n-        if not self.conf.getboolean('gravatar'):\n+        if not self.conf.getboolean(\"gravatar\"):\n             return item\n \n-        email = item['email'] or item['author'] or ''\n+        email = item[\"email\"] or item[\"author\"] or \"\"\n         email_md5_hash = md5(email)\n \n-        gravatar_url = self.conf.get('gravatar-url')\n-        item['gravatar_image'] = gravatar_url.format(email_md5_hash)\n+        gravatar_url = self.conf.get(\"gravatar-url\")\n+        item[\"gravatar_image\"] = gravatar_url.format(email_md5_hash)\n \n         return item\n \n     def _process_fetched_list(self, fetched_list, plain=False):\n         for item in fetched_list:\n-\n-            key = item['email'] or item['remote_addr']\n-            val = self.cache.get('hash', key.encode('utf-8'))\n+            key = item[\"email\"] or item[\"remote_addr\"]\n+            val = self.cache.get(\"hash\", key.encode(\"utf-8\"))\n \n             if val is None:\n                 val = self.hash(key)\n-                self.cache.set('hash', key.encode('utf-8'), val)\n+                self.cache.set(\"hash\", key.encode(\"utf-8\"), val)\n \n-            item['hash'] = val\n+            item[\"hash\"] = val\n \n             item = self._add_gravatar_image(item)\n \n@@ -1059,7 +1063,7 @@ def _process_fetched_list(self, fetched_list, plain=False):\n \n         if plain:\n             for item in fetched_list:\n-                item['text'] = self.isso.render(item['text'])\n+                item[\"text\"] = self.isso.render(item[\"text\"])\n \n         return fetched_list\n \n@@ -1093,9 +1097,9 @@ def _process_fetched_list(self, fetched_list, plain=False):\n \n     @apiUse likeResponse\n     \"\"\"\n+\n     @xhr\n     def like(self, environ, request, id):\n-\n         nv = self.comments.vote(True, id, self._remote_addr(request))\n         return JSON(nv, 200)\n \n@@ -1116,9 +1120,9 @@ def like(self, environ, request, id):\n \n     @apiUse likeResponse\n     \"\"\"\n+\n     @xhr\n     def dislike(self, environ, request, id):\n-\n         nv = self.comments.vote(False, id, self._remote_addr(request))\n         return JSON(nv, 200)\n \n@@ -1144,13 +1148,14 @@ def dislike(self, environ, request, id):\n             \"text\": \"<p>A sample comment</p>\"\n         }\n     \"\"\"\n+\n     def preview(self, environment, request):\n         data = request.json\n \n         if data.get(\"text\", None) is None:\n             raise BadRequest(\"no text given\")\n \n-        return JSON({'text': self.isso.render(data[\"text\"])}, 200)\n+        return JSON({\"text\": self.isso.render(data[\"text\"])}, 200)\n \n     \"\"\"\n     @api {post} /count Count comments\n@@ -1169,8 +1174,8 @@ def preview(self, environment, request):\n     @apiSuccessExample {json} Counts of 5 threads:\n         [2, 18, 4, 0, 3]\n     \"\"\"\n-    def counts(self, environ, request):\n \n+    def counts(self, environ, request):\n         data = request.json\n \n         if not isinstance(data, list) and not all(isinstance(x, str) for x in data):\n@@ -1220,117 +1225,104 @@ def counts(self, environ, request):\n           </entry>\n         </feed>\n     \"\"\"\n-    @requires(str, 'uri')\n+\n+    @requires(str, \"uri\")\n     def feed(self, environ, request, uri):\n         conf = self.isso.conf.section(\"rss\")\n-        if not conf.get('base'):\n+        if not conf.get(\"base\"):\n             raise NotFound\n \n-        args = {\n-            'uri': uri,\n-            'order_by': 'id',\n-            'asc': 0,\n-            'limit': conf.getint('limit')\n-        }\n+        args = {\"uri\": uri, \"order_by\": \"id\", \"asc\": 0, \"limit\": conf.getint(\"limit\")}\n         try:\n-            args['limit'] = max(int(request.args.get('limit')), args['limit'])\n+            args[\"limit\"] = max(int(request.args.get(\"limit\")), args[\"limit\"])\n         except TypeError:\n             pass\n         except ValueError:\n             return BadRequest(\"limit should be integer\")\n         comments = self.comments.fetch(**args)\n-        base = conf.get('base').rstrip('/')\n+        base = conf.get(\"base\").rstrip(\"/\")\n         hostname = urlparse(base).netloc\n \n         # Let's build an Atom feed.\n         #  RFC 4287: https://tools.ietf.org/html/rfc4287\n         #  RFC 4685: https://tools.ietf.org/html/rfc4685 (threading extensions)\n         #  For IDs: http://web.archive.org/web/20110514113830/http://diveintomark.org/archives/2004/05/28/howto-atom-id\n-        feed = ET.Element('feed', {\n-            'xmlns': 'http://www.w3.org/2005/Atom',\n-            'xmlns:thr': 'http://purl.org/syndication/thread/1.0'\n-        })\n+        feed = ET.Element(\n+            \"feed\", {\"xmlns\": \"http://www.w3.org/2005/Atom\", \"xmlns:thr\": \"http://purl.org/syndication/thread/1.0\"}\n+        )\n \n         # For feed ID, we would use thread ID, but we may not have\n         # one. Therefore, we use the URI. We don't have a year\n         # either...\n-        id = ET.SubElement(feed, 'id')\n-        id.text = 'tag:{hostname},2018:/isso/thread{uri}'.format(\n-            hostname=hostname, uri=uri)\n+        id = ET.SubElement(feed, \"id\")\n+        id.text = \"tag:{hostname},2018:/isso/thread{uri}\".format(hostname=hostname, uri=uri)\n \n         # For title, we don't have much either. Be pretty generic.\n-        title = ET.SubElement(feed, 'title')\n-        title.text = 'Comments for {hostname}{uri}'.format(\n-            hostname=hostname, uri=uri)\n+        title = ET.SubElement(feed, \"title\")\n+        title.text = \"Comments for {hostname}{uri}\".format(hostname=hostname, uri=uri)\n \n         comment0 = None\n \n         for comment in comments:\n             if comment0 is None:\n                 comment0 = comment\n \n-            entry = ET.SubElement(feed, 'entry')\n+            entry = ET.SubElement(feed, \"entry\")\n             # We don't use a real date in ID either to help with\n             # threading.\n-            id = ET.SubElement(entry, 'id')\n-            id.text = 'tag:{hostname},2018:/isso/{tid}/{id}'.format(\n-                hostname=hostname,\n-                tid=comment['tid'],\n-                id=comment['id'])\n-            title = ET.SubElement(entry, 'title')\n-            title.text = 'Comment #{}'.format(comment['id'])\n-            updated = ET.SubElement(entry, 'updated')\n-            updated.text = '{}Z'.format(datetime.fromtimestamp(\n-                comment['modified'] or comment['created']).isoformat())\n-            author = ET.SubElement(entry, 'author')\n-            name = ET.SubElement(author, 'name')\n-            name.text = comment['author']\n-            ET.SubElement(entry, 'link', {\n-                'href': '{base}{uri}#isso-{id}'.format(\n-                    base=base,\n-                    uri=uri, id=comment['id'])\n-            })\n-            content = ET.SubElement(entry, 'content', {\n-                'type': 'html',\n-            })\n-            content.text = self.isso.render(comment['text'])\n-\n-            if comment['parent']:\n-                ET.SubElement(entry, 'thr:in-reply-to', {\n-                    'ref': 'tag:{hostname},2018:/isso/{tid}/{id}'.format(\n-                        hostname=hostname,\n-                        tid=comment['tid'],\n-                        id=comment['parent']),\n-                    'href': '{base}{uri}#isso-{id}'.format(\n-                        base=base,\n-                        uri=uri, id=comment['parent'])\n-                })\n+            id = ET.SubElement(entry, \"id\")\n+            id.text = \"tag:{hostname},2018:/isso/{tid}/{id}\".format(hostname=hostname, tid=comment[\"tid\"], id=comment[\"id\"])\n+            title = ET.SubElement(entry, \"title\")\n+            title.text = \"Comment #{}\".format(comment[\"id\"])\n+            updated = ET.SubElement(entry, \"updated\")\n+            updated.text = \"{}Z\".format(datetime.fromtimestamp(comment[\"modified\"] or comment[\"created\"]).isoformat())\n+            author = ET.SubElement(entry, \"author\")\n+            name = ET.SubElement(author, \"name\")\n+            name.text = comment[\"author\"]\n+            ET.SubElement(entry, \"link\", {\"href\": \"{base}{uri}#isso-{id}\".format(base=base, uri=uri, id=comment[\"id\"])})\n+            content = ET.SubElement(\n+                entry,\n+                \"content\",\n+                {\n+                    \"type\": \"html\",\n+                },\n+            )\n+            content.text = self.isso.render(comment[\"text\"])\n+\n+            if comment[\"parent\"]:\n+                ET.SubElement(\n+                    entry,\n+                    \"thr:in-reply-to\",\n+                    {\n+                        \"ref\": \"tag:{hostname},2018:/isso/{tid}/{id}\".format(\n+                            hostname=hostname, tid=comment[\"tid\"], id=comment[\"parent\"]\n+                        ),\n+                        \"href\": \"{base}{uri}#isso-{id}\".format(base=base, uri=uri, id=comment[\"parent\"]),\n+                    },\n+                )\n \n         # Updated is mandatory. If we have comments, we use the date\n         # of last modification of the first one (which is the last\n         # one). Otherwise, we use a fixed date.\n-        updated = ET.Element('updated')\n+        updated = ET.Element(\"updated\")\n         if comment0 is None:\n-            updated.text = '1970-01-01T01:00:00Z'\n+            updated.text = \"1970-01-01T01:00:00Z\"\n         else:\n-            updated.text = datetime.fromtimestamp(\n-                comment0['modified'] or comment0['created']).isoformat()\n-            updated.text += 'Z'\n+            updated.text = datetime.fromtimestamp(comment0[\"modified\"] or comment0[\"created\"]).isoformat()\n+            updated.text += \"Z\"\n         feed.insert(0, updated)\n \n         output = StringIO()\n-        ET.ElementTree(feed).write(output,\n-                                   encoding='utf-8',\n-                                   xml_declaration=True)\n+        ET.ElementTree(feed).write(output, encoding=\"utf-8\", xml_declaration=True)\n         response = XML(output.getvalue(), 200)\n \n         # Add an etag/last-modified value for caching purpose\n         if comment0 is None:\n-            response.set_etag('empty')\n+            response.set_etag(\"empty\")\n             response.last_modified = 0\n         else:\n-            response.set_etag('{tid}-{id}'.format(**comment0))\n-            response.last_modified = comment0['modified'] or comment0['created']\n+            response.set_etag(\"{tid}-{id}\".format(**comment0))\n+            response.last_modified = comment0[\"modified\"] or comment0[\"created\"]\n         return response.make_conditional(request)\n \n     \"\"\"\n@@ -1377,8 +1369,9 @@ def feed(self, environ, request, uri):\n           }\n         }\n     \"\"\"\n+\n     def config(self, environment, request):\n-        rv = {'config': self.public_conf}\n+        rv = {\"config\": self.public_conf}\n         return JSON(rv, 200)\n \n     \"\"\"\n@@ -1415,9 +1408,10 @@ def config(self, environment, request):\n          </div>\n         </body>\n     \"\"\"\n+\n     def demo(self, env, req):\n-        index = str(files('isso').joinpath('demo/index.html'))\n-        return send_from_directory(os_path.dirname(index), 'index.html', env)\n+        index = str(files(\"isso\").joinpath(\"demo/index.html\"))\n+        return send_from_directory(os_path.dirname(index), \"index.html\", env)\n \n     \"\"\"\n     @api {post} /login/ Log in\n@@ -1441,26 +1435,22 @@ def demo(self, env, req):\n         <h1>Redirecting...</h1>\n         <p>You should be redirected automatically to the target URL: <a href=\"https://comments.example.com/admin/\">https://comments.example.com/admin/</a>. If not, click the link.\n     \"\"\"\n+\n     def login(self, env, req):\n         if not self.isso.conf.getboolean(\"admin\", \"enabled\"):\n             isso_host_script = self.isso.conf.get(\"server\", \"public-endpoint\") or local.host\n-            return render_template('disabled.html', isso_host_script=isso_host_script)\n+            return render_template(\"disabled.html\", isso_host_script=isso_host_script)\n         data = req.form\n         password = self.isso.conf.get(\"admin\", \"password\")\n-        if data['password'] and data['password'] == password:\n-            response = redirect(re.sub(\n-                r'/login/$',\n-                '/admin/',\n-                get_current_url(env, strip_querystring=True)\n-            ))\n-            cookie = self.create_cookie(value=self.isso.sign({\"logged\": True}),\n-                                        expires=datetime.now() + timedelta(1))\n+        if data[\"password\"] and data[\"password\"] == password:\n+            response = redirect(re.sub(r\"/login/$\", \"/admin/\", get_current_url(env, strip_querystring=True)))\n+            cookie = self.create_cookie(value=self.isso.sign({\"logged\": True}), expires=datetime.now() + timedelta(1))\n             response.headers.add(\"Set-Cookie\", cookie(\"admin-session\"))\n             response.headers.add(\"X-Set-Cookie\", cookie(\"isso-admin-session\"))\n             return response\n         else:\n             isso_host_script = self.isso.conf.get(\"server\", \"public-endpoint\") or local.host\n-            return render_template('login.html', isso_host_script=isso_host_script)\n+            return render_template(\"login.html\", isso_host_script=isso_host_script)\n \n     \"\"\"\n     @api {get} /admin/ Admin interface\n@@ -1493,23 +1483,23 @@ def login(self, env, req):\n     @apiExample {curl} Listing of published comments:\n         curl 'https://comments.example.com/admin/?mode=1&page=0&order_by=modified&asc=1' -b cookie.txt\n     \"\"\"\n+\n     def admin(self, env, req):\n         isso_host_script = self.isso.conf.get(\"server\", \"public-endpoint\") or local.host\n         if not self.isso.conf.getboolean(\"admin\", \"enabled\"):\n-            return render_template('disabled.html', isso_host_script=isso_host_script)\n+            return render_template(\"disabled.html\", isso_host_script=isso_host_script)\n         try:\n-            data = self.isso.unsign(req.cookies.get('admin-session', ''),\n-                                    max_age=60 * 60 * 24)\n+            data = self.isso.unsign(req.cookies.get(\"admin-session\", \"\"), max_age=60 * 60 * 24)\n         except BadSignature:\n-            return render_template('login.html', isso_host_script=isso_host_script)\n-        if not data or not data['logged']:\n-            return render_template('login.html', isso_host_script=isso_host_script)\n+            return render_template(\"login.html\", isso_host_script=isso_host_script)\n+        if not data or not data[\"logged\"]:\n+            return render_template(\"login.html\", isso_host_script=isso_host_script)\n         page_size = 100\n-        page = int(req.args.get('page', 0))\n-        order_by = req.args.get('order_by', 'created')\n-        asc = int(req.args.get('asc', 0))\n-        mode = int(req.args.get('mode', 2))\n-        comment_search_url = req.args.get('comment_search_url', '')\n+        page = int(req.args.get(\"page\", 0))\n+        order_by = req.args.get(\"order_by\", \"created\")\n+        asc = int(req.args.get(\"asc\", 0))\n+        mode = int(req.args.get(\"mode\", 2))\n+        comment_search_url = req.args.get(\"comment_search_url\", \"\")\n \n         # Search for comments by URL\n         if comment_search_url:\n@@ -1520,23 +1510,27 @@ def admin(self, env, req):\n             else:\n                 comments = []\n         else:\n-            comments = self.comments.fetchall(mode=mode, page=page,\n-                                              limit=page_size,\n-                                              order_by=order_by,\n-                                              asc=asc)\n+            comments = self.comments.fetchall(mode=mode, page=page, limit=page_size, order_by=order_by, asc=asc)\n         comments_enriched = []\n         for comment in list(comments):\n-            comment['hash'] = self.isso.sign(comment['id'])\n+            comment[\"hash\"] = self.isso.sign(comment[\"id\"])\n             comments_enriched.append(comment)\n         comment_mode_count = self.comments.count_modes()\n         max_page = int(sum(comment_mode_count.values()) / 100)\n-        return render_template('admin.html', comments=comments_enriched,\n-                               page=int(page), mode=int(mode),\n-                               conf=self.conf, max_page=max_page,\n-                               counts=comment_mode_count,\n-                               order_by=order_by, asc=asc,\n-                               comment_search_url=comment_search_url,\n-                               isso_host_script=isso_host_script)\n+        return render_template(\n+            \"admin.html\",\n+            comments=comments_enriched,\n+            page=int(page),\n+            mode=int(mode),\n+            conf=self.conf,\n+            max_page=max_page,\n+            counts=comment_mode_count,\n+            order_by=order_by,\n+            asc=asc,\n+            comment_search_url=comment_search_url,\n+            isso_host_script=isso_host_script,\n+        )\n+\n     \"\"\"\n     @api {get} /latest latest\n     @apiGroup Comment\n@@ -1583,46 +1577,45 @@ def admin(self, env, req):\n             }\n         ]\n     \"\"\"\n+\n     def latest(self, environ, request):\n         # if the feature is not allowed, don't present the endpoint\n         if not self.conf.getboolean(\"latest-enabled\"):\n-            return NotFound(\n-                \"Unavailable because 'latest-enabled' not set by site admin\"\n-            )\n+            return NotFound(\"Unavailable because 'latest-enabled' not set by site admin\")\n \n         # get and check the limit\n         bad_limit_msg = \"Query parameter 'limit' is mandatory (integer, >0)\"\n         try:\n-            limit = int(request.args['limit'])\n+            limit = int(request.args[\"limit\"])\n         except (KeyError, ValueError):\n             return BadRequest(bad_limit_msg)\n         if limit <= 0:\n             return BadRequest(bad_limit_msg)\n \n         # retrieve the latest N comments from the DB\n-        all_comments_gen = self.comments.fetchall(limit=None, order_by='created', mode='1')\n+        all_comments_gen = self.comments.fetchall(limit=None, order_by=\"created\", mode=\"1\")\n         comments = collections.deque(all_comments_gen, maxlen=limit)\n \n         # prepare a special set of fields (except text which is rendered specifically)\n         fields = {\n-            'author',\n-            'created',\n-            'dislikes',\n-            'id',\n-            'likes',\n-            'mode',\n-            'modified',\n-            'parent',\n-            'text',\n-            'uri',\n-            'website',\n+            \"author\",\n+            \"created\",\n+            \"dislikes\",\n+            \"id\",\n+            \"likes\",\n+            \"mode\",\n+            \"modified\",\n+            \"parent\",\n+            \"text\",\n+            \"uri\",\n+            \"website\",\n         }\n \n         # process the retrieved comments and build results\n         result = []\n         for comment in comments:\n             processed = {key: comment[key] for key in fields}\n-            processed['text'] = self.isso.render(comment['text'])\n+            processed[\"text\"] = self.isso.render(comment[\"text\"])\n             result.append(processed)\n \n         return JSON(result, 200)"
    },
    {
      "sha": "61a3dd6a2f7b896144906ddc553fae999ad8929f",
      "filename": "isso/wsgi.py",
      "status": "modified",
      "additions": 22,
      "deletions": 31,
      "changes": 53,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fwsgi.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/isso%2Fwsgi.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fwsgi.py?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -18,38 +18,38 @@ def host(environ):  # pragma: no cover\n     of http://www.python.org/dev/peps/pep-0333/#url-reconstruction\n     \"\"\"\n \n-    url = environ['wsgi.url_scheme'] + '://'\n+    url = environ[\"wsgi.url_scheme\"] + \"://\"\n \n-    if environ.get('HTTP_HOST'):\n-        url += environ['HTTP_HOST']\n+    if environ.get(\"HTTP_HOST\"):\n+        url += environ[\"HTTP_HOST\"]\n     else:\n-        url += environ['SERVER_NAME']\n+        url += environ[\"SERVER_NAME\"]\n \n-        if environ['wsgi.url_scheme'] == 'https':\n-            if environ['SERVER_PORT'] != '443':\n-                url += ':' + environ['SERVER_PORT']\n+        if environ[\"wsgi.url_scheme\"] == \"https\":\n+            if environ[\"SERVER_PORT\"] != \"443\":\n+                url += \":\" + environ[\"SERVER_PORT\"]\n         else:\n-            if environ['SERVER_PORT'] != '80':\n-                url += ':' + environ['SERVER_PORT']\n+            if environ[\"SERVER_PORT\"] != \"80\":\n+                url += \":\" + environ[\"SERVER_PORT\"]\n \n-    return url + quote(environ.get('SCRIPT_NAME', ''))\n+    return url + quote(environ.get(\"SCRIPT_NAME\", \"\"))\n \n \n def urlsplit(name):\n     \"\"\"\n     Parse :param:`name` into (netloc, port, ssl)\n     \"\"\"\n \n-    if not isinstance(name, (str, )):\n+    if not isinstance(name, (str,)):\n         name = str(name)\n \n-    if not name.startswith(('http://', 'https://')):\n-        name = 'http://' + name\n+    if not name.startswith((\"http://\", \"https://\")):\n+        name = \"http://\" + name\n \n     rv = urlparse(name)\n-    if rv.scheme == 'https' and rv.port is None:\n+    if rv.scheme == \"https\" and rv.port is None:\n         return rv.netloc, 443, True\n-    return rv.netloc.rsplit(':')[0], rv.port or 80, rv.scheme == 'https'\n+    return rv.netloc.rsplit(\":\")[0], rv.port or 80, rv.scheme == \"https\"\n \n \n def urljoin(netloc, port, ssl):\n@@ -72,7 +72,6 @@ def origin(hosts):\n     hosts = [urlsplit(h) for h in hosts]\n \n     def func(environ):\n-\n         if not hosts:\n             return \"http://invalid.local\"\n \n@@ -91,18 +90,16 @@ def func(environ):\n \n \n class SubURI(object):\n-\n     def __init__(self, app):\n         self.app = app\n \n     def __call__(self, environ, start_response):\n-\n-        script_name = environ.get('HTTP_X_SCRIPT_NAME')\n+        script_name = environ.get(\"HTTP_X_SCRIPT_NAME\")\n         if script_name:\n-            environ['SCRIPT_NAME'] = script_name\n-            path_info = environ['PATH_INFO']\n+            environ[\"SCRIPT_NAME\"] = script_name\n+            path_info = environ[\"PATH_INFO\"]\n             if path_info.startswith(script_name):\n-                environ['PATH_INFO'] = path_info[len(script_name):]\n+                environ[\"PATH_INFO\"] = path_info[len(script_name) :]\n \n         return self.app(environ, start_response)\n \n@@ -119,19 +116,15 @@ def __init__(self, app, origin, allowed=None, exposed=None):\n         self.exposed = exposed\n \n     def __call__(self, environ, start_response):\n-\n         def add_cors_headers(status, headers, exc_info=None):\n             headers = Headers(headers)\n             headers.add(\"Access-Control-Allow-Origin\", self.origin(environ))\n             headers.add(\"Access-Control-Allow-Credentials\", \"true\")\n-            headers.add(\"Access-Control-Allow-Methods\",\n-                        \", \".join(self.methods))\n+            headers.add(\"Access-Control-Allow-Methods\", \", \".join(self.methods))\n             if self.allowed:\n-                headers.add(\"Access-Control-Allow-Headers\",\n-                            \", \".join(self.allowed))\n+                headers.add(\"Access-Control-Allow-Headers\", \", \".join(self.allowed))\n             if self.exposed:\n-                headers.add(\"Access-Control-Expose-Headers\",\n-                            \", \".join(self.exposed))\n+                headers.add(\"Access-Control-Expose-Headers\", \", \".join(self.exposed))\n             return start_response(status, headers.to_wsgi_list(), exc_info)\n \n         if environ.get(\"REQUEST_METHOD\") == \"OPTIONS\":\n@@ -142,15 +135,13 @@ def add_cors_headers(status, headers, exc_info=None):\n \n \n class Request(_Request):\n-\n     # Assuming UTF-8, comments with 65536 characters would consume\n     # 128 kb memory. The remaining 128 kb cover additional parameters\n     # and WSGI headers.\n     max_content_length = 256 * 1024\n \n \n class SocketWSGIRequestHandler(WSGIRequestHandler):\n-\n     def run_wsgi(self):\n         self.client_address = (\"<local>\", 0)\n         super(SocketWSGIRequestHandler, self).run_wsgi()"
    },
    {
      "sha": "b6f1f83c7269971347cfd1ac64753bf10eae8473",
      "filename": "pyproject.toml",
      "status": "added",
      "additions": 38,
      "deletions": 0,
      "changes": 38,
      "blob_url": "https://github.com/isso-comments/isso/blob/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/pyproject.toml",
      "raw_url": "https://github.com/isso-comments/isso/raw/fe4459b95ccbd326c6ff7bb9623c32ed31284dad/pyproject.toml",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/pyproject.toml?ref=fe4459b95ccbd326c6ff7bb9623c32ed31284dad",
      "patch": "@@ -0,0 +1,38 @@\n+[build-system]\n+requires = [\"setuptools>=45\", \"setuptools_scm[toml]>=6.2\"]\n+build-backend = \"setuptools.build_meta\"\n+\n+[tool.ruff]\n+line-length = 127\n+target-version = \"py38\"\n+\n+[tool.ruff.lint]\n+# Enable pycodestyle (`E`) and Pyflakes (`F`) codes by default.\n+select = [\"E\", \"F\", \"W\"]\n+# Ignore E501 (line too long) and E402 (module level import not at top of file)\n+# to match the existing flake8 configuration\n+ignore = [\"E501\", \"E402\"]\n+\n+exclude = [\n+    \"docs/conf.py\",\n+    \"node_modules\",\n+    \".tox\",\n+    \".eggs\",\n+    \".git\",\n+    \"__pycache__\",\n+    \".pytest_cache\",\n+    \".mypy_cache\",\n+    \".ruff_cache\",\n+    \"build\",\n+    \"dist\",\n+]\n+\n+[tool.ruff.format]\n+# Use double quotes for strings.\n+quote-style = \"double\"\n+# Indent with spaces, rather than tabs.\n+indent-style = \"space\"\n+# Respect magic trailing commas.\n+skip-magic-trailing-comma = false\n+# Automatically detect the appropriate line ending.\n+line-ending = \"auto\""
    },
    {
      "sha": "06525a154045bbcad2fb487f5744596eed354bc3",
      "filename": "setup.cfg",
      "status": "removed",
      "additions": 0,
      "deletions": 3,
      "changes": 3,
      "blob_url": "https://github.com/isso-comments/isso/blob/009e2c9bd8534627780e69421541145aae8b2ccf/setup.cfg",
      "raw_url": "https://github.com/isso-comments/isso/raw/009e2c9bd8534627780e69421541145aae8b2ccf/setup.cfg",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/setup.cfg?ref=009e2c9bd8534627780e69421541145aae8b2ccf",
      "patch": "@@ -1,3 +0,0 @@\n-[flake8]\n-ignore = E501, E402\n-exclude = docs/conf.py,node_modules,.tox,.eggs,.git"
    }
  ]
}
