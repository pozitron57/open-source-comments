{
  "sha": "e3ee8fb4c0a135d077c6a55c7b0481226ed4bed9",
  "node_id": "C_kwDOAF-mA9oAKGUzZWU4ZmI0YzBhMTM1ZDA3N2M2YTU1YzdiMDQ4MTIyNmVkNGJlZDk",
  "commit": {
    "author": {
      "name": "ix5",
      "email": "ix5@users.noreply.github.com",
      "date": "2024-04-23T22:18:02Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2024-04-23T22:18:02Z"
    },
    "message": "Merge pull request #992 from pkvach/fix/handling-i18n-data-attribute-values\n\njs: config.js: Fix newline character handling in data-isso-* i18n strings",
    "tree": {
      "sha": "a4d3f85b5e2ddb5afcc73a892ed655d6e47b1de8",
      "url": "https://api.github.com/repos/isso-comments/isso/git/trees/a4d3f85b5e2ddb5afcc73a892ed655d6e47b1de8"
    },
    "url": "https://api.github.com/repos/isso-comments/isso/git/commits/e3ee8fb4c0a135d077c6a55c7b0481226ed4bed9",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsFcBAABCAAQBQJmKDOaCRC1aQ7uu5UhlAAAFAoQAHIBl2pVy3Rw++5L++kasLFo\nEgdWiUqPL3HDECsWs3bP6yrwJbKgDr8sq184cKS7ey2PTyVYUU06UNA/nQWk8XNa\nt4xvfQlcIl6bh5vTxFgu0QzQWPRJS6x69XtIh0Cl6OWj7U1PGbH2/5MkADuQey4z\nAEtJ8qspPUpe1KCzXeV7GahRR2NA8FylDZpjFMhorsUlcF7Gl8c+rxEwe1zve/uX\nSeFJts4V250s61ykneCUWrLzDVxs0+9EY8nmkQvxnw+i4mwf0vXShtTMPuzvV//i\nll5VRcFQcic3EVTnHDmlcmMxne9S87CVIgv+H8r+5rNpaxczGAA/DZ9kKr5m5OXn\n7Ppm4H/esQXlJ88goFT4Ery9/UzxMBv4MC16aF6U93pMA0Iql7h7UaMeX5SBnT2G\nIhrF7fEHNugq8wM0aQY9gSe3qVOcvoJOBYGPF4u+p9+4t7Z2w5/KhCtvX+Nk01oO\n/pCM0OGwDcrEz9nD0GyNJ28RxbXbdCbYrBZFqa6cJBRKEmCXfVRYPQ0oQwIEYMSw\n+7vCfex+0pYgzkuIS8421J4+o45m2iw5maO52MMH6u0y0chvOEt0DrZYt1i9JSdC\n5WA5tvz/zdYBmP8BsekSTNOknKAmCqIKdbRkMXV67iHwR111SQvpE/xh/A8PcuOG\nz1aEp6wZiIrtR5ETgdyB\n=Jqt7\n-----END PGP SIGNATURE-----\n",
      "payload": "tree a4d3f85b5e2ddb5afcc73a892ed655d6e47b1de8\nparent 0986104dfda4b2a26a02a7c581016042013fc257\nparent 953051b0621deab5d3f43770a260acfca5b639b4\nauthor ix5 <ix5@users.noreply.github.com> 1713910682 +0200\ncommitter GitHub <noreply@github.com> 1713910682 +0200\n\nMerge pull request #992 from pkvach/fix/handling-i18n-data-attribute-values\n\njs: config.js: Fix newline character handling in data-isso-* i18n strings"
    }
  },
  "url": "https://api.github.com/repos/isso-comments/isso/commits/e3ee8fb4c0a135d077c6a55c7b0481226ed4bed9",
  "html_url": "https://github.com/isso-comments/isso/commit/e3ee8fb4c0a135d077c6a55c7b0481226ed4bed9",
  "comments_url": "https://api.github.com/repos/isso-comments/isso/commits/e3ee8fb4c0a135d077c6a55c7b0481226ed4bed9/comments",
  "author": {
    "login": "ix5",
    "id": 10212877,
    "node_id": "MDQ6VXNlcjEwMjEyODc3",
    "avatar_url": "https://avatars.githubusercontent.com/u/10212877?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ix5",
    "html_url": "https://github.com/ix5",
    "followers_url": "https://api.github.com/users/ix5/followers",
    "following_url": "https://api.github.com/users/ix5/following{/other_user}",
    "gists_url": "https://api.github.com/users/ix5/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ix5/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ix5/subscriptions",
    "organizations_url": "https://api.github.com/users/ix5/orgs",
    "repos_url": "https://api.github.com/users/ix5/repos",
    "events_url": "https://api.github.com/users/ix5/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ix5/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "0986104dfda4b2a26a02a7c581016042013fc257",
      "url": "https://api.github.com/repos/isso-comments/isso/commits/0986104dfda4b2a26a02a7c581016042013fc257",
      "html_url": "https://github.com/isso-comments/isso/commit/0986104dfda4b2a26a02a7c581016042013fc257"
    },
    {
      "sha": "953051b0621deab5d3f43770a260acfca5b639b4",
      "url": "https://api.github.com/repos/isso-comments/isso/commits/953051b0621deab5d3f43770a260acfca5b639b4",
      "html_url": "https://github.com/isso-comments/isso/commit/953051b0621deab5d3f43770a260acfca5b639b4"
    }
  ],
  "stats": {
    "total": 58,
    "additions": 42,
    "deletions": 16
  },
  "files": [
    {
      "sha": "9997aad4183995fc531e64dc25546e7300873943",
      "filename": "CHANGES.rst",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/isso-comments/isso/blob/e3ee8fb4c0a135d077c6a55c7b0481226ed4bed9/CHANGES.rst",
      "raw_url": "https://github.com/isso-comments/isso/raw/e3ee8fb4c0a135d077c6a55c7b0481226ed4bed9/CHANGES.rst",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/CHANGES.rst?ref=e3ee8fb4c0a135d077c6a55c7b0481226ed4bed9",
      "patch": "@@ -15,8 +15,6 @@ New Features\n .. _#966: https://github.com/posativ/isso/pull/966\n .. _#998: https://github.com/isso-comments/isso/pull/998\n .. _#1000: https://github.com/isso-comments/isso/pull/1000\n-.. _#966: https://github.com/posativ/isso/pull/966\n-.. _#998: https://github.com/isso-comments/isso/pull/998\n .. _#1001: https://github.com/isso-comments/isso/pull/1001\n \n Breaking Changes\n@@ -34,6 +32,7 @@ Bugfixes & Improvements\n - Fix W3C Validation issues (`#999`_, pkvach)\n - Handle deleted comments in Disqus migration (`#994`_, pkvach)\n - Fix total comments count calculation (`#997`_, pkvach)\n+- Fix newline character handling in data-isso-* i18n strings (`#992`_, pkvach)\n \n .. _#951: https://github.com/posativ/isso/pull/951\n .. _#967: https://github.com/posativ/isso/pull/967\n@@ -42,6 +41,7 @@ Bugfixes & Improvements\n .. _#999: https://github.com/isso-comments/isso/pull/999\n .. _#994: https://github.com/isso-comments/isso/pull/994\n .. _#997: https://github.com/isso-comments/isso/pull/997\n+.. _#992: https://github.com/isso-comments/isso/pull/992\n \n 0.13.1.dev0 (2023-02-05)\n ------------------------"
    },
    {
      "sha": "4ce92fbbd06009006250c05caef8b6a14857be3d",
      "filename": "isso/js/app/config.js",
      "status": "modified",
      "additions": 17,
      "deletions": 14,
      "changes": 31,
      "blob_url": "https://github.com/isso-comments/isso/blob/e3ee8fb4c0a135d077c6a55c7b0481226ed4bed9/isso%2Fjs%2Fapp%2Fconfig.js",
      "raw_url": "https://github.com/isso-comments/isso/raw/e3ee8fb4c0a135d077c6a55c7b0481226ed4bed9/isso%2Fjs%2Fapp%2Fconfig.js",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fjs%2Fapp%2Fconfig.js?ref=e3ee8fb4c0a135d077c6a55c7b0481226ed4bed9",
      "patch": "@@ -16,22 +16,25 @@ for (var i = 0; i < js.length; i++) {\n     for (var j = 0; j < js[i].attributes.length; j++) {\n         var attr = js[i].attributes[j];\n         if (/^data-isso-/.test(attr.name)) {\n-            try {\n-                // Normalize underscores to dashes so that language-specific\n-                // strings can be caught better later on,\n-                // e.g. data-isso-postbox-text-text-PT_BR becomes\n-                // postbox-text-text-pt-br.\n-                // Also note that attr.name only gives lowercase strings as per\n-                // HTML spec, e.g. data-isso-FOO-Bar becomes foo-bar, but since\n-                // the test environment's jest-environment-jsdom seemingly does\n-                // not follow that convention, convert to lowercase here anyway.\n-                config[attr.name.substring(10)\n+\n+            // Normalize underscores to dashes so that language-specific\n+            // strings can be caught better later on, e.g.\n+            // data-isso-postbox-text-text-PT_BR becomes postbox-text-text-pt-br.\n+            // Also note that attr.name only gives lowercase strings as per HTML\n+            // spec, e.g. data-isso-FOO-Bar becomes foo-bar, but since the test\n+            // environment's jest-environment-jsdom seemingly does not follow\n+            // that convention, convert to lowercase here anyway.\n+            const attrName = attr.name.substring(10)\n                        .replace(/_/g, '-')\n-                       .toLowerCase()] = JSON.parse(attr.value);\n+                       .toLowerCase()\n+\n+            // Replace escaped newline characters in the attribute value with actual newline characters\n+            const attrValue = attr.value.replace(/\\\\n/g, '\\n');\n+\n+            try {\n+                config[attrName] = JSON.parse(attrValue);\n             } catch (ex) {\n-                config[attr.name.substring(10)\n-                       .replace(/_/g, '-')\n-                       .toLowerCase()] = attr.value;\n+                config[attrName] = attrValue;\n             }\n         }\n     }"
    },
    {
      "sha": "087249856fbb2c381ab54774d75a0824d6781927",
      "filename": "isso/js/tests/unit/config.test.js",
      "status": "modified",
      "additions": 23,
      "deletions": 0,
      "changes": 23,
      "blob_url": "https://github.com/isso-comments/isso/blob/e3ee8fb4c0a135d077c6a55c7b0481226ed4bed9/isso%2Fjs%2Ftests%2Funit%2Fconfig.test.js",
      "raw_url": "https://github.com/isso-comments/isso/raw/e3ee8fb4c0a135d077c6a55c7b0481226ed4bed9/isso%2Fjs%2Ftests%2Funit%2Fconfig.test.js",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fjs%2Ftests%2Funit%2Fconfig.test.js?ref=e3ee8fb4c0a135d077c6a55c7b0481226ed4bed9",
      "patch": "@@ -9,6 +9,11 @@\n \n \"use strict\";\n \n+beforeEach(() => {\n+  jest.resetModules();\n+  document.body.innerHTML = '';\n+});\n+\n test(\"Client configuration - no languages\", () => {\n   // Mock navigator.languages = []\n   global.languages = jest.spyOn(navigator, \"languages\", \"get\")\n@@ -35,3 +40,21 @@ test(\"Client configuration - no languages\", () => {\n \n   expect(config[\"langs\"]).toStrictEqual(expected_langs);\n });\n+\n+test(\"data-isso-* i18n strings should be accepted with newline characters\", () => {\n+\n+  document.body.innerHTML =\n+      '<div id=isso-thread></div>' +\n+      // Note: `src` and `data-isso` need to be set,\n+      // else `api` fails to initialize!\n+      '<script src=\"http://isso.api/js/embed.min.js\"'\n+      + ' data-isso=\"/\"'\n+      + '</script>';\n+\n+  var script_tag = document.getElementsByTagName('script')[0];\n+  script_tag.setAttributeNS(null, 'data-isso-num-comments-text-en', \"One comment\\\\n{{ n }} comments\");\n+\n+  const config = require(\"app/config\");\n+\n+  expect(config['num-comments-text-en']).toMatch(\"One comment\\n{{ n }} comments\");\n+});"
    }
  ]
}
