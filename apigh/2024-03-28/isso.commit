{
  "sha": "6dffaa74f1184280f45a8bf64730f3d153c74b05",
  "node_id": "C_kwDOAF-mA9oAKDZkZmZhYTc0ZjExODQyODBmNDVhOGJmNjQ3MzBmM2QxNTNjNzRiMDU",
  "commit": {
    "author": {
      "name": "Pavel Kvach",
      "email": "pavel.kvach@gmail.com",
      "date": "2024-03-18T19:28:23Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2024-03-18T19:28:23Z"
    },
    "message": "isso: migrate: Handle deleted comments in Disqus migration (#994)\n\n* isso: migrate: Handle deleted comments in Disqus migration\r\n\r\nFixes https://github.com/posativ/isso/issues/979",
    "tree": {
      "sha": "506f1f40d5b9fdc59e18e221126d9bd3dc5a290a",
      "url": "https://api.github.com/repos/isso-comments/isso/git/trees/506f1f40d5b9fdc59e18e221126d9bd3dc5a290a"
    },
    "url": "https://api.github.com/repos/isso-comments/isso/git/commits/6dffaa74f1184280f45a8bf64730f3d153c74b05",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsFcBAABCAAQBQJl+JXXCRC1aQ7uu5UhlAAAf1oQAGMz55gWdUeH/uMQFOL7JUxF\nhqiB6JnLnAAdfM2BFq4Li05lN2ep/iUBJOiaaqALjyBz7okOQJPaFq8r0ndfRiVE\nlgh7hUjfx9mbFnbqoESJLaNXHYlFxpNBGzng6hck+gnNwYk8bFPzBjCNCo0r6Xof\nhSClLAYp7688Y1Y/dRhBFbnp5bkjxx4ikGcPRTG4578xNsYFOOgAoFFFaK9DBABS\n8TGPaqw51y4plthPVwvbzyuN8ewAHKp2erqgiUVgPyhoQdyPu7dbuyY7J24Miv2N\nvsD8mT25une7OfaJB0go+LNjCEuL8iiZ29Y0FsQ8PJnbZ1+8oElrpGQfLz00BIrN\neAe9DG6Izns87gsh+fYNNcFbgL1xLA6+Rpaqeq5KlcTmePe3qIp5TX7N5IHoQEKR\nyeGQVcGHiqPvIp3iAQRGF2lB4jPxjgs20JVAgcHw1f5z2ta/HSRoKUYUHcIbw7b/\nyH0fxjWLcN59RRCUkV90WSsxPNMYgHvnoPbtFW5Gk4aCkA7NlATx9sSmhDDhaqlk\nsyW6hqpozQCPVPOs/ENyMHBjx21CH+DFyasJZih9SUj+fI6Oa0OpwVbBHcoD+1qH\nhIGYrLTVTubIsbx9kvWK2YK3TmaZYwPCSpzxWaIB3fE6YYSKcrX/EOvNPzw988ty\nubr/ThFUxK7KHevVViHR\n=GOdS\n-----END PGP SIGNATURE-----\n",
      "payload": "tree 506f1f40d5b9fdc59e18e221126d9bd3dc5a290a\nparent 50642b10d1479080616add7fde13702f9f4411ae\nauthor Pavel Kvach <pavel.kvach@gmail.com> 1710790103 +0200\ncommitter GitHub <noreply@github.com> 1710790103 +0000\n\nisso: migrate: Handle deleted comments in Disqus migration (#994)\n\n* isso: migrate: Handle deleted comments in Disqus migration\r\n\r\nFixes https://github.com/posativ/isso/issues/979"
    }
  },
  "url": "https://api.github.com/repos/isso-comments/isso/commits/6dffaa74f1184280f45a8bf64730f3d153c74b05",
  "html_url": "https://github.com/isso-comments/isso/commit/6dffaa74f1184280f45a8bf64730f3d153c74b05",
  "comments_url": "https://api.github.com/repos/isso-comments/isso/commits/6dffaa74f1184280f45a8bf64730f3d153c74b05/comments",
  "author": {
    "login": "pkvach",
    "id": 5307506,
    "node_id": "MDQ6VXNlcjUzMDc1MDY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5307506?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pkvach",
    "html_url": "https://github.com/pkvach",
    "followers_url": "https://api.github.com/users/pkvach/followers",
    "following_url": "https://api.github.com/users/pkvach/following{/other_user}",
    "gists_url": "https://api.github.com/users/pkvach/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pkvach/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pkvach/subscriptions",
    "organizations_url": "https://api.github.com/users/pkvach/orgs",
    "repos_url": "https://api.github.com/users/pkvach/repos",
    "events_url": "https://api.github.com/users/pkvach/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pkvach/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "50642b10d1479080616add7fde13702f9f4411ae",
      "url": "https://api.github.com/repos/isso-comments/isso/commits/50642b10d1479080616add7fde13702f9f4411ae",
      "html_url": "https://github.com/isso-comments/isso/commit/50642b10d1479080616add7fde13702f9f4411ae"
    }
  ],
  "stats": {
    "total": 51,
    "additions": 46,
    "deletions": 5
  },
  "files": [
    {
      "sha": "718368a995d600698ca95625a747517f8f52eb4a",
      "filename": "CHANGES.rst",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/isso-comments/isso/blob/6dffaa74f1184280f45a8bf64730f3d153c74b05/CHANGES.rst",
      "raw_url": "https://github.com/isso-comments/isso/raw/6dffaa74f1184280f45a8bf64730f3d153c74b05/CHANGES.rst",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/CHANGES.rst?ref=6dffaa74f1184280f45a8bf64730f3d153c74b05",
      "patch": "@@ -26,12 +26,14 @@ Bugfixes & Improvements\n - Make language code handling more robust (`#983`_, ix5)\n - Prevent auto creation of invalid links in comments (`#995`_, pkvach)\n - Fix W3C Validation issues (`#999`_, pkvach)\n+- Handle deleted comments in Disqus migration (`#994`_, pkvach)\n \n .. _#951: https://github.com/posativ/isso/pull/951\n .. _#967: https://github.com/posativ/isso/pull/967\n .. _#983: https://github.com/posativ/isso/pull/983\n .. _#995: https://github.com/isso-comments/isso/pull/995\n .. _#999: https://github.com/isso-comments/isso/pull/999\n+.. _#994: https://github.com/isso-comments/isso/pull/994\n \n 0.13.1.dev0 (2023-02-05)\n ------------------------"
    },
    {
      "sha": "9bed6f0b522eadfd3a7da7538ae4738766961c1b",
      "filename": "isso/db/comments.py",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/isso-comments/isso/blob/6dffaa74f1184280f45a8bf64730f3d153c74b05/isso%2Fdb%2Fcomments.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/6dffaa74f1184280f45a8bf64730f3d153c74b05/isso%2Fdb%2Fcomments.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fdb%2Fcomments.py?ref=6dffaa74f1184280f45a8bf64730f3d153c74b05",
      "patch": "@@ -38,7 +38,7 @@ def __init__(self, db):\n             'CREATE TABLE IF NOT EXISTS comments (',\n             '    tid REFERENCES threads(id), id INTEGER PRIMARY KEY, parent INTEGER,',\n             '    created FLOAT NOT NULL, modified FLOAT, mode INTEGER, remote_addr VARCHAR,',\n-            '    text VARCHAR, author VARCHAR, email VARCHAR, website VARCHAR,',\n+            '    text VARCHAR NOT NULL, author VARCHAR, email VARCHAR, website VARCHAR,',\n             '    likes INTEGER DEFAULT 0, dislikes INTEGER DEFAULT 0, voters BLOB NOT NULL,',\n             '    notification INTEGER DEFAULT 0);'])\n         try:"
    },
    {
      "sha": "5123c4327e2526f818b4c59c011cd79e05918e57",
      "filename": "isso/migrate.py",
      "status": "modified",
      "additions": 5,
      "deletions": 2,
      "changes": 7,
      "blob_url": "https://github.com/isso-comments/isso/blob/6dffaa74f1184280f45a8bf64730f3d153c74b05/isso%2Fmigrate.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/6dffaa74f1184280f45a8bf64730f3d153c74b05/isso%2Fmigrate.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fmigrate.py?ref=6dffaa74f1184280f45a8bf64730f3d153c74b05",
      "patch": "@@ -92,10 +92,11 @@ def migrate(self):\n         for post in tree.findall(Disqus.ns + 'post'):\n             email = post.find('{0}author/{0}email'.format(Disqus.ns))\n             ip = post.find(Disqus.ns + 'ipAddress')\n+            comment_text = post.find(Disqus.ns + 'message').text or ''\n \n             item = {\n                 'dsq:id': post.attrib.get(Disqus.internals + 'id'),\n-                'text': post.find(Disqus.ns + 'message').text,\n+                'text': comment_text,\n                 'author': post.find('{0}author/{0}name'.format(Disqus.ns)).text,\n                 'email': email.text if email is not None else '',\n                 'created': mktime(strptime(\n@@ -146,11 +147,13 @@ def migrate(self):\n                     continue\n \n                 email = post.find(\"{0}author/{0}email\".format(Disqus.ns))\n+                comment_text = post.find(Disqus.ns + 'message').text or ''\n+\n                 print(\" * {0} by {1} <{2}>\".format(\n                     post.attrib.get(Disqus.internals + \"id\"),\n                     post.find(\"{0}author/{0}name\".format(Disqus.ns)).text,\n                     email.text if email is not None else \"\"))\n-                print(textwrap.fill(post.find(Disqus.ns + \"message\").text,\n+                print(textwrap.fill(comment_text,\n                                     initial_indent=\"  \", subsequent_indent=\"  \"))\n                 print(\"\")\n "
    },
    {
      "sha": "d8d09740c9d57053b40d396ae8547472a614fc91",
      "filename": "isso/tests/disqus.xml",
      "status": "modified",
      "additions": 33,
      "deletions": 0,
      "changes": 33,
      "blob_url": "https://github.com/isso-comments/isso/blob/6dffaa74f1184280f45a8bf64730f3d153c74b05/isso%2Ftests%2Fdisqus.xml",
      "raw_url": "https://github.com/isso-comments/isso/raw/6dffaa74f1184280f45a8bf64730f3d153c74b05/isso%2Ftests%2Fdisqus.xml",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Ftests%2Fdisqus.xml?ref=6dffaa74f1184280f45a8bf64730f3d153c74b05",
      "patch": "@@ -113,4 +113,37 @@\n         <thread dsq:id=\"7\" />\n     </post>\n \n+    <!-- deleted post -->\n+    <post dsq:id=\"9\">\n+        <id/>\n+        <message/>\n+        <createdAt>2013-10-10T19:20:29Z</createdAt>\n+        <isDeleted>true</isDeleted>\n+        <isSpam>false</isSpam>\n+        <author>\n+            <email>foo@bar.com</email>\n+            <name>peter</name>\n+            <isAnonymous>true</isAnonymous>\n+        </author>\n+        <ipAddress>127.0.0.1</ipAddress>\n+        <thread dsq:id=\"2\" />\n+    </post>\n+\n+    <!-- reference to previous deleted post -->\n+    <post dsq:id=\"11\">\n+        <message><![CDATA[<p>Hello, World.</p>]]></message>\n+        <createdAt>2013-10-11T06:52:33Z</createdAt>\n+        <isDeleted>false</isDeleted>\n+        <isSpam>false</isSpam>\n+        <author>\n+            <email>foo@bar.com</email>\n+            <name>user</name>\n+            <isAnonymous>false</isAnonymous>\n+            <username>user</username>\n+        </author>\n+        <ipAddress>127.0.0.1</ipAddress>\n+        <thread dsq:id=\"2\" />\n+        <parent dsq:id=\"9\" />\n+    </post>\n+\n   </disqus>"
    },
    {
      "sha": "78fc6844307ab02e079cfd23adb772c2fc2363ba",
      "filename": "isso/tests/test_migration.py",
      "status": "modified",
      "additions": 5,
      "deletions": 2,
      "changes": 7,
      "blob_url": "https://github.com/isso-comments/isso/blob/6dffaa74f1184280f45a8bf64730f3d153c74b05/isso%2Ftests%2Ftest_migration.py",
      "raw_url": "https://github.com/isso-comments/isso/raw/6dffaa74f1184280f45a8bf64730f3d153c74b05/isso%2Ftests%2Ftest_migration.py",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Ftests%2Ftest_migration.py?ref=6dffaa74f1184280f45a8bf64730f3d153c74b05",
      "patch": "@@ -56,7 +56,7 @@ def test_disqus_empty_id_workaround(self):\n         Disqus(db, xml, empty_id=True).migrate()\n \n         self.assertEqual(\n-            len(db.execute(\"SELECT id FROM comments\").fetchall()), 3)\n+            len(db.execute(\"SELECT id FROM comments\").fetchall()), 5)\n \n         self.assertEqual(db.threads[\"/\"][\"title\"], \"Hello, World!\")\n         self.assertEqual(db.threads[\"/\"][\"id\"], 1)\n@@ -67,9 +67,12 @@ def test_disqus_empty_id_workaround(self):\n         self.assertEqual(a[\"email\"], \"foo@bar.com\")\n         self.assertEqual(a[\"remote_addr\"], \"127.0.0.0\")\n \n-        b = db.comments.get(2)\n+        b = db.comments.get(3)\n         self.assertEqual(b[\"parent\"], a[\"id\"])\n \n+        deleted_comment = db.comments.get(2)\n+        self.assertEqual(deleted_comment[\"text\"], \"\")\n+\n     def test_wordpress(self):\n \n         xml = join(dirname(__file__), \"wordpress.xml\")"
    }
  ]
}
