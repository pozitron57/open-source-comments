{
  "sha": "ac9fb0d38e5ede5f8efbf408a012086a40f244b9",
  "node_id": "C_kwDOAF-mA9oAKGFjOWZiMGQzOGU1ZWRlNWY4ZWZiZjQwOGEwMTIwODZhNDBmMjQ0Yjk",
  "commit": {
    "author": {
      "name": "ix5",
      "email": "ix5@users.noreply.github.com",
      "date": "2024-04-29T00:28:44Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2024-04-29T00:28:44Z"
    },
    "message": "Merge pull request #1021 from ix5/fix/ci\n\nDocker, CI: Make JS integration tests more robust; update screenshots",
    "tree": {
      "sha": "b9807de5f13b6d277e39c8c54bee31fc0ef825df",
      "url": "https://api.github.com/repos/isso-comments/isso/git/trees/b9807de5f13b6d277e39c8c54bee31fc0ef825df"
    },
    "url": "https://api.github.com/repos/isso-comments/isso/git/commits/ac9fb0d38e5ede5f8efbf408a012086a40f244b9",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsFcBAABCAAQBQJmLum8CRC1aQ7uu5UhlAAAkjcQABaC0EODbduDFMcuj1idDbe1\n1fiOvDRAvjqIqaipy5hUGk1GcBSlhQsrWdNcVWUuKX5l5AeRZn61I7WTpeSmqt6T\nov/qVwNFh3aTX08/+/rl9u5T68h4chF1oorLNuOzjLQkvcRc9movy55Gsj4vcGJM\nLsJ054sronRAsyoWu8e9oy0sZ7xJYSdwDF7H3fcv6imyI02KCbe3iINuKgzkJNlD\nm14+F83PxWONHgbk2jwqzm/lvq6aypKGHqK6U/LsIdTgoEi7fxS4qPn324zb1vT1\nggaD0Wqv7oaNpZM8I7WkixX4SzbugXiN5Awd/mM55NMC/8Yj22idjRWVfVRGHtMi\nT0WP1Jra7GQJkpFH6smvO5P540/wLATYq0uR091/A+lGtz8N3uApccN+5P9McAhq\nTOLwYLyRcd2a2/GGygoGfkbwu86QUVj8BkYeUtuFvfl+8WuR8/fwG4enN3My/H3a\npdg90cFt+smTkpzaED3vb0/47aw8jlxN6tNyQx3CXymPtLTPL4VnhCNcIGr5CQxq\nBiqw6ebCaKSdaadCkO4FE4WoLEG5LtIYJZjZ/wJz+gb20Z27D5zFGkmSobsL5fhv\nLQpvnPoUJh8jtkz9TnZPPmFRPvDUakGa7C5ZAsFv4wvEuZHhhZv9WWdftErbo0p3\nBgyMIQIF0bNdrCNX4erU\n=I5HJ\n-----END PGP SIGNATURE-----\n",
      "payload": "tree b9807de5f13b6d277e39c8c54bee31fc0ef825df\nparent dc114345a7b3f55616157c8a69405c848d9c05b4\nparent 265d8e6aaa326ac1bdc024aec534eb2129328113\nauthor ix5 <ix5@users.noreply.github.com> 1714350524 +0200\ncommitter GitHub <noreply@github.com> 1714350524 +0200\n\nMerge pull request #1021 from ix5/fix/ci\n\nDocker, CI: Make JS integration tests more robust; update screenshots"
    }
  },
  "url": "https://api.github.com/repos/isso-comments/isso/commits/ac9fb0d38e5ede5f8efbf408a012086a40f244b9",
  "html_url": "https://github.com/isso-comments/isso/commit/ac9fb0d38e5ede5f8efbf408a012086a40f244b9",
  "comments_url": "https://api.github.com/repos/isso-comments/isso/commits/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/comments",
  "author": {
    "login": "ix5",
    "id": 10212877,
    "node_id": "MDQ6VXNlcjEwMjEyODc3",
    "avatar_url": "https://avatars.githubusercontent.com/u/10212877?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ix5",
    "html_url": "https://github.com/ix5",
    "followers_url": "https://api.github.com/users/ix5/followers",
    "following_url": "https://api.github.com/users/ix5/following{/other_user}",
    "gists_url": "https://api.github.com/users/ix5/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ix5/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ix5/subscriptions",
    "organizations_url": "https://api.github.com/users/ix5/orgs",
    "repos_url": "https://api.github.com/users/ix5/repos",
    "events_url": "https://api.github.com/users/ix5/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ix5/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "dc114345a7b3f55616157c8a69405c848d9c05b4",
      "url": "https://api.github.com/repos/isso-comments/isso/commits/dc114345a7b3f55616157c8a69405c848d9c05b4",
      "html_url": "https://github.com/isso-comments/isso/commit/dc114345a7b3f55616157c8a69405c848d9c05b4"
    },
    {
      "sha": "265d8e6aaa326ac1bdc024aec534eb2129328113",
      "url": "https://api.github.com/repos/isso-comments/isso/commits/265d8e6aaa326ac1bdc024aec534eb2129328113",
      "html_url": "https://github.com/isso-comments/isso/commit/265d8e6aaa326ac1bdc024aec534eb2129328113"
    }
  ],
  "stats": {
    "total": 83,
    "additions": 69,
    "deletions": 14
  },
  "files": [
    {
      "sha": "fd39eeedca40be347792e0ec7250e56dc59cc0d8",
      "filename": ".github/workflows/docker-testbed-periodic-rebuild.yaml",
      "status": "added",
      "additions": 48,
      "deletions": 0,
      "changes": 48,
      "blob_url": "https://github.com/isso-comments/isso/blob/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/.github%2Fworkflows%2Fdocker-testbed-periodic-rebuild.yaml",
      "raw_url": "https://github.com/isso-comments/isso/raw/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/.github%2Fworkflows%2Fdocker-testbed-periodic-rebuild.yaml",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/.github%2Fworkflows%2Fdocker-testbed-periodic-rebuild.yaml?ref=ac9fb0d38e5ede5f8efbf408a012086a40f244b9",
      "patch": "@@ -0,0 +1,48 @@\n+name: Rebuild js testbed image\n+\n+on:\n+  workflow_dispatch:\n+  schedule:\n+    # Run weekly, at 2:15pm on Monday (chosen at random)\n+    # https://cron.help/#15_14_*_*_1\n+    - cron: '15 14 * * 1'\n+\n+env:\n+  build_platforms: ${{ vars.BUILD_PLATFORMS || 'linux/amd64' }}\n+  build_image: ${{ vars.BUILD_IMAGE || 'ghcr.io/isso-comments/isso-js-testbed' }}\n+\n+jobs:\n+  build:\n+    runs-on: ubuntu-latest\n+    permissions:\n+      packages: write\n+    steps:\n+      - name: Checkout\n+        uses: actions/checkout@v3\n+\n+      - name: Docker meta\n+        id: meta\n+        uses: docker/metadata-action@v4\n+        with:\n+          flavor: |\n+            latest=false\n+          images: ${{ env.build_image }}\n+          tags: |\n+            type=raw,value=latest,enable={{is_default_branch}}\n+\n+      - name: Login to Github Container Registry\n+        if: github.event_name != 'pull_request'\n+        uses: docker/login-action@v2\n+        with:\n+          registry: ghcr.io\n+          username: ${{ github.actor }}\n+          password: ${{ secrets.GITHUB_TOKEN }}\n+\n+      - name: Set up Docker Buildx\n+        uses: docker/setup-buildx-action@v2\n+\n+      - name: Build docker-js-testbed\n+        run: make docker-testbed\n+\n+      - name: Push docker-js-testbed image as ${{ env.build_image }}\n+        run: make docker-testbed-push"
    },
    {
      "sha": "0a45ef7dd7dce54bec2db100bdd5bb6cf160e665",
      "filename": ".github/workflows/e2e-tests.yml",
      "status": "modified",
      "additions": 5,
      "deletions": 3,
      "changes": 8,
      "blob_url": "https://github.com/isso-comments/isso/blob/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/.github%2Fworkflows%2Fe2e-tests.yml",
      "raw_url": "https://github.com/isso-comments/isso/raw/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/.github%2Fworkflows%2Fe2e-tests.yml",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/.github%2Fworkflows%2Fe2e-tests.yml?ref=ac9fb0d38e5ede5f8efbf408a012086a40f244b9",
      "patch": "@@ -41,14 +41,16 @@ jobs:\n         run: docker compose build isso-server\n \n       - name: Bring up containers\n+        # Don't wait for healthcheck via --wait. This would fail with a\n+        # negative exit code since the isso-client container is expected to\n+        # exit\n         run: docker compose up -d\n \n       - name: Client unit tests\n         run: make docker-js-unit\n \n-      - name: Check if containers are up, sleep if not\n-        shell: bash\n-        run: '[ \"$(docker inspect --format={{.State.Health.Status}} isso-server)\" = \"healthy\" ] || sleep 5'\n+      - name: Wait for isso-server container to be ready\n+        run: 'for i in $(seq 1 30); do [ \"`docker inspect -f {{.State.Health.Status}} isso-server`\" == \"healthy\" ] && s=0 && break || s=$? && sleep 0.3; done; (exit $s)'\n \n       - name: Client integration tests\n         run: make docker-js-integration"
    },
    {
      "sha": "fc36eef2932f9a65a4ffb2d0b732e35096fdb7d2",
      "filename": "docker-compose.yml",
      "status": "modified",
      "additions": 11,
      "deletions": 6,
      "changes": 17,
      "blob_url": "https://github.com/isso-comments/isso/blob/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/docker-compose.yml",
      "raw_url": "https://github.com/isso-comments/isso/raw/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/docker-compose.yml",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/docker-compose.yml?ref=ac9fb0d38e5ede5f8efbf408a012086a40f244b9",
      "patch": "@@ -14,17 +14,20 @@ services:\n     #command: /isso/bin/isso -c /config/isso.cfg run\n     environment:\n       ISSO_SETTINGS: \"/config/isso-dev.cfg\"\n+      ISSO_ENDPOINT: \"http://isso-dev.local:8080\"\n     healthcheck:\n-      test: wget --no-verbose --tries=1 --spider http://localhost:8080/info || exit 1\n-      interval: 5s  # short timeout needed during start phase\n-      retries: 3\n-      start_period: 5s\n-      timeout: 3s\n+      # Double $$ for parsing vars inside CMD: https://stackoverflow.com/a/54989793\n+      # Debug with 'docker inspect --format \"{{json .State.Health }}\" isso-server | jq'\n+      test: wget --no-verbose --tries=1 --spider $$ISSO_ENDPOINT/info || exit 1\n+      interval: 1s  # time before first check and between subsequent checks\n+      retries: 10\n+      start_period: 10s\n+      timeout: 10s\n     # If needed, production docker image can also be exposed to host for\n     # non-docker unit/integration testing\n     ports:\n       - 127.0.0.1:8080:8080\n-    # Expose port 80080 to other containerized services, not to host machine:\n+    # Expose port 8080 to other containerized services, not to host machine:\n     expose:\n       - 8080\n     networks:\n@@ -49,6 +52,8 @@ services:\n       dockerfile: docker/Dockerfile-js-testbed\n     environment:\n       ISSO_ENDPOINT: \"http://isso-dev.local:8080\"\n+    healthcheck:\n+      disable: true\n     # Command may also run from outside docker compose, e.g.:\n     # $ docker run isso-js-testbed [mount, networks, ...] npm run test-integration\n     #command: npm run test-integration"
    },
    {
      "sha": "f8b05f59c6275646b79d58b0022b860954fa9889",
      "filename": "docker/Dockerfile-js-testbed",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/isso-comments/isso/blob/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/docker%2FDockerfile-js-testbed",
      "raw_url": "https://github.com/isso-comments/isso/raw/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/docker%2FDockerfile-js-testbed",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/docker%2FDockerfile-js-testbed?ref=ac9fb0d38e5ede5f8efbf408a012086a40f244b9",
      "patch": "@@ -3,9 +3,9 @@\n \n # Note: Do not use alpine images as they do not contain needed GObject, X11\n # etc. packages and complicate things\n-# :current resolves to NodeJS 17 on Debian Buster as of 03/2022\n+# :22-bookworm resolves to NodeJS 22 on Debian Bookworm as of 04/2024\n # https://hub.docker.com/_/node\n-FROM docker.io/node:current AS isso-js-testbed\n+FROM docker.io/node:22-bookworm AS isso-js-testbed\n WORKDIR /src/\n \n # Install everything necessary to run headless"
    },
    {
      "sha": "6d803c90fc4e07229b3f9d9953ee3aaa155ff32b",
      "filename": "isso/js/tests/screenshots/reference/comment.png",
      "status": "modified",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "blob_url": "https://github.com/isso-comments/isso/blob/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/isso%2Fjs%2Ftests%2Fscreenshots%2Freference%2Fcomment.png",
      "raw_url": "https://github.com/isso-comments/isso/raw/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/isso%2Fjs%2Ftests%2Fscreenshots%2Freference%2Fcomment.png",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fjs%2Ftests%2Fscreenshots%2Freference%2Fcomment.png?ref=ac9fb0d38e5ede5f8efbf408a012086a40f244b9"
    },
    {
      "sha": "752dd02593158ce48b83416e75cf7c2ffad8570b",
      "filename": "isso/js/tests/screenshots/reference/comment.png.hash",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/isso-comments/isso/blob/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/isso%2Fjs%2Ftests%2Fscreenshots%2Freference%2Fcomment.png.hash",
      "raw_url": "https://github.com/isso-comments/isso/raw/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/isso%2Fjs%2Ftests%2Fscreenshots%2Freference%2Fcomment.png.hash",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fjs%2Ftests%2Fscreenshots%2Freference%2Fcomment.png.hash?ref=ac9fb0d38e5ede5f8efbf408a012086a40f244b9",
      "patch": "@@ -1 +1 @@\n-065f2dfac1c6bc174c8406e574f8890d3bb867b13407809eb9aec184f97c172d\n+56314990cb566160044f46033a7bd0c4d8be5bb41afa44fa54cf156aed21bbe3"
    },
    {
      "sha": "d1ddd13090f3da721dd0d42cb0e2ff10dae71976",
      "filename": "isso/js/tests/screenshots/reference/postbox.png",
      "status": "modified",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "blob_url": "https://github.com/isso-comments/isso/blob/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/isso%2Fjs%2Ftests%2Fscreenshots%2Freference%2Fpostbox.png",
      "raw_url": "https://github.com/isso-comments/isso/raw/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/isso%2Fjs%2Ftests%2Fscreenshots%2Freference%2Fpostbox.png",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fjs%2Ftests%2Fscreenshots%2Freference%2Fpostbox.png?ref=ac9fb0d38e5ede5f8efbf408a012086a40f244b9"
    },
    {
      "sha": "1fb65ad8534b40c8b4074dce02e28bb155ec4342",
      "filename": "isso/js/tests/screenshots/reference/postbox.png.hash",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/isso-comments/isso/blob/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/isso%2Fjs%2Ftests%2Fscreenshots%2Freference%2Fpostbox.png.hash",
      "raw_url": "https://github.com/isso-comments/isso/raw/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/isso%2Fjs%2Ftests%2Fscreenshots%2Freference%2Fpostbox.png.hash",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fjs%2Ftests%2Fscreenshots%2Freference%2Fpostbox.png.hash?ref=ac9fb0d38e5ede5f8efbf408a012086a40f244b9",
      "patch": "@@ -1 +1 @@\n-0eb72a0e3faaf65c373383e9cfe9359de37e31c7f0e6e38c2b2369eb85f0eba4\n+a218440951dbc7312118647c955d0d4480fc46bb6dddd72e0d9459744b471f32"
    },
    {
      "sha": "4e4a02f34a50b61985beba3429ff1d484592e405",
      "filename": "isso/js/tests/screenshots/reference/thread.png",
      "status": "modified",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "blob_url": "https://github.com/isso-comments/isso/blob/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/isso%2Fjs%2Ftests%2Fscreenshots%2Freference%2Fthread.png",
      "raw_url": "https://github.com/isso-comments/isso/raw/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/isso%2Fjs%2Ftests%2Fscreenshots%2Freference%2Fthread.png",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fjs%2Ftests%2Fscreenshots%2Freference%2Fthread.png?ref=ac9fb0d38e5ede5f8efbf408a012086a40f244b9"
    },
    {
      "sha": "d793091e55b4dd69b566d676af6d4fc6d1e3b967",
      "filename": "isso/js/tests/screenshots/reference/thread.png.hash",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/isso-comments/isso/blob/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/isso%2Fjs%2Ftests%2Fscreenshots%2Freference%2Fthread.png.hash",
      "raw_url": "https://github.com/isso-comments/isso/raw/ac9fb0d38e5ede5f8efbf408a012086a40f244b9/isso%2Fjs%2Ftests%2Fscreenshots%2Freference%2Fthread.png.hash",
      "contents_url": "https://api.github.com/repos/isso-comments/isso/contents/isso%2Fjs%2Ftests%2Fscreenshots%2Freference%2Fthread.png.hash?ref=ac9fb0d38e5ede5f8efbf408a012086a40f244b9",
      "patch": "@@ -1 +1 @@\n-3185d06957e792d48d28b47c3e2c7e89353aa8d70757d4c92890d38850a66e54\n+78ea677962d3f80607995d9b88d81df2b7787832023cb7f1d64811829d0fc10a"
    }
  ]
}
