{
  "sha": "cf7d74ab86c82eee65ae3027f9d84d87405c4d1b",
  "node_id": "C_kwDOCQOkhNoAKGNmN2Q3NGFiODZjODJlZWU2NWFlMzAyN2Y5ZDg0ZDg3NDA1YzRkMWI",
  "commit": {
    "author": {
      "name": "qwqcode",
      "email": "qwqcode@gmail.com",
      "date": "2024-05-30T11:39:03Z"
    },
    "committer": {
      "name": "qwqcode",
      "email": "qwqcode@gmail.com",
      "date": "2024-05-30T11:39:03Z"
    },
    "message": "fix(plugin_katex): fix event issue causing katex integration failure (#897)",
    "tree": {
      "sha": "1baa07ef65d3e0f4b0cdbde6b2ca97bee3eb80dc",
      "url": "https://api.github.com/repos/ArtalkJS/Artalk/git/trees/1baa07ef65d3e0f4b0cdbde6b2ca97bee3eb80dc"
    },
    "url": "https://api.github.com/repos/ArtalkJS/Artalk/git/commits/cf7d74ab86c82eee65ae3027f9d84d87405c4d1b",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\niHUEABYIAB0WIQS0Ev3sdPZbHkWwzmLUbg8O6nwTagUCZlhlVwAKCRDUbg8O6nwT\navIzAQDPVm33sAgdVEpwoJuLF8p3FB6I7B8vLF+7KGqf567EeAD/QlW3fJztZNxU\nZ3awKRa+Iug8EdMMi+xKWRrh8pXs1AM=\n=cXO/\n-----END PGP SIGNATURE-----",
      "payload": "tree 1baa07ef65d3e0f4b0cdbde6b2ca97bee3eb80dc\nparent a0b0a3386201319b9b23c3eee591c7c79476822e\nauthor qwqcode <qwqcode@gmail.com> 1717069143 +0800\ncommitter qwqcode <qwqcode@gmail.com> 1717069143 +0800\n\nfix(plugin_katex): fix event issue causing katex integration failure (#897)\n"
    }
  },
  "url": "https://api.github.com/repos/ArtalkJS/Artalk/commits/cf7d74ab86c82eee65ae3027f9d84d87405c4d1b",
  "html_url": "https://github.com/ArtalkJS/Artalk/commit/cf7d74ab86c82eee65ae3027f9d84d87405c4d1b",
  "comments_url": "https://api.github.com/repos/ArtalkJS/Artalk/commits/cf7d74ab86c82eee65ae3027f9d84d87405c4d1b/comments",
  "author": {
    "login": "qwqcode",
    "id": 22412567,
    "node_id": "MDQ6VXNlcjIyNDEyNTY3",
    "avatar_url": "https://avatars.githubusercontent.com/u/22412567?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/qwqcode",
    "html_url": "https://github.com/qwqcode",
    "followers_url": "https://api.github.com/users/qwqcode/followers",
    "following_url": "https://api.github.com/users/qwqcode/following{/other_user}",
    "gists_url": "https://api.github.com/users/qwqcode/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/qwqcode/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/qwqcode/subscriptions",
    "organizations_url": "https://api.github.com/users/qwqcode/orgs",
    "repos_url": "https://api.github.com/users/qwqcode/repos",
    "events_url": "https://api.github.com/users/qwqcode/events{/privacy}",
    "received_events_url": "https://api.github.com/users/qwqcode/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "qwqcode",
    "id": 22412567,
    "node_id": "MDQ6VXNlcjIyNDEyNTY3",
    "avatar_url": "https://avatars.githubusercontent.com/u/22412567?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/qwqcode",
    "html_url": "https://github.com/qwqcode",
    "followers_url": "https://api.github.com/users/qwqcode/followers",
    "following_url": "https://api.github.com/users/qwqcode/following{/other_user}",
    "gists_url": "https://api.github.com/users/qwqcode/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/qwqcode/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/qwqcode/subscriptions",
    "organizations_url": "https://api.github.com/users/qwqcode/orgs",
    "repos_url": "https://api.github.com/users/qwqcode/repos",
    "events_url": "https://api.github.com/users/qwqcode/events{/privacy}",
    "received_events_url": "https://api.github.com/users/qwqcode/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "a0b0a3386201319b9b23c3eee591c7c79476822e",
      "url": "https://api.github.com/repos/ArtalkJS/Artalk/commits/a0b0a3386201319b9b23c3eee591c7c79476822e",
      "html_url": "https://github.com/ArtalkJS/Artalk/commit/a0b0a3386201319b9b23c3eee591c7c79476822e"
    }
  ],
  "stats": {
    "total": 238,
    "additions": 108,
    "deletions": 130
  },
  "files": [
    {
      "sha": "f97d8adaa6c1c99358b6d91bbc4691d134e7c197",
      "filename": "ui/plugin-katex/README.md",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/cf7d74ab86c82eee65ae3027f9d84d87405c4d1b/ui%2Fplugin-katex%2FREADME.md",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/cf7d74ab86c82eee65ae3027f9d84d87405c4d1b/ui%2Fplugin-katex%2FREADME.md",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fplugin-katex%2FREADME.md?ref=cf7d74ab86c82eee65ae3027f9d84d87405c4d1b",
      "patch": "@@ -1,3 +1,3 @@\n # @artalk/plugin-katex\n \n-食用方法参考：[官方文档](https://artalk.js.org/guide/frontend/latex.html)\n+使用方法参考：[官方文档](https://artalk.js.org/guide/frontend/latex.html)"
    },
    {
      "sha": "6b4f63a0a17944e312786155ec398ec344c49264",
      "filename": "ui/plugin-katex/index.html",
      "status": "removed",
      "additions": 0,
      "deletions": 28,
      "changes": 28,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/a0b0a3386201319b9b23c3eee591c7c79476822e/ui%2Fplugin-katex%2Findex.html",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/a0b0a3386201319b9b23c3eee591c7c79476822e/ui%2Fplugin-katex%2Findex.html",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fplugin-katex%2Findex.html?ref=a0b0a3386201319b9b23c3eee591c7c79476822e",
      "patch": "@@ -1,28 +0,0 @@\n-<!doctype html>\n-<html>\n-  <head>\n-    <meta charset=\"UTF-8\" />\n-    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" />\n-    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n-    <title>plugin-katex</title>\n-    <link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css\" />\n-    <script defer src=\"https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js\"></script>\n-  </head>\n-  <body>\n-    <div id=\"comments\"></div>\n-\n-    <script type=\"module\">\n-      import Artalk from 'artalk'\n-      import './main.ts'\n-      import 'artalk/dist/Artalk.css'\n-\n-      var artalk = Artalk.init({\n-        el: '#comments',\n-        pageKey: 'https://artalk.js.org/',\n-        pageTitle: 'Artalk Home',\n-        server: import.meta.env.DEV ? 'http://localhost:23366' : 'https://artalk.qwqaq.com',\n-        site: 'ArtalkDocs',\n-      })\n-    </script>\n-  </body>\n-</html>"
    },
    {
      "sha": "723408089cc788af76d85dfd3148b4a956c62e35",
      "filename": "ui/plugin-katex/main.ts",
      "status": "removed",
      "additions": 0,
      "deletions": 79,
      "changes": 79,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/a0b0a3386201319b9b23c3eee591c7c79476822e/ui%2Fplugin-katex%2Fmain.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/a0b0a3386201319b9b23c3eee591c7c79476822e/ui%2Fplugin-katex%2Fmain.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fplugin-katex%2Fmain.ts?ref=a0b0a3386201319b9b23c3eee591c7c79476822e",
      "patch": "@@ -1,79 +0,0 @@\n-/* eslint-disable guard-for-in */\n-/* eslint-disable no-restricted-syntax */\n-import Artalk from 'artalk'\n-import katex from 'katex'\n-\n-// @link https://github.com/markedjs/marked/issues/1538#issuecomment-575838181\n-Artalk.use((ctx) => {\n-  const markedInstance = ctx.getMarked()\n-  if (!markedInstance) {\n-    console.error('[artalk-plugin-katex] no marked instance found')\n-    return\n-  }\n-\n-  let i = 0\n-  const nextID = () => `__atk_katex_id_${i++}__`\n-  const mathExpressions: {\n-    [key: string]: { type: 'block' | 'inline'; expression: string }\n-  } = {}\n-\n-  function replaceMathWithIds(text: string) {\n-    // Allowing newlines inside of `$$...$$`\n-    text = text.replace(/\\$\\$([\\s\\S]+?)\\$\\$/g, (_match, expression) => {\n-      const id = nextID()\n-      mathExpressions[id] = { type: 'block', expression }\n-      return id\n-    })\n-\n-    // Not allowing newlines or space inside of `$...$`\n-    text = text.replace(/\\$([^\\n]+?)\\$/g, (_match, expression) => {\n-      const id = nextID()\n-      mathExpressions[id] = { type: 'inline', expression }\n-      return id\n-    })\n-\n-    return text\n-  }\n-\n-  // Marked render\n-  const renderer = new markedInstance.Renderer() as any\n-\n-  const orgListitem = renderer.listitem\n-  const orgParagraph = renderer.paragraph\n-  const orgTablecell = renderer.tablecell\n-  const orgCodespan = renderer.codespan\n-  const orgText = renderer.text\n-\n-  renderer.listitem = (text: string, task: boolean, checked: boolean) =>\n-    orgListitem(replaceMathWithIds(text), task, checked)\n-  renderer.paragraph = (text: string) => orgParagraph(replaceMathWithIds(text))\n-  renderer.tablecell = (content: string, flags: any) =>\n-    orgTablecell(replaceMathWithIds(content), flags)\n-  renderer.codespan = (code: string) => orgCodespan(replaceMathWithIds(code))\n-  renderer.text = (text: string) => orgText(replaceMathWithIds(text)) // Inline level, maybe unneeded\n-\n-  ctx.updateConf({\n-    markedReplacers: [\n-      (text) => {\n-        text = text.replace(/(__atk_katex_id_\\d+__)/g, (_match, capture) => {\n-          const v = mathExpressions[capture]\n-          const type = v.type\n-          let expression = v.expression\n-\n-          // replace <br/> tag to \\n\n-          expression = expression.replace(/<br\\s*\\/?>/gm, '\\n')\n-\n-          return katex.renderToString(expression, {\n-            displayMode: type === 'block',\n-          })\n-        })\n-\n-        return text\n-      },\n-    ],\n-  })\n-\n-  markedInstance.use({\n-    renderer,\n-  })\n-})"
    },
    {
      "sha": "7c9cc134fcec28af67360420c2bf22e52f293ff7",
      "filename": "ui/plugin-katex/package.json",
      "status": "modified",
      "additions": 21,
      "deletions": 2,
      "changes": 23,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/cf7d74ab86c82eee65ae3027f9d84d87405c4d1b/ui%2Fplugin-katex%2Fpackage.json",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/cf7d74ab86c82eee65ae3027f9d84d87405c4d1b/ui%2Fplugin-katex%2Fpackage.json",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fplugin-katex%2Fpackage.json?ref=cf7d74ab86c82eee65ae3027f9d84d87405c4d1b",
      "patch": "@@ -1,10 +1,16 @@\n {\n   \"name\": \"@artalk/plugin-katex\",\n-  \"version\": \"0.1.6\",\n+  \"version\": \"0.1.7\",\n+  \"minAppVersion\": \"2.8.6\",\n   \"license\": \"MIT\",\n   \"description\": \"The katex plugin for artalk\",\n+  \"type\": \"module\",\n   \"main\": \"./dist/artalk-plugin-katex.js\",\n-  \"module\": \"./dist/artalk-plugin-katex.es.js\",\n+  \"module\": \"./dist/artalk-plugin-katex.mjs\",\n+  \"types\": \"./dist/artalk-plugin-katex.d.ts\",\n+  \"files\": [\n+    \"dist\"\n+  ],\n   \"scripts\": {\n     \"dev\": \"vite\",\n     \"build\": \"vite build\",\n@@ -13,10 +19,23 @@\n     \"publish\": \"pnpm publish --access=public\"\n   },\n   \"dependencies\": {\n+    \"@artalk/plugin-kit\": \"workspace:^\",\n     \"artalk\": \"workspace:^\",\n     \"katex\": \"^0.16.10\"\n   },\n   \"devDependencies\": {\n     \"@types/katex\": \"0.16.7\"\n+  },\n+  \"exports\": {\n+    \".\": {\n+      \"require\": {\n+        \"types\": \"./dist/artalk-plugin-katex.d.cts\",\n+        \"default\": \"./dist/artalk-plugin-katex.cjs\"\n+      },\n+      \"default\": {\n+        \"types\": \"./dist/artalk-plugin-katex.d.ts\",\n+        \"default\": \"./dist/artalk-plugin-katex.mjs\"\n+      }\n+    }\n   }\n }"
    },
    {
      "sha": "c18b6e1c6ff5c55f4547a3e5d4f43c628a77a385",
      "filename": "ui/plugin-katex/src/main.ts",
      "status": "added",
      "additions": 80,
      "deletions": 0,
      "changes": 80,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/cf7d74ab86c82eee65ae3027f9d84d87405c4d1b/ui%2Fplugin-katex%2Fsrc%2Fmain.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/cf7d74ab86c82eee65ae3027f9d84d87405c4d1b/ui%2Fplugin-katex%2Fsrc%2Fmain.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fplugin-katex%2Fsrc%2Fmain.ts?ref=cf7d74ab86c82eee65ae3027f9d84d87405c4d1b",
      "patch": "@@ -0,0 +1,80 @@\n+import { ArtalkPlugin } from 'artalk'\n+import katex from 'katex'\n+import 'katex/dist/katex.min.css'\n+\n+export const ArtalkKatexPlugin: ArtalkPlugin = (ctx) => {\n+  ctx.on('mounted', () => {\n+    // @see https://github.com/markedjs/marked/issues/1538#issuecomment-575838181\n+    const markedInstance = ctx.getMarked() // must be called after `mounted` event\n+    if (!markedInstance) {\n+      console.error('[artalk-plugin-katex] no marked instance found')\n+      return\n+    }\n+\n+    let i = 0\n+    const nextID = () => `__atk_katex_id_${i++}__`\n+    const mathExpressions: {\n+      [key: string]: { type: 'block' | 'inline'; expression: string }\n+    } = {}\n+\n+    function replaceMathWithIds(text: string) {\n+      // Allowing newlines inside of `$$...$$`\n+      text = text.replace(/\\$\\$([\\s\\S]+?)\\$\\$/g, (_match, expression) => {\n+        const id = nextID()\n+        mathExpressions[id] = { type: 'block', expression }\n+        return id\n+      })\n+\n+      // Not allowing newlines or space inside of `$...$`\n+      text = text.replace(/\\$([^\\n]+?)\\$/g, (_match, expression) => {\n+        const id = nextID()\n+        mathExpressions[id] = { type: 'inline', expression }\n+        return id\n+      })\n+\n+      return text\n+    }\n+\n+    // Marked render\n+    const renderer = new markedInstance.Renderer() as any\n+\n+    const orgListitem = renderer.listitem\n+    const orgParagraph = renderer.paragraph\n+    const orgTablecell = renderer.tablecell\n+    const orgCodespan = renderer.codespan\n+    const orgText = renderer.text\n+\n+    renderer.listitem = (text: string, task: boolean, checked: boolean) =>\n+      orgListitem(replaceMathWithIds(text), task, checked)\n+    renderer.paragraph = (text: string) => orgParagraph(replaceMathWithIds(text))\n+    renderer.tablecell = (content: string, flags: any) =>\n+      orgTablecell(replaceMathWithIds(content), flags)\n+    renderer.codespan = (code: string) => orgCodespan(replaceMathWithIds(code))\n+    renderer.text = (text: string) => orgText(replaceMathWithIds(text)) // Inline level, maybe unneeded\n+\n+    ctx.updateConf({\n+      markedReplacers: [\n+        (text) => {\n+          text = text.replace(/(__atk_katex_id_\\d+__)/g, (_match, capture) => {\n+            const v = mathExpressions[capture]\n+            const type = v.type\n+            let expression = v.expression\n+\n+            // replace <br/> tag to \\n\n+            expression = expression.replace(/<br\\s*\\/?>/gm, '\\n')\n+\n+            return katex.renderToString(expression, {\n+              displayMode: type === 'block',\n+            })\n+          })\n+\n+          return text\n+        },\n+      ],\n+    })\n+\n+    markedInstance.use({\n+      renderer,\n+    })\n+  })\n+}"
    },
    {
      "sha": "3cd80645429dd98bf37b19d89cfec29aebefa58e",
      "filename": "ui/plugin-katex/tsconfig.json",
      "status": "modified",
      "additions": 2,
      "deletions": 1,
      "changes": 3,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/cf7d74ab86c82eee65ae3027f9d84d87405c4d1b/ui%2Fplugin-katex%2Ftsconfig.json",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/cf7d74ab86c82eee65ae3027f9d84d87405c4d1b/ui%2Fplugin-katex%2Ftsconfig.json",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fplugin-katex%2Ftsconfig.json?ref=cf7d74ab86c82eee65ae3027f9d84d87405c4d1b",
      "patch": "@@ -2,6 +2,7 @@\n   \"extends\": \"../../tsconfig.base.json\",\n   \"compilerOptions\": {\n     \"baseUrl\": \".\",\n-    \"outDir\": \"dist\"\n+    \"outDir\": \"dist\",\n+    \"types\": [\"@artalk/plugin-kit/client\"]\n   }\n }"
    },
    {
      "sha": "51cc9f9e9f7f06c02a3efeff5b1ff7d5e82622b5",
      "filename": "ui/plugin-katex/vite.config.ts",
      "status": "modified",
      "additions": 4,
      "deletions": 19,
      "changes": 23,
      "blob_url": "https://github.com/ArtalkJS/Artalk/blob/cf7d74ab86c82eee65ae3027f9d84d87405c4d1b/ui%2Fplugin-katex%2Fvite.config.ts",
      "raw_url": "https://github.com/ArtalkJS/Artalk/raw/cf7d74ab86c82eee65ae3027f9d84d87405c4d1b/ui%2Fplugin-katex%2Fvite.config.ts",
      "contents_url": "https://api.github.com/repos/ArtalkJS/Artalk/contents/ui%2Fplugin-katex%2Fvite.config.ts?ref=cf7d74ab86c82eee65ae3027f9d84d87405c4d1b",
      "patch": "@@ -1,32 +1,17 @@\n import { defineConfig } from 'vite'\n-import { resolve } from 'path'\n-import tsconfigPaths from 'vite-tsconfig-paths'\n+\n+import { ViteArtalkPluginKit } from '@artalk/plugin-kit'\n \n export default defineConfig({\n-  base: './',\n   build: {\n-    target: 'es2015',\n-    outDir: resolve(__dirname, 'dist'),\n-    minify: 'terser',\n-    lib: {\n-      entry: resolve(__dirname, './main.ts'),\n-      name: 'artalk-plugin-katex',\n-      fileName: (format) =>\n-        format == 'umd' ? 'artalk-plugin-katex.js' : `artalk-plugin-katex.${format}.js`,\n-      formats: ['es', 'umd', 'iife'],\n-    },\n     rollupOptions: {\n-      // 确保外部化处理那些你不想打包进库的依赖\n-      external: ['artalk', 'katex'],\n+      external: ['katex', 'katex/dist/katex.min.css'],\n       output: {\n-        // 在 UMD 构建模式下为这些外部化的依赖提供一个全局变量\n         globals: {\n-          artalk: 'Artalk',\n           katex: 'katex',\n         },\n-        extend: true,\n       },\n     },\n   },\n-  plugins: [tsconfigPaths()],\n+  plugins: [ViteArtalkPluginKit()],\n })"
    }
  ]
}
